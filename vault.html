<!DOCTYPE HTML>
<html lang="en" class="light sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Encryption at Rest (Vault) - Moltis Documentation</title>


        <!-- Custom HTML head -->

        <meta name="description" content="Documentation for Moltis - Your AI coding assistant">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="favicon.svg">
        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" id="highlight-css" href="highlight.css">
        <link rel="stylesheet" id="tomorrow-night-css" href="tomorrow-night.css">
        <link rel="stylesheet" id="ayu-highlight-css" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        <link rel="stylesheet" href="theme/admonish.css">
        <link rel="stylesheet" href="theme/custom.css">


        <!-- Provide site root and default themes to javascript -->
        <script>
            const path_to_root = "";
            const default_light_theme = "light";
            const default_dark_theme = "navy";
            window.path_to_searchindex_js = "searchindex.js";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="toc.js"></script>
    </head>
    <body>
    <div id="mdbook-help-container">
        <div id="mdbook-help-popup">
            <h2 class="mdbook-help-title">Keyboard shortcuts</h2>
            <div>
                <p>Press <kbd>←</kbd> or <kbd>→</kbd> to navigate between chapters</p>
                <p>Press <kbd>S</kbd> or <kbd>/</kbd> to search in the book</p>
                <p>Press <kbd>?</kbd> to show this help</p>
                <p>Press <kbd>Esc</kbd> to hide this help</p>
            </div>
        </div>
    </div>
    <div id="body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                let theme = localStorage.getItem('mdbook-theme');
                let sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            const default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? default_dark_theme : default_light_theme;
            let theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            let sidebar = null;
            const sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
                sidebar_toggle.checked = false;
            }
            if (sidebar === 'visible') {
                sidebar_toggle.checked = true;
            } else {
                html.classList.remove('sidebar-visible');
            }
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="toc.html"></iframe>
            </noscript>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="default_theme">Auto</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search (`/`)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="/ s" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Moltis Documentation</h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        <a href="https://github.com/moltis-org/moltis" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>
                        <a href="https://github.com/moltis-org/moltis/edit/main/docs/src/src/vault.md" title="Suggest an edit" aria-label="Suggest an edit" rel="edit">
                            <i id="git-edit-button" class="fa fa-edit"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <div class="search-wrapper">
                            <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                            <div class="spinner-wrapper">
                                <i class="fa fa-spinner fa-spin"></i>
                            </div>
                        </div>
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="encryption-at-rest-vault"><a class="header" href="#encryption-at-rest-vault">Encryption at Rest (Vault)</a></h1>
<p>Moltis includes an encryption-at-rest vault that protects sensitive data
stored in the SQLite database. Environment variables (provider API keys,
tokens, etc.) are encrypted with <strong>XChaCha20-Poly1305</strong> AEAD using keys
derived from your password via <strong>Argon2id</strong>.</p>
<p>The vault is enabled by default (the <code>vault</code> cargo feature) and requires
no configuration. It initializes automatically when you set your first
password (during setup or later in <strong>Settings &gt; Authentication</strong>).</p>
<h2 id="key-hierarchy"><a class="header" href="#key-hierarchy">Key Hierarchy</a></h2>
<p>The vault uses a two-layer key hierarchy to separate the encryption key
from the password:</p>
<pre><code>User password
  │
  ▼ Argon2id (salt from DB)
  │
  KEK (Key Encryption Key)
  │
  ▼ XChaCha20-Poly1305 unwrap
  │
  DEK (Data Encryption Key)
  │
  ▼ XChaCha20-Poly1305 encrypt/decrypt
  │
  Encrypted data (env variables, ...)
</code></pre>
<ul>
<li><strong>KEK</strong> — derived from the user’s password using Argon2id with a
per-instance random salt. Never stored directly; recomputed on each unseal.</li>
<li><strong>DEK</strong> — a random 256-bit key generated once at vault initialization.
Stored encrypted (wrapped) by the KEK in the <code>vault_metadata</code> table.</li>
<li><strong>Recovery KEK</strong> — an independent Argon2id-derived key from the recovery
phrase with a fixed domain-separation salt, used to wrap a second copy of
the DEK for emergency access. Uses lighter KDF parameters (16 MiB, 2
iterations) since the recovery key already has 128 bits of entropy.</li>
</ul>
<p>This design means changing your password only re-wraps the DEK with a new
KEK. The DEK itself (and all data encrypted by it) stays the same, so
password changes are fast regardless of how much data is encrypted.</p>
<h2 id="vault-states"><a class="header" href="#vault-states">Vault States</a></h2>
<p>The vault has three states:</p>
<div class="table-wrapper"><table><thead><tr><th>State</th><th>Meaning</th></tr></thead><tbody>
<tr><td><strong>Uninitialized</strong></td><td>No vault metadata exists. The vault hasn’t been set up yet.</td></tr>
<tr><td><strong>Sealed</strong></td><td>Metadata exists but the DEK is not in memory. Data cannot be read or written.</td></tr>
<tr><td><strong>Unsealed</strong></td><td>The DEK is in memory. Encryption and decryption are active.</td></tr>
</tbody></table>
</div>
<pre><code>                 set password
Uninitialized ──────────────► Unsealed
                                │  ▲
                     restart    │  │  login / unlock
                                ▼  │
                              Sealed
</code></pre>
<p>After a server restart, the vault is always in the <strong>Sealed</strong> state until
the user logs in (which provides the password needed to derive the KEK and
unwrap the DEK).</p>
<h2 id="lifecycle-integration"><a class="header" href="#lifecycle-integration">Lifecycle Integration</a></h2>
<p>The vault integrates transparently with the authentication flow:</p>
<h3 id="first-password-set-post-apiauthsetup-or-first-post-apiauthpasswordchange"><a class="header" href="#first-password-set-post-apiauthsetup-or-first-post-apiauthpasswordchange">First password set (<code>POST /api/auth/setup</code> or first <code>POST /api/auth/password/change</code>)</a></h3>
<p>When the first password is set (during onboarding or later in Settings):</p>
<ol>
<li><code>vault.initialize(password)</code> generates a random DEK and recovery key</li>
<li>The DEK is wrapped with a KEK derived from the password</li>
<li>A second copy of the DEK is wrapped with the recovery KEK</li>
<li>The response includes a <code>recovery_key</code> field (shown once, then not returned again)</li>
<li>Any existing plaintext env vars are migrated to encrypted</li>
</ol>
<h3 id="login-post-apiauthlogin"><a class="header" href="#login-post-apiauthlogin">Login (<code>POST /api/auth/login</code>)</a></h3>
<p>After successful password verification:</p>
<ol>
<li><code>vault.unseal(password)</code> derives the KEK and unwraps the DEK into memory</li>
<li>Unencrypted env vars are migrated to encrypted (if any remain)</li>
</ol>
<h3 id="password-change-after-initialization-post-apiauthpasswordchange"><a class="header" href="#password-change-after-initialization-post-apiauthpasswordchange">Password change after initialization (<code>POST /api/auth/password/change</code>)</a></h3>
<p>When a password already exists and is rotated:</p>
<ol>
<li><code>vault.change_password(old, new)</code> re-wraps the DEK with a new KEK
derived from the new password</li>
</ol>
<p>No new recovery key is generated during normal password rotation.</p>
<h3 id="server-restart"><a class="header" href="#server-restart">Server restart</a></h3>
<p>The vault starts in <strong>Sealed</strong> state. All encrypted data is unreadable
until the user logs in, which triggers unseal.</p>
<h2 id="recovery-key"><a class="header" href="#recovery-key">Recovery Key</a></h2>
<p>At vault initialization, a human-readable recovery key is generated and
returned in the API response that performed initialization. It looks like:</p>
<pre><code>ABCD-EFGH-JKLM-NPQR-STUV-WXYZ-2345-6789
</code></pre>
<p>The alphabet excludes ambiguous characters (<code>I</code>, <code>O</code>, <code>0</code>, <code>1</code>) to avoid
transcription errors. The key is case-insensitive.</p>
<div id="admonition-warning" class="admonition admonish-warning" role="note" aria-labelledby="admonition-warning-title">
<div class="admonition-title">
<div id="admonition-warning-title">
<p>Warning</p>
</div>
<a class="admonition-anchor-link" href="#admonition-warning"></a>
</div>
<div>
<p>The recovery key is shown <strong>exactly once</strong> when the vault is initialized.
Store it in a safe place (password manager, printed copy in a safe, etc.).
If you lose both your password and recovery key, encrypted data cannot be
recovered.</p>
</div>
</div>
<p>Use the recovery key to unseal the vault when you’ve forgotten your
password:</p>
<pre><code class="language-bash">curl -X POST http://localhost:18789/api/auth/vault/recovery \
  -H "Content-Type: application/json" \
  -d '{"recovery_key": "ABCD-EFGH-JKLM-NPQR-STUV-WXYZ-2345-6789"}'
</code></pre>
<h2 id="what-gets-encrypted"><a class="header" href="#what-gets-encrypted">What Gets Encrypted</a></h2>
<p>Currently encrypted:</p>
<div class="table-wrapper"><table><thead><tr><th>Data</th><th>Storage</th><th>AAD</th></tr></thead><tbody>
<tr><td>Environment variables (<code>env_variables</code> table)</td><td>SQLite</td><td><code>env:{key}</code></td></tr>
</tbody></table>
</div>
<p>The <code>encrypted</code> column in <code>env_variables</code> tracks whether each row is
encrypted (1) or plaintext (0). When the vault is unsealed, new env vars
are written encrypted. When sealed or uninitialized, they are written as
plaintext.</p>
<div id="admonition-planned" class="admonition admonish-info" role="note" aria-labelledby="admonition-planned-title">
<div class="admonition-title">
<div id="admonition-planned-title">
<p>Planned</p>
</div>
<a class="admonition-anchor-link" href="#admonition-planned"></a>
</div>
<div>
<p>KeyStore (provider API keys in <code>provider_keys.json</code>) and TokenStore
(OAuth tokens in <code>credentials.json</code>) are currently sync/file-based and
cannot easily call async vault methods. Encryption for these stores is
planned after an async refactor.</p>
</div>
</div>
<h2 id="vault-guard-middleware"><a class="header" href="#vault-guard-middleware">Vault Guard Middleware</a></h2>
<p>When the vault is in the <strong>Sealed</strong> state, a middleware layer blocks API
requests (except auth and bootstrap endpoints) with <code>423 Locked</code>:</p>
<pre><code class="language-json">{"error": "vault is sealed", "status": "sealed"}
</code></pre>
<p>This prevents the application from serving stale or unreadable data when
the vault needs to be unlocked.</p>
<p>The guard does <strong>not</strong> block when the vault is <strong>Uninitialized</strong> — there’s
nothing to protect yet, and the application needs to function normally for
initial setup.</p>
<p>Allowed through regardless of vault state:</p>
<ul>
<li><code>/api/auth/*</code> — authentication endpoints (including vault unlock)</li>
<li><code>/api/gon</code> — server-injected bootstrap data</li>
<li>Non-API routes — static assets, HTML pages, health check</li>
</ul>
<h2 id="api-endpoints"><a class="header" href="#api-endpoints">API Endpoints</a></h2>
<p>All vault endpoints are under <code>/api/auth/vault/</code> and require no session
(they are on the public auth allowlist):</p>
<div class="table-wrapper"><table><thead><tr><th>Method</th><th>Path</th><th>Purpose</th></tr></thead><tbody>
<tr><td><code>GET</code></td><td><code>/api/auth/vault/status</code></td><td>Returns <code>{"status": "uninitialized"|"sealed"|"unsealed"|"disabled"}</code></td></tr>
<tr><td><code>POST</code></td><td><code>/api/auth/vault/unlock</code></td><td>Unseal with password: <code>{"password": "..."}</code></td></tr>
<tr><td><code>POST</code></td><td><code>/api/auth/vault/recovery</code></td><td>Unseal with recovery key: <code>{"recovery_key": "..."}</code></td></tr>
</tbody></table>
</div>
<p>Error responses:</p>
<div class="table-wrapper"><table><thead><tr><th>Status</th><th>Meaning</th></tr></thead><tbody>
<tr><td><code>200</code></td><td>Success</td></tr>
<tr><td><code>423 Locked</code></td><td>Bad password or recovery key</td></tr>
<tr><td><code>404</code></td><td>Vault not available (feature disabled)</td></tr>
<tr><td><code>500</code></td><td>Internal error</td></tr>
</tbody></table>
</div>
<h2 id="frontend-integration"><a class="header" href="#frontend-integration">Frontend Integration</a></h2>
<p>The vault status is included in the gon data (<code>window.__MOLTIS__</code>) on
every page load:</p>
<pre><code class="language-js">import * as gon from "./gon.js";
const vaultStatus = gon.get("vault_status");
// "uninitialized" | "sealed" | "unsealed" | "disabled"
</code></pre>
<p>Live updates are available via <code>gon.onChange("vault_status", callback)</code>.</p>
<h3 id="locked-vault-banners"><a class="header" href="#locked-vault-banners">Locked-vault banners</a></h3>
<p>When <code>vault_status</code> is <code>sealed</code>, the UI shows an info banner:</p>
<ul>
<li>In the main app shell (<code>index.html</code>): a banner linking to
<strong>Settings &gt; Encryption</strong> for manual unlock.</li>
<li>On the login page (<code>/login</code>): a banner that explains the vault is locked
and will unlock after successful sign-in.</li>
</ul>
<h3 id="onboarding-and-localhost"><a class="header" href="#onboarding-and-localhost">Onboarding and localhost</a></h3>
<p>The onboarding wizard’s Security step explains that setting a password
also enables the encryption vault for stored secrets. The password
selection card explicitly says: “Set a password and enable the encryption
vault for stored secrets.”</p>
<p>On localhost, where authentication is optional, the subtitle mentions
that setting a password enables the vault — giving users a reason to
set one even when network security is not a concern.</p>
<p>When a password is set during first-time setup, the server returns a
<code>recovery_key</code> field in the JSON response. The onboarding wizard shows an
interstitial screen with:</p>
<ul>
<li>A success message (“Password set and vault initialized”)</li>
<li>The recovery key in a monospace <code>&lt;code&gt;</code> block with <code>select-all</code> for
easy selection</li>
<li>A <strong>Copy</strong> button using the Clipboard API</li>
<li>A warning that the key will not be shown again</li>
<li>A <strong>Continue</strong> button to proceed to the next onboarding step</li>
</ul>
<p>In <strong>Settings &gt; Authentication</strong>, setting a password for the first time
also returns a <code>recovery_key</code>. The page keeps the user on Settings long
enough to copy it, then shows a <strong>Continue to sign in</strong> action when the
new password makes authentication mandatory.</p>
<p>Passkey-only setup does not trigger vault initialization (no password to
derive a KEK from), so the recovery key screen is never shown in that flow.</p>
<h3 id="vault-status-in-settings--encryption"><a class="header" href="#vault-status-in-settings--encryption">Vault status in Settings &gt; Encryption</a></h3>
<p>When the vault feature is compiled in, an <strong>Encryption</strong> tab appears in
Settings (under the Security group). It tells the user their API keys
and secrets are encrypted before being stored, and that the vault locks
on restart and unlocks on login.</p>
<div class="table-wrapper"><table><thead><tr><th>Vault state</th><th>Badge</th><th>What it means</th></tr></thead><tbody>
<tr><td><strong>Unsealed</strong></td><td>Green (“Unlocked”)</td><td>Your API keys and secrets are encrypted in the database. Everything is working.</td></tr>
<tr><td><strong>Sealed</strong></td><td>Amber (“Locked”)</td><td>Log in or unlock below to access your encrypted keys.</td></tr>
<tr><td><strong>Uninitialized</strong></td><td>Gray (“Off”)</td><td>Set a password in Authentication settings to start encrypting your stored keys.</td></tr>
</tbody></table>
</div>
<p>When the vault is <strong>sealed</strong>, both unlock forms are shown in the same
panel (password and recovery key, separated by an “or” divider). Submitting
calls <code>POST /api/auth/vault/unlock</code> or <code>POST /api/auth/vault/recovery</code>,
then refreshes gon data to update the status badge.</p>
<h3 id="encrypted-badges-on-environment-variables"><a class="header" href="#encrypted-badges-on-environment-variables">Encrypted badges on environment variables</a></h3>
<p>Each environment variable in <strong>Settings &gt; Environment</strong> shows a badge
indicating its encryption status:</p>
<div class="table-wrapper"><table><thead><tr><th>Badge</th><th>Style</th><th>Meaning</th></tr></thead><tbody>
<tr><td><strong>Encrypted</strong></td><td>Green (<code>.provider-item-badge.configured</code>)</td><td>Value is encrypted at rest by the vault</td></tr>
<tr><td><strong>Plaintext</strong></td><td>Gray (<code>.provider-item-badge.muted</code>)</td><td>Value is stored in cleartext</td></tr>
</tbody></table>
</div>
<p>A status note at the top of the section explains the current vault state:</p>
<ul>
<li><strong>Unlocked</strong>: “Your keys are stored encrypted.”</li>
<li><strong>Locked</strong>: “Encrypted keys can’t be read — sandbox commands won’t
work.” Links to Encryption settings to unlock.</li>
<li><strong>Not set up</strong>: “Set a password to encrypt your stored keys.” Links
to Authentication settings.</li>
</ul>
<h2 id="disabling-the-vault"><a class="header" href="#disabling-the-vault">Disabling the Vault</a></h2>
<p>To compile without vault support, disable the <code>vault</code> feature:</p>
<pre><code class="language-bash">cargo build --no-default-features --features "web-ui,tls"
</code></pre>
<p>When the feature is disabled, all vault code is compiled out via
<code>#[cfg(feature = "vault")]</code>. Environment variables are stored as plaintext,
and the vault API endpoints return 404.</p>
<h2 id="cryptographic-details"><a class="header" href="#cryptographic-details">Cryptographic Details</a></h2>
<div class="table-wrapper"><table><thead><tr><th>Parameter</th><th>Value</th></tr></thead><tbody>
<tr><td>AEAD cipher</td><td>XChaCha20-Poly1305 (192-bit nonce, 256-bit key)</td></tr>
<tr><td>KDF</td><td>Argon2id</td></tr>
<tr><td>Argon2id memory</td><td>64 MiB</td></tr>
<tr><td>Argon2id iterations</td><td>3</td></tr>
<tr><td>Argon2id parallelism</td><td>1</td></tr>
<tr><td>DEK size</td><td>256 bits</td></tr>
<tr><td>Nonce generation</td><td>Random per encryption (24 bytes)</td></tr>
<tr><td>AAD</td><td>Context string per data type (e.g. <code>env:MY_KEY</code>)</td></tr>
<tr><td>Key wrapping</td><td>XChaCha20-Poly1305 (KEK encrypts DEK)</td></tr>
<tr><td>Recovery key</td><td>128-bit random, 32-char alphanumeric encoding (8 groups of 4)</td></tr>
</tbody></table>
</div>
<p>The nonce is prepended to the ciphertext and stored as base64. AAD
(Additional Authenticated Data) binds each ciphertext to its context,
preventing an attacker from swapping encrypted values between keys.</p>
<h2 id="database-schema"><a class="header" href="#database-schema">Database Schema</a></h2>
<p>The vault uses a single metadata table:</p>
<pre><code class="language-sql">CREATE TABLE IF NOT EXISTS vault_metadata (
    id                   INTEGER PRIMARY KEY CHECK (id = 1),
    version              INTEGER NOT NULL DEFAULT 1,
    kdf_salt             TEXT    NOT NULL,
    kdf_params           TEXT    NOT NULL,
    wrapped_dek          TEXT    NOT NULL,
    recovery_wrapped_dek TEXT,
    recovery_key_hash    TEXT,
    created_at           TEXT    NOT NULL DEFAULT (datetime('now')),
    updated_at           TEXT    NOT NULL DEFAULT (datetime('now'))
);
</code></pre>
<p>The <code>CHECK (id = 1)</code> constraint ensures only one row exists — the vault
is a singleton per database.</p>
<p>The gateway migration adds the <code>encrypted</code> column to <code>env_variables</code>:</p>
<pre><code class="language-sql">ALTER TABLE env_variables ADD COLUMN encrypted INTEGER NOT NULL DEFAULT 0;
</code></pre>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="authentication.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="security.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="authentication.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="security.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="elasticlunr.min.js"></script>
        <script src="mark.min.js"></script>
        <script src="searcher.js"></script>

        <script src="clipboard.min.js"></script>
        <script src="highlight.js"></script>
        <script src="book.js"></script>

        <!-- Custom JS scripts -->



    </div>
    </body>
</html>
