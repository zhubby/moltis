<!DOCTYPE HTML>
<html lang="en" class="light sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Moltis Documentation</title>
        <meta name="robots" content="noindex">


        <!-- Custom HTML head -->

        <meta name="description" content="Documentation for Moltis - Your AI coding assistant">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="favicon.svg">
        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" id="highlight-css" href="highlight.css">
        <link rel="stylesheet" id="tomorrow-night-css" href="tomorrow-night.css">
        <link rel="stylesheet" id="ayu-highlight-css" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        <link rel="stylesheet" href="theme/admonish.css">
        <link rel="stylesheet" href="theme/custom.css">


        <!-- Provide site root and default themes to javascript -->
        <script>
            const path_to_root = "";
            const default_light_theme = "light";
            const default_dark_theme = "navy";
            window.path_to_searchindex_js = "searchindex.js";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="toc.js"></script>
    </head>
    <body>
    <div id="mdbook-help-container">
        <div id="mdbook-help-popup">
            <h2 class="mdbook-help-title">Keyboard shortcuts</h2>
            <div>
                <p>Press <kbd>â†</kbd> or <kbd>â†’</kbd> to navigate between chapters</p>
                <p>Press <kbd>S</kbd> or <kbd>/</kbd> to search in the book</p>
                <p>Press <kbd>?</kbd> to show this help</p>
                <p>Press <kbd>Esc</kbd> to hide this help</p>
            </div>
        </div>
    </div>
    <div id="body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                let theme = localStorage.getItem('mdbook-theme');
                let sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            const default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? default_dark_theme : default_light_theme;
            let theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            let sidebar = null;
            const sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
                sidebar_toggle.checked = false;
            }
            if (sidebar === 'visible') {
                sidebar_toggle.checked = true;
            } else {
                html.classList.remove('sidebar-visible');
            }
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="toc.html"></iframe>
            </noscript>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="default_theme">Auto</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search (`/`)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="/ s" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Moltis Documentation</h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        <a href="https://github.com/moltis-org/moltis" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <div class="search-wrapper">
                            <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                            <div class="spinner-wrapper">
                                <i class="fa fa-spinner fa-spin"></i>
                            </div>
                        </div>
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="moltis"><a class="header" href="#moltis">Moltis</a></h1>
<div id="admonition-alpha-software-use-with-care" class="admonition admonish-warning" role="note" aria-labelledby="admonition-alpha-software-use-with-care-title">
<div class="admonition-title">
<div id="admonition-alpha-software-use-with-care-title">
<p>Alpha software: use with care</p>
</div>
<a class="admonition-anchor-link" href="index.html#admonition-alpha-software-use-with-care"></a>
</div>
<div>
<p>Running an AI assistant on your own machine or server is still new territory. Treat Moltis as alpha software: run it in isolated environments, review enabled tools/providers, keep secrets scoped and rotated, and avoid exposing it publicly without strong authentication and network controls.</p>
</div>
</div>
<div style="text-align: center; margin: 2em 0;">
<strong style="font-size: 1.2em;">A personal AI gateway written in Rust.<br>One binary, no runtime, no npm.</strong>
</div>
<p>Moltis compiles your entire AI gateway â€” web UI, LLM providers, tools, and all assets â€” into a single self-contained executable. Thereâ€™s no Node.js to babysit, no <code>node_modules</code> to sync, no V8 garbage collector introducing latency spikes.</p>
<pre><code class="language-bash"># Quick install (macOS / Linux)
curl -fsSL https://www.moltis.org/install.sh | sh
</code></pre>
<h2 id="why-moltis"><a class="header" href="#why-moltis">Why Moltis?</a></h2>
<div class="table-wrapper"><table><thead><tr><th>Feature</th><th>Moltis</th><th>Other Solutions</th></tr></thead><tbody>
<tr><td><strong>Deployment</strong></td><td>Single binary</td><td>Node.js + dependencies</td></tr>
<tr><td><strong>Memory Safety</strong></td><td>Rust ownership</td><td>Garbage collection</td></tr>
<tr><td><strong>Secret Handling</strong></td><td>Zeroed on drop</td><td>â€œEventually collectedâ€</td></tr>
<tr><td><strong>Sandbox</strong></td><td>Docker + Apple Container</td><td>Docker only</td></tr>
<tr><td><strong>Startup</strong></td><td>Milliseconds</td><td>Seconds</td></tr>
</tbody></table>
</div>
<h2 id="key-features"><a class="header" href="#key-features">Key Features</a></h2>
<ul>
<li><strong>Multiple LLM Providers</strong> â€” OpenAI Codex, GitHub Copilot, Local LLM*</li>
<li><strong>Streaming-First</strong> â€” Responses appear as tokens arrive, not after completion</li>
<li><strong>Sandboxed Execution</strong> â€” Commands run in isolated containers (Docker or Apple Container)</li>
<li><strong>MCP Support</strong> â€” Connect to Model Context Protocol servers for extended capabilities</li>
<li><strong>Multi-Channel</strong> â€” Web UI, Telegram, API access with synchronized responses</li>
<li><strong>Built-in Throttling</strong> â€” Per-IP endpoint limits with strict login protection</li>
<li><strong>Long-Term Memory</strong> â€” Embeddings-powered knowledge base with hybrid search</li>
<li><strong>Hook System</strong> â€” Observe, modify, or block actions at any lifecycle point</li>
<li><strong>Compile-Time Safety</strong> â€” Misconfigurations caught by <code>cargo check</code>, not runtime crashes</li>
</ul>
<p><em>More providers are coming soon.</em></p>
<h2 id="quick-start"><a class="header" href="#quick-start">Quick Start</a></h2>
<pre><code class="language-bash"># Install
curl -fsSL https://www.moltis.org/install.sh | sh

# Run
moltis
</code></pre>
<p>On first launch:</p>
<ol>
<li>Open the URL shown in your browser (e.g., <code>http://localhost:13131</code>)</li>
<li>Add your LLM API key</li>
<li>Start chatting!</li>
</ol>
<div id="admonition-note" class="admonition admonish-note" role="note" aria-labelledby="admonition-note-title">
<div class="admonition-title">
<div id="admonition-note-title">
<p>Note</p>
</div>
<a class="admonition-anchor-link" href="index.html#admonition-note"></a>
</div>
<div>
<p>Authentication is only required when accessing Moltis from a non-localhost address. On localhost, you can start using it immediately.</p>
</div>
</div>
<p>â†’ <a href="quickstart.html">Full Quickstart Guide</a></p>
<h2 id="how-it-works"><a class="header" href="#how-it-works">How It Works</a></h2>
<pre><code>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Web UI    â”‚  â”‚  Telegram   â”‚  â”‚     API     â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚                â”‚                â”‚
       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚
                        â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚       Moltis Gateway          â”‚
        â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
        â”‚   â”‚  Agent  â”‚ â”‚   Tools   â”‚   â”‚
        â”‚   â”‚  Loop   â”‚â—„â”¤  Registry â”‚   â”‚
        â”‚   â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
        â”‚        â”‚                      â”‚
        â”‚   â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
        â”‚   â”‚  Provider Registry  â”‚     â”‚
        â”‚   â”‚ Codex Â· Copilot Â· Local* â”‚   â”‚
        â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚
                â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”
                â”‚    Sandbox    â”‚
                â”‚ Docker/Apple  â”‚
                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
</code></pre>
<h2 id="documentation"><a class="header" href="#documentation">Documentation</a></h2>
<h3 id="getting-started"><a class="header" href="#getting-started">Getting Started</a></h3>
<ul>
<li><strong><a href="quickstart.html">Quickstart</a></strong> â€” Up and running in 5 minutes</li>
<li><strong><a href="installation.html">Installation</a></strong> â€” All installation methods</li>
<li><strong><a href="configuration.html">Configuration</a></strong> â€” <code>moltis.toml</code> reference</li>
<li><strong><a href="e2e-testing.html">End-to-End Testing</a></strong> â€” Browser regression coverage for the web UI</li>
</ul>
<h3 id="features"><a class="header" href="#features">Features</a></h3>
<ul>
<li><strong><a href="providers.html">Providers</a></strong> â€” Configure LLM providers</li>
<li><strong><a href="mcp.html">MCP Servers</a></strong> â€” Extend with Model Context Protocol</li>
<li><strong><a href="hooks.html">Hooks</a></strong> â€” Lifecycle hooks for customization</li>
<li><strong><a href="local-llm.html">Local LLMs</a></strong> â€” Run models on your machine</li>
</ul>
<h3 id="deployment"><a class="header" href="#deployment">Deployment</a></h3>
<ul>
<li><strong><a href="docker.html">Docker</a></strong> â€” Container deployment</li>
</ul>
<h3 id="architecture"><a class="header" href="#architecture">Architecture</a></h3>
<ul>
<li><strong><a href="streaming.html">Streaming</a></strong> â€” How real-time streaming works</li>
<li><strong><a href="metrics-and-tracing.html">Metrics &amp; Tracing</a></strong> â€” Observability</li>
</ul>
<h2 id="security"><a class="header" href="#security">Security</a></h2>
<p>Moltis applies defense in depth:</p>
<ul>
<li><strong>Authentication</strong> â€” Password or passkey (WebAuthn) required for non-localhost access</li>
<li><strong>SSRF Protection</strong> â€” Blocks requests to internal networks</li>
<li><strong>Secret Handling</strong> â€” <code>secrecy::Secret</code> zeroes memory on drop</li>
<li><strong>Sandboxed Execution</strong> â€” Commands never run on the host</li>
<li><strong>Origin Validation</strong> â€” Prevents Cross-Site WebSocket Hijacking</li>
<li><strong>No Unsafe Code</strong> â€” <code>unsafe</code> is denied workspace-wide</li>
</ul>
<h2 id="community"><a class="header" href="#community">Community</a></h2>
<ul>
<li><strong>GitHub</strong>: <a href="https://github.com/moltis-org/moltis">github.com/moltis-org/moltis</a></li>
<li><strong>Issues</strong>: <a href="https://github.com/moltis-org/moltis/issues">Report bugs</a></li>
<li><strong>Discussions</strong>: <a href="https://github.com/moltis-org/moltis/discussions">Ask questions</a></li>
</ul>
<h2 id="license"><a class="header" href="#license">License</a></h2>
<p>MIT â€” Free for personal and commercial use.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="quickstart"><a class="header" href="#quickstart">Quickstart</a></h1>
<p>Get Moltis running in under 5 minutes.</p>
<h2 id="1-install"><a class="header" href="#1-install">1. Install</a></h2>
<pre><code class="language-bash">curl -fsSL https://www.moltis.org/install.sh | sh
</code></pre>
<p>Or via Homebrew:</p>
<pre><code class="language-bash">brew install moltis-org/tap/moltis
</code></pre>
<h2 id="2-start"><a class="header" href="#2-start">2. Start</a></h2>
<pre><code class="language-bash">moltis
</code></pre>
<p>Youâ€™ll see output like:</p>
<pre><code>ğŸš€ Moltis gateway starting...
ğŸŒ Open http://localhost:13131 in your browser
</code></pre>
<h2 id="3-configure-a-provider"><a class="header" href="#3-configure-a-provider">3. Configure a Provider</a></h2>
<p>You need an LLM provider configured to chat. Current options are:</p>
<h3 id="option-a-openai-codex-oauth"><a class="header" href="#option-a-openai-codex-oauth">Option A: OpenAI Codex (OAuth)</a></h3>
<ol>
<li>In Moltis, go to <strong>Settings</strong> â†’ <strong>Providers</strong></li>
<li>Click <strong>OpenAI Codex</strong> â†’ <strong>Connect</strong></li>
<li>Complete the OAuth flow</li>
</ol>
<h3 id="option-b-github-copilot-oauth"><a class="header" href="#option-b-github-copilot-oauth">Option B: GitHub Copilot (OAuth)</a></h3>
<ol>
<li>In Moltis, go to <strong>Settings</strong> â†’ <strong>Providers</strong></li>
<li>Click <strong>GitHub Copilot</strong> â†’ <strong>Connect</strong></li>
<li>Complete the GitHub OAuth flow</li>
</ol>
<h3 id="option-c-local-llm-offline"><a class="header" href="#option-c-local-llm-offline">Option C: Local LLM (Offline)</a></h3>
<ol>
<li>In Moltis, go to <strong>Settings</strong> â†’ <strong>Providers</strong></li>
<li>Click <strong>Local LLM</strong></li>
<li>Choose a model and save</li>
</ol>
<p><em>More providers are coming soon.</em></p>
<h2 id="4-chat"><a class="header" href="#4-chat">4. Chat!</a></h2>
<p>Go to the <strong>Chat</strong> tab and start a conversation:</p>
<pre><code>You: Write a Python function to check if a number is prime

Agent: Here's a Python function to check if a number is prime:

def is_prime(n):
    if n &lt; 2:
        return False
    for i in range(2, int(n ** 0.5) + 1):
        if n % i == 0:
            return False
    return True
</code></pre>
<h2 id="whats-next"><a class="header" href="#whats-next">Whatâ€™s Next?</a></h2>
<h3 id="enable-tool-use"><a class="header" href="#enable-tool-use">Enable Tool Use</a></h3>
<p>Moltis can execute code, browse the web, and more. Tools are enabled by default with sandbox protection.</p>
<p>Try:</p>
<pre><code>You: Create a hello.py file that prints "Hello, World!" and run it
</code></pre>
<h3 id="connect-telegram"><a class="header" href="#connect-telegram">Connect Telegram</a></h3>
<p>Chat with your agent from anywhere:</p>
<ol>
<li>Create a bot via <a href="https://t.me/BotFather">@BotFather</a></li>
<li>Copy the bot token</li>
<li>In Moltis: <strong>Settings</strong> â†’ <strong>Telegram</strong> â†’ Enter token â†’ <strong>Save</strong></li>
<li>Message your bot!</li>
</ol>
<h3 id="add-mcp-servers"><a class="header" href="#add-mcp-servers">Add MCP Servers</a></h3>
<p>Extend capabilities with <a href="mcp.html">MCP servers</a>:</p>
<pre><code class="language-toml"># In moltis.toml
[[mcp.servers]]
name = "github"
command = "npx"
args = ["-y", "@modelcontextprotocol/server-github"]
env = { GITHUB_TOKEN = "ghp_..." }
</code></pre>
<h3 id="set-up-memory"><a class="header" href="#set-up-memory">Set Up Memory</a></h3>
<p>Enable long-term memory for context across sessions:</p>
<pre><code class="language-toml"># In moltis.toml
[memory]
enabled = true
</code></pre>
<p>Add knowledge by placing Markdown files in <code>~/.moltis/memory/</code>.</p>
<h2 id="useful-commands"><a class="header" href="#useful-commands">Useful Commands</a></h2>
<div class="table-wrapper"><table><thead><tr><th>Command</th><th>Description</th></tr></thead><tbody>
<tr><td><code>/new</code></td><td>Start a new session</td></tr>
<tr><td><code>/model &lt;name&gt;</code></td><td>Switch models</td></tr>
<tr><td><code>/clear</code></td><td>Clear chat history</td></tr>
<tr><td><code>/help</code></td><td>Show available commands</td></tr>
</tbody></table>
</div>
<h2 id="file-locations"><a class="header" href="#file-locations">File Locations</a></h2>
<div class="table-wrapper"><table><thead><tr><th>Path</th><th>Contents</th></tr></thead><tbody>
<tr><td><code>~/.config/moltis/moltis.toml</code></td><td>Configuration</td></tr>
<tr><td><code>~/.config/moltis/provider_keys.json</code></td><td>API keys</td></tr>
<tr><td><code>~/.moltis/</code></td><td>Data (sessions, memory, logs)</td></tr>
</tbody></table>
</div>
<h2 id="getting-help"><a class="header" href="#getting-help">Getting Help</a></h2>
<ul>
<li><strong>Documentation</strong>: <a href="https://docs.moltis.org">docs.moltis.org</a></li>
<li><strong>GitHub Issues</strong>: <a href="https://github.com/moltis-org/moltis/issues">github.com/moltis-org/moltis/issues</a></li>
<li><strong>Discussions</strong>: <a href="https://github.com/moltis-org/moltis/discussions">github.com/moltis-org/moltis/discussions</a></li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="installation"><a class="header" href="#installation">Installation</a></h1>
<p>Moltis is distributed as a single self-contained binary. Choose the installation method that works best for your setup.</p>
<h2 id="quick-install-recommended"><a class="header" href="#quick-install-recommended">Quick Install (Recommended)</a></h2>
<p>The fastest way to get started on macOS or Linux:</p>
<pre><code class="language-bash">curl -fsSL https://www.moltis.org/install.sh | sh
</code></pre>
<p>This downloads the latest release for your platform and installs it to <code>~/.local/bin</code>.</p>
<h2 id="package-managers"><a class="header" href="#package-managers">Package Managers</a></h2>
<h3 id="homebrew-macos--linux"><a class="header" href="#homebrew-macos--linux">Homebrew (macOS / Linux)</a></h3>
<pre><code class="language-bash">brew install moltis-org/tap/moltis
</code></pre>
<h2 id="linux-packages"><a class="header" href="#linux-packages">Linux Packages</a></h2>
<h3 id="debian--ubuntu-deb"><a class="header" href="#debian--ubuntu-deb">Debian / Ubuntu (.deb)</a></h3>
<pre><code class="language-bash"># Download the latest .deb package
curl -LO https://github.com/moltis-org/moltis/releases/latest/download/moltis_amd64.deb

# Install
sudo dpkg -i moltis_amd64.deb
</code></pre>
<h3 id="fedora--rhel-rpm"><a class="header" href="#fedora--rhel-rpm">Fedora / RHEL (.rpm)</a></h3>
<pre><code class="language-bash"># Download the latest .rpm package
curl -LO https://github.com/moltis-org/moltis/releases/latest/download/moltis.x86_64.rpm

# Install
sudo rpm -i moltis.x86_64.rpm
</code></pre>
<h3 id="arch-linux-pkgtarzst"><a class="header" href="#arch-linux-pkgtarzst">Arch Linux (.pkg.tar.zst)</a></h3>
<pre><code class="language-bash"># Download the latest package
curl -LO https://github.com/moltis-org/moltis/releases/latest/download/moltis.pkg.tar.zst

# Install
sudo pacman -U moltis.pkg.tar.zst
</code></pre>
<h3 id="snap"><a class="header" href="#snap">Snap</a></h3>
<pre><code class="language-bash">sudo snap install moltis
</code></pre>
<h3 id="appimage"><a class="header" href="#appimage">AppImage</a></h3>
<pre><code class="language-bash"># Download
curl -LO https://github.com/moltis-org/moltis/releases/latest/download/moltis.AppImage
chmod +x moltis.AppImage

# Run
./moltis.AppImage
</code></pre>
<h2 id="docker"><a class="header" href="#docker">Docker</a></h2>
<p>Multi-architecture images (amd64/arm64) are published to GitHub Container Registry:</p>
<pre><code class="language-bash">docker pull ghcr.io/moltis-org/moltis:latest
</code></pre>
<p>See <a href="docker.html">Docker Deployment</a> for full instructions on running Moltis in a container.</p>
<h2 id="build-from-source"><a class="header" href="#build-from-source">Build from Source</a></h2>
<h3 id="prerequisites"><a class="header" href="#prerequisites">Prerequisites</a></h3>
<ul>
<li>Rust 1.91 or later</li>
<li>A C compiler (for some dependencies)</li>
</ul>
<h3 id="clone-and-build"><a class="header" href="#clone-and-build">Clone and Build</a></h3>
<pre><code class="language-bash">git clone https://github.com/moltis-org/moltis.git
cd moltis
cargo build --release
</code></pre>
<p>The binary will be at <code>target/release/moltis</code>.</p>
<h3 id="install-via-cargo"><a class="header" href="#install-via-cargo">Install via Cargo</a></h3>
<pre><code class="language-bash">cargo install moltis --git https://github.com/moltis-org/moltis
</code></pre>
<h2 id="first-run"><a class="header" href="#first-run">First Run</a></h2>
<p>After installation, start Moltis:</p>
<pre><code class="language-bash">moltis
</code></pre>
<p>On first launch:</p>
<ol>
<li>Open <code>http://localhost:&lt;port&gt;</code> in your browser (the port is shown in the terminal output)</li>
<li>Configure your LLM provider (API key)</li>
<li>Start chatting!</li>
</ol>
<div id="admonition-tip" class="admonition admonish-tip" role="note" aria-labelledby="admonition-tip-title">
<div class="admonition-title">
<div id="admonition-tip-title">
<p>Tip</p>
</div>
<a class="admonition-anchor-link" href="installation.html#admonition-tip"></a>
</div>
<div>
<p>Moltis picks a random available port on first install to avoid conflicts. The port is saved in your config and reused on subsequent runs.</p>
</div>
</div>
<div id="admonition-note" class="admonition admonish-note" role="note" aria-labelledby="admonition-note-title">
<div class="admonition-title">
<div id="admonition-note-title">
<p>Note</p>
</div>
<a class="admonition-anchor-link" href="installation.html#admonition-note"></a>
</div>
<div>
<p>Authentication is only required when accessing Moltis from a non-localhost address (e.g., over the network). When this happens, a one-time setup code is printed to the terminal for initial authentication setup.</p>
</div>
</div>
<h2 id="verify-installation"><a class="header" href="#verify-installation">Verify Installation</a></h2>
<pre><code class="language-bash">moltis --version
</code></pre>
<h2 id="updating"><a class="header" href="#updating">Updating</a></h2>
<h3 id="homebrew"><a class="header" href="#homebrew">Homebrew</a></h3>
<pre><code class="language-bash">brew upgrade moltis
</code></pre>
<h3 id="from-source"><a class="header" href="#from-source">From Source</a></h3>
<pre><code class="language-bash">cd moltis
git pull
cargo build --release
</code></pre>
<h2 id="uninstalling"><a class="header" href="#uninstalling">Uninstalling</a></h2>
<h3 id="homebrew-1"><a class="header" href="#homebrew-1">Homebrew</a></h3>
<pre><code class="language-bash">brew uninstall moltis
</code></pre>
<h3 id="remove-data"><a class="header" href="#remove-data">Remove Data</a></h3>
<p>Moltis stores data in two directories:</p>
<pre><code class="language-bash"># Configuration
rm -rf ~/.config/moltis

# Data (sessions, databases, memory)
rm -rf ~/.moltis
</code></pre>
<div id="admonition-warning" class="admonition admonish-warning" role="note" aria-labelledby="admonition-warning-title">
<div class="admonition-title">
<div id="admonition-warning-title">
<p>Warning</p>
</div>
<a class="admonition-anchor-link" href="installation.html#admonition-warning"></a>
</div>
<div>
<p>Removing these directories deletes all your conversations, memory, and settings permanently.</p>
</div>
</div>
<div style="break-before: page; page-break-before: always;"></div><h1 id="configuration"><a class="header" href="#configuration">Configuration</a></h1>
<p>Moltis is configured through <code>moltis.toml</code>, located in <code>~/.config/moltis/</code> by default.</p>
<p>On first run, a complete configuration file is generated with sensible defaults. You can edit it to customize behavior.</p>
<h2 id="configuration-file-location"><a class="header" href="#configuration-file-location">Configuration File Location</a></h2>
<div class="table-wrapper"><table><thead><tr><th>Platform</th><th>Default Path</th></tr></thead><tbody>
<tr><td>macOS/Linux</td><td><code>~/.config/moltis/moltis.toml</code></td></tr>
<tr><td>Custom</td><td>Set via <code>--config-dir</code> or <code>MOLTIS_CONFIG_DIR</code></td></tr>
</tbody></table>
</div>
<h2 id="basic-settings"><a class="header" href="#basic-settings">Basic Settings</a></h2>
<pre><code class="language-toml">[gateway]
port = 13131                    # HTTP/WebSocket port
host = "0.0.0.0"               # Listen address

[agent]
name = "Moltis"                 # Agent display name
model = "gpt-5.2-codex"         # Default model
timeout = 600                   # Agent run timeout (seconds)
max_iterations = 25             # Max tool call iterations per run
</code></pre>
<h2 id="llm-providers"><a class="header" href="#llm-providers">LLM Providers</a></h2>
<p>Provider API keys are stored separately in <code>~/.config/moltis/provider_keys.json</code> for security. Configure them through the web UI or directly in the JSON file.</p>
<pre><code class="language-toml">[providers]
default = "openai-codex"        # Default provider

[providers.openai-codex]
enabled = true

[providers.github-copilot]
enabled = true

[providers.local]
enabled = true
model = "qwen2.5-coder-7b-q4_k_m"
</code></pre>
<p>See <a href="providers.html">Providers</a> for detailed provider configuration.</p>
<p><em>More providers are coming soon.</em></p>
<h2 id="sandbox-configuration"><a class="header" href="#sandbox-configuration">Sandbox Configuration</a></h2>
<p>Commands run inside isolated containers for security:</p>
<pre><code class="language-toml">[tools.exec.sandbox]
enabled = true
backend = "docker"              # "docker" or "apple" (macOS 15+)
base_image = "ubuntu:25.10"

# Packages installed in the sandbox image
packages = [
    "curl",
    "git",
    "jq",
    "python3",
    "python3-pip",
    "nodejs",
    "npm",
]
</code></pre>
<div id="admonition-info" class="admonition admonish-info" role="note" aria-labelledby="admonition-info-title">
<div class="admonition-title">
<div id="admonition-info-title">
<p>Info</p>
</div>
<a class="admonition-anchor-link" href="configuration.html#admonition-info"></a>
</div>
<div>
<p>When you modify the packages list and restart, Moltis automatically rebuilds the sandbox image with a new tag.</p>
</div>
</div>
<h2 id="memory-system"><a class="header" href="#memory-system">Memory System</a></h2>
<p>Long-term memory uses embeddings for semantic search:</p>
<pre><code class="language-toml">[memory]
enabled = true
embedding_model = "text-embedding-3-small"  # OpenAI embedding model
chunk_size = 512                # Characters per chunk
chunk_overlap = 50              # Overlap between chunks

# Directories to watch for memory files
watch_dirs = [
    "~/.moltis/memory",
]
</code></pre>
<h2 id="authentication"><a class="header" href="#authentication">Authentication</a></h2>
<p>Authentication is <strong>only required when accessing Moltis from a non-localhost address</strong>. When running on <code>localhost</code> or <code>127.0.0.1</code>, no authentication is needed by default.</p>
<p>When you access Moltis from a network address (e.g., <code>http://192.168.1.100:13131</code>), a one-time setup code is printed to the terminal. Use it to set up a password or passkey.</p>
<pre><code class="language-toml">[auth]
disabled = false                # Set true to disable auth entirely

# Session settings
session_expiry = 604800         # Session lifetime in seconds (7 days)
</code></pre>
<div id="admonition-warning" class="admonition admonish-warning" role="note" aria-labelledby="admonition-warning-title">
<div class="admonition-title">
<div id="admonition-warning-title">
<p>Warning</p>
</div>
<a class="admonition-anchor-link" href="configuration.html#admonition-warning"></a>
</div>
<div>
<p>Only set <code>disabled = true</code> if Moltis is running on a trusted private network. Never expose an unauthenticated instance to the internet.</p>
</div>
</div>
<h2 id="hooks"><a class="header" href="#hooks">Hooks</a></h2>
<p>Configure lifecycle hooks:</p>
<pre><code class="language-toml">[[hooks]]
name = "my-hook"
command = "./hooks/my-hook.sh"
events = ["BeforeToolCall", "AfterToolCall"]
timeout = 5                     # Timeout in seconds

[hooks.env]
MY_VAR = "value"               # Environment variables for the hook
</code></pre>
<p>See <a href="hooks.html">Hooks</a> for the full hook system documentation.</p>
<h2 id="mcp-servers"><a class="header" href="#mcp-servers">MCP Servers</a></h2>
<p>Connect to Model Context Protocol servers:</p>
<pre><code class="language-toml">[[mcp.servers]]
name = "filesystem"
command = "npx"
args = ["-y", "@modelcontextprotocol/server-filesystem", "/path/to/allowed"]

[[mcp.servers]]
name = "github"
command = "npx"
args = ["-y", "@modelcontextprotocol/server-github"]
env = { GITHUB_TOKEN = "ghp_..." }
</code></pre>
<h2 id="telegram-integration"><a class="header" href="#telegram-integration">Telegram Integration</a></h2>
<pre><code class="language-toml">[telegram]
enabled = true
# Token is stored in provider_keys.json, not here
allowed_users = [123456789]     # Telegram user IDs allowed to chat
</code></pre>
<h2 id="tls--https"><a class="header" href="#tls--https">TLS / HTTPS</a></h2>
<pre><code class="language-toml">[tls]
enabled = true
cert_path = "~/.config/moltis/cert.pem"
key_path = "~/.config/moltis/key.pem"
# If paths don't exist, a self-signed certificate is generated

# Port for the plain-HTTP redirect / CA-download server.
# Defaults to the gateway port + 1 when not set.
# http_redirect_port = 13132
</code></pre>
<p>Override via environment variable: <code>MOLTIS_TLS__HTTP_REDIRECT_PORT=8080</code>.</p>
<h2 id="tailscale-integration"><a class="header" href="#tailscale-integration">Tailscale Integration</a></h2>
<p>Expose Moltis over your Tailscale network:</p>
<pre><code class="language-toml">[tailscale]
enabled = true
mode = "serve"                  # "serve" (private) or "funnel" (public)
</code></pre>
<h2 id="observability"><a class="header" href="#observability">Observability</a></h2>
<pre><code class="language-toml">[telemetry]
enabled = true
otlp_endpoint = "http://localhost:4317"  # OpenTelemetry collector
</code></pre>
<h2 id="process-environment-variables-env"><a class="header" href="#process-environment-variables-env">Process Environment Variables (<code>[env]</code>)</a></h2>
<p>The <code>[env]</code> section injects variables into the Moltis process at startup.
This is useful in Docker deployments where passing individual <code>-e</code> flags is
inconvenient, or when you want API keys stored in the config file rather
than the host environment.</p>
<pre><code class="language-toml">[env]
BRAVE_API_KEY = "your-brave-key"
OPENROUTER_API_KEY = "sk-or-..."
ELEVENLABS_API_KEY = "..."
</code></pre>
<p><strong>Precedence</strong>: existing process environment variables are never overwritten.
If <code>BRAVE_API_KEY</code> is already set via <code>docker -e</code> or the host shell, the
<code>[env]</code> value is skipped. This means <code>docker -e</code> always wins.</p>
<div id="admonition-settings-ui-vs-env" class="admonition admonish-info" role="note" aria-labelledby="admonition-settings-ui-vs-env-title">
<div class="admonition-title">
<div id="admonition-settings-ui-vs-env-title">
<p>Settings UI vs [env]</p>
</div>
<a class="admonition-anchor-link" href="configuration.html#admonition-settings-ui-vs-env"></a>
</div>
<div>
<p>Environment variables configured through the Settings UI (Settings &gt;
Environment) are also injected into the Moltis process at startup.
Precedence: host/<code>docker -e</code> &gt; config <code>[env]</code> &gt; Settings UI.</p>
</div>
</div>
<h2 id="environment-variables"><a class="header" href="#environment-variables">Environment Variables</a></h2>
<p>All settings can be overridden via environment variables:</p>
<div class="table-wrapper"><table><thead><tr><th>Variable</th><th>Description</th></tr></thead><tbody>
<tr><td><code>MOLTIS_CONFIG_DIR</code></td><td>Configuration directory</td></tr>
<tr><td><code>MOLTIS_DATA_DIR</code></td><td>Data directory</td></tr>
<tr><td><code>MOLTIS_PORT</code></td><td>Gateway port</td></tr>
<tr><td><code>MOLTIS_HOST</code></td><td>Listen address</td></tr>
</tbody></table>
</div>
<h2 id="cli-flags"><a class="header" href="#cli-flags">CLI Flags</a></h2>
<pre><code class="language-bash">moltis --config-dir /path/to/config --data-dir /path/to/data
</code></pre>
<h2 id="complete-example"><a class="header" href="#complete-example">Complete Example</a></h2>
<pre><code class="language-toml">[gateway]
port = 13131
host = "0.0.0.0"

[agent]
name = "Atlas"
model = "gpt-5.2-codex"
timeout = 600
max_iterations = 25

[providers]
default = "openai-codex"

[tools.exec.sandbox]
enabled = true
backend = "docker"
base_image = "ubuntu:25.10"
packages = ["curl", "git", "jq", "python3", "nodejs"]

[memory]
enabled = true

[auth]
disabled = false

[[hooks]]
name = "audit-log"
command = "./hooks/audit.sh"
events = ["BeforeToolCall"]
timeout = 5
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="local-validation"><a class="header" href="#local-validation">Local Validation</a></h1>
<p>Moltis provides a local validation script that runs the same checks as CI
(format, lint, test, e2e) on your machine.</p>
<h2 id="why-this-exists"><a class="header" href="#why-this-exists">Why this exists</a></h2>
<ul>
<li>Faster feedback for Rust-heavy branches (no long runner queues for every push)</li>
<li>Better parity with a developerâ€™s local environment while iterating</li>
<li>Clear visibility in the PR UI (<code>fmt</code>, <code>biome</code>, <code>zizmor</code>, <code>clippy</code>, <code>test</code>, <code>e2e</code>)</li>
</ul>
<h2 id="run-local-validation"><a class="header" href="#run-local-validation">Run local validation</a></h2>
<p>Run all checks on your current checkout:</p>
<pre><code class="language-bash">./scripts/local-validate.sh
</code></pre>
<p>When working on a pull request, pass the PR number to also publish commit
statuses to GitHub:</p>
<pre><code class="language-bash">./scripts/local-validate.sh 63
</code></pre>
<p>The script runs these checks:</p>
<ul>
<li><code>local/fmt</code></li>
<li><code>local/biome</code></li>
<li><code>local/zizmor</code></li>
<li><code>local/lockfile</code> â€” verifies <code>Cargo.lock</code> is in sync (<code>cargo fetch --locked</code>)</li>
<li><code>local/lint</code></li>
<li><code>local/test</code></li>
<li><code>local/e2e</code> â€” runs gateway UI Playwright coverage</li>
</ul>
<p>In PR mode, the PR workflow verifies these contexts and surfaces them as
checks in the PR.</p>
<h2 id="notes"><a class="header" href="#notes">Notes</a></h2>
<ul>
<li>The script requires a clean working tree (no uncommitted or untracked
changes). Commit or stash local changes before running.</li>
<li>On macOS without CUDA (<code>nvcc</code>), the script automatically falls back to
non-CUDA test/coverage defaults for local runs.</li>
<li><code>local/lint</code> uses the same clippy flags as CI and release:
<code>cargo +nightly-2025-11-30 clippy -Z unstable-options --workspace --all-features --all-targets --timings -- -D warnings</code>.</li>
<li><code>zizmor</code> is installed automatically (Homebrew on macOS, apt on Linux) when
not already available.</li>
<li><code>zizmor</code> is advisory in local runs and does not block lint/test execution.</li>
<li>Test output is suppressed unless tests fail.</li>
<li><code>local/e2e</code> auto-runs <code>npm ci</code> only when <code>crates/gateway/ui/node_modules</code>
is missing, then runs <code>npm run e2e:install</code> and <code>npm run e2e</code>. Override with
<code>LOCAL_VALIDATE_E2E_CMD</code>.</li>
</ul>
<h2 id="merge-and-release-safety"><a class="header" href="#merge-and-release-safety">Merge and release safety</a></h2>
<p>This local-first flow is for pull requests. Full CI still runs on GitHub
runners for non-PR events (for example push to <code>main</code>, scheduled runs, and
release paths).</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="end-to-end-testing"><a class="header" href="#end-to-end-testing">End-to-End Testing</a></h1>
<p>This project uses Playwright to run browser-level tests against a real <code>moltis</code> gateway process.</p>
<p>The goal is simple: catch web UI regressions before they ship.</p>
<h2 id="why-this-approach"><a class="header" href="#why-this-approach">Why This Approach</a></h2>
<ul>
<li>Tests run in a real browser (Chromium), not a DOM mock.</li>
<li>Tests hit real gateway routes and WebSocket behavior.</li>
<li>Runtime state is isolated so local machine config does not leak into test outcomes.</li>
</ul>
<h2 id="current-setup"><a class="header" href="#current-setup">Current Setup</a></h2>
<p>The e2e harness lives in <code>crates/gateway/ui</code>:</p>
<ul>
<li><code>playwright.config.js</code> configures Playwright and web server startup.</li>
<li><code>e2e/start-gateway.sh</code> boots the gateway in deterministic test mode.</li>
<li><code>e2e/specs/smoke.spec.js</code> contains smoke coverage for critical routes.</li>
</ul>
<h2 id="how-startup-works"><a class="header" href="#how-startup-works">How Startup Works</a></h2>
<p><code>e2e/start-gateway.sh</code>:</p>
<ol>
<li>Creates isolated runtime directories under <code>target/e2e-runtime</code>.</li>
<li>Seeds <code>IDENTITY.md</code> and <code>USER.md</code> so onboarding does not block tests.</li>
<li>Exports <code>MOLTIS_CONFIG_DIR</code>, <code>MOLTIS_DATA_DIR</code>, and test port env.</li>
<li>Starts the gateway with:</li>
</ol>
<pre><code class="language-bash">cargo run --bin moltis -- --no-tls --bind 127.0.0.1 --port &lt;PORT&gt;
</code></pre>
<p><code>--no-tls</code> is intentional here so Playwright can probe <code>http://.../health</code> during readiness checks.</p>
<h2 id="running-e2e"><a class="header" href="#running-e2e">Running E2E</a></h2>
<p>From repo root (recommended):</p>
<pre><code class="language-bash">just ui-e2e-install
just ui-e2e
</code></pre>
<p>Headed mode:</p>
<pre><code class="language-bash">just ui-e2e-headed
</code></pre>
<p>Directly from <code>crates/gateway/ui</code>:</p>
<pre><code class="language-bash">npm install
npm run e2e:install
npm run e2e
</code></pre>
<h2 id="test-artifacts"><a class="header" href="#test-artifacts">Test Artifacts</a></h2>
<p>On failures, Playwright stores artifacts in:</p>
<ul>
<li><code>crates/gateway/ui/test-results/</code> (screenshots, video, traces)</li>
<li><code>crates/gateway/ui/playwright-report/</code> (HTML report)</li>
</ul>
<p>Open a trace with:</p>
<pre><code class="language-bash">cd crates/gateway/ui
npx playwright show-trace test-results/&lt;test-dir&gt;/trace.zip
</code></pre>
<h2 id="writing-stable-tests"><a class="header" href="#writing-stable-tests">Writing Stable Tests</a></h2>
<ul>
<li>Prefer stable IDs/selectors over broad text matching.</li>
<li>Assert route + core UI state, avoid over-asserting cosmetic details.</li>
<li>Keep smoke tests fast and deterministic.</li>
<li>Add focused scenario tests for high-risk features (chat send flow, settings persistence, skills, projects, crons).</li>
</ul>
<h2 id="ci-integration"><a class="header" href="#ci-integration">CI Integration</a></h2>
<p>The <code>just ui-e2e</code> target is the intended command for CI.</p>
<p>Pull requests use the local-validation flow: the E2E workflow waits for a
<code>local/e2e</code> commit status, published by <code>./scripts/local-validate.sh</code>.</p>
<p>Pushes to <code>main</code>, tags, and manual dispatch still run the hosted E2E job.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="llm-providers-1"><a class="header" href="#llm-providers-1">LLM Providers</a></h1>
<p>Moltis supports multiple LLM providers through a trait-based architecture.
Configure providers through the web UI or directly in configuration files.</p>
<h2 id="currently-available-providers"><a class="header" href="#currently-available-providers">Currently Available Providers*</a></h2>
<div class="table-wrapper"><table><thead><tr><th>Provider</th><th>Auth</th><th>Notes</th></tr></thead><tbody>
<tr><td><strong>OpenAI Codex</strong></td><td>OAuth</td><td>Codex-focused cloud models</td></tr>
<tr><td><strong>GitHub Copilot</strong></td><td>OAuth</td><td>Requires active Copilot subscription</td></tr>
<tr><td><strong>Local LLM</strong></td><td>Local runtime</td><td>Runs models on your machine</td></tr>
</tbody></table>
</div>
<p>*More providers are coming soon.</p>
<h2 id="configuration-1"><a class="header" href="#configuration-1">Configuration</a></h2>
<h3 id="via-web-ui-recommended"><a class="header" href="#via-web-ui-recommended">Via Web UI (Recommended)</a></h3>
<ol>
<li>Open Moltis in your browser.</li>
<li>Go to <strong>Settings</strong> -&gt; <strong>Providers</strong>.</li>
<li>Choose a provider card.</li>
<li>Complete OAuth or enter your API key.</li>
<li>Select your preferred model.</li>
</ol>
<h3 id="via-configuration-files"><a class="header" href="#via-configuration-files">Via Configuration Files</a></h3>
<p>Provider credentials are stored in <code>~/.config/moltis/provider_keys.json</code>:</p>
<pre><code class="language-json">{
  "openai-codex": {
    "model": "gpt-5.2-codex"
  }
}
</code></pre>
<p>Enable providers in <code>moltis.toml</code>:</p>
<pre><code class="language-toml">[providers]
default = "openai-codex"

[providers.openai-codex]
enabled = true

[providers.github-copilot]
enabled = true

[providers.local]
enabled = true
model = "qwen2.5-coder-7b-q4_k_m"
</code></pre>
<h2 id="provider-setup"><a class="header" href="#provider-setup">Provider Setup</a></h2>
<h3 id="openai-codex"><a class="header" href="#openai-codex">OpenAI Codex</a></h3>
<p>OpenAI Codex uses OAuth token import and OAuth-based access.</p>
<ol>
<li>Go to <strong>Settings</strong> -&gt; <strong>Providers</strong> -&gt; <strong>OpenAI Codex</strong>.</li>
<li>Click <strong>Connect</strong> and complete the auth flow.</li>
<li>Choose a Codex model.</li>
</ol>
<h3 id="github-copilot"><a class="header" href="#github-copilot">GitHub Copilot</a></h3>
<p>GitHub Copilot uses OAuth authentication.</p>
<ol>
<li>Go to <strong>Settings</strong> -&gt; <strong>Providers</strong> -&gt; <strong>GitHub Copilot</strong>.</li>
<li>Click <strong>Connect</strong>.</li>
<li>Complete the GitHub OAuth flow.</li>
</ol>
<div id="admonition-info" class="admonition admonish-info" role="note" aria-labelledby="admonition-info-title">
<div class="admonition-title">
<div id="admonition-info-title">
<p>Info</p>
</div>
<a class="admonition-anchor-link" href="providers.html#admonition-info"></a>
</div>
<div>
<p>Requires an active GitHub Copilot subscription.</p>
</div>
</div>
<h3 id="local-llm"><a class="header" href="#local-llm">Local LLM</a></h3>
<p>Local LLM runs models directly on your machine.</p>
<ol>
<li>Go to <strong>Settings</strong> -&gt; <strong>Providers</strong> -&gt; <strong>Local LLM</strong>.</li>
<li>Choose a model from the local registry or download one.</li>
<li>Save and select it as your active model.</li>
</ol>
<h2 id="switching-models"><a class="header" href="#switching-models">Switching Models</a></h2>
<ul>
<li><strong>Per session</strong>: Use the model selector in the chat UI.</li>
<li><strong>Per message</strong>: Use <code>/model &lt;name&gt;</code> in chat.</li>
<li><strong>Global default</strong>: Set <code>[providers].default</code> and <code>[agent].model</code> in <code>moltis.toml</code>.</li>
</ul>
<h2 id="troubleshooting"><a class="header" href="#troubleshooting">Troubleshooting</a></h2>
<h3 id="model-not-available"><a class="header" href="#model-not-available">â€œModel not availableâ€</a></h3>
<ul>
<li>Check provider auth is still valid.</li>
<li>Check model ID spelling.</li>
<li>Check account access for that model.</li>
</ul>
<h3 id="rate-limited"><a class="header" href="#rate-limited">â€œRate limitedâ€</a></h3>
<ul>
<li>Retry after a short delay.</li>
<li>Switch provider/model.</li>
<li>Upgrade provider quota if needed.</li>
</ul>
<h3 id="invalid-api-key"><a class="header" href="#invalid-api-key">â€œInvalid API keyâ€</a></h3>
<ul>
<li>Verify the key has no extra spaces.</li>
<li>Verify it is active and has required permissions.</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="mcp-servers-1"><a class="header" href="#mcp-servers-1">MCP Servers</a></h1>
<p>Moltis supports the <a href="https://modelcontextprotocol.io">Model Context Protocol (MCP)</a> for connecting to external tool servers. MCP servers extend your agentâ€™s capabilities without modifying Moltis itself.</p>
<h2 id="what-is-mcp"><a class="header" href="#what-is-mcp">What is MCP?</a></h2>
<p>MCP is an open protocol that lets AI assistants connect to external tools and data sources. Think of MCP servers as plugins that provide:</p>
<ul>
<li><strong>Tools</strong> â€” Functions the agent can call (e.g., search, file operations, API calls)</li>
<li><strong>Resources</strong> â€” Data the agent can read (e.g., files, database records)</li>
<li><strong>Prompts</strong> â€” Pre-defined prompt templates</li>
</ul>
<h2 id="supported-transports"><a class="header" href="#supported-transports">Supported Transports</a></h2>
<div class="table-wrapper"><table><thead><tr><th>Transport</th><th>Description</th><th>Use Case</th></tr></thead><tbody>
<tr><td><strong>stdio</strong></td><td>Local process via stdin/stdout</td><td>npm packages, local scripts</td></tr>
<tr><td><strong>Streamable HTTP</strong></td><td>Remote server via HTTP</td><td>Cloud services, shared servers</td></tr>
</tbody></table>
</div>
<h2 id="adding-an-mcp-server"><a class="header" href="#adding-an-mcp-server">Adding an MCP Server</a></h2>
<h3 id="via-web-ui"><a class="header" href="#via-web-ui">Via Web UI</a></h3>
<ol>
<li>Go to <strong>Settings</strong> â†’ <strong>MCP Servers</strong></li>
<li>Click <strong>Add Server</strong></li>
<li>Enter the server configuration</li>
<li>Click <strong>Save</strong></li>
</ol>
<h3 id="via-configuration"><a class="header" href="#via-configuration">Via Configuration</a></h3>
<p>Add servers to <code>moltis.toml</code>:</p>
<pre><code class="language-toml">[mcp.servers.filesystem]
command = "npx"
args = ["-y", "@modelcontextprotocol/server-filesystem", "/Users/me/projects"]

[mcp.servers.github]
command = "npx"
args = ["-y", "@modelcontextprotocol/server-github"]
env = { GITHUB_TOKEN = "ghp_..." }

[mcp.servers.remote_api]
url = "https://mcp.example.com/mcp"
transport = "sse"
</code></pre>
<h2 id="popular-mcp-servers"><a class="header" href="#popular-mcp-servers">Popular MCP Servers</a></h2>
<h3 id="official-servers"><a class="header" href="#official-servers">Official Servers</a></h3>
<div class="table-wrapper"><table><thead><tr><th>Server</th><th>Description</th><th>Install</th></tr></thead><tbody>
<tr><td><strong>filesystem</strong></td><td>Read/write local files</td><td><code>npx @modelcontextprotocol/server-filesystem</code></td></tr>
<tr><td><strong>github</strong></td><td>GitHub API access</td><td><code>npx @modelcontextprotocol/server-github</code></td></tr>
<tr><td><strong>postgres</strong></td><td>PostgreSQL queries</td><td><code>npx @modelcontextprotocol/server-postgres</code></td></tr>
<tr><td><strong>sqlite</strong></td><td>SQLite database</td><td><code>npx @modelcontextprotocol/server-sqlite</code></td></tr>
<tr><td><strong>puppeteer</strong></td><td>Browser automation</td><td><code>npx @modelcontextprotocol/server-puppeteer</code></td></tr>
<tr><td><strong>brave-search</strong></td><td>Web search</td><td><code>npx @modelcontextprotocol/server-brave-search</code></td></tr>
</tbody></table>
</div>
<h3 id="community-servers"><a class="header" href="#community-servers">Community Servers</a></h3>
<p>Explore more at <a href="https://mcp.so">mcp.so</a> and <a href="https://github.com/modelcontextprotocol/servers">GitHub MCP Servers</a>.</p>
<h2 id="configuration-options"><a class="header" href="#configuration-options">Configuration Options</a></h2>
<pre><code class="language-toml">[mcp.servers.my_server]
command = "node"                # Required for stdio transport
args = ["server.js"]            # Optional arguments

# Optional environment variables
env = { API_KEY = "secret", DEBUG = "true" }

# Optional: remote transport
transport = "sse"               # "stdio" (default) or "sse"
url = "https://mcp.example.com/mcp"  # Required when transport = "sse"
</code></pre>
<h2 id="server-lifecycle"><a class="header" href="#server-lifecycle">Server Lifecycle</a></h2>
<pre><code>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   MCP Server                         â”‚
â”‚                                                      â”‚
â”‚  Start â†’ Initialize â†’ Ready â†’ [Tool Calls] â†’ Stop   â”‚
â”‚            â”‚                       â”‚                 â”‚
â”‚            â–¼                       â–¼                 â”‚
â”‚     Health Check â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Heartbeat             â”‚
â”‚            â”‚                       â”‚                 â”‚
â”‚            â–¼                       â–¼                 â”‚
â”‚    Crash Detected â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º Restart              â”‚
â”‚                                    â”‚                 â”‚
â”‚                              Backoff Wait            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
</code></pre>
<h3 id="health-monitoring"><a class="header" href="#health-monitoring">Health Monitoring</a></h3>
<p>Moltis monitors MCP servers and automatically:</p>
<ul>
<li>Detects crashes via process exit</li>
<li>Restarts with exponential backoff</li>
<li>Disables after max restart attempts</li>
<li>Re-enables after cooldown period</li>
</ul>
<h2 id="using-mcp-tools"><a class="header" href="#using-mcp-tools">Using MCP Tools</a></h2>
<p>Once connected, MCP tools appear alongside built-in tools. The agent can use them naturally:</p>
<pre><code>User: Search GitHub for Rust async runtime projects

Agent: I'll search GitHub for you.
[Calling github.search_repositories with query="rust async runtime"]

Found 15 repositories:
1. tokio-rs/tokio - A runtime for writing reliable async applications
2. async-std/async-std - Async version of the Rust standard library
...
</code></pre>
<h2 id="creating-an-mcp-server"><a class="header" href="#creating-an-mcp-server">Creating an MCP Server</a></h2>
<h3 id="simple-nodejs-server"><a class="header" href="#simple-nodejs-server">Simple Node.js Server</a></h3>
<pre><code class="language-javascript">// server.js
import { Server } from "@modelcontextprotocol/sdk/server/index.js";
import { StdioServerTransport } from "@modelcontextprotocol/sdk/server/stdio.js";

const server = new Server(
  { name: "my-server", version: "1.0.0" },
  { capabilities: { tools: {} } }
);

server.setRequestHandler("tools/list", async () =&gt; ({
  tools: [{
    name: "hello",
    description: "Says hello",
    inputSchema: {
      type: "object",
      properties: {
        name: { type: "string", description: "Name to greet" }
      },
      required: ["name"]
    }
  }]
}));

server.setRequestHandler("tools/call", async (request) =&gt; {
  if (request.params.name === "hello") {
    const name = request.params.arguments.name;
    return { content: [{ type: "text", text: `Hello, ${name}!` }] };
  }
});

const transport = new StdioServerTransport();
await server.connect(transport);
</code></pre>
<h3 id="configure-in-moltis"><a class="header" href="#configure-in-moltis">Configure in Moltis</a></h3>
<pre><code class="language-toml">[mcp.servers.my_server]
command = "node"
args = ["server.js"]
</code></pre>
<h2 id="debugging"><a class="header" href="#debugging">Debugging</a></h2>
<h3 id="check-server-status"><a class="header" href="#check-server-status">Check Server Status</a></h3>
<p>In the web UI, go to <strong>Settings</strong> â†’ <strong>MCP Servers</strong> to see:</p>
<ul>
<li>Connection status (connected/disconnected/error)</li>
<li>Available tools</li>
<li>Recent errors</li>
</ul>
<h3 id="view-logs"><a class="header" href="#view-logs">View Logs</a></h3>
<p>MCP server stderr is captured in Moltis logs:</p>
<pre><code class="language-bash"># View gateway logs
tail -f ~/.moltis/logs.jsonl | grep -i mcp
</code></pre>
<h3 id="test-locally"><a class="header" href="#test-locally">Test Locally</a></h3>
<p>Run the server directly to debug:</p>
<pre><code class="language-bash">echo '{"jsonrpc":"2.0","method":"tools/list","id":1}' | node server.js
</code></pre>
<h2 id="oauth-authentication"><a class="header" href="#oauth-authentication">OAuth Authentication</a></h2>
<p>Remote MCP servers can require OAuth 2.1 authentication. Moltis handles this automatically â€” when a server returns <code>401 Unauthorized</code>, the OAuth flow starts without any manual configuration.</p>
<h3 id="how-it-works-1"><a class="header" href="#how-it-works-1">How It Works</a></h3>
<ol>
<li>Moltis connects to the remote MCP server</li>
<li>The server returns <code>401 Unauthorized</code> with a <code>WWW-Authenticate</code> header</li>
<li>Moltis discovers the authorization server via <a href="https://www.rfc-editor.org/rfc/rfc9728">RFC 9728</a> (Protected Resource Metadata)</li>
<li>Moltis performs <a href="https://www.rfc-editor.org/rfc/rfc7591">dynamic client registration</a> (RFC 7591)</li>
<li>A PKCE authorization code flow opens your browser for login</li>
<li>After login, tokens are stored and used for all subsequent requests</li>
</ol>
<p>Client registrations and tokens are cached locally, so you only need to log in once per server.</p>
<h3 id="manual-oauth-configuration"><a class="header" href="#manual-oauth-configuration">Manual OAuth Configuration</a></h3>
<p>If a server doesnâ€™t support standard OAuth discovery, you can configure credentials manually:</p>
<pre><code class="language-toml">[mcp.servers.private_api]
url = "https://mcp.example.com/mcp"
transport = "sse"

[mcp.servers.private_api.oauth]
client_id = "your-client-id"
auth_url = "https://auth.example.com/authorize"
token_url = "https://auth.example.com/token"
scopes = ["mcp:read", "mcp:write"]
</code></pre>
<h3 id="re-authentication"><a class="header" href="#re-authentication">Re-authentication</a></h3>
<p>If your session expires or tokens are revoked, Moltis automatically re-authenticates on the next <code>401</code> response. You can also trigger re-authentication manually via the <code>mcp.reauth</code> RPC method.</p>
<h2 id="security-considerations"><a class="header" href="#security-considerations">Security Considerations</a></h2>
<div id="admonition-warning" class="admonition admonish-warning" role="note" aria-labelledby="admonition-warning-title">
<div class="admonition-title">
<div id="admonition-warning-title">
<p>Warning</p>
</div>
<a class="admonition-anchor-link" href="mcp.html#admonition-warning"></a>
</div>
<div>
<p>MCP servers run with the same permissions as Moltis. Only use servers from trusted sources.</p>
</div>
</div>
<ul>
<li><strong>Review server code</strong> before running</li>
<li><strong>Limit file access</strong> â€” use specific paths, not <code>/</code></li>
<li><strong>Use environment variables</strong> for secrets</li>
<li><strong>Network isolation</strong> â€” run untrusted servers in containers</li>
</ul>
<h2 id="troubleshooting-1"><a class="header" href="#troubleshooting-1">Troubleshooting</a></h2>
<h3 id="server-wont-start"><a class="header" href="#server-wont-start">Server wonâ€™t start</a></h3>
<ul>
<li>Check the command exists: <code>which npx</code></li>
<li>Verify the package: <code>npx @modelcontextprotocol/server-filesystem --help</code></li>
<li>Check for port conflicts</li>
</ul>
<h3 id="tools-not-appearing"><a class="header" href="#tools-not-appearing">Tools not appearing</a></h3>
<ul>
<li>Server may still be initializing (wait a few seconds)</li>
<li>Check server logs for errors</li>
<li>Verify the server implements <code>tools/list</code></li>
</ul>
<h3 id="server-keeps-restarting"><a class="header" href="#server-keeps-restarting">Server keeps restarting</a></h3>
<ul>
<li>Check stderr for crash messages</li>
<li>Increase <code>max_restart_attempts</code> for debugging</li>
<li>Verify environment variables are set correctly</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="memory-system-1"><a class="header" href="#memory-system-1">Memory System</a></h1>
<p>Moltis provides a powerful memory system that enables the agent to recall past conversations, notes, and context across sessions. This document explains the available backends, features, and configuration options.</p>
<h2 id="backends"><a class="header" href="#backends">Backends</a></h2>
<p>Moltis supports two memory backends:</p>
<div class="table-wrapper"><table><thead><tr><th>Feature</th><th>Built-in</th><th>QMD</th></tr></thead><tbody>
<tr><td><strong>Search Type</strong></td><td>Hybrid (vector + FTS5 keyword)</td><td>Hybrid (BM25 + vector + LLM reranking)</td></tr>
<tr><td><strong>Local Embeddings</strong></td><td>GGUF models via llama-cpp-2</td><td>GGUF models</td></tr>
<tr><td><strong>Remote Embeddings</strong></td><td>OpenAI, Ollama, custom endpoints</td><td>Built-in</td></tr>
<tr><td><strong>Embedding Cache</strong></td><td>SQLite with LRU eviction</td><td>Built-in</td></tr>
<tr><td><strong>Batch API</strong></td><td>OpenAI batch (50% cost saving)</td><td>No</td></tr>
<tr><td><strong>Circuit Breaker</strong></td><td>Fallback chain with auto-recovery</td><td>No</td></tr>
<tr><td><strong>LLM Reranking</strong></td><td>Optional (configurable)</td><td>Built-in with <code>query</code> command</td></tr>
<tr><td><strong>File Watching</strong></td><td>Real-time sync via notify</td><td>Built-in</td></tr>
<tr><td><strong>External Dependency</strong></td><td>None (pure Rust)</td><td>Requires QMD binary (Node.js/Bun)</td></tr>
<tr><td><strong>Offline Support</strong></td><td>Yes (with local embeddings)</td><td>Yes</td></tr>
</tbody></table>
</div>
<h3 id="built-in-backend"><a class="header" href="#built-in-backend">Built-in Backend</a></h3>
<p>The default backend uses SQLite for storage with FTS5 for keyword search and optional vector embeddings for semantic search. Key advantages:</p>
<ul>
<li><strong>Zero external dependencies</strong>: Everything is embedded in the moltis binary</li>
<li><strong>Fallback chain</strong>: Automatically switches between embedding providers if one fails</li>
<li><strong>Batch embedding</strong>: Reduces OpenAI API costs by 50% for large sync operations</li>
<li><strong>Embedding cache</strong>: Avoids re-embedding unchanged content</li>
</ul>
<h3 id="qmd-backend"><a class="header" href="#qmd-backend">QMD Backend</a></h3>
<p>QMD is an optional external sidecar that provides enhanced search capabilities:</p>
<ul>
<li><strong>BM25 keyword search</strong>: Fast, instant results (similar to Elasticsearch)</li>
<li><strong>Vector search</strong>: Semantic similarity using local GGUF models</li>
<li><strong>Hybrid search with LLM reranking</strong>: Combines both methods with an LLM pass for optimal relevance</li>
</ul>
<p>To use QMD:</p>
<ol>
<li>Install QMD separately from <a href="https://github.com/tobi/qmd">github.com/tobi/qmd</a></li>
<li>Enable it in Settings &gt; Memory &gt; Backend</li>
</ol>
<h2 id="features-1"><a class="header" href="#features-1">Features</a></h2>
<h3 id="citations"><a class="header" href="#citations">Citations</a></h3>
<p>Citations append source file and line number information to search results:</p>
<pre><code>Some important content from your notes.

Source: memory/notes.md#42
</code></pre>
<p><strong>Configuration options:</strong></p>
<ul>
<li><code>auto</code> (default): Include citations when results come from multiple files</li>
<li><code>on</code>: Always include citations</li>
<li><code>off</code>: Never include citations</li>
</ul>
<h3 id="session-export"><a class="header" href="#session-export">Session Export</a></h3>
<p>When enabled, session transcripts are automatically exported to the memory system for cross-run recall. This allows the agent to remember past conversations even after restarts.</p>
<p>Exported sessions are:</p>
<ul>
<li>Stored in <code>memory/sessions/</code> as markdown files</li>
<li>Sanitized to remove sensitive tool results and system messages</li>
<li>Automatically cleaned up based on age/count limits</li>
</ul>
<h3 id="llm-reranking"><a class="header" href="#llm-reranking">LLM Reranking</a></h3>
<p>LLM reranking uses the configured language model to re-score and reorder search results based on semantic relevance to the query. This provides better results than keyword or vector matching alone, at the cost of additional latency.</p>
<p><strong>How it works:</strong></p>
<ol>
<li>Initial search returns candidate results</li>
<li>LLM evaluates each resultâ€™s relevance (0.0-1.0 score)</li>
<li>Results are reordered by combined score (70% LLM, 30% original)</li>
</ol>
<h2 id="configuration-2"><a class="header" href="#configuration-2">Configuration</a></h2>
<p>Memory settings can be configured in <code>moltis.toml</code>:</p>
<pre><code class="language-toml">[memory]
# Backend: "builtin" (default) or "qmd"
backend = "builtin"

# Embedding provider: "local", "ollama", "openai", "custom", or auto-detect
provider = "local"

# Disable RAG embeddings and force keyword-only search
disable_rag = false

# Embedding API base URL (host, /v1, or full /embeddings endpoint)
base_url = "http://localhost:11434/v1"

# Citation mode: "on", "off", or "auto"
citations = "auto"

# Enable LLM reranking for hybrid search
llm_reranking = false

# Export sessions to memory for cross-run recall
session_export = true

# QMD-specific settings (only used when backend = "qmd")
[memory.qmd]
command = "qmd"
max_results = 10
timeout_ms = 30000
</code></pre>
<p>Or via the web UI: <strong>Settings &gt; Memory</strong></p>
<h2 id="embedding-providers"><a class="header" href="#embedding-providers">Embedding Providers</a></h2>
<p>The built-in backend supports multiple embedding providers:</p>
<div class="table-wrapper"><table><thead><tr><th>Provider</th><th>Model</th><th>Dimensions</th><th>Notes</th></tr></thead><tbody>
<tr><td>Local (GGUF)</td><td>EmbeddingGemma-300M</td><td>768</td><td>Offline, ~300MB download</td></tr>
<tr><td>Ollama</td><td>nomic-embed-text</td><td>768</td><td>Requires Ollama running</td></tr>
<tr><td>OpenAI</td><td>text-embedding-3-small</td><td>1536</td><td>Requires API key</td></tr>
<tr><td>Custom</td><td>Configurable</td><td>Varies</td><td>OpenAI-compatible endpoint</td></tr>
</tbody></table>
</div>
<p>The system auto-detects available providers and creates a fallback chain:</p>
<ol>
<li>Try configured provider first</li>
<li>Fall back to other available providers if it fails</li>
<li>Use keyword-only search if no embedding provider is available</li>
</ol>
<h2 id="memory-directories"><a class="header" href="#memory-directories">Memory Directories</a></h2>
<p>By default, moltis indexes markdown files from:</p>
<ul>
<li><code>~/.moltis/MEMORY.md</code> - Main long-term memory file</li>
<li><code>~/.moltis/memory/*.md</code> - Additional memory files</li>
<li><code>~/.moltis/memory/sessions/*.md</code> - Exported session transcripts</li>
</ul>
<h2 id="tools"><a class="header" href="#tools">Tools</a></h2>
<p>The memory system exposes three agent tools:</p>
<h3 id="memory_search"><a class="header" href="#memory_search">memory_search</a></h3>
<p>Search memory with a natural language query. Returns relevant chunks ranked
by hybrid (vector + keyword) similarity.</p>
<pre><code class="language-json">{
  "query": "what did we discuss about the API design?",
  "limit": 5
}
</code></pre>
<h3 id="memory_get"><a class="header" href="#memory_get">memory_get</a></h3>
<p>Retrieve a specific memory chunk by ID. Useful for reading the full text of a
result found via <code>memory_search</code>.</p>
<pre><code class="language-json">{
  "chunk_id": "memory/notes.md:42"
}
</code></pre>
<h3 id="memory_save"><a class="header" href="#memory_save">memory_save</a></h3>
<p>Save content to long-term memory files. The agent uses this tool when you ask
it to remember something (â€œremember that I prefer dark modeâ€) or when it
decides certain information is worth persisting.</p>
<pre><code class="language-json">{
  "content": "User prefers dark mode and Vim keybindings.",
  "file": "MEMORY.md",
  "append": true
}
</code></pre>
<p><strong>Parameters:</strong></p>
<div class="table-wrapper"><table><thead><tr><th>Parameter</th><th>Type</th><th>Default</th><th>Description</th></tr></thead><tbody>
<tr><td><code>content</code></td><td>string</td><td><em>(required)</em></td><td>The content to save</td></tr>
<tr><td><code>file</code></td><td>string</td><td><code>MEMORY.md</code></td><td>Target file: <code>MEMORY.md</code>, <code>memory.md</code>, or <code>memory/&lt;name&gt;.md</code></td></tr>
<tr><td><code>append</code></td><td>boolean</td><td><code>true</code></td><td>Append to existing file (<code>true</code>) or overwrite (<code>false</code>)</td></tr>
</tbody></table>
</div>
<p><strong>Path validation:</strong> The tool enforces a strict allowlist of write targets
to prevent path traversal attacks. Only these patterns are accepted:</p>
<ul>
<li><code>MEMORY.md</code> or <code>memory.md</code> (root memory files)</li>
<li><code>memory/&lt;name&gt;.md</code> (files in the memory subdirectory, one level deep)</li>
</ul>
<p>Absolute paths, <code>..</code> traversal, non-<code>.md</code> extensions, spaces in filenames,
and nested subdirectories (<code>memory/a/b.md</code>) are all rejected. Content is
limited to 50 KB per write.</p>
<p><strong>Auto-reindex:</strong> After writing, the memory system automatically re-indexes
the affected file so the new content is immediately searchable via
<code>memory_search</code>.</p>
<h2 id="silent-memory-turn-pre-compaction-flush"><a class="header" href="#silent-memory-turn-pre-compaction-flush">Silent Memory Turn (Pre-Compaction Flush)</a></h2>
<p>Before compacting a session (summarizing old messages to free context window
space), Moltis runs a <strong>silent agentic turn</strong> that reviews the conversation
and saves important information to memory files. This ensures durable memories
survive compaction.</p>
<p><strong>How it works:</strong></p>
<ol>
<li>When a session approaches the modelâ€™s context window limit, the gateway
triggers compaction</li>
<li>Before summarizing, a hidden LLM turn runs with a special system prompt
asking the agent to save noteworthy information</li>
<li>The agent writes to <code>MEMORY.md</code> and/or <code>memory/YYYY-MM-DD.md</code> using an
internal <code>write_file</code> tool backed by the same <code>MemoryWriter</code> as
<code>memory_save</code></li>
<li>The LLMâ€™s response text is discarded (the user sees nothing)</li>
<li>Written files are automatically re-indexed for future search</li>
</ol>
<p><strong>What gets saved:</strong></p>
<ul>
<li>User preferences and working style</li>
<li>Key decisions and their reasoning</li>
<li>Project context, architecture choices, and conventions</li>
<li>Important facts, names, dates, and relationships</li>
<li>Technical setup details (tools, languages, frameworks)</li>
</ul>
<p>This is the same approach used by OpenClaw. See the
<a href="memory-comparison.html">comparison page</a> for a detailed analysis of both
systems.</p>
<h2 id="architecture-1"><a class="header" href="#architecture-1">Architecture</a></h2>
<pre><code>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                       Memory Manager                             â”‚
â”‚               (implements MemoryWriter trait)                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                         Read Path                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚  â”‚   Chunker   â”‚  â”‚   Search    â”‚  â”‚  Session Export     â”‚      â”‚
â”‚  â”‚ (markdown)  â”‚  â”‚  (hybrid)   â”‚  â”‚  (transcripts)      â”‚      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                        Write Path                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  memory_save    â”‚  â”‚  Silent Turn     â”‚  â”‚  Path          â”‚  â”‚
â”‚  â”‚  (agent tool)   â”‚  â”‚  (pre-compact)   â”‚  â”‚  Validation    â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                      Storage Backend                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
â”‚  â”‚   Built-in (SQLite)    â”‚  â”‚   QMD (sidecar)        â”‚         â”‚
â”‚  â”‚  - FTS5 keyword        â”‚  â”‚  - BM25 keyword        â”‚         â”‚
â”‚  â”‚  - Vector similarity   â”‚  â”‚  - Vector similarity   â”‚         â”‚
â”‚  â”‚  - Embedding cache     â”‚  â”‚  - LLM reranking       â”‚         â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                    Embedding Providers                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚  â”‚  Local  â”‚  â”‚ Ollama  â”‚  â”‚ OpenAI  â”‚  â”‚ Batch/Fallbackâ”‚      â”‚
â”‚  â”‚  (GGUF) â”‚  â”‚         â”‚  â”‚         â”‚  â”‚               â”‚      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
</code></pre>
<h2 id="troubleshooting-2"><a class="header" href="#troubleshooting-2">Troubleshooting</a></h2>
<h3 id="memory-not-working"><a class="header" href="#memory-not-working">Memory not working</a></h3>
<ol>
<li>Check status in Settings &gt; Memory</li>
<li>Ensure at least one embedding provider is available:
<ul>
<li>Local: Requires <code>local-embeddings</code> feature enabled at build</li>
<li>Ollama: Must be running at <code>localhost:11434</code></li>
<li>OpenAI: Requires <code>OPENAI_API_KEY</code> environment variable</li>
</ul>
</li>
</ol>
<h3 id="search-returns-no-results"><a class="header" href="#search-returns-no-results">Search returns no results</a></h3>
<ol>
<li>Check that memory files exist in the expected directories</li>
<li>Trigger a manual sync by restarting moltis</li>
<li>Check logs for sync errors</li>
</ol>
<h3 id="qmd-not-available"><a class="header" href="#qmd-not-available">QMD not available</a></h3>
<ol>
<li>Verify QMD is installed: <code>qmd --version</code></li>
<li>Check that the path is correct in settings</li>
<li>Ensure QMD has indexed your collections: <code>qmd stats</code></li>
</ol>
<div style="break-before: page; page-break-before: always;"></div><h1 id="memory-moltis-vs-openclaw"><a class="header" href="#memory-moltis-vs-openclaw">Memory: Moltis vs OpenClaw</a></h1>
<p>This page provides a detailed comparison of the memory systems in Moltis and
<a href="https://github.com/openclaw/openclaw">OpenClaw</a>. Both projects share the
same core architecture for long-term memory, but differ in implementation
details, tool surface, and configuration.</p>
<h2 id="overview"><a class="header" href="#overview">Overview</a></h2>
<p>Both systems follow the same fundamental approach: <strong>plain Markdown files are
the source of truth</strong> for agent memory, indexed for semantic search using
hybrid vector + keyword retrieval. The agent reads from memory via search
tools and writes to memory via file-writing tools (either dedicated or
general-purpose).</p>
<h2 id="feature-comparison"><a class="header" href="#feature-comparison">Feature Comparison</a></h2>
<h3 id="storage-and-indexing"><a class="header" href="#storage-and-indexing">Storage and Indexing</a></h3>
<div class="table-wrapper"><table><thead><tr><th>Feature</th><th>Moltis</th><th>OpenClaw</th></tr></thead><tbody>
<tr><td><strong>Storage format</strong></td><td>Markdown files on disk</td><td>Markdown files on disk</td></tr>
<tr><td><strong>Index storage</strong></td><td>SQLite (per data dir)</td><td>SQLite (per agent)</td></tr>
<tr><td><strong>Default backend</strong></td><td>Built-in (SQLite + FTS5 + vector)</td><td>Built-in (SQLite + BM25 + vector)</td></tr>
<tr><td><strong>Alternative backend</strong></td><td>QMD (sidecar, BM25 + vector + reranking)</td><td>QMD (sidecar, BM25 + vector + reranking)</td></tr>
<tr><td><strong>Keyword search</strong></td><td>FTS5</td><td>BM25</td></tr>
<tr><td><strong>Vector search</strong></td><td>Cosine similarity</td><td>Cosine similarity</td></tr>
<tr><td><strong>Hybrid scoring</strong></td><td>Configurable vector/keyword weights</td><td>Configurable vector/text weights</td></tr>
<tr><td><strong>Chunking</strong></td><td>Markdown-aware (~400 tokens, configurable)</td><td>Markdown-aware (~400 tokens, 80-token overlap)</td></tr>
<tr><td><strong>Embedding cache</strong></td><td>SQLite with LRU eviction</td><td>SQLite, chunk-level</td></tr>
<tr><td><strong>File watching</strong></td><td>Real-time sync via <code>notify</code></td><td>File watcher with 1.5s debounce</td></tr>
<tr><td><strong>Auto-reindex on provider change</strong></td><td>No (manual)</td><td>Yes (fingerprint-based)</td></tr>
</tbody></table>
</div>
<h3 id="embedding-providers-1"><a class="header" href="#embedding-providers-1">Embedding Providers</a></h3>
<div class="table-wrapper"><table><thead><tr><th>Provider</th><th>Moltis</th><th>OpenClaw</th></tr></thead><tbody>
<tr><td><strong>Local GGUF</strong></td><td>EmbeddingGemma-300M via llama-cpp-2</td><td>Auto-download GGUF (~0.6 GB)</td></tr>
<tr><td><strong>Ollama</strong></td><td>nomic-embed-text</td><td>Not listed</td></tr>
<tr><td><strong>OpenAI</strong></td><td>text-embedding-3-small</td><td>Via API key</td></tr>
<tr><td><strong>Gemini</strong></td><td>Not available</td><td>Via API key</td></tr>
<tr><td><strong>Voyage</strong></td><td>Not available</td><td>Via API key</td></tr>
<tr><td><strong>Custom endpoint</strong></td><td>OpenAI-compatible</td><td>Not listed</td></tr>
<tr><td><strong>Batch embedding</strong></td><td>OpenAI batch API (50% cost saving)</td><td>OpenAI, Gemini, Voyage batch</td></tr>
<tr><td><strong>Fallback chain</strong></td><td>Auto-detect + circuit breaker</td><td>Auto-select in priority order</td></tr>
<tr><td><strong>Offline support</strong></td><td>Yes (local embeddings)</td><td>Yes (local embeddings)</td></tr>
</tbody></table>
</div>
<h3 id="memory-files"><a class="header" href="#memory-files">Memory Files</a></h3>
<div class="table-wrapper"><table><thead><tr><th>Aspect</th><th>Moltis</th><th>OpenClaw</th></tr></thead><tbody>
<tr><td><strong>Data directory</strong></td><td><code>~/.moltis/</code> (configurable)</td><td><code>~/.openclaw/workspace/</code></td></tr>
<tr><td><strong>Long-term memory</strong></td><td><code>MEMORY.md</code></td><td><code>MEMORY.md</code></td></tr>
<tr><td><strong>Daily logs</strong></td><td><code>memory/YYYY-MM-DD.md</code></td><td><code>memory/YYYY-MM-DD.md</code></td></tr>
<tr><td><strong>Session transcripts</strong></td><td><code>memory/sessions/*.md</code></td><td>Session JSONL files (separate)</td></tr>
<tr><td><strong>Extra paths</strong></td><td>Via <code>memory_dirs</code> config</td><td>Via <code>memorySearch.extraPaths</code></td></tr>
<tr><td><strong>MEMORY.md loading</strong></td><td>Always available in system prompt</td><td>Only in private sessions (not group chats)</td></tr>
</tbody></table>
</div>
<h3 id="agent-tools"><a class="header" href="#agent-tools">Agent Tools</a></h3>
<p>This is where the two systems differ most significantly in approach.</p>
<div class="table-wrapper"><table><thead><tr><th>Tool</th><th>Moltis</th><th>OpenClaw</th></tr></thead><tbody>
<tr><td><strong>memory_search</strong></td><td>Dedicated tool, hybrid search</td><td>Dedicated tool, hybrid search</td></tr>
<tr><td><strong>memory_get</strong></td><td>Dedicated tool, by chunk ID</td><td>Dedicated tool, by path + optional line range</td></tr>
<tr><td><strong>memory_save</strong></td><td>Dedicated tool with path validation</td><td>No dedicated tool</td></tr>
<tr><td><strong>General file writing</strong></td><td><code>exec</code> tool (shell commands)</td><td>Generic <code>write_file</code> tool</td></tr>
<tr><td><strong>Silent memory turn</strong></td><td>Pre-compaction flush via <code>MemoryWriter</code></td><td>Pre-compaction flush via <code>write_file</code></td></tr>
</tbody></table>
</div>
<h4 id="how-remember-x-works"><a class="header" href="#how-remember-x-works">How â€œRemember Xâ€ Works</a></h4>
<p>When a user says â€œremember that I prefer dark modeâ€, here is how each system
handles it:</p>
<p><strong>Moltis:</strong>
The agent calls the <code>memory_save</code> tool directly:</p>
<pre><code class="language-json">{
  "content": "User prefers dark mode.",
  "file": "MEMORY.md",
  "append": true
}
</code></pre>
<p>The <code>memory_save</code> tool validates the path, writes the file, and re-indexes it
so the content is immediately searchable. The agent does not need shell access
or a generic file-writing tool.</p>
<p><strong>OpenClaw:</strong>
The agent calls the generic <code>write_file</code> tool (which is also used for writing
code, configs, and any other file):</p>
<pre><code class="language-json">{
  "path": "MEMORY.md",
  "content": "User prefers dark mode.",
  "append": true
}
</code></pre>
<p>The system prompt instructs the agent which paths are for memory. The tool
itself has no special memory awareness â€“ it is a general-purpose file writer.
The memory indexerâ€™s file watcher detects the change and re-indexes
asynchronously (1.5s debounce).</p>
<p><strong>Key difference:</strong> Moltis uses a purpose-built <code>memory_save</code> tool with
built-in path validation (only <code>MEMORY.md</code> and <code>memory/*.md</code> are writable)
and immediate re-indexing. OpenClaw uses a general-purpose <code>write_file</code> tool
that can write anywhere, relying on the system prompt to guide the agent to
memory paths and the file watcher to re-index.</p>
<h3 id="session-memory-and-compaction"><a class="header" href="#session-memory-and-compaction">Session Memory and Compaction</a></h3>
<div class="table-wrapper"><table><thead><tr><th>Feature</th><th>Moltis</th><th>OpenClaw</th></tr></thead><tbody>
<tr><td><strong>Session storage</strong></td><td>SQLite database</td><td>JSONL files (append-only, tree structure)</td></tr>
<tr><td><strong>Auto-compaction</strong></td><td>Yes, near context window limit</td><td>Yes, near context window limit</td></tr>
<tr><td><strong>Manual compaction</strong></td><td>Not yet</td><td><code>/compact</code> command with optional instructions</td></tr>
<tr><td><strong>Pre-compaction memory flush</strong></td><td>Silent turn via <code>MemoryWriter</code> trait</td><td>Silent turn via <code>write_file</code> tool</td></tr>
<tr><td><strong>Flush visibility</strong></td><td>Completely hidden from user</td><td>Hidden via <code>NO_REPLY</code> convention</td></tr>
<tr><td><strong>Session export to memory</strong></td><td>Markdown files in <code>memory/sessions/</code></td><td>Optional (<code>sessionMemory</code> experimental flag)</td></tr>
<tr><td><strong>Session pruning</strong></td><td>Not yet</td><td>Cache-TTL based, trims old tool results</td></tr>
<tr><td><strong>Session transcript indexing</strong></td><td>Via session export</td><td>Experimental, async delta-based</td></tr>
</tbody></table>
</div>
<h3 id="pre-compaction-memory-flush-detailed-comparison"><a class="header" href="#pre-compaction-memory-flush-detailed-comparison">Pre-Compaction Memory Flush: Detailed Comparison</a></h3>
<p>Both systems run a hidden LLM turn before compaction to persist important
context. The implementation differs:</p>
<p><strong>Moltis:</strong></p>
<ul>
<li>The gateway detects that compaction is needed</li>
<li>A <code>run_silent_memory_turn()</code> call creates a temporary agent loop with a
<code>write_file</code> tool backed by <code>MemoryWriter</code></li>
<li>The <code>MemoryWriter</code> trait is implemented by <code>MemoryManager</code>, which validates
paths and re-indexes after writing</li>
<li>The LLMâ€™s response text is discarded</li>
<li>Written file paths are returned to the caller for logging</li>
</ul>
<p><strong>OpenClaw:</strong></p>
<ul>
<li>A soft threshold (default 4000 tokens below compaction trigger) activates
the flush</li>
<li>The flush executes as a regular turn with <code>NO_REPLY</code> prefix to suppress
user-facing output</li>
<li>The agent writes memory files via the same <code>write_file</code> tool used during
normal conversation</li>
<li>Flush state is tracked in <code>sessions.json</code> (<code>memoryFlushAt</code>,
<code>memoryFlushCompactionCount</code>) to run once per compaction cycle</li>
<li>Skipped for read-only workspaces</li>
</ul>
<h3 id="write-path-security"><a class="header" href="#write-path-security">Write Path Security</a></h3>
<div class="table-wrapper"><table><thead><tr><th>Aspect</th><th>Moltis</th><th>OpenClaw</th></tr></thead><tbody>
<tr><td><strong>Path validation</strong></td><td>Strict allowlist (MEMORY.md, memory.md, memory/*.md)</td><td>No special memory path restrictions</td></tr>
<tr><td><strong>Traversal prevention</strong></td><td>Rejects <code>..</code>, absolute paths, non-.md extensions</td><td>Relies on workspace sandboxing</td></tr>
<tr><td><strong>Size limit</strong></td><td>50 KB per write</td><td>No documented limit</td></tr>
<tr><td><strong>Write scope</strong></td><td>Only memory files</td><td>Any file in workspace</td></tr>
<tr><td><strong>Mechanism</strong></td><td><code>validate_memory_path()</code> in <code>MemoryWriter</code></td><td>Workspace access mode (rw/ro/none)</td></tr>
</tbody></table>
</div>
<h3 id="search-features"><a class="header" href="#search-features">Search Features</a></h3>
<div class="table-wrapper"><table><thead><tr><th>Feature</th><th>Moltis</th><th>OpenClaw</th></tr></thead><tbody>
<tr><td><strong>LLM reranking</strong></td><td>Optional (configurable)</td><td>Built-in with QMD</td></tr>
<tr><td><strong>Citations</strong></td><td>Configurable (auto/on/off)</td><td>Configurable (auto/on/off)</td></tr>
<tr><td><strong>Result format</strong></td><td>Chunk ID, path, source, line range, score, text</td><td>Path, line range, score, snippet (~700 chars)</td></tr>
<tr><td><strong>Fallback</strong></td><td>Keyword-only if no embeddings</td><td>BM25-only if no embeddings</td></tr>
</tbody></table>
</div>
<h3 id="configuration-3"><a class="header" href="#configuration-3">Configuration</a></h3>
<div class="table-wrapper"><table><thead><tr><th>Setting</th><th>Moltis (<code>moltis.toml</code>)</th><th>OpenClaw (<code>openclaw.json</code>)</th></tr></thead><tbody>
<tr><td><strong>Backend</strong></td><td><code>memory.backend = "builtin"</code></td><td><code>memory.backend = "builtin"</code></td></tr>
<tr><td><strong>Provider</strong></td><td><code>memory.provider = "local"</code></td><td>Auto-detect from available keys</td></tr>
<tr><td><strong>Citations</strong></td><td><code>memory.citations = "auto"</code></td><td><code>memory.citations = "auto"</code></td></tr>
<tr><td><strong>LLM reranking</strong></td><td><code>memory.llm_reranking = false</code></td><td>Via QMD config</td></tr>
<tr><td><strong>Session export</strong></td><td><code>memory.session_export = true</code></td><td><code>memorySearch.experimental.sessionMemory</code></td></tr>
<tr><td><strong>UI configuration</strong></td><td>Settings &gt; Memory page</td><td>Config file only</td></tr>
<tr><td><strong>QMD settings</strong></td><td><code>[memory.qmd]</code> section</td><td><code>memory.backend = "qmd"</code></td></tr>
</tbody></table>
</div>
<h3 id="cli-commands"><a class="header" href="#cli-commands">CLI Commands</a></h3>
<div class="table-wrapper"><table><thead><tr><th>Command</th><th>Moltis</th><th>OpenClaw</th></tr></thead><tbody>
<tr><td><strong>Status</strong></td><td>Settings &gt; Memory (web UI)</td><td><code>openclaw memory status [--deep]</code></td></tr>
<tr><td><strong>Index/reindex</strong></td><td>Automatic on startup</td><td><code>openclaw memory index [--verbose]</code></td></tr>
<tr><td><strong>Search</strong></td><td>Via agent tool only</td><td><code>openclaw memory search "query"</code></td></tr>
<tr><td><strong>Per-agent scoping</strong></td><td>Single agent</td><td><code>--agent &lt;id&gt;</code> flag</td></tr>
</tbody></table>
</div>
<h3 id="architecture-2"><a class="header" href="#architecture-2">Architecture</a></h3>
<div class="table-wrapper"><table><thead><tr><th>Aspect</th><th>Moltis</th><th>OpenClaw</th></tr></thead><tbody>
<tr><td><strong>Language</strong></td><td>Rust</td><td>TypeScript/Node.js</td></tr>
<tr><td><strong>Memory crate/module</strong></td><td><code>moltis-memory</code> crate</td><td><code>memory-core</code> plugin</td></tr>
<tr><td><strong>Write abstraction</strong></td><td><code>MemoryWriter</code> trait (shared by tools and silent turn)</td><td>Direct file I/O via <code>write_file</code> tool</td></tr>
<tr><td><strong>Plugin system</strong></td><td>Memory is a core crate</td><td>Memory is a swappable plugin slot</td></tr>
<tr><td><strong>Multi-agent</strong></td><td>Single agent</td><td>Per-agent memory isolation</td></tr>
</tbody></table>
</div>
<h2 id="what-moltis-has-that-openclaw-does-not"><a class="header" href="#what-moltis-has-that-openclaw-does-not">What Moltis Has That OpenClaw Does Not</a></h2>
<ul>
<li><strong>Dedicated <code>memory_save</code> tool</strong> with path validation and immediate
re-indexing, reducing reliance on the system prompt for write guidance</li>
<li><strong>Ollama embedding support</strong> as a provider option</li>
<li><strong>Custom OpenAI-compatible embedding endpoints</strong></li>
<li><strong>Circuit breaker</strong> with automatic fallback chain for embedding providers</li>
<li><strong>Web UI for memory configuration</strong> (Settings &gt; Memory page)</li>
<li><strong>Pure Rust implementation</strong> with zero external runtime dependencies</li>
</ul>
<h2 id="what-openclaw-has-that-moltis-does-not-yet"><a class="header" href="#what-openclaw-has-that-moltis-does-not-yet">What OpenClaw Has That Moltis Does Not (Yet)</a></h2>
<ul>
<li><strong>Manual <code>/compact</code> command</strong> with user-specified instructions</li>
<li><strong>CLI memory commands</strong> (<code>status</code>, <code>index</code>, <code>search</code>) for debugging</li>
<li><strong>Session pruning</strong> (cache-TTL based trimming of old tool results)</li>
<li><strong>Gemini and Voyage embedding providers</strong></li>
<li><strong>Per-agent memory isolation</strong> for multi-agent setups</li>
<li><strong>Automatic re-indexing on embedding provider/model change</strong> (fingerprint
detection)</li>
<li><strong>Memory plugin slot</strong> allowing third-party memory implementations</li>
<li><strong>Flush-once-per-compaction tracking</strong> to avoid redundant silent turns</li>
<li><strong>Configurable flush threshold</strong> (soft threshold tokens before compaction)</li>
</ul>
<h2 id="summary"><a class="header" href="#summary">Summary</a></h2>
<p>The two systems are architecturally equivalent â€“ both use Markdown files,
hybrid search, and pre-compaction memory flushes. The main differences are:</p>
<ol>
<li>
<p><strong>Tool approach</strong>: Moltis provides a purpose-built <code>memory_save</code> tool with
security validation; OpenClaw uses a general-purpose <code>write_file</code> tool
guided by the system prompt.</p>
</li>
<li>
<p><strong>Write safety</strong>: Moltis validates write paths at the tool level (allowlist</p>
<ul>
<li>traversal checks); OpenClaw relies on workspace-level access control.</li>
</ul>
</li>
<li>
<p><strong>Implementation</strong>: Moltis is pure Rust with a <code>MemoryWriter</code> trait
abstraction; OpenClaw is TypeScript with direct file I/O through a plugin
system.</p>
</li>
<li>
<p><strong>Maturity</strong>: OpenClaw has more CLI tooling and configuration knobs for
advanced memory management; Moltis has a simpler, more opinionated setup
with a web UI.</p>
</li>
</ol>
<div style="break-before: page; page-break-before: always;"></div><h1 id="hooks-1"><a class="header" href="#hooks-1">Hooks</a></h1>
<p>Hooks let you observe, modify, or block actions at key points in the agent lifecycle. Use them for auditing, policy enforcement, prompt injection filtering, notifications, and custom integrations.</p>
<h2 id="how-hooks-work"><a class="header" href="#how-hooks-work">How Hooks Work</a></h2>
<pre><code>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        Agent Loop                            â”‚
â”‚                                                              â”‚
â”‚  User Message â”€â†’ BeforeLLMCall â”€â†’ LLM Provider              â”‚
â”‚                       â”‚                 â”‚                    â”‚
â”‚                  modify/block      AfterLLMCall              â”‚
â”‚                                         â”‚                    â”‚
â”‚                                    modify/block              â”‚
â”‚                                         â”‚                    â”‚
â”‚                                         â–¼                    â”‚
â”‚                                  BeforeToolCall              â”‚
â”‚                                         â”‚                    â”‚
â”‚                                    modify/block              â”‚
â”‚                                         â”‚                    â”‚
â”‚                                    Tool Execution            â”‚
â”‚                                         â”‚                    â”‚
â”‚                                    AfterToolCall             â”‚
â”‚                                         â”‚                    â”‚
â”‚                                         â–¼                    â”‚
â”‚                              (loop continues or)             â”‚
â”‚                             Response â†’ MessageSent           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
</code></pre>
<h2 id="event-types"><a class="header" href="#event-types">Event Types</a></h2>
<h3 id="modifying-events-sequential"><a class="header" href="#modifying-events-sequential">Modifying Events (Sequential)</a></h3>
<p>These events run hooks sequentially. Hooks can modify the payload or block the action.</p>
<div class="table-wrapper"><table><thead><tr><th>Event</th><th>Description</th><th>Can Modify</th><th>Can Block</th></tr></thead><tbody>
<tr><td><code>BeforeAgentStart</code></td><td>Before agent loop starts</td><td>yes</td><td>yes</td></tr>
<tr><td><code>BeforeLLMCall</code></td><td>Before prompt is sent to the LLM provider</td><td>yes</td><td>yes</td></tr>
<tr><td><code>AfterLLMCall</code></td><td>After LLM response, before tool execution</td><td>yes</td><td>yes</td></tr>
<tr><td><code>BeforeToolCall</code></td><td>Before a tool executes</td><td>yes</td><td>yes</td></tr>
<tr><td><code>BeforeCompaction</code></td><td>Before context compaction</td><td>yes</td><td>yes</td></tr>
<tr><td><code>MessageSending</code></td><td>Before sending a response</td><td>yes</td><td>yes</td></tr>
<tr><td><code>ToolResultPersist</code></td><td>When a tool result is persisted</td><td>yes</td><td>yes</td></tr>
</tbody></table>
</div>
<h3 id="read-only-events-parallel"><a class="header" href="#read-only-events-parallel">Read-Only Events (Parallel)</a></h3>
<p>These events run hooks in parallel for performance. They cannot modify or block.</p>
<div class="table-wrapper"><table><thead><tr><th>Event</th><th>Description</th></tr></thead><tbody>
<tr><td><code>AfterToolCall</code></td><td>After a tool completes</td></tr>
<tr><td><code>AfterCompaction</code></td><td>After context is compacted</td></tr>
<tr><td><code>AgentEnd</code></td><td>When agent loop completes</td></tr>
<tr><td><code>MessageReceived</code></td><td>When a user message arrives</td></tr>
<tr><td><code>MessageSent</code></td><td>After response is delivered</td></tr>
<tr><td><code>SessionStart</code></td><td>When a new session begins</td></tr>
<tr><td><code>SessionEnd</code></td><td>When a session ends</td></tr>
<tr><td><code>GatewayStart</code></td><td>When Moltis starts</td></tr>
<tr><td><code>GatewayStop</code></td><td>When Moltis shuts down</td></tr>
<tr><td><code>Command</code></td><td>When a slash command is used</td></tr>
</tbody></table>
</div>
<h2 id="prompt-injection-filtering"><a class="header" href="#prompt-injection-filtering">Prompt Injection Filtering</a></h2>
<p>The <code>BeforeLLMCall</code> and <code>AfterLLMCall</code> hooks provide filtering points for prompt injection defense.</p>
<h3 id="beforellmcall"><a class="header" href="#beforellmcall">BeforeLLMCall</a></h3>
<p>Fires before each LLM API call. The payload includes the full message array, provider name, model ID, and iteration count. Use it to:</p>
<ul>
<li>Scan prompts for injection patterns before they reach the LLM</li>
<li>Redact PII or sensitive data from the conversation</li>
<li>Add safety prefixes to system prompts</li>
<li>Block requests that match known attack patterns</li>
</ul>
<p><strong>Payload fields:</strong></p>
<div class="table-wrapper"><table><thead><tr><th>Field</th><th>Type</th><th>Description</th></tr></thead><tbody>
<tr><td><code>session_key</code></td><td>string</td><td>Session identifier</td></tr>
<tr><td><code>provider</code></td><td>string</td><td>Provider name (e.g. â€œopenaiâ€, â€œanthropicâ€)</td></tr>
<tr><td><code>model</code></td><td>string</td><td>Model ID (e.g. â€œgpt-5.2-codexâ€, â€œqwen2.5-coder-7b-q4_k_mâ€)</td></tr>
<tr><td><code>messages</code></td><td>array</td><td>Serialized message array (OpenAI format)</td></tr>
<tr><td><code>tool_count</code></td><td>number</td><td>Number of tool schemas sent to the LLM</td></tr>
<tr><td><code>iteration</code></td><td>number</td><td>1-based loop iteration</td></tr>
</tbody></table>
</div>
<h3 id="afterllmcall"><a class="header" href="#afterllmcall">AfterLLMCall</a></h3>
<p>Fires after the LLM response is received but before tool calls execute. For streaming responses, this fires after the full response is accumulated (text has already been streamed to the UI) but blocking still prevents tool execution.</p>
<p><strong>Payload fields:</strong></p>
<div class="table-wrapper"><table><thead><tr><th>Field</th><th>Type</th><th>Description</th></tr></thead><tbody>
<tr><td><code>session_key</code></td><td>string</td><td>Session identifier</td></tr>
<tr><td><code>provider</code></td><td>string</td><td>Provider name</td></tr>
<tr><td><code>model</code></td><td>string</td><td>Model ID</td></tr>
<tr><td><code>text</code></td><td>string/null</td><td>LLM response text</td></tr>
<tr><td><code>tool_calls</code></td><td>array</td><td>Tool calls requested by the LLM</td></tr>
<tr><td><code>input_tokens</code></td><td>number</td><td>Tokens consumed by the prompt</td></tr>
<tr><td><code>output_tokens</code></td><td>number</td><td>Tokens in the response</td></tr>
<tr><td><code>iteration</code></td><td>number</td><td>1-based loop iteration</td></tr>
</tbody></table>
</div>
<h3 id="example-block-suspicious-tool-calls"><a class="header" href="#example-block-suspicious-tool-calls">Example: Block Suspicious Tool Calls</a></h3>
<pre><code class="language-bash">#!/bin/bash
# filter-injection.sh â€” subscribe to AfterLLMCall
payload=$(cat)
event=$(echo "$payload" | jq -r '.event')

if [ "$event" = "AfterLLMCall" ]; then
    # Check if tool calls contain suspicious patterns
    tool_names=$(echo "$payload" | jq -r '.tool_calls[].name')

    for name in $tool_names; do
        # Block unexpected tool calls that might come from injection
        case "$name" in
            exec|bash|shell)
                text=$(echo "$payload" | jq -r '.text // ""')
                if echo "$text" | grep -qi "ignore previous\|disregard\|new instructions"; then
                    echo "Blocked suspicious tool call after potential injection" &gt;&amp;2
                    exit 1
                fi
                ;;
        esac
    done
fi

exit 0
</code></pre>
<h3 id="example-external-proxy-filter"><a class="header" href="#example-external-proxy-filter">Example: External Proxy Filter</a></h3>
<pre><code class="language-bash">#!/bin/bash
# proxy-filter.sh â€” subscribe to BeforeLLMCall
payload=$(cat)

# Send to an external moderation API
result=$(echo "$payload" | curl -s -X POST \
  -H "Content-Type: application/json" \
  -d @- \
  "$MODERATION_API_URL/check")

# Block if the API flags it
if echo "$result" | jq -e '.flagged' &gt; /dev/null 2&gt;&amp;1; then
    reason=$(echo "$result" | jq -r '.reason // "content policy violation"')
    echo "$reason" &gt;&amp;2
    exit 1
fi

exit 0
</code></pre>
<h2 id="creating-a-hook"><a class="header" href="#creating-a-hook">Creating a Hook</a></h2>
<h3 id="1-create-the-hook-directory"><a class="header" href="#1-create-the-hook-directory">1. Create the Hook Directory</a></h3>
<pre><code class="language-bash">mkdir -p ~/.moltis/hooks/my-hook
</code></pre>
<h3 id="2-create-hookmd"><a class="header" href="#2-create-hookmd">2. Create HOOK.md</a></h3>
<pre><code class="language-markdown">+++
name = "my-hook"
description = "Logs all tool calls to a file"
events = ["BeforeToolCall", "AfterToolCall"]
command = "./handler.sh"
timeout = 5

[requires]
os = ["darwin", "linux"]
bins = ["jq"]
env = ["LOG_FILE"]
+++

# My Hook

This hook logs all tool calls for auditing purposes.
</code></pre>
<h3 id="3-create-the-handler-script"><a class="header" href="#3-create-the-handler-script">3. Create the Handler Script</a></h3>
<pre><code class="language-bash">#!/bin/bash
# handler.sh

# Read event payload from stdin
payload=$(cat)

# Extract event type
event=$(echo "$payload" | jq -r '.event')

# Log to file
echo "$(date -Iseconds) $event: $payload" &gt;&gt; "$LOG_FILE"

# Exit 0 to continue (don't block)
exit 0
</code></pre>
<h3 id="4-make-it-executable"><a class="header" href="#4-make-it-executable">4. Make it Executable</a></h3>
<pre><code class="language-bash">chmod +x ~/.moltis/hooks/my-hook/handler.sh
</code></pre>
<h2 id="shell-hook-protocol"><a class="header" href="#shell-hook-protocol">Shell Hook Protocol</a></h2>
<p>Hooks communicate via stdin/stdout and exit codes:</p>
<h3 id="input"><a class="header" href="#input">Input</a></h3>
<p>The event payload is passed as JSON on stdin:</p>
<pre><code class="language-json">{
  "event": "BeforeToolCall",
  "data": {
    "tool": "bash",
    "arguments": {
      "command": "ls -la"
    }
  },
  "session_id": "abc123",
  "timestamp": "2024-01-15T10:30:00Z"
}
</code></pre>
<h3 id="output"><a class="header" href="#output">Output</a></h3>
<div class="table-wrapper"><table><thead><tr><th>Exit Code</th><th>Stdout</th><th>Result</th></tr></thead><tbody>
<tr><td><code>0</code></td><td>(empty)</td><td>Continue normally</td></tr>
<tr><td><code>0</code></td><td><code>{"action":"modify","data":{...}}</code></td><td>Replace payload data</td></tr>
<tr><td><code>1</code></td><td>â€”</td><td>Block (stderr = reason)</td></tr>
</tbody></table>
</div>
<h3 id="example-modify-tool-arguments"><a class="header" href="#example-modify-tool-arguments">Example: Modify Tool Arguments</a></h3>
<pre><code class="language-bash">#!/bin/bash
payload=$(cat)
tool=$(echo "$payload" | jq -r '.data.tool')

if [ "$tool" = "bash" ]; then
    # Add safety flag to all bash commands
    modified=$(echo "$payload" | jq '.data.arguments.command = "set -e; " + .data.arguments.command')
    echo "{\"action\":\"modify\",\"data\":$(echo "$modified" | jq '.data')}"
fi

exit 0
</code></pre>
<h3 id="example-block-dangerous-commands"><a class="header" href="#example-block-dangerous-commands">Example: Block Dangerous Commands</a></h3>
<pre><code class="language-bash">#!/bin/bash
payload=$(cat)
command=$(echo "$payload" | jq -r '.data.arguments.command // ""')

# Block rm -rf /
if echo "$command" | grep -qE 'rm\s+-rf\s+/'; then
    echo "Blocked dangerous rm command" &gt;&amp;2
    exit 1
fi

exit 0
</code></pre>
<h2 id="hook-discovery"><a class="header" href="#hook-discovery">Hook Discovery</a></h2>
<p>Hooks are discovered from <code>HOOK.md</code> files in these locations (priority order):</p>
<ol>
<li><strong>Project-local</strong>: <code>&lt;workspace&gt;/.moltis/hooks/&lt;name&gt;/HOOK.md</code></li>
<li><strong>User-global</strong>: <code>~/.moltis/hooks/&lt;name&gt;/HOOK.md</code></li>
</ol>
<p>Project-local hooks take precedence over global hooks with the same name.</p>
<h2 id="configuration-in-moltistoml"><a class="header" href="#configuration-in-moltistoml">Configuration in moltis.toml</a></h2>
<p>You can also define hooks directly in the config file:</p>
<pre><code class="language-toml">[[hooks]]
name = "audit-log"
command = "./hooks/audit.sh"
events = ["BeforeToolCall", "AfterToolCall"]
timeout = 5
priority = 100  # Higher = runs first

[[hooks]]
name = "llm-filter"
command = "./hooks/filter-injection.sh"
events = ["BeforeLLMCall", "AfterLLMCall"]
timeout = 10

[[hooks]]
name = "notify-slack"
command = "./hooks/slack-notify.sh"
events = ["SessionEnd"]
env = { SLACK_WEBHOOK_URL = "https://hooks.slack.com/..." }
</code></pre>
<h2 id="eligibility-requirements"><a class="header" href="#eligibility-requirements">Eligibility Requirements</a></h2>
<p>Hooks can declare requirements that must be met:</p>
<pre><code class="language-toml">[requires]
os = ["darwin", "linux"]       # Only run on these OSes
bins = ["jq", "curl"]          # Required binaries in PATH
env = ["SLACK_WEBHOOK_URL"]    # Required environment variables
</code></pre>
<p>If requirements arenâ€™t met, the hook is skipped (not an error).</p>
<h2 id="circuit-breaker"><a class="header" href="#circuit-breaker">Circuit Breaker</a></h2>
<p>Hooks that fail repeatedly are automatically disabled:</p>
<ul>
<li><strong>Threshold</strong>: 5 consecutive failures</li>
<li><strong>Cooldown</strong>: 60 seconds</li>
<li><strong>Recovery</strong>: Auto-re-enabled after cooldown</li>
</ul>
<p>This prevents a broken hook from blocking all operations.</p>
<h2 id="cli-commands-1"><a class="header" href="#cli-commands-1">CLI Commands</a></h2>
<pre><code class="language-bash"># List all discovered hooks
moltis hooks list

# List only eligible hooks (requirements met)
moltis hooks list --eligible

# Output as JSON
moltis hooks list --json

# Show details for a specific hook
moltis hooks info my-hook
</code></pre>
<h2 id="bundled-hooks"><a class="header" href="#bundled-hooks">Bundled Hooks</a></h2>
<p>Moltis includes several built-in hooks:</p>
<h3 id="boot-md"><a class="header" href="#boot-md">boot-md</a></h3>
<p>Reads <code>BOOT.md</code> from the workspace on <code>GatewayStart</code> and injects it into the agent context.</p>
<p><code>BOOT.md</code> is intended for short, explicit startup tasks (health checks, reminders,
â€œsend one startup messageâ€, etc.). If the file is missing or empty, nothing is injected.</p>
<h2 id="workspace-context-files"><a class="header" href="#workspace-context-files">Workspace Context Files</a></h2>
<p>Moltis supports several workspace markdown files in <code>data_dir</code>.</p>
<h3 id="toolsmd"><a class="header" href="#toolsmd">TOOLS.md</a></h3>
<p><code>TOOLS.md</code> is loaded as a workspace context file in the system prompt.</p>
<p>Best use is to combine:</p>
<ul>
<li><strong>Local notes</strong>: environment-specific facts (hosts, device names, channel aliases)</li>
<li><strong>Policy constraints</strong>: â€œprefer read-only tools firstâ€, â€œnever run X on startupâ€, etc.</li>
</ul>
<p>If <code>TOOLS.md</code> is empty or missing, it is not injected.</p>
<h3 id="agentsmd-workspace"><a class="header" href="#agentsmd-workspace">AGENTS.md (workspace)</a></h3>
<p>Moltis also supports a workspace-level <code>AGENTS.md</code> in <code>data_dir</code>.</p>
<p>This is separate from project <code>AGENTS.md</code>/<code>CLAUDE.md</code> discovery. Use workspace
<code>AGENTS.md</code> for global instructions that should apply across projects in this workspace.</p>
<h3 id="session-memory"><a class="header" href="#session-memory">session-memory</a></h3>
<p>Saves session context when you use the <code>/new</code> command, preserving important information for future sessions.</p>
<h3 id="command-logger"><a class="header" href="#command-logger">command-logger</a></h3>
<p>Logs all <code>Command</code> events to a JSONL file for auditing.</p>
<h2 id="example-hooks"><a class="header" href="#example-hooks">Example Hooks</a></h2>
<h3 id="slack-notification-on-session-end"><a class="header" href="#slack-notification-on-session-end">Slack Notification on Session End</a></h3>
<pre><code class="language-bash">#!/bin/bash
# slack-notify.sh
payload=$(cat)
session_id=$(echo "$payload" | jq -r '.session_id')
message_count=$(echo "$payload" | jq -r '.data.message_count')

curl -X POST "$SLACK_WEBHOOK_URL" \
  -H 'Content-Type: application/json' \
  -d "{\"text\":\"Session $session_id ended with $message_count messages\"}"

exit 0
</code></pre>
<h3 id="redact-secrets-from-tool-output"><a class="header" href="#redact-secrets-from-tool-output">Redact Secrets from Tool Output</a></h3>
<pre><code class="language-bash">#!/bin/bash
# redact-secrets.sh
payload=$(cat)

# Redact common secret patterns
redacted=$(echo "$payload" | sed -E '
  s/sk-[a-zA-Z0-9]{32,}/[REDACTED]/g
  s/ghp_[a-zA-Z0-9]{36}/[REDACTED]/g
  s/password=[^&amp;\s]+/password=[REDACTED]/g
')

echo "{\"action\":\"modify\",\"data\":$(echo "$redacted" | jq '.data')}"
exit 0
</code></pre>
<h3 id="block-file-writes-outside-project"><a class="header" href="#block-file-writes-outside-project">Block File Writes Outside Project</a></h3>
<pre><code class="language-bash">#!/bin/bash
# sandbox-writes.sh
payload=$(cat)
tool=$(echo "$payload" | jq -r '.data.tool')

if [ "$tool" = "write_file" ]; then
    path=$(echo "$payload" | jq -r '.data.arguments.path')

    # Only allow writes under current project
    if [[ ! "$path" =~ ^/workspace/ ]]; then
        echo "File writes only allowed in /workspace" &gt;&amp;2
        exit 1
    fi
fi

exit 0
</code></pre>
<h2 id="best-practices"><a class="header" href="#best-practices">Best Practices</a></h2>
<ol>
<li><strong>Keep hooks fast</strong> â€” Set appropriate timeouts (default: 5s)</li>
<li><strong>Handle errors gracefully</strong> â€” Use <code>exit 0</code> unless you want to block</li>
<li><strong>Log for debugging</strong> â€” Write to a log file, not stdout</li>
<li><strong>Test locally first</strong> â€” Pipe sample JSON through your script</li>
<li><strong>Use jq for JSON</strong> â€” Itâ€™s reliable and fast for parsing</li>
<li><strong>Layer defenses</strong> â€” Use <code>BeforeLLMCall</code> for input filtering and <code>AfterLLMCall</code> for output filtering</li>
</ol>
<div style="break-before: page; page-break-before: always;"></div><h1 id="local-llm-support"><a class="header" href="#local-llm-support">Local LLM Support</a></h1>
<p>Moltis can run LLM inference locally on your machine without requiring an API
key or internet connection. This enables fully offline operation and keeps your
conversations private.</p>
<h2 id="backends-1"><a class="header" href="#backends-1">Backends</a></h2>
<p>Moltis supports two backends for local inference:</p>
<div class="table-wrapper"><table><thead><tr><th>Backend</th><th>Format</th><th>Platform</th><th>GPU Acceleration</th></tr></thead><tbody>
<tr><td><strong>GGUF</strong> (llama.cpp)</td><td><code>.gguf</code> files</td><td>macOS, Linux, Windows</td><td>Metal (macOS), CUDA (NVIDIA)</td></tr>
<tr><td><strong>MLX</strong></td><td>MLX model repos</td><td>macOS (Apple Silicon only)</td><td>Apple Silicon neural engine</td></tr>
</tbody></table>
</div>
<h3 id="gguf-llamacpp"><a class="header" href="#gguf-llamacpp">GGUF (llama.cpp)</a></h3>
<p>GGUF is the primary backend, powered by <a href="https://github.com/ggerganov/llama.cpp">llama.cpp</a>.
It supports quantized models in the GGUF format, which significantly reduces
memory requirements while maintaining good quality.</p>
<p><strong>Advantages:</strong></p>
<ul>
<li>Cross-platform (macOS, Linux, Windows)</li>
<li>Wide model compatibility (any GGUF model)</li>
<li>GPU acceleration on both NVIDIA (CUDA) and Apple Silicon (Metal)</li>
<li>Mature and well-tested</li>
</ul>
<h3 id="mlx"><a class="header" href="#mlx">MLX</a></h3>
<p>MLX is Appleâ€™s machine learning framework optimized for Apple Silicon. Models
from the <a href="https://huggingface.co/mlx-community">mlx-community</a> on HuggingFace
are specifically optimized for M1/M2/M3/M4 chips.</p>
<p><strong>Advantages:</strong></p>
<ul>
<li>Native Apple Silicon performance</li>
<li>Efficient unified memory usage</li>
<li>Lower latency on Macs</li>
</ul>
<p><strong>Requirements:</strong></p>
<ul>
<li>macOS with Apple Silicon (M1/M2/M3/M4)</li>
</ul>
<h2 id="memory-requirements"><a class="header" href="#memory-requirements">Memory Requirements</a></h2>
<p>Models are organized by memory tiers based on your system RAM:</p>
<div class="table-wrapper"><table><thead><tr><th>Tier</th><th>RAM</th><th>Recommended Models</th></tr></thead><tbody>
<tr><td><strong>Tiny</strong></td><td>4GB</td><td>Qwen 2.5 Coder 1.5B, Llama 3.2 1B</td></tr>
<tr><td><strong>Small</strong></td><td>8GB</td><td>Qwen 2.5 Coder 3B, Llama 3.2 3B</td></tr>
<tr><td><strong>Medium</strong></td><td>16GB</td><td>Qwen 2.5 Coder 7B, Llama 3.1 8B</td></tr>
<tr><td><strong>Large</strong></td><td>32GB+</td><td>Qwen 2.5 Coder 14B, DeepSeek Coder V2 Lite</td></tr>
</tbody></table>
</div>
<p>Moltis automatically detects your system memory and suggests appropriate models
in the UI.</p>
<h2 id="configuration-4"><a class="header" href="#configuration-4">Configuration</a></h2>
<h3 id="via-web-ui-recommended-1"><a class="header" href="#via-web-ui-recommended-1">Via Web UI (Recommended)</a></h3>
<ol>
<li>Navigate to <strong>Providers</strong> in the sidebar</li>
<li>Click <strong>Add Provider</strong></li>
<li>Select <strong>Local LLM</strong></li>
<li>Choose a model from the registry or search HuggingFace</li>
<li>Click <strong>Configure</strong> â€” the model will download automatically</li>
</ol>
<h3 id="via-configuration-file"><a class="header" href="#via-configuration-file">Via Configuration File</a></h3>
<p>Add to <code>~/.moltis/moltis.toml</code>:</p>
<pre><code class="language-toml">[providers.local]
model = "qwen2.5-coder-7b-q4_k_m"
</code></pre>
<p>For custom GGUF files:</p>
<pre><code class="language-toml">[providers.local]
model = "my-custom-model"
model_path = "/path/to/model.gguf"
</code></pre>
<h2 id="model-storage"><a class="header" href="#model-storage">Model Storage</a></h2>
<p>Downloaded models are cached in <code>~/.cache/moltis/models/</code> by default. This
directory can grow large (several GB per model).</p>
<p>To change the cache location:</p>
<pre><code class="language-toml">[providers.local]
cache_dir = "/custom/models/path"
</code></pre>
<h2 id="huggingface-integration"><a class="header" href="#huggingface-integration">HuggingFace Integration</a></h2>
<p>You can search and download models directly from HuggingFace:</p>
<ol>
<li>In the Add Provider dialog, click â€œSearch HuggingFaceâ€</li>
<li>Enter a search term (e.g., â€œqwen coderâ€)</li>
<li>Select GGUF or MLX backend</li>
<li>Choose a model from the results</li>
<li>The model will be downloaded on first use</li>
</ol>
<h3 id="finding-gguf-models"><a class="header" href="#finding-gguf-models">Finding GGUF Models</a></h3>
<p>Look for repositories with â€œGGUFâ€ in the name on HuggingFace:</p>
<ul>
<li><a href="https://huggingface.co/TheBloke">TheBloke</a> â€” large collection of quantized models</li>
<li><a href="https://huggingface.co/bartowski">bartowski</a> â€” Llama 3.x GGUF models</li>
<li><a href="https://huggingface.co/Qwen">Qwen</a> â€” official Qwen GGUF models</li>
</ul>
<h3 id="finding-mlx-models"><a class="header" href="#finding-mlx-models">Finding MLX Models</a></h3>
<p>MLX models are available from <a href="https://huggingface.co/mlx-community">mlx-community</a>:</p>
<ul>
<li>Pre-converted models optimized for Apple Silicon</li>
<li>Look for models ending in <code>-4bit</code> or <code>-8bit</code> for quantized versions</li>
</ul>
<h2 id="gpu-acceleration"><a class="header" href="#gpu-acceleration">GPU Acceleration</a></h2>
<h3 id="metal-macos"><a class="header" href="#metal-macos">Metal (macOS)</a></h3>
<p>Metal acceleration is enabled by default on macOS. The number of GPU layers
can be configured:</p>
<pre><code class="language-toml">[providers.local]
gpu_layers = 99  # Offload all layers to GPU
</code></pre>
<h3 id="cuda-nvidia"><a class="header" href="#cuda-nvidia">CUDA (NVIDIA)</a></h3>
<p>Requires building with the <code>local-llm-cuda</code> feature:</p>
<pre><code class="language-bash">cargo build --release --features local-llm-cuda
</code></pre>
<h2 id="limitations"><a class="header" href="#limitations">Limitations</a></h2>
<p>Local LLM models have some limitations compared to cloud providers:</p>
<ol>
<li>
<p><strong>No tool calling</strong> â€” Local models donâ€™t support function/tool calling.
When using a local model, features like file operations, shell commands,
and memory search are disabled.</p>
</li>
<li>
<p><strong>Slower inference</strong> â€” Depending on your hardware, local inference may be
significantly slower than cloud APIs.</p>
</li>
<li>
<p><strong>Quality varies</strong> â€” Smaller quantized models may produce lower quality
responses than larger cloud models.</p>
</li>
<li>
<p><strong>Context window</strong> â€” Local models typically have smaller context windows
(8K-32K tokens vs 128K+ for cloud models).</p>
</li>
</ol>
<h2 id="chat-templates"><a class="header" href="#chat-templates">Chat Templates</a></h2>
<p>Different model families use different chat formatting. Moltis automatically
detects the correct template for registered models:</p>
<ul>
<li><strong>ChatML</strong> â€” Qwen, many instruction-tuned models</li>
<li><strong>Llama 3</strong> â€” Metaâ€™s Llama 3.x family</li>
<li><strong>DeepSeek</strong> â€” DeepSeek Coder models</li>
</ul>
<p>For custom models, the template is auto-detected from the model metadata when
possible.</p>
<h2 id="troubleshooting-3"><a class="header" href="#troubleshooting-3">Troubleshooting</a></h2>
<h3 id="model-fails-to-load"><a class="header" href="#model-fails-to-load">Model fails to load</a></h3>
<ul>
<li>Check you have enough RAM (see memory tier table above)</li>
<li>Verify the GGUF file isnâ€™t corrupted (re-download if needed)</li>
<li>Ensure the model file matches the expected architecture</li>
</ul>
<h3 id="slow-inference"><a class="header" href="#slow-inference">Slow inference</a></h3>
<ul>
<li>Enable GPU acceleration (Metal on macOS, CUDA on Linux)</li>
<li>Try a smaller/more quantized model</li>
<li>Reduce context size in config</li>
</ul>
<h3 id="out-of-memory"><a class="header" href="#out-of-memory">Out of memory</a></h3>
<ul>
<li>Choose a model from a lower memory tier</li>
<li>Close other applications to free RAM</li>
<li>Use a more aggressively quantized model (Q4_K_M vs Q8_0)</li>
</ul>
<h2 id="feature-flag"><a class="header" href="#feature-flag">Feature Flag</a></h2>
<p>Local LLM support requires the <code>local-llm</code> feature flag at compile time:</p>
<pre><code class="language-bash">cargo build --release --features local-llm
</code></pre>
<p>This is enabled by default in release builds.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="sandbox-backends"><a class="header" href="#sandbox-backends">Sandbox Backends</a></h1>
<p>Moltis runs LLM-generated commands inside containers to protect your host
system. The sandbox backend controls which container technology is used.</p>
<h2 id="backend-selection"><a class="header" href="#backend-selection">Backend Selection</a></h2>
<p>Configure in <code>moltis.toml</code>:</p>
<pre><code class="language-toml">[tools.exec.sandbox]
backend = "auto"          # default â€” picks the best available
# backend = "docker"      # force Docker
# backend = "apple-container"  # force Apple Container (macOS only)
</code></pre>
<p>With <code>"auto"</code> (the default), Moltis picks the strongest available backend:</p>
<div class="table-wrapper"><table><thead><tr><th>Priority</th><th>Backend</th><th>Platform</th><th>Isolation</th></tr></thead><tbody>
<tr><td>1</td><td>Apple Container</td><td>macOS</td><td>VM (Virtualization.framework)</td></tr>
<tr><td>2</td><td>Docker</td><td>any</td><td>Linux namespaces / cgroups</td></tr>
<tr><td>3</td><td>none (host)</td><td>any</td><td>no isolation</td></tr>
</tbody></table>
</div>
<h2 id="apple-container-recommended-on-macos"><a class="header" href="#apple-container-recommended-on-macos">Apple Container (recommended on macOS)</a></h2>
<p><a href="https://github.com/apple/container">Apple Container</a> runs each sandbox in a
lightweight virtual machine using Appleâ€™s Virtualization.framework. Every
container gets its own kernel, so a kernel exploit inside the sandbox cannot
reach the host â€” unlike Docker, which shares the host kernel.</p>
<h3 id="install"><a class="header" href="#install">Install</a></h3>
<p>Download the signed installer from GitHub:</p>
<pre><code class="language-bash"># Download the installer package
gh release download --repo apple/container --pattern "container-installer-signed.pkg" --dir /tmp

# Install (requires admin)
sudo installer -pkg /tmp/container-installer-signed.pkg -target /

# First-time setup â€” downloads a default Linux kernel
container system start
</code></pre>
<p>Alternatively, build from source with <code>brew install container</code> (requires
Xcode 26+).</p>
<h3 id="verify"><a class="header" href="#verify">Verify</a></h3>
<pre><code class="language-bash">container --version
# Run a quick test
container run --rm ubuntu echo "hello from VM"
</code></pre>
<p>Once installed, restart <code>moltis gateway</code> â€” the startup banner will show
<code>sandbox: apple-container backend</code>.</p>
<h2 id="docker-1"><a class="header" href="#docker-1">Docker</a></h2>
<p>Docker is supported on macOS, Linux, and Windows. On macOS it runs inside a
Linux VM managed by Docker Desktop, so it is reasonably isolated but adds more
overhead than Apple Container.</p>
<p>Install from https://docs.docker.com/get-docker/</p>
<h2 id="no-sandbox"><a class="header" href="#no-sandbox">No sandbox</a></h2>
<p>If neither runtime is found, commands execute directly on the host. The
startup banner will show a warning. This is <strong>not recommended</strong> for untrusted
workloads.</p>
<h2 id="per-session-overrides"><a class="header" href="#per-session-overrides">Per-session overrides</a></h2>
<p>The web UI allows toggling sandboxing per session and selecting a custom
container image. These overrides persist across gateway restarts.</p>
<h2 id="resource-limits"><a class="header" href="#resource-limits">Resource limits</a></h2>
<pre><code class="language-toml">[tools.exec.sandbox.resource_limits]
memory_limit = "512M"
cpu_quota = 1.0
pids_max = 256
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="voice-services"><a class="header" href="#voice-services">Voice Services</a></h1>
<p>Moltis provides text-to-speech (TTS) and speech-to-text (STT) capabilities
through the <code>moltis-voice</code> crate and gateway integration.</p>
<h2 id="feature-flag-1"><a class="header" href="#feature-flag-1">Feature Flag</a></h2>
<p>Voice services are behind the <code>voice</code> cargo feature, enabled by default:</p>
<pre><code class="language-toml"># Cargo.toml (gateway crate)
[features]
default = ["voice", ...]
voice = ["dep:moltis-voice"]
</code></pre>
<p>To disable voice features at compile time:</p>
<pre><code class="language-bash">cargo build --no-default-features --features "file-watcher,tailscale,tls,web-ui"
</code></pre>
<p>When disabled:</p>
<ul>
<li>TTS/STT RPC methods are not registered</li>
<li>Voice settings section is hidden in the UI</li>
<li>Microphone button is hidden in the chat interface</li>
<li><code>voice_enabled: false</code> is set in the gon data</li>
</ul>
<h2 id="architecture-3"><a class="header" href="#architecture-3">Architecture</a></h2>
<pre><code>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      Voice Crate                            â”‚
â”‚                   (crates/voice/)                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  TtsProvider trait         â”‚  SttProvider trait             â”‚
â”‚  â”œâ”€ ElevenLabsTts          â”‚  â”œâ”€ WhisperStt (OpenAI)        â”‚
â”‚  â”œâ”€ OpenAiTts              â”‚  â”œâ”€ GroqStt (Groq)             â”‚
â”‚  â”œâ”€ GoogleTts              â”‚  â”œâ”€ DeepgramStt                â”‚
â”‚  â”œâ”€ PiperTts (local)       â”‚  â”œâ”€ GoogleStt                  â”‚
â”‚  â””â”€ CoquiTts (local)       â”‚  â”œâ”€ MistralStt                 â”‚
â”‚                            â”‚  â”œâ”€ VoxtralLocalStt (local)    â”‚
â”‚                            â”‚  â”œâ”€ WhisperCliStt (local)      â”‚
â”‚                            â”‚  â””â”€ SherpaOnnxStt (local)      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚
                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Gateway Services                         â”‚
â”‚                (crates/gateway/src/voice.rs)                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  LiveTtsService            â”‚  LiveSttService                â”‚
â”‚  (wraps TTS providers)     â”‚  (wraps STT providers)         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚
                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     RPC Methods                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  tts.status, tts.providers, tts.enable, tts.disable,        â”‚
â”‚  tts.convert, tts.setProvider                               â”‚
â”‚  stt.status, stt.providers, stt.transcribe, stt.setProvider â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
</code></pre>
<h2 id="text-to-speech-tts"><a class="header" href="#text-to-speech-tts">Text-to-Speech (TTS)</a></h2>
<h3 id="supported-providers"><a class="header" href="#supported-providers">Supported Providers</a></h3>
<p>Moltis supports multiple TTS providers across cloud and local backends.</p>
<div class="table-wrapper"><table><thead><tr><th>Category</th><th>Notes</th></tr></thead><tbody>
<tr><td>Cloud TTS providers</td><td>Hosted neural voices with low-latency streaming</td></tr>
<tr><td>Local TTS providers</td><td>Offline/on-device synthesis for privacy-sensitive workflows</td></tr>
</tbody></table>
</div>
<p><em>More voice providers are coming soon.</em></p>
<h3 id="configuration-5"><a class="header" href="#configuration-5">Configuration</a></h3>
<p>Set API keys via environment variables:</p>
<pre><code class="language-bash">export ELEVENLABS_API_KEY=your-key-here
export OPENAI_API_KEY=your-key-here
</code></pre>
<p>Or configure in <code>moltis.toml</code>:</p>
<pre><code class="language-toml">[voice.tts]
enabled = true
provider = "elevenlabs"  # or "openai"
providers = []           # Optional UI allowlist, empty = show all TTS providers
auto = "off"             # "always", "off", "inbound", "tagged"
max_text_length = 2000

[voice.tts.elevenlabs]
api_key = "sk-..."
voice_id = "21m00Tcm4TlvDq8ikWAM"  # Rachel (default)
model = "eleven_flash_v2_5"
stability = 0.5
similarity_boost = 0.75

[voice.tts.openai]
api_key = "sk-..."
voice = "alloy"  # alloy, echo, fable, onyx, nova, shimmer
model = "tts-1"
speed = 1.0

[voice.tts.google]
api_key = "..."  # Google Cloud API key
voice = "en-US-Neural2-D"  # See Google Cloud TTS voices
language_code = "en-US"
speaking_rate = 1.0

# Local providers - no API key required

[voice.tts.piper]
# binary_path = "/usr/local/bin/piper"  # optional, searches PATH
model_path = "~/.moltis/models/en_US-lessac-medium.onnx"  # required
# config_path = "~/.moltis/models/en_US-lessac-medium.onnx.json"  # optional
# speaker_id = 0  # for multi-speaker models
# length_scale = 1.0  # speaking rate (lower = faster)

[voice.tts.coqui]
endpoint = "http://localhost:5002"  # Coqui TTS server
# model = "tts_models/en/ljspeech/tacotron2-DDC"  # optional
</code></pre>
<h3 id="local-tts-provider-setup"><a class="header" href="#local-tts-provider-setup">Local TTS Provider Setup</a></h3>
<h4 id="piper-tts"><a class="header" href="#piper-tts">Piper TTS</a></h4>
<p>Piper is a fast, local neural text-to-speech system that runs entirely offline.</p>
<ol>
<li>
<p>Install Piper:</p>
<pre><code class="language-bash"># Via pip
pip install piper-tts

# Or download pre-built binaries from:
# https://github.com/rhasspy/piper/releases
</code></pre>
</li>
<li>
<p>Download a voice model from <a href="https://github.com/rhasspy/piper#voices">Piper Voices</a>:</p>
<pre><code class="language-bash">mkdir -p ~/.moltis/models
curl -L -o ~/.moltis/models/en_US-lessac-medium.onnx \
  https://huggingface.co/rhasspy/piper-voices/resolve/main/en/en_US/lessac/medium/en_US-lessac-medium.onnx
</code></pre>
</li>
<li>
<p>Configure in <code>moltis.toml</code>:</p>
<pre><code class="language-toml">[voice.tts]
provider = "piper"

[voice.tts.piper]
model_path = "~/.moltis/models/en_US-lessac-medium.onnx"
</code></pre>
</li>
</ol>
<h4 id="coqui-tts"><a class="header" href="#coqui-tts">Coqui TTS</a></h4>
<p>Coqui TTS is a high-quality neural TTS with voice cloning capabilities.</p>
<ol>
<li>
<p>Install and start the server:</p>
<pre><code class="language-bash"># Via pip
pip install TTS
tts-server --model_name tts_models/en/ljspeech/tacotron2-DDC

# Or via Docker
docker run -p 5002:5002 ghcr.io/coqui-ai/tts
</code></pre>
</li>
<li>
<p>Configure in <code>moltis.toml</code>:</p>
<pre><code class="language-toml">[voice.tts]
provider = "coqui"

[voice.tts.coqui]
endpoint = "http://localhost:5002"
</code></pre>
</li>
</ol>
<p>Browse available models at <a href="https://github.com/coqui-ai/TTS#available-models">Coqui TTS Models</a>.</p>
<h3 id="rpc-methods"><a class="header" href="#rpc-methods">RPC Methods</a></h3>
<h4 id="ttsstatus"><a class="header" href="#ttsstatus"><code>tts.status</code></a></h4>
<p>Get current TTS status.</p>
<p><strong>Response:</strong></p>
<pre><code class="language-json">{
  "enabled": true,
  "provider": "elevenlabs",
  "auto": "off",
  "maxTextLength": 2000,
  "configured": true
}
</code></pre>
<h4 id="ttsproviders"><a class="header" href="#ttsproviders"><code>tts.providers</code></a></h4>
<p>List available TTS providers.</p>
<p><strong>Response:</strong></p>
<pre><code class="language-json">[
  { "id": "elevenlabs", "name": "ElevenLabs", "configured": true },
  { "id": "openai", "name": "OpenAI", "configured": false }
]
</code></pre>
<h4 id="ttsenable"><a class="header" href="#ttsenable"><code>tts.enable</code></a></h4>
<p>Enable TTS with optional provider selection.</p>
<p><strong>Request:</strong></p>
<pre><code class="language-json">{ "provider": "elevenlabs" }
</code></pre>
<p><strong>Response:</strong></p>
<pre><code class="language-json">{ "enabled": true, "provider": "elevenlabs" }
</code></pre>
<h4 id="ttsdisable"><a class="header" href="#ttsdisable"><code>tts.disable</code></a></h4>
<p>Disable TTS.</p>
<p><strong>Response:</strong></p>
<pre><code class="language-json">{ "enabled": false }
</code></pre>
<h4 id="ttsconvert"><a class="header" href="#ttsconvert"><code>tts.convert</code></a></h4>
<p>Convert text to speech.</p>
<p><strong>Request:</strong></p>
<pre><code class="language-json">{
  "text": "Hello, how can I help you today?",
  "provider": "elevenlabs",
  "voiceId": "21m00Tcm4TlvDq8ikWAM",
  "model": "eleven_flash_v2_5",
  "format": "mp3",
  "speed": 1.0,
  "stability": 0.5,
  "similarityBoost": 0.75
}
</code></pre>
<p><strong>Response:</strong></p>
<pre><code class="language-json">{
  "audio": "base64-encoded-audio-data",
  "format": "mp3",
  "mimeType": "audio/mpeg",
  "durationMs": 2500,
  "size": 45000
}
</code></pre>
<p><strong>Audio Formats:</strong></p>
<ul>
<li><code>mp3</code> (default) - Widely compatible</li>
<li><code>opus</code> / <code>ogg</code> - Good for Telegram voice notes</li>
<li><code>aac</code> - Apple devices</li>
<li><code>pcm</code> - Raw audio</li>
</ul>
<h4 id="ttssetprovider"><a class="header" href="#ttssetprovider"><code>tts.setProvider</code></a></h4>
<p>Change the active TTS provider.</p>
<p><strong>Request:</strong></p>
<pre><code class="language-json">{ "provider": "openai" }
</code></pre>
<h3 id="auto-speak-modes"><a class="header" href="#auto-speak-modes">Auto-Speak Modes</a></h3>
<div class="table-wrapper"><table><thead><tr><th>Mode</th><th>Description</th></tr></thead><tbody>
<tr><td><code>always</code></td><td>Speak all AI responses</td></tr>
<tr><td><code>off</code></td><td>Never auto-speak (default)</td></tr>
<tr><td><code>inbound</code></td><td>Only when user sent voice input</td></tr>
<tr><td><code>tagged</code></td><td>Only with explicit <code>[[tts]]</code> markup</td></tr>
</tbody></table>
</div>
<h2 id="speech-to-text-stt"><a class="header" href="#speech-to-text-stt">Speech-to-Text (STT)</a></h2>
<h3 id="supported-providers-1"><a class="header" href="#supported-providers-1">Supported Providers</a></h3>
<p>Moltis supports multiple STT providers across cloud and local backends.</p>
<div class="table-wrapper"><table><thead><tr><th>Category</th><th>Notes</th></tr></thead><tbody>
<tr><td>Cloud STT providers</td><td>Managed transcription APIs with language/model options</td></tr>
<tr><td>Local STT providers</td><td>Offline transcription through local binaries or services</td></tr>
</tbody></table>
</div>
<p><em>More voice providers are coming soon.</em></p>
<h3 id="configuration-6"><a class="header" href="#configuration-6">Configuration</a></h3>
<pre><code class="language-toml">[voice.stt]
enabled = true
provider = "whisper"  # set to any configured STT provider id
providers = []        # Optional UI allowlist, empty = show all STT providers

# Cloud providers - API key required
[voice.stt.whisper]
api_key = "sk-..."  # Uses OPENAI_API_KEY if not set
model = "whisper-1"
language = "en"     # Optional ISO 639-1 hint

[voice.stt.groq]
api_key = "gsk_..."
model = "whisper-large-v3-turbo"  # default
language = "en"

[voice.stt.deepgram]
api_key = "..."
model = "nova-3"  # default
language = "en"
smart_format = true

[voice.stt.google]
api_key = "..."
language = "en-US"
# model = "latest_long"  # optional

[voice.stt.mistral]
api_key = "..."
model = "voxtral-mini-latest"  # default
language = "en"

# Local providers - no API key, requires server or binary

# Voxtral local via vLLM server
[voice.stt.voxtral_local]
# endpoint = "http://localhost:8000"  # default vLLM endpoint
# model = "mistralai/Voxtral-Mini-3B-2507"  # optional, server default
# language = "en"  # optional

[voice.stt.whisper_cli]
# binary_path = "/usr/local/bin/whisper-cli"  # optional, searches PATH
model_path = "~/.moltis/models/ggml-base.en.bin"  # required
language = "en"

[voice.stt.sherpa_onnx]
# binary_path = "/usr/local/bin/sherpa-onnx-offline"  # optional
model_dir = "~/.moltis/models/sherpa-onnx-whisper-tiny.en"  # required
language = "en"
</code></pre>
<h3 id="local-provider-setup"><a class="header" href="#local-provider-setup">Local Provider Setup</a></h3>
<h4 id="voxtral-via-vllm"><a class="header" href="#voxtral-via-vllm">Voxtral via vLLM</a></h4>
<p>Voxtral is an open-weights model from Mistral AI that can run locally using vLLM.
It supports 13 languages with fast transcription.</p>
<p><strong>Requirements:</strong></p>
<ul>
<li>Python 3.10+</li>
<li>CUDA-capable GPU with ~9.5GB VRAM (or CPU with more memory)</li>
<li>vLLM with audio support</li>
</ul>
<p><strong>Setup:</strong></p>
<ol>
<li>
<p>Install vLLM with audio support:</p>
<pre><code class="language-bash">pip install "vllm[audio]"
</code></pre>
</li>
<li>
<p>Start the vLLM server:</p>
<pre><code class="language-bash">vllm serve mistralai/Voxtral-Mini-3B-2507 \
  --tokenizer_mode mistral \
  --config_format mistral \
  --load_format mistral
</code></pre>
<p>The server exposes an OpenAI-compatible endpoint at <code>http://localhost:8000</code>.</p>
</li>
<li>
<p>Configure in <code>moltis.toml</code>:</p>
<pre><code class="language-toml">[voice.stt]
provider = "voxtral-local"

[voice.stt.voxtral_local]
# Default endpoint works if vLLM is running locally
# endpoint = "http://localhost:8000"
</code></pre>
</li>
</ol>
<p><strong>Supported Languages:</strong>
English, French, German, Spanish, Portuguese, Italian, Dutch, Polish, Swedish,
Norwegian, Danish, Finnish, Arabic</p>
<p><strong>Note:</strong> Unlike the embedded local providers (whisper.cpp, sherpa-onnx), this
requires running vLLM as a separate server process. The model is downloaded
automatically on first vLLM startup.</p>
<h4 id="whispercpp"><a class="header" href="#whispercpp">whisper.cpp</a></h4>
<ol>
<li>
<p>Install the binary:</p>
<pre><code class="language-bash"># macOS
brew install whisper-cpp

# From source: https://github.com/ggerganov/whisper.cpp
</code></pre>
</li>
<li>
<p>Download a model from <a href="https://huggingface.co/ggerganov/whisper.cpp">Hugging Face</a>:</p>
<pre><code class="language-bash">mkdir -p ~/.moltis/models
curl -L -o ~/.moltis/models/ggml-base.en.bin \
  https://huggingface.co/ggerganov/whisper.cpp/resolve/main/ggml-base.en.bin
</code></pre>
</li>
<li>
<p>Configure in <code>moltis.toml</code>:</p>
<pre><code class="language-toml">[voice.stt]
provider = "whisper-cli"

[voice.stt.whisper_cli]
model_path = "~/.moltis/models/ggml-base.en.bin"
</code></pre>
</li>
</ol>
<h4 id="sherpa-onnx"><a class="header" href="#sherpa-onnx">sherpa-onnx</a></h4>
<ol>
<li>
<p>Install following the <a href="https://k2-fsa.github.io/sherpa/onnx/install.html">official docs</a></p>
</li>
<li>
<p>Download a model from the <a href="https://k2-fsa.github.io/sherpa/onnx/pretrained_models/index.html">model list</a></p>
</li>
<li>
<p>Configure in <code>moltis.toml</code>:</p>
<pre><code class="language-toml">[voice.stt]
provider = "sherpa-onnx"

[voice.stt.sherpa_onnx]
model_dir = "~/.moltis/models/sherpa-onnx-whisper-tiny.en"
</code></pre>
</li>
</ol>
<h3 id="rpc-methods-1"><a class="header" href="#rpc-methods-1">RPC Methods</a></h3>
<h4 id="sttstatus"><a class="header" href="#sttstatus"><code>stt.status</code></a></h4>
<p>Get current STT status.</p>
<p><strong>Response:</strong></p>
<pre><code class="language-json">{
  "enabled": true,
  "provider": "whisper",
  "configured": true
}
</code></pre>
<h4 id="sttproviders"><a class="header" href="#sttproviders"><code>stt.providers</code></a></h4>
<p>List available STT providers.</p>
<p><strong>Response:</strong></p>
<pre><code class="language-json">[
  { "id": "whisper", "name": "OpenAI Whisper", "configured": true },
  { "id": "groq", "name": "Groq", "configured": false },
  { "id": "deepgram", "name": "Deepgram", "configured": false },
  { "id": "google", "name": "Google Cloud", "configured": false },
  { "id": "mistral", "name": "Mistral AI", "configured": false },
  { "id": "voxtral-local", "name": "Voxtral (Local)", "configured": false },
  { "id": "whisper-cli", "name": "whisper.cpp", "configured": false },
  { "id": "sherpa-onnx", "name": "sherpa-onnx", "configured": false }
]
</code></pre>
<h4 id="stttranscribe"><a class="header" href="#stttranscribe"><code>stt.transcribe</code></a></h4>
<p>Transcribe audio to text.</p>
<p><strong>Request:</strong></p>
<pre><code class="language-json">{
  "audio": "base64-encoded-audio-data",
  "format": "mp3",
  "language": "en",
  "prompt": "Technical discussion about Rust programming"
}
</code></pre>
<p><strong>Response:</strong></p>
<pre><code class="language-json">{
  "text": "Hello, how are you today?",
  "language": "en",
  "confidence": null,
  "durationSeconds": 2.5,
  "words": [
    { "word": "Hello", "start": 0.0, "end": 0.5 },
    { "word": "how", "start": 0.6, "end": 0.8 },
    { "word": "are", "start": 0.9, "end": 1.0 },
    { "word": "you", "start": 1.1, "end": 1.3 },
    { "word": "today", "start": 1.4, "end": 1.8 }
  ]
}
</code></pre>
<p><strong>Parameters:</strong></p>
<ul>
<li><code>audio</code> (required): Base64-encoded audio data</li>
<li><code>format</code>: Audio format (<code>mp3</code>, <code>opus</code>, <code>ogg</code>, <code>aac</code>, <code>pcm</code>)</li>
<li><code>language</code>: ISO 639-1 code to improve accuracy</li>
<li><code>prompt</code>: Context hint (terminology, topic)</li>
</ul>
<h4 id="sttsetprovider"><a class="header" href="#sttsetprovider"><code>stt.setProvider</code></a></h4>
<p>Change the active STT provider.</p>
<p><strong>Request:</strong></p>
<pre><code class="language-json">{ "provider": "groq" }
</code></pre>
<p>Valid provider IDs: <code>whisper</code>, <code>groq</code>, <code>deepgram</code>, <code>google</code>, <code>mistral</code>, <code>voxtral-local</code>, <code>whisper-cli</code>, <code>sherpa-onnx</code></p>
<h2 id="code-structure"><a class="header" href="#code-structure">Code Structure</a></h2>
<h3 id="voice-crate-cratesvoice"><a class="header" href="#voice-crate-cratesvoice">Voice Crate (<code>crates/voice/</code>)</a></h3>
<pre><code>src/
â”œâ”€â”€ lib.rs           # Crate entry, re-exports
â”œâ”€â”€ config.rs        # VoiceConfig, TtsConfig, SttConfig
â”œâ”€â”€ tts/
â”‚   â”œâ”€â”€ mod.rs       # TtsProvider trait, AudioFormat, types
â”‚   â”œâ”€â”€ elevenlabs.rs # ElevenLabs implementation
â”‚   â”œâ”€â”€ openai.rs    # OpenAI TTS implementation
â”‚   â”œâ”€â”€ google.rs    # Google Cloud TTS implementation
â”‚   â”œâ”€â”€ piper.rs     # Piper local TTS implementation
â”‚   â””â”€â”€ coqui.rs     # Coqui TTS server implementation
â””â”€â”€ stt/
    â”œâ”€â”€ mod.rs          # SttProvider trait, Transcript types
    â”œâ”€â”€ whisper.rs      # OpenAI Whisper implementation
    â”œâ”€â”€ groq.rs         # Groq Whisper implementation
    â”œâ”€â”€ deepgram.rs     # Deepgram implementation
    â”œâ”€â”€ google.rs       # Google Cloud Speech-to-Text
    â”œâ”€â”€ mistral.rs      # Mistral AI Voxtral cloud implementation
    â”œâ”€â”€ voxtral_local.rs # Voxtral via local vLLM server
    â”œâ”€â”€ cli_utils.rs    # Shared utilities for CLI providers
    â”œâ”€â”€ whisper_cli.rs  # whisper.cpp CLI wrapper
    â””â”€â”€ sherpa_onnx.rs  # sherpa-onnx CLI wrapper
</code></pre>
<h3 id="key-traits"><a class="header" href="#key-traits">Key Traits</a></h3>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>/// Text-to-Speech provider trait
#[async_trait]
pub trait TtsProvider: Send + Sync {
    fn id(&amp;self) -&gt; &amp;'static str;
    fn name(&amp;self) -&gt; &amp;'static str;
    fn is_configured(&amp;self) -&gt; bool;
    async fn voices(&amp;self) -&gt; Result&lt;Vec&lt;Voice&gt;&gt;;
    async fn synthesize(&amp;self, request: SynthesizeRequest) -&gt; Result&lt;AudioOutput&gt;;
}

/// Speech-to-Text provider trait
#[async_trait]
pub trait SttProvider: Send + Sync {
    fn id(&amp;self) -&gt; &amp;'static str;
    fn name(&amp;self) -&gt; &amp;'static str;
    fn is_configured(&amp;self) -&gt; bool;
    async fn transcribe(&amp;self, request: TranscribeRequest) -&gt; Result&lt;Transcript&gt;;
}
<span class="boring">}</span></code></pre></pre>
<h3 id="gateway-integration-cratesgatewaysrcvoicers"><a class="header" href="#gateway-integration-cratesgatewaysrcvoicers">Gateway Integration (<code>crates/gateway/src/voice.rs</code>)</a></h3>
<ul>
<li><code>LiveTtsService</code>: Wraps TTS providers, implements <code>TtsService</code> trait</li>
<li><code>LiveSttService</code>: Wraps STT providers, implements <code>SttService</code> trait</li>
<li><code>NoopSttService</code>: No-op for when STT is not configured</li>
</ul>
<h2 id="security-1"><a class="header" href="#security-1">Security</a></h2>
<ul>
<li>API keys are stored using <code>secrecy::Secret&lt;String&gt;</code> to prevent accidental logging</li>
<li>Debug output redacts all secret values</li>
<li>Keys can be set via environment variables or config file</li>
</ul>
<h2 id="adding-new-providers"><a class="header" href="#adding-new-providers">Adding New Providers</a></h2>
<h3 id="tts-provider"><a class="header" href="#tts-provider">TTS Provider</a></h3>
<ol>
<li>Create <code>crates/voice/src/tts/newprovider.rs</code></li>
<li>Implement <code>TtsProvider</code> trait</li>
<li>Re-export from <code>crates/voice/src/tts/mod.rs</code></li>
<li>Add to <code>LiveTtsService</code> in gateway</li>
</ol>
<h3 id="stt-provider"><a class="header" href="#stt-provider">STT Provider</a></h3>
<ol>
<li>Create <code>crates/voice/src/stt/newprovider.rs</code></li>
<li>Implement <code>SttProvider</code> trait</li>
<li>Re-export from <code>crates/voice/src/stt/mod.rs</code></li>
<li>Add to <code>LiveSttService</code> in gateway</li>
</ol>
<h2 id="web-ui-integration"><a class="header" href="#web-ui-integration">Web UI Integration</a></h2>
<p>The voice feature integrates with the web UI:</p>
<ul>
<li><strong>Microphone button</strong>: Record voice input in the chat interface</li>
<li><strong>Settings page</strong>: Configure and enable/disable voice providers</li>
<li><strong>Auto-detection</strong>: API keys are detected from environment variables and LLM provider configs</li>
<li><strong>Toggle switches</strong>: Enable/disable providers without removing configuration</li>
<li><strong>Setup instructions</strong>: Step-by-step guides for local provider installation</li>
</ul>
<h2 id="future-enhancements"><a class="header" href="#future-enhancements">Future Enhancements</a></h2>
<ul>
<li><strong>Streaming TTS</strong>: Chunked audio delivery for lower latency</li>
<li><strong>VoiceWake</strong>: Wake word detection and continuous listening</li>
<li><strong>Audio playback</strong>: Play TTS responses directly in the chat</li>
<li><strong>Channel Integration</strong>: Auto-transcribe Telegram voice messages</li>
<li><strong>Per-Agent Voices</strong>: Different voices for different agents</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="browser-automation"><a class="header" href="#browser-automation">Browser Automation</a></h1>
<p>Moltis provides full browser automation via Chrome DevTools Protocol (CDP),
enabling agents to interact with JavaScript-heavy websites, fill forms,
click buttons, and capture screenshots.</p>
<h2 id="overview-1"><a class="header" href="#overview-1">Overview</a></h2>
<p>Browser automation is useful when you need to:</p>
<ul>
<li>Interact with SPAs (Single Page Applications)</li>
<li>Fill forms and click buttons</li>
<li>Navigate sites that require JavaScript rendering</li>
<li>Take screenshots of pages</li>
<li>Execute JavaScript in page context</li>
<li>Maintain session state across multiple interactions</li>
</ul>
<p>For simple page content retrieval (static HTML), prefer <code>web_fetch</code> as itâ€™s
faster and more lightweight.</p>
<h2 id="architecture-4"><a class="header" href="#architecture-4">Architecture</a></h2>
<pre><code>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   BrowserTool   â”‚â”€â”€â”€â”€â–¶â”‚  BrowserManager â”‚â”€â”€â”€â”€â–¶â”‚   BrowserPool    â”‚
â”‚   (AgentTool)   â”‚     â”‚   (actions)     â”‚     â”‚   (instances)    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                                         â”‚
                                                         â–¼
                                                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                                â”‚  Chrome/Chromium â”‚
                                                â”‚     via CDP      â”‚
                                                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
</code></pre>
<h3 id="components"><a class="header" href="#components">Components</a></h3>
<ul>
<li><strong>BrowserTool</strong> (<code>crates/tools/src/browser.rs</code>) - AgentTool wrapper for LLM</li>
<li><strong>BrowserManager</strong> (<code>crates/browser/src/manager.rs</code>) - High-level action API</li>
<li><strong>BrowserPool</strong> (<code>crates/browser/src/pool.rs</code>) - Chrome instance management</li>
<li><strong>Snapshot</strong> (<code>crates/browser/src/snapshot.rs</code>) - DOM element extraction</li>
</ul>
<h2 id="configuration-7"><a class="header" href="#configuration-7">Configuration</a></h2>
<p>Browser automation is <strong>enabled by default</strong>. To customize, add to your <code>moltis.toml</code>:</p>
<pre><code class="language-toml">[tools.browser]
enabled = true              # Enable browser support
headless = true             # Run without visible window (default)
viewport_width = 2560       # Default viewport width
viewport_height = 1440      # Default viewport height
device_scale_factor = 2.0   # HiDPI/Retina scaling (1.0 = standard, 2.0 = Retina)

# Pool management
max_instances = 0           # 0 = unlimited (limited by memory), &gt;0 = hard limit
memory_limit_percent = 90   # Block new instances when memory exceeds this %
idle_timeout_secs = 300     # Close idle browsers after 5 min
navigation_timeout_ms = 30000  # Page load timeout

# Optional customization
# chrome_path = "/path/to/chrome"  # Custom Chrome path
# user_agent = "Custom UA"         # Custom user agent
# chrome_args = ["--disable-extensions"]  # Extra args

# Sandbox image (browser sandbox mode follows session sandbox mode)
sandbox_image = "browserless/chrome"  # Container image for sandboxed sessions
# allowed_domains = ["example.com", "*.trusted.org"]  # Restrict navigation
</code></pre>
<h3 id="memory-based-pool-limits"><a class="header" href="#memory-based-pool-limits">Memory-Based Pool Limits</a></h3>
<p>By default, browser instances are limited by system memory rather than a fixed count:</p>
<ul>
<li><code>max_instances = 0</code> (default): Unlimited instances, blocked only when memory
exceeds <code>memory_limit_percent</code></li>
<li><code>memory_limit_percent = 90</code>: New browsers blocked when system memory &gt; 90%</li>
<li>Set <code>max_instances &gt; 0</code> for a hard limit if you prefer fixed constraints</li>
</ul>
<p>This allows multiple chat sessions to each have their own browser without
artificial limits, while protecting system stability when memory is constrained.</p>
<h3 id="domain-restrictions"><a class="header" href="#domain-restrictions">Domain Restrictions</a></h3>
<p>For improved security, you can restrict which domains the browser can navigate to:</p>
<pre><code class="language-toml">[tools.browser]
allowed_domains = [
    "docs.example.com",    # Exact match
    "*.github.com",        # Wildcard: matches any subdomain
    "localhost",           # Allow localhost
]
</code></pre>
<p>When <code>allowed_domains</code> is set, any navigation to a domain not in the list will
be blocked with an error. Wildcards (<code>*.domain.com</code>) match any subdomain and
also the base domain itself.</p>
<h2 id="tool-usage"><a class="header" href="#tool-usage">Tool Usage</a></h2>
<h3 id="actions"><a class="header" href="#actions">Actions</a></h3>
<div class="table-wrapper"><table><thead><tr><th>Action</th><th>Description</th><th>Required Params</th></tr></thead><tbody>
<tr><td><code>navigate</code></td><td>Go to a URL</td><td><code>url</code></td></tr>
<tr><td><code>snapshot</code></td><td>Get DOM with element refs</td><td>-</td></tr>
<tr><td><code>screenshot</code></td><td>Capture page image</td><td><code>full_page</code> (optional)</td></tr>
<tr><td><code>click</code></td><td>Click element by ref</td><td><code>ref_</code></td></tr>
<tr><td><code>type</code></td><td>Type into element</td><td><code>ref_</code>, <code>text</code></td></tr>
<tr><td><code>scroll</code></td><td>Scroll page/element</td><td><code>x</code>, <code>y</code>, <code>ref_</code> (optional)</td></tr>
<tr><td><code>evaluate</code></td><td>Run JavaScript</td><td><code>code</code></td></tr>
<tr><td><code>wait</code></td><td>Wait for element</td><td><code>selector</code> or <code>ref_</code></td></tr>
<tr><td><code>get_url</code></td><td>Get current URL</td><td>-</td></tr>
<tr><td><code>get_title</code></td><td>Get page title</td><td>-</td></tr>
<tr><td><code>back</code></td><td>Go back in history</td><td>-</td></tr>
<tr><td><code>forward</code></td><td>Go forward in history</td><td>-</td></tr>
<tr><td><code>refresh</code></td><td>Reload the page</td><td>-</td></tr>
<tr><td><code>close</code></td><td>Close browser session</td><td>-</td></tr>
</tbody></table>
</div>
<h3 id="automatic-session-tracking"><a class="header" href="#automatic-session-tracking">Automatic Session Tracking</a></h3>
<p>The browser tool automatically tracks and reuses session IDs. After a <code>navigate</code>
action creates a session, subsequent actions will reuse it without needing to
pass <code>session_id</code> explicitly:</p>
<pre><code class="language-json">// 1. Navigate (creates session)
{ "action": "navigate", "url": "https://example.com" }

// 2. Snapshot (session_id auto-injected)
{ "action": "snapshot" }

// 3. Click (session_id auto-injected)
{ "action": "click", "ref_": 1 }

// 4. Screenshot (session_id auto-injected)
{ "action": "screenshot" }

// 5. Close (clears tracked session)
{ "action": "close" }
</code></pre>
<p>This prevents pool exhaustion from LLMs that forget to pass the session_id.</p>
<h3 id="browser-selection"><a class="header" href="#browser-selection">Browser selection</a></h3>
<p>You can ask for a specific browser at runtime (host mode):</p>
<pre><code class="language-json">{ "action": "navigate", "url": "https://example.com", "browser": "brave" }
</code></pre>
<p>Supported values: <code>auto</code>, <code>chrome</code>, <code>chromium</code>, <code>edge</code>, <code>brave</code>, <code>opera</code>,
<code>vivaldi</code>, <code>arc</code>.</p>
<p><code>auto</code> (default) picks the first detected installed browser. If none are
installed, Moltis will attempt a best-effort auto-install, then retry
detection.</p>
<h3 id="workflow-example"><a class="header" href="#workflow-example">Workflow Example</a></h3>
<pre><code class="language-json">// 1. Navigate to a page
{
  "action": "navigate",
  "url": "https://example.com/login"
}
// Returns: { "session_id": "browser-abc123", "url": "https://..." }

// 2. Get interactive elements (session_id optional - auto-tracked)
{
  "action": "snapshot"
}
// Returns element refs like:
// { "elements": [
//   { "ref_": 1, "tag": "input", "role": "textbox", "placeholder": "Email" },
//   { "ref_": 2, "tag": "input", "role": "textbox", "placeholder": "Password" },
//   { "ref_": 3, "tag": "button", "role": "button", "text": "Sign In" }
// ]}

// 3. Fill in the form
{
  "action": "type",
  "ref_": 1,
  "text": "user@example.com"
}

{
  "action": "type",
  "ref_": 2,
  "text": "password123"
}

// 4. Click the submit button
{
  "action": "click",
  "ref_": 3
}

// 5. Take a screenshot of the result
{
  "action": "screenshot"
}
// Returns: { "screenshot": "data:image/png;base64,..." }
</code></pre>
<h2 id="element-reference-system"><a class="header" href="#element-reference-system">Element Reference System</a></h2>
<p>The snapshot action extracts interactive elements and assigns them numeric
references. This approach (inspired by <a href="https://docs.openclaw.ai">OpenClaw</a>)
provides:</p>
<ul>
<li><strong>Stability</strong>: References donâ€™t break with minor page updates</li>
<li><strong>Security</strong>: No CSS selectors exposed to the model</li>
<li><strong>Reliability</strong>: Elements identified by role/content, not fragile paths</li>
</ul>
<h3 id="extracted-element-info"><a class="header" href="#extracted-element-info">Extracted Element Info</a></h3>
<pre><code class="language-json">{
  "ref_": 1,
  "tag": "button",
  "role": "button",
  "text": "Submit",
  "href": null,
  "placeholder": null,
  "value": null,
  "aria_label": "Submit form",
  "visible": true,
  "interactive": true,
  "bounds": { "x": 100, "y": 200, "width": 80, "height": 40 }
}
</code></pre>
<h2 id="comparison-browser-vs-web-fetch"><a class="header" href="#comparison-browser-vs-web-fetch">Comparison: Browser vs Web Fetch</a></h2>
<div class="table-wrapper"><table><thead><tr><th>Feature</th><th><code>web_fetch</code></th><th><code>browser</code></th></tr></thead><tbody>
<tr><td>Speed</td><td>Fast</td><td>Slower</td></tr>
<tr><td>Resources</td><td>Minimal</td><td>Chrome instance</td></tr>
<tr><td>JavaScript</td><td>No</td><td>Yes</td></tr>
<tr><td>Forms/clicks</td><td>No</td><td>Yes</td></tr>
<tr><td>Screenshots</td><td>No</td><td>Yes</td></tr>
<tr><td>Sessions</td><td>No</td><td>Yes</td></tr>
<tr><td>Use case</td><td>Static content</td><td>Interactive sites</td></tr>
</tbody></table>
</div>
<p><strong>When to use <code>web_fetch</code>:</strong></p>
<ul>
<li>Reading documentation</li>
<li>Fetching API responses</li>
<li>Scraping static HTML</li>
</ul>
<p><strong>When to use <code>browser</code>:</strong></p>
<ul>
<li>Logging into websites</li>
<li>Filling forms</li>
<li>Interacting with SPAs</li>
<li>Sites that require JavaScript</li>
<li>Taking screenshots</li>
</ul>
<h2 id="metrics"><a class="header" href="#metrics">Metrics</a></h2>
<p>When the <code>metrics</code> feature is enabled, the browser module records:</p>
<div class="table-wrapper"><table><thead><tr><th>Metric</th><th>Description</th></tr></thead><tbody>
<tr><td><code>moltis_browser_instances_active</code></td><td>Currently running browsers</td></tr>
<tr><td><code>moltis_browser_instances_created_total</code></td><td>Total browsers launched</td></tr>
<tr><td><code>moltis_browser_instances_destroyed_total</code></td><td>Total browsers closed</td></tr>
<tr><td><code>moltis_browser_screenshots_total</code></td><td>Screenshots taken</td></tr>
<tr><td><code>moltis_browser_navigation_duration_seconds</code></td><td>Page load time histogram</td></tr>
<tr><td><code>moltis_browser_errors_total</code></td><td>Errors by type</td></tr>
</tbody></table>
</div>
<h2 id="sandbox-mode"><a class="header" href="#sandbox-mode">Sandbox Mode</a></h2>
<p>Browser sandbox mode <strong>automatically follows the sessionâ€™s sandbox mode</strong>. When
a chat session uses sandbox mode (controlled by <code>[tools.exec.sandbox]</code>), the
browser tool will also run in a sandboxed container. When the session is not
sandboxed, the browser runs directly on the host.</p>
<h3 id="host-mode"><a class="header" href="#host-mode">Host Mode</a></h3>
<p>When the session is not sandboxed (or sandbox mode is â€œoffâ€), Chrome runs
directly on the host machine. This is faster but the browser has full access
to the host network and filesystem.</p>
<h3 id="sandbox-mode-1"><a class="header" href="#sandbox-mode-1">Sandbox Mode</a></h3>
<p>When the session is sandboxed, Chrome runs inside a Docker container with:</p>
<ul>
<li><strong>Network isolation</strong>: Browser can access the internet but not local services</li>
<li><strong>Filesystem isolation</strong>: No access to host filesystem</li>
<li><strong>Automatic lifecycle</strong>: Container started/stopped with browser session</li>
<li><strong>Readiness detection</strong>: Waits for Chrome to be fully ready before connecting</li>
</ul>
<pre><code class="language-toml">[tools.browser]
sandbox_image = "browserless/chrome"  # Container image for sandboxed sessions
</code></pre>
<p>Requirements:</p>
<ul>
<li>Docker or Apple Container must be installed and running</li>
<li>The container image is pulled automatically on first use</li>
<li>Session sandbox mode must be enabled (<code>[tools.exec.sandbox] mode = "all"</code>)</li>
</ul>
<h3 id="exec-tool-scripts"><a class="header" href="#exec-tool-scripts">Exec Tool Scripts</a></h3>
<p>If agents need to run browser automation <strong>scripts</strong> (Puppeteer, Playwright,
Selenium) inside the command sandbox, Chromium is included in the default
sandbox packages:</p>
<pre><code class="language-bash"># Inside sandbox (via exec tool)
chromium --headless --no-sandbox --dump-dom https://example.com
</code></pre>
<p>Or use Puppeteer/Playwright in a Node.js script executed via the <code>exec</code> tool.</p>
<h2 id="security-considerations-1"><a class="header" href="#security-considerations-1">Security Considerations</a></h2>
<h3 id="prompt-injection-risk"><a class="header" href="#prompt-injection-risk">Prompt Injection Risk</a></h3>
<p><strong>Important</strong>: Web pages can contain content designed to manipulate LLM behavior
(prompt injection). When the browser tool returns page content to the LLM,
malicious sites could attempt to inject instructions.</p>
<p><strong>Mitigations</strong>:</p>
<ol>
<li>
<p><strong>Domain restrictions</strong>: Use <code>allowed_domains</code> to limit navigation to trusted
sites only. This is the most effective mitigation.</p>
</li>
<li>
<p><strong>Review returned content</strong>: The snapshot action returns element text which
could contain injected prompts. Be cautious with untrusted sites.</p>
</li>
<li>
<p><strong>Sandbox mode</strong>: Use sandboxed sessions to run the browser in an isolated
Docker container for additional security. Browser sandbox follows session
sandbox mode automatically.</p>
</li>
</ol>
<h3 id="other-security-considerations"><a class="header" href="#other-security-considerations">Other Security Considerations</a></h3>
<ol>
<li>
<p><strong>Host vs Sandbox mode</strong>: Browser sandbox mode follows the sessionâ€™s sandbox
mode. For sandboxed sessions, the browser runs in a Docker container with
network/filesystem isolation. For non-sandboxed sessions, the browser runs
on the host with <code>--no-sandbox</code> for container compatibility.</p>
</li>
<li>
<p><strong>Resource limits</strong>: Browser instances are limited by memory usage (default:
block when &gt; 90% used). Set <code>max_instances &gt; 0</code> for a hard limit.</p>
</li>
<li>
<p><strong>Idle cleanup</strong>: Browsers are automatically closed after <code>idle_timeout_secs</code>
of inactivity.</p>
</li>
<li>
<p><strong>Network access</strong>: In host mode, the browser has full network access. In
sandbox mode, the browser can reach the internet but not local services.
Use firewall rules for additional restrictions.</p>
</li>
<li>
<p><strong>Sandbox scripts</strong>: Browser scripts running in the exec sandbox (Puppeteer,
Playwright) inherit sandbox network restrictions (<code>no_network: true</code> by default).</p>
</li>
</ol>
<h2 id="browser-detection"><a class="header" href="#browser-detection">Browser Detection</a></h2>
<p>Moltis automatically detects installed Chromium-based browsers in the following order:</p>
<ol>
<li><strong>Custom path</strong> from <code>chrome_path</code> config</li>
<li><strong>CHROME environment variable</strong></li>
<li><strong>Platform-specific app bundles</strong> (macOS/Windows)
<ul>
<li>macOS: <code>/Applications/Google Chrome.app</code>, <code>/Applications/Chromium.app</code>, etc.</li>
<li>Windows: <code>C:\Program Files\Google\Chrome\Application\chrome.exe</code>, etc.</li>
</ul>
</li>
<li><strong>PATH executables</strong> (fallback): <code>chrome</code>, <code>chromium</code>, <code>msedge</code>, <code>brave</code>, etc.</li>
</ol>
<p>If no browser is found, Moltis displays platform-specific installation instructions.</p>
<h3 id="supported-browsers"><a class="header" href="#supported-browsers">Supported Browsers</a></h3>
<p>Any Chromium-based browser works:</p>
<ul>
<li>Google Chrome</li>
<li>Chromium</li>
<li>Microsoft Edge</li>
<li>Brave</li>
<li>Opera</li>
<li>Vivaldi</li>
<li>Arc (macOS)</li>
</ul>
<h2 id="screenshot-display"><a class="header" href="#screenshot-display">Screenshot Display</a></h2>
<p>When the browser tool takes a screenshot, itâ€™s displayed in the chat UI:</p>
<ul>
<li><strong>Thumbnail view</strong>: Screenshots appear as clickable thumbnails (200Ã—150px max)</li>
<li><strong>Fullscreen lightbox</strong>: Click to view full-size with dark overlay</li>
<li><strong>Scrollable view</strong>: Long screenshots can be scrolled within the lightbox</li>
<li><strong>Download button</strong>: Save screenshot to disk (top of lightbox)</li>
<li><strong>Close button</strong>: Click âœ• button, click outside, or press Escape to close</li>
<li><strong>HiDPI scaling</strong>: Screenshots display at correct size on Retina displays</li>
</ul>
<p>Screenshots are base64-encoded PNGs returned in the tool result. The
<code>device_scale_factor</code> config (default: 2.0) controls the rendering resolution
for high-DPI displays.</p>
<h3 id="telegram-integration-1"><a class="header" href="#telegram-integration-1">Telegram Integration</a></h3>
<p>When using the Telegram channel, screenshots are automatically sent to the chat:</p>
<ul>
<li>Images sent as photos when dimensions are within Telegram limits</li>
<li>Automatically retried as documents for oversized images (aspect ratio &gt; 20)</li>
<li>Error messages sent to channel if delivery fails</li>
</ul>
<h2 id="handling-model-errors"><a class="header" href="#handling-model-errors">Handling Model Errors</a></h2>
<p>Some models (particularly Claude via GitHub Copilot) occasionally send malformed
tool calls with missing required fields. Moltis handles this gracefully:</p>
<ul>
<li><strong>Default action</strong>: If <code>url</code> is provided but <code>action</code> is missing, defaults to
<code>navigate</code></li>
<li><strong>Automatic retry</strong>: The agent loop retries with corrected arguments</li>
<li><strong>Muted error display</strong>: Validation errors show as muted/informational cards
in the UI (60% opacity, gray text) to indicate theyâ€™re expected, not alarming</li>
</ul>
<h2 id="troubleshooting-4"><a class="header" href="#troubleshooting-4">Troubleshooting</a></h2>
<h3 id="browser-not-launching"><a class="header" href="#browser-not-launching">Browser not launching</a></h3>
<ul>
<li>Ensure Chrome/Chromium is installed</li>
<li>Check <code>chrome_path</code> in config if using custom location</li>
<li>Set <code>CHROME</code> environment variable to specify browser path</li>
<li>On Linux, install dependencies: <code>apt-get install chromium-browser</code></li>
<li>On macOS, if using Homebrew Chromium, prefer installing Google Chrome or Brave
(the Homebrew chromium wrapper can be unreliable)</li>
</ul>
<h3 id="elements-not-found"><a class="header" href="#elements-not-found">Elements not found</a></h3>
<ul>
<li>Use <code>snapshot</code> to see available elements</li>
<li>Elements must be visible in the viewport</li>
<li>Some elements may need scrolling first</li>
</ul>
<h3 id="timeouts"><a class="header" href="#timeouts">Timeouts</a></h3>
<ul>
<li>Increase <code>navigation_timeout_ms</code> for slow pages</li>
<li>Use <code>wait</code> action to wait for dynamic content</li>
<li>Check network connectivity</li>
</ul>
<h3 id="high-memory-usage"><a class="header" href="#high-memory-usage">High memory usage</a></h3>
<ul>
<li>Browser instances are now limited by memory (blocks at 90% by default)</li>
<li>Set <code>max_instances &gt; 0</code> for a hard limit if preferred</li>
<li>Lower <code>idle_timeout_secs</code> to clean up faster</li>
<li>Consider enabling headless mode if not already</li>
</ul>
<h3 id="pool-exhaustion"><a class="header" href="#pool-exhaustion">Pool exhaustion</a></h3>
<ul>
<li>Browser tool now auto-tracks session IDs, preventing pool exhaustion from
LLMs that forget to pass session_id</li>
<li>If you still hit limits, check <code>memory_limit_percent</code> threshold</li>
<li>Use <code>close</code> action when done to free up sessions</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="session-state"><a class="header" href="#session-state">Session State</a></h1>
<p>Moltis provides a per-session key-value store that allows skills, extensions,
and the agent itself to persist context across messages within a session.</p>
<h2 id="overview-2"><a class="header" href="#overview-2">Overview</a></h2>
<p>Session state is scoped to a <code>(session_key, namespace, key)</code> triple, backed by
SQLite. Each entry stores a string value and is automatically timestamped.</p>
<p>The agent accesses state through the <code>session_state</code> tool, which supports three
operations: <code>get</code>, <code>set</code>, and <code>list</code>.</p>
<h2 id="agent-tool"><a class="header" href="#agent-tool">Agent Tool</a></h2>
<p>The <code>session_state</code> tool is registered as a built-in tool and available in every
session.</p>
<h3 id="get-a-value"><a class="header" href="#get-a-value">Get a value</a></h3>
<pre><code class="language-json">{
  "op": "get",
  "namespace": "my-skill",
  "key": "last_query"
}
</code></pre>
<h3 id="set-a-value"><a class="header" href="#set-a-value">Set a value</a></h3>
<pre><code class="language-json">{
  "op": "set",
  "namespace": "my-skill",
  "key": "last_query",
  "value": "SELECT * FROM users"
}
</code></pre>
<h3 id="list-all-keys-in-a-namespace"><a class="header" href="#list-all-keys-in-a-namespace">List all keys in a namespace</a></h3>
<pre><code class="language-json">{
  "op": "list",
  "namespace": "my-skill"
}
</code></pre>
<h2 id="namespacing"><a class="header" href="#namespacing">Namespacing</a></h2>
<p>Every state entry belongs to a namespace. This prevents collisions between
different skills or extensions using state in the same session. Use your skill
name as the namespace.</p>
<h2 id="storage"><a class="header" href="#storage">Storage</a></h2>
<p>State is stored in the <code>session_state</code> table in the main SQLite database
(<code>moltis.db</code>). The migration is in
<code>crates/sessions/migrations/20260205120000_session_state.sql</code>.</p>
<div id="admonition-tip" class="admonition admonish-tip" role="note" aria-labelledby="admonition-tip-title">
<div class="admonition-title">
<div id="admonition-tip-title">
<p>Tip</p>
</div>
<a class="admonition-anchor-link" href="session-state.html#admonition-tip"></a>
</div>
<div>
<p>State values are strings. To store structured data, serialize to JSON before
writing and parse after reading.</p>
</div>
</div>
<div style="break-before: page; page-break-before: always;"></div><h1 id="session-branching"><a class="header" href="#session-branching">Session Branching</a></h1>
<p>Session branching (forking) lets you create an independent copy of a
conversation at any point. The new session diverges without affecting the
original â€” useful for exploring alternative approaches, running â€œwhat ifâ€
scenarios, or preserving a checkpoint before a risky prompt.</p>
<h2 id="forking-from-the-ui"><a class="header" href="#forking-from-the-ui">Forking from the UI</a></h2>
<p>There are two ways to fork a session in the web UI:</p>
<ul>
<li><strong>Chat header</strong> â€” click the <strong>Fork</strong> button in the header bar (next to
Delete). This is visible for every session except cron sessions.</li>
<li><strong>Sidebar</strong> â€” hover over a session in the sidebar and click the fork icon
that appears in the action buttons.</li>
</ul>
<p>Both create a new session that copies all messages from the current one and
immediately switch you to it.</p>
<p>Forked sessions appear <strong>indented</strong> under their parent in the sidebar, with a
branch icon to distinguish them from top-level sessions. The metadata line
shows <code>fork@N</code> where N is the message index at which the fork occurred.</p>
<h2 id="agent-tool-1"><a class="header" href="#agent-tool-1">Agent Tool</a></h2>
<p>The agent can also fork programmatically using the <code>branch_session</code> tool:</p>
<pre><code class="language-json">{
  "at_message": 5,
  "label": "explore-alternative"
}
</code></pre>
<ul>
<li><strong><code>at_message</code></strong> â€” the message index to fork at (messages 0..N are copied).
If omitted, all messages are copied.</li>
<li><strong><code>label</code></strong> â€” optional human-readable label for the new session.</li>
</ul>
<p>The tool returns the new session key.</p>
<h2 id="rpc-method"><a class="header" href="#rpc-method">RPC Method</a></h2>
<p>The <code>sessions.fork</code> RPC method is the underlying mechanism:</p>
<pre><code class="language-json">{ "key": "main", "at_message": 5, "label": "my-fork" }
</code></pre>
<p>On success the response payload contains <code>{ "sessionKey": "session:&lt;uuid&gt;" }</code>.</p>
<h2 id="what-gets-inherited"><a class="header" href="#what-gets-inherited">What Gets Inherited</a></h2>
<p>When forking, the new session inherits:</p>
<div class="table-wrapper"><table><thead><tr><th>Inherited</th><th>Not inherited</th></tr></thead><tbody>
<tr><td>Messages (up to fork point)</td><td>Worktree branch</td></tr>
<tr><td>Model selection</td><td>Sandbox settings</td></tr>
<tr><td>Project assignment</td><td>Channel binding</td></tr>
<tr><td>MCP disabled flag</td><td></td></tr>
</tbody></table>
</div>
<h2 id="parent-child-relationships"><a class="header" href="#parent-child-relationships">Parent-Child Relationships</a></h2>
<p>Fork relationships are stored directly on the <code>sessions</code> table:</p>
<ul>
<li><strong><code>parent_session_key</code></strong> â€” the key of the session this was forked from.</li>
<li><strong><code>fork_point</code></strong> â€” the message index where the fork occurred.</li>
</ul>
<p>These fields drive the tree rendering in the sidebar. Sessions with a parent
appear indented under it; deeply nested forks indent further.</p>
<div id="admonition-deleting-a-parent" class="admonition admonish-warning" role="note" aria-labelledby="admonition-deleting-a-parent-title">
<div class="admonition-title">
<div id="admonition-deleting-a-parent-title">
<p>Deleting a parent</p>
</div>
<a class="admonition-anchor-link" href="session-branching.html#admonition-deleting-a-parent"></a>
</div>
<div>
<p>Deleting a parent session does <strong>not</strong> cascade to its children. Child sessions
become top-level sessions â€” they keep their messages and history but lose
their visual nesting in the sidebar.</p>
</div>
</div>
<h2 id="navigation-after-delete"><a class="header" href="#navigation-after-delete">Navigation After Delete</a></h2>
<p>When you delete a forked session, the UI navigates back to its parent session.
If the deleted session had no parent (or the parent no longer exists), it falls
back to the next sibling or <code>main</code>.</p>
<div id="admonition-independence" class="admonition admonish-info" role="note" aria-labelledby="admonition-independence-title">
<div class="admonition-title">
<div id="admonition-independence-title">
<p>Independence</p>
</div>
<a class="admonition-anchor-link" href="session-branching.html#admonition-independence"></a>
</div>
<div>
<p>A forked session is fully independent after creation. Changes to the parent
do not propagate to the fork, and vice versa.</p>
</div>
</div>
<div style="break-before: page; page-break-before: always;"></div><h1 id="skill-self-extension"><a class="header" href="#skill-self-extension">Skill Self-Extension</a></h1>
<p>Moltis can create, update, and delete skills at runtime through agent tools,
enabling the system to extend its own capabilities during a conversation.</p>
<h2 id="overview-3"><a class="header" href="#overview-3">Overview</a></h2>
<p>Three agent tools manage project-local skills:</p>
<div class="table-wrapper"><table><thead><tr><th>Tool</th><th>Description</th></tr></thead><tbody>
<tr><td><code>create_skill</code></td><td>Write a new <code>SKILL.md</code> to <code>.moltis/skills/&lt;name&gt;/</code></td></tr>
<tr><td><code>update_skill</code></td><td>Overwrite an existing skillâ€™s <code>SKILL.md</code></td></tr>
<tr><td><code>delete_skill</code></td><td>Remove a skill directory</td></tr>
</tbody></table>
</div>
<p>Skills created this way are project-local and stored in the working directoryâ€™s
<code>.moltis/skills/</code> folder. They become available on the next message
automatically thanks to the skill watcher.</p>
<h2 id="skill-watcher"><a class="header" href="#skill-watcher">Skill Watcher</a></h2>
<p>The skill watcher (<code>crates/skills/src/watcher.rs</code>) monitors skill directories
for filesystem changes using debounced notifications. When a <code>SKILL.md</code> file is
created, modified, or deleted, the watcher emits a <code>skills.changed</code> event via
the WebSocket event bus so the UI can refresh.</p>
<div id="admonition-tip" class="admonition admonish-tip" role="note" aria-labelledby="admonition-tip-title">
<div class="admonition-title">
<div id="admonition-tip-title">
<p>Tip</p>
</div>
<a class="admonition-anchor-link" href="skill-tools.html#admonition-tip"></a>
</div>
<div>
<p>The watcher uses debouncing to avoid firing multiple events for rapid
successive edits (e.g. an editor writing a temp file then renaming).</p>
</div>
</div>
<h2 id="creating-a-skill"><a class="header" href="#creating-a-skill">Creating a Skill</a></h2>
<p>The agent can create a skill by calling the <code>create_skill</code> tool:</p>
<pre><code class="language-json">{
  "name": "summarize-pr",
  "content": "# summarize-pr\n\nSummarize a GitHub pull request...",
  "description": "Summarize GitHub PRs with key changes and review notes"
}
</code></pre>
<p>This writes <code>.moltis/skills/summarize-pr/SKILL.md</code> with the provided content.
The skill discoverer picks it up on the next message.</p>
<h2 id="updating-a-skill"><a class="header" href="#updating-a-skill">Updating a Skill</a></h2>
<pre><code class="language-json">{
  "name": "summarize-pr",
  "content": "# summarize-pr\n\nUpdated instructions..."
}
</code></pre>
<h2 id="deleting-a-skill"><a class="header" href="#deleting-a-skill">Deleting a Skill</a></h2>
<pre><code class="language-json">{
  "name": "summarize-pr"
}
</code></pre>
<p>This removes the entire <code>.moltis/skills/summarize-pr/</code> directory.</p>
<div id="admonition-warning" class="admonition admonish-warning" role="note" aria-labelledby="admonition-warning-title">
<div class="admonition-title">
<div id="admonition-warning-title">
<p>Warning</p>
</div>
<a class="admonition-anchor-link" href="skill-tools.html#admonition-warning"></a>
</div>
<div>
<p>Deleted skills cannot be recovered. The agent should confirm with the user
before deleting a skill.</p>
</div>
</div>
<div style="break-before: page; page-break-before: always;"></div><h1 id="mobile-pwa-and-push-notifications"><a class="header" href="#mobile-pwa-and-push-notifications">Mobile PWA and Push Notifications</a></h1>
<p>Moltis can be installed as a Progressive Web App (PWA) on mobile devices, providing a native app-like experience with push notifications.</p>
<h2 id="installing-on-mobile"><a class="header" href="#installing-on-mobile">Installing on Mobile</a></h2>
<h3 id="ios-safari"><a class="header" href="#ios-safari">iOS (Safari)</a></h3>
<ol>
<li>Open moltis in Safari</li>
<li>Tap the Share button (box with arrow)</li>
<li>Scroll down and tap â€œAdd to Home Screenâ€</li>
<li>Tap â€œAddâ€ to confirm</li>
</ol>
<p>The app will appear on your home screen with the moltis icon.</p>
<h3 id="android-chrome"><a class="header" href="#android-chrome">Android (Chrome)</a></h3>
<ol>
<li>Open moltis in Chrome</li>
<li>You should see an install banner at the bottom - tap â€œInstallâ€</li>
<li>Or tap the three-dot menu and select â€œInstall appâ€ or â€œAdd to Home Screenâ€</li>
<li>Tap â€œInstallâ€ to confirm</li>
</ol>
<p>The app will appear in your app drawer and home screen.</p>
<h2 id="pwa-features"><a class="header" href="#pwa-features">PWA Features</a></h2>
<p>When installed as a PWA, moltis provides:</p>
<ul>
<li><strong>Standalone mode</strong>: Full-screen experience without browser UI</li>
<li><strong>Offline support</strong>: Previously loaded content remains accessible</li>
<li><strong>Fast loading</strong>: Assets are cached locally</li>
<li><strong>Home screen icon</strong>: Quick access from your deviceâ€™s home screen</li>
<li><strong>Safe area support</strong>: Proper spacing for notched devices (iPhone X+)</li>
</ul>
<h2 id="push-notifications"><a class="header" href="#push-notifications">Push Notifications</a></h2>
<p>Push notifications allow you to receive alerts when the LLM responds, even when youâ€™re not actively viewing the app.</p>
<h3 id="enabling-push-notifications"><a class="header" href="#enabling-push-notifications">Enabling Push Notifications</a></h3>
<ol>
<li>Open the moltis app (must be installed as PWA on Safari/iOS)</li>
<li>Go to <strong>Settings &gt; Notifications</strong></li>
<li>Click <strong>Enable</strong> to subscribe to push notifications</li>
<li>When prompted, allow notification permissions</li>
</ol>
<p><strong>Safari/iOS Note</strong>: Push notifications only work when the app is installed as a PWA. If you see â€œInstallation requiredâ€, add moltis to your Dock first:</p>
<ul>
<li><strong>macOS</strong>: File â†’ Add to Dock</li>
<li><strong>iOS</strong>: Share â†’ Add to Home Screen</li>
</ul>
<h3 id="managing-subscriptions"><a class="header" href="#managing-subscriptions">Managing Subscriptions</a></h3>
<p>The Settings &gt; Notifications page shows all subscribed devices:</p>
<ul>
<li><strong>Device name</strong>: Parsed from user agent (e.g., â€œSafari on macOSâ€, â€œiPhoneâ€)</li>
<li><strong>IP address</strong>: Client IP at subscription time (supports proxies via X-Forwarded-For)</li>
<li><strong>Subscription date</strong>: When the device subscribed</li>
</ul>
<p>You can remove any subscription by clicking the <strong>Remove</strong> button. This works from any device - useful for revoking access to old devices.</p>
<p>Subscription changes are broadcast in real-time via WebSocket, so all connected clients see updates immediately.</p>
<h3 id="how-it-works-2"><a class="header" href="#how-it-works-2">How It Works</a></h3>
<p>Moltis uses the Web Push API with VAPID (Voluntary Application Server Identification) keys:</p>
<ol>
<li><strong>VAPID Keys</strong>: On first run, the server generates a P-256 ECDSA key pair</li>
<li><strong>Subscription</strong>: The browser creates a push subscription using the serverâ€™s public key</li>
<li><strong>Registration</strong>: The subscription details are sent to the server and stored</li>
<li><strong>Notification</strong>: When you need to be notified, the server encrypts and sends a push message</li>
</ol>
<h3 id="push-api-routes"><a class="header" href="#push-api-routes">Push API Routes</a></h3>
<p>The gateway exposes these API endpoints for push notifications:</p>
<div class="table-wrapper"><table><thead><tr><th>Endpoint</th><th>Method</th><th>Description</th></tr></thead><tbody>
<tr><td><code>/api/push/vapid-key</code></td><td>GET</td><td>Get the VAPID public key for subscription</td></tr>
<tr><td><code>/api/push/subscribe</code></td><td>POST</td><td>Register a push subscription</td></tr>
<tr><td><code>/api/push/unsubscribe</code></td><td>POST</td><td>Remove a push subscription</td></tr>
<tr><td><code>/api/push/status</code></td><td>GET</td><td>Get push service status and subscription list</td></tr>
</tbody></table>
</div>
<h3 id="subscribe-request"><a class="header" href="#subscribe-request">Subscribe Request</a></h3>
<pre><code class="language-json">{
  "endpoint": "https://fcm.googleapis.com/fcm/send/...",
  "keys": {
    "p256dh": "base64url-encoded-key",
    "auth": "base64url-encoded-auth"
  }
}
</code></pre>
<h3 id="status-response"><a class="header" href="#status-response">Status Response</a></h3>
<pre><code class="language-json">{
  "enabled": true,
  "subscription_count": 2,
  "subscriptions": [
    {
      "endpoint": "https://fcm.googleapis.com/...",
      "device": "Safari on macOS",
      "ip": "192.168.1.100",
      "created_at": "2025-02-05T23:30:00Z"
    }
  ]
}
</code></pre>
<h3 id="notification-payload"><a class="header" href="#notification-payload">Notification Payload</a></h3>
<p>Push notifications include:</p>
<pre><code class="language-json">{
  "title": "moltis",
  "body": "New response available",
  "url": "/chats",
  "sessionKey": "session-id"
}
</code></pre>
<p>Clicking a notification will open or focus the app and navigate to the relevant chat.</p>
<h2 id="configuration-8"><a class="header" href="#configuration-8">Configuration</a></h2>
<h3 id="feature-flag-2"><a class="header" href="#feature-flag-2">Feature Flag</a></h3>
<p>Push notifications are controlled by the <code>push-notifications</code> feature flag, which is enabled by default. To disable:</p>
<pre><code class="language-toml"># In your Cargo.toml or when building
[dependencies]
moltis-gateway = { default-features = false, features = ["web-ui", "tls"] }
</code></pre>
<p>Or build without the feature:</p>
<pre><code class="language-bash">cargo build --no-default-features --features web-ui,tls,tailscale,file-watcher
</code></pre>
<h3 id="data-storage"><a class="header" href="#data-storage">Data Storage</a></h3>
<p>Push notification data is stored in <code>push.json</code> in the data directory:</p>
<ul>
<li><strong>VAPID keys</strong>: Generated once and reused</li>
<li><strong>Subscriptions</strong>: List of all registered browser subscriptions</li>
</ul>
<p>The VAPID keys are persisted so subscriptions remain valid across restarts.</p>
<h2 id="mobile-ui-considerations"><a class="header" href="#mobile-ui-considerations">Mobile UI Considerations</a></h2>
<p>The mobile interface adapts for smaller screens:</p>
<ul>
<li><strong>Navigation drawer</strong>: The sidebar becomes a slide-out drawer on mobile</li>
<li><strong>Sessions panel</strong>: Displayed as a bottom sheet that can be swiped</li>
<li><strong>Touch targets</strong>: Minimum 44px touch targets for accessibility</li>
<li><strong>Safe areas</strong>: Proper insets for devices with notches or home indicators</li>
</ul>
<h3 id="responsive-breakpoints"><a class="header" href="#responsive-breakpoints">Responsive Breakpoints</a></h3>
<ul>
<li><strong>Mobile</strong>: &lt; 768px width (drawer navigation)</li>
<li><strong>Desktop</strong>: â‰¥ 768px width (sidebar navigation)</li>
</ul>
<h2 id="browser-support"><a class="header" href="#browser-support">Browser Support</a></h2>
<div class="table-wrapper"><table><thead><tr><th>Feature</th><th>Chrome</th><th>Safari</th><th>Firefox</th><th>Edge</th></tr></thead><tbody>
<tr><td>PWA Install</td><td>âœ…</td><td>âœ… (iOS)</td><td>âŒ</td><td>âœ…</td></tr>
<tr><td>Push Notifications</td><td>âœ…</td><td>âœ… (iOS 16.4+)</td><td>âœ…</td><td>âœ…</td></tr>
<tr><td>Service Worker</td><td>âœ…</td><td>âœ…</td><td>âœ…</td><td>âœ…</td></tr>
<tr><td>Offline Support</td><td>âœ…</td><td>âœ…</td><td>âœ…</td><td>âœ…</td></tr>
</tbody></table>
</div>
<p>Note: iOS push notifications require iOS 16.4 or later and the app must be installed as a PWA.</p>
<h2 id="troubleshooting-5"><a class="header" href="#troubleshooting-5">Troubleshooting</a></h2>
<h3 id="notifications-not-working"><a class="header" href="#notifications-not-working">Notifications Not Working</a></h3>
<ol>
<li><strong>Check permissions</strong>: Ensure notifications are allowed in browser/OS settings</li>
<li><strong>Check subscription</strong>: Go to Settings &gt; Notifications to see if your device is listed</li>
<li><strong>Check server logs</strong>: Look for <code>push:</code> prefixed log messages for delivery status</li>
<li><strong>Safari/iOS specific</strong>:
<ul>
<li>Must be installed as PWA (Add to Dock/Home Screen)</li>
<li>iOS requires version 16.4 or later</li>
<li>The Enable button is disabled until installed as PWA</li>
</ul>
</li>
<li><strong>Behind a proxy</strong>: Ensure your proxy forwards <code>X-Forwarded-For</code> or <code>X-Real-IP</code> headers</li>
</ol>
<h3 id="pwa-not-installing"><a class="header" href="#pwa-not-installing">PWA Not Installing</a></h3>
<ol>
<li><strong>HTTPS required</strong>: PWAs require a secure connection (or localhost)</li>
<li><strong>Valid manifest</strong>: Ensure <code>/manifest.json</code> loads correctly</li>
<li><strong>Service worker</strong>: Check that <code>/sw.js</code> registers without errors</li>
<li><strong>Clear cache</strong>: Try clearing browser cache and reloading</li>
</ol>
<h3 id="service-worker-issues"><a class="header" href="#service-worker-issues">Service Worker Issues</a></h3>
<p>Clear the service worker registration:</p>
<ol>
<li>Open browser DevTools</li>
<li>Go to Application &gt; Service Workers</li>
<li>Click â€œUnregisterâ€ on the moltis service worker</li>
<li>Reload the page</li>
</ol>
<div style="break-before: page; page-break-before: always;"></div><h1 id="authentication-1"><a class="header" href="#authentication-1">Authentication</a></h1>
<p>Moltis uses a unified authentication gate that protects all routes with a
single source of truth. This page explains how authentication works, the
decision logic, and the different credential types.</p>
<h2 id="architecture-5"><a class="header" href="#architecture-5">Architecture</a></h2>
<p>All HTTP requests pass through a single <code>auth_gate</code> middleware before
reaching any handler. The middleware calls <code>check_auth()</code> â€” the <strong>only</strong>
function in the codebase that decides whether a request is authenticated.
This eliminates the class of bugs where different code paths disagree on
auth status.</p>
<pre><code>Request
  â”‚
  â–¼
auth_gate middleware
  â”‚
  â”œâ”€ Public path? (/health, /assets/*, /api/auth/*, ...) â†’ pass through
  â”‚
  â”œâ”€ No credential store? â†’ pass through
  â”‚
  â””â”€ check_auth()
       â”‚
       â”œâ”€ Allowed    â†’ insert AuthIdentity into request, continue
       â”œâ”€ SetupRequired â†’ 401 (API/WS) or redirect to /onboarding (pages)
       â””â”€ Unauthorized  â†’ 401 (API/WS) or serve SPA login page (pages)
</code></pre>
<p>WebSocket connections also use <code>check_auth()</code> for the HTTP upgrade
handshake. After the upgrade, the WS protocol has its own param-based auth
(API key or password in the <code>connect</code> message) for clients that cannot set
HTTP headers.</p>
<h2 id="decision-matrix"><a class="header" href="#decision-matrix">Decision Matrix</a></h2>
<p><code>check_auth()</code> evaluates conditions in order and returns the first match:</p>
<div class="table-wrapper"><table><thead><tr><th>#</th><th>Condition</th><th>Result</th><th>Auth method</th></tr></thead><tbody>
<tr><td>1</td><td><code>auth_disabled</code> is true</td><td><strong>Allowed</strong></td><td>Loopback</td></tr>
<tr><td>2</td><td>Setup not complete + local connection</td><td><strong>Allowed</strong></td><td>Loopback</td></tr>
<tr><td>3</td><td>Setup not complete + remote connection</td><td><strong>SetupRequired</strong></td><td>â€”</td></tr>
<tr><td>4</td><td>Valid session cookie</td><td><strong>Allowed</strong></td><td>Password</td></tr>
<tr><td>5</td><td>Valid Bearer API key</td><td><strong>Allowed</strong></td><td>ApiKey</td></tr>
<tr><td>6</td><td>None of the above</td><td><strong>Unauthorized</strong></td><td>â€”</td></tr>
</tbody></table>
</div><div id="admonition-what-is-setup-complete" class="admonition admonish-info" role="note" aria-labelledby="admonition-what-is-setup-complete-title">
<div class="admonition-title">
<div id="admonition-what-is-setup-complete-title">
<p>What is â€˜setup completeâ€™?</p>
</div>
<a class="admonition-anchor-link" href="authentication.html#admonition-what-is-setup-complete"></a>
</div>
<div>
<p>Setup is complete when at least one credential (password or passkey) has
been registered. The <code>setup_complete</code> flag is recomputed whenever
credentials are added or removed, so it correctly reflects passkey-only
setups â€” not just password presence.</p>
</div>
</div>
<h2 id="three-tier-model"><a class="header" href="#three-tier-model">Three-Tier Model</a></h2>
<p>The decision matrix above implements a three-tier authentication model:</p>
<div class="table-wrapper"><table><thead><tr><th>Tier</th><th>Condition</th><th>Behaviour</th></tr></thead><tbody>
<tr><td><strong>1 â€” Full auth</strong></td><td>Password or passkey is configured</td><td>Auth <strong>always</strong> required (any IP)</td></tr>
<tr><td><strong>2 â€” Local dev</strong></td><td>No credentials + direct local connection</td><td>Full access (dev convenience)</td></tr>
<tr><td><strong>3 â€” Remote setup</strong></td><td>No credentials + remote/proxied connection</td><td>Setup flow only</td></tr>
</tbody></table>
</div>
<h3 id="practical-scenarios"><a class="header" href="#practical-scenarios">Practical scenarios</a></h3>
<div class="table-wrapper"><table><thead><tr><th>Scenario</th><th>No credentials</th><th>Credentials configured</th></tr></thead><tbody>
<tr><td>Local browser on <code>localhost:18789</code></td><td>Full access (Tier 2)</td><td>Login required (Tier 1)</td></tr>
<tr><td>Local CLI/wscat on <code>localhost:18789</code></td><td>Full access (Tier 2)</td><td>Login required (Tier 1)</td></tr>
<tr><td>Internet via reverse proxy</td><td>Onboarding only (Tier 3)</td><td>Login required (Tier 1)</td></tr>
<tr><td><code>MOLTIS_BEHIND_PROXY=true</code>, any source</td><td>Onboarding only (Tier 3)</td><td>Login required (Tier 1)</td></tr>
</tbody></table>
</div>
<h3 id="how-local-is-determined"><a class="header" href="#how-local-is-determined">How â€œlocalâ€ is determined</a></h3>
<p>A connection is classified as <strong>local</strong> only when <strong>all four</strong> checks pass:</p>
<ol>
<li><code>MOLTIS_BEHIND_PROXY</code> env var is <strong>not</strong> set</li>
<li>No proxy headers present (<code>X-Forwarded-For</code>, <code>X-Real-IP</code>,
<code>CF-Connecting-IP</code>, <code>Forwarded</code>)</li>
<li>The <code>Host</code> header resolves to a loopback address (or is absent)</li>
<li>The TCP source IP is loopback (<code>127.0.0.1</code>, <code>::1</code>)</li>
</ol>
<p>If <strong>any</strong> check fails, the connection is treated as remote.</p>
<h2 id="credential-types"><a class="header" href="#credential-types">Credential Types</a></h2>
<h3 id="password"><a class="header" href="#password">Password</a></h3>
<ul>
<li>Set during initial setup or added later via Settings</li>
<li>Hashed with Argon2id before storage</li>
<li>Minimum 8 characters</li>
<li>Verified against <code>auth_password</code> table</li>
</ul>
<h3 id="passkey-webauthn"><a class="header" href="#passkey-webauthn">Passkey (WebAuthn)</a></h3>
<ul>
<li>Registered during setup or added later via Settings</li>
<li>Supports hardware keys (YubiKey), platform authenticators (Touch ID,
Windows Hello), and cross-platform authenticators</li>
<li>Stored in <code>passkeys</code> table as serialized WebAuthn credential data</li>
<li>Multiple passkeys can be registered per instance</li>
</ul>
<h3 id="session-cookie"><a class="header" href="#session-cookie">Session cookie</a></h3>
<ul>
<li>HTTP-only <code>moltis_session</code> cookie, <code>SameSite=Strict</code></li>
<li>Created on successful login (password or passkey)</li>
<li>30-day expiry</li>
<li>Validated against <code>auth_sessions</code> table</li>
<li>When the request arrives on a <code>.localhost</code> subdomain (e.g.
<code>moltis.localhost</code>), the cookie includes <code>Domain=localhost</code> so it is
shared across all loopback hostnames</li>
</ul>
<h3 id="api-key"><a class="header" href="#api-key">API key</a></h3>
<ul>
<li>Created in Settings &gt; Security &gt; API Keys</li>
<li>Prefixed with <code>mk_</code> for identification</li>
<li>Stored as SHA-256 hash (the raw key is shown once at creation)</li>
<li>Passed via <code>Authorization: Bearer &lt;key&gt;</code> header (HTTP) or in the
<code>connect</code> handshake <code>auth.api_key</code> field (WebSocket)</li>
<li><strong>Must have at least one scope</strong> â€” keys without scopes are denied</li>
</ul>
<h2 id="api-key-scopes"><a class="header" href="#api-key-scopes">API Key Scopes</a></h2>
<div class="table-wrapper"><table><thead><tr><th>Scope</th><th>Permissions</th></tr></thead><tbody>
<tr><td><code>operator.read</code></td><td>View status, list jobs, read history</td></tr>
<tr><td><code>operator.write</code></td><td>Send messages, create jobs, modify configuration</td></tr>
<tr><td><code>operator.admin</code></td><td>All permissions (superset of all scopes)</td></tr>
<tr><td><code>operator.approvals</code></td><td>Handle command approval requests</td></tr>
<tr><td><code>operator.pairing</code></td><td>Manage device/node pairing</td></tr>
</tbody></table>
</div><div id="admonition-tip" class="admonition admonish-tip" role="note" aria-labelledby="admonition-tip-title">
<div class="admonition-title">
<div id="admonition-tip-title">
<p>Tip</p>
</div>
<a class="admonition-anchor-link" href="authentication.html#admonition-tip"></a>
</div>
<div>
<p>Use the minimum necessary scopes. A monitoring integration only needs
<code>operator.read</code>. A CI pipeline that triggers agent runs needs
<code>operator.read</code> and <code>operator.write</code>.</p>
</div>
</div>
<h2 id="public-paths"><a class="header" href="#public-paths">Public Paths</a></h2>
<p>These paths are accessible without authentication, even when credentials
are configured:</p>
<div class="table-wrapper"><table><thead><tr><th>Path</th><th>Purpose</th></tr></thead><tbody>
<tr><td><code>/health</code></td><td>Health check endpoint</td></tr>
<tr><td><code>/api/auth/*</code></td><td>Auth status, login, setup, passkey flows</td></tr>
<tr><td><code>/assets/*</code></td><td>Static assets (JS, CSS, images)</td></tr>
<tr><td><code>/auth/callback</code></td><td>OAuth callback</td></tr>
<tr><td><code>/manifest.json</code></td><td>PWA manifest</td></tr>
<tr><td><code>/sw.js</code></td><td>Service worker</td></tr>
</tbody></table>
</div>
<h2 id="request-throttling"><a class="header" href="#request-throttling">Request Throttling</a></h2>
<p>Moltis applies built-in endpoint throttling per client IP only when auth is
required for the current request.</p>
<p>Requests bypass IP throttling when:</p>
<ul>
<li>The request is already authenticated (session or API key)</li>
<li>Auth is not currently enforced (<code>auth_disabled = true</code>)</li>
<li>Setup is incomplete and the request is allowed by local Tier-2 access</li>
</ul>
<p>Default limits:</p>
<div class="table-wrapper"><table><thead><tr><th>Scope</th><th>Default</th></tr></thead><tbody>
<tr><td><code>POST /api/auth/login</code></td><td>5 requests per 60 seconds</td></tr>
<tr><td>Other <code>/api/auth/*</code></td><td>120 requests per 60 seconds</td></tr>
<tr><td>Other <code>/api/*</code></td><td>180 requests per 60 seconds</td></tr>
<tr><td><code>/ws</code> upgrade</td><td>30 requests per 60 seconds</td></tr>
</tbody></table>
</div>
<p>When a limit is exceeded:</p>
<ul>
<li>API endpoints return <code>429 Too Many Requests</code></li>
<li>Responses include <code>Retry-After</code> header</li>
<li>JSON API responses also include <code>retry_after_seconds</code></li>
</ul>
<div id="admonition-note" class="admonition admonish-note" role="note" aria-labelledby="admonition-note-title">
<div class="admonition-title">
<div id="admonition-note-title">
<p>Note</p>
</div>
<a class="admonition-anchor-link" href="authentication.html#admonition-note"></a>
</div>
<div>
<p>When <code>MOLTIS_BEHIND_PROXY=true</code>, throttling is keyed by forwarded client IP
headers (<code>X-Forwarded-For</code>, <code>X-Real-IP</code>, <code>CF-Connecting-IP</code>) instead of the
direct socket address.</p>
</div>
</div>
<h2 id="setup-flow"><a class="header" href="#setup-flow">Setup Flow</a></h2>
<p>On first run (no credentials configured):</p>
<ol>
<li>A random 6-digit <strong>setup code</strong> is printed to the terminal</li>
<li>Local connections get full access (Tier 2) â€” no setup code needed</li>
<li>Remote connections are redirected to <code>/onboarding</code> (Tier 3) â€” the
setup code is required to set a password or register a passkey</li>
<li>After setting up, the setup code is cleared and a session is created</li>
</ol>
<div id="admonition-warning" class="admonition admonish-warning" role="note" aria-labelledby="admonition-warning-title">
<div class="admonition-title">
<div id="admonition-warning-title">
<p>Warning</p>
</div>
<a class="admonition-anchor-link" href="authentication.html#admonition-warning"></a>
</div>
<div>
<p>The setup code is single-use and only valid until the first credential is
registered. If you lose it, restart the server to generate a new one.</p>
</div>
</div>
<h2 id="removing-authentication"><a class="header" href="#removing-authentication">Removing Authentication</a></h2>
<p>The â€œRemove all authâ€ action in Settings:</p>
<ol>
<li>Deletes all passwords, passkeys, sessions, and API keys</li>
<li>Sets <code>auth_disabled = true</code> in config</li>
<li>Generates a new setup code for re-setup</li>
<li>All subsequent requests are allowed through (Tier 1 check: <code>auth_disabled</code>)</li>
</ol>
<p>To re-enable auth, complete the setup flow again with the new setup code.</p>
<h2 id="websocket-authentication"><a class="header" href="#websocket-authentication">WebSocket Authentication</a></h2>
<p>WebSocket connections are authenticated at two levels:</p>
<h3 id="1-http-upgrade-header-auth"><a class="header" href="#1-http-upgrade-header-auth">1. HTTP upgrade (header auth)</a></h3>
<p>The WebSocket upgrade request passes through <code>check_auth()</code> like any
other HTTP request. If the browser has a valid session cookie, the
connection is pre-authenticated.</p>
<h3 id="2-connect-message-param-auth"><a class="header" href="#2-connect-message-param-auth">2. Connect message (param auth)</a></h3>
<p>After the WebSocket is established, the client sends a <code>connect</code> message.
Non-browser clients (CLI tools, scripts) that cannot set HTTP headers
authenticate here:</p>
<pre><code class="language-json">{
  "method": "connect",
  "params": {
    "client": { "id": "my-tool", "version": "1.0.0" },
    "auth": {
      "api_key": "mk_abc123..."
    }
  }
}
</code></pre>
<p>The <code>auth</code> object can contain <code>api_key</code> or <code>password</code>. If neither is
provided and the connection was not pre-authenticated via headers, the
connection is rejected.</p>
<h2 id="reverse-proxy-considerations"><a class="header" href="#reverse-proxy-considerations">Reverse Proxy Considerations</a></h2>
<p>When running behind a reverse proxy, authentication interacts with the
local-connection detection:</p>
<ul>
<li><strong>Most proxies</strong> add <code>X-Forwarded-For</code> or similar headers, which
automatically classify connections as remote</li>
<li><strong>Bare proxies</strong> (no forwarding headers) can appear local â€” set
<code>MOLTIS_BEHIND_PROXY=true</code> to force all connections to be treated as
remote</li>
<li>The proxy must forward <code>Origin</code> and <code>Host</code> headers for WebSocket
CSWSH protection</li>
<li>TLS termination typically happens at the proxy</li>
</ul>
<p>See <a href="security.html#reverse-proxy-deployments">Security Architecture</a> for
detailed proxy deployment guidance.</p>
<h2 id="session-management"><a class="header" href="#session-management">Session Management</a></h2>
<div class="table-wrapper"><table><thead><tr><th>Operation</th><th>Endpoint</th><th>Auth required</th></tr></thead><tbody>
<tr><td>Check status</td><td><code>GET /api/auth/status</code></td><td>No</td></tr>
<tr><td>Set password (setup)</td><td><code>POST /api/auth/setup</code></td><td>Setup code</td></tr>
<tr><td>Login with password</td><td><code>POST /api/auth/login</code></td><td>No (validates password)</td></tr>
<tr><td>Login with passkey</td><td><code>POST /api/auth/passkey/auth/*</code></td><td>No (validates passkey)</td></tr>
<tr><td>Logout</td><td><code>POST /api/auth/logout</code></td><td>Session</td></tr>
<tr><td>Change password</td><td><code>POST /api/auth/password/change</code></td><td>Session</td></tr>
<tr><td>List API keys</td><td><code>GET /api/auth/api-keys</code></td><td>Session</td></tr>
<tr><td>Create API key</td><td><code>POST /api/auth/api-keys</code></td><td>Session</td></tr>
<tr><td>Revoke API key</td><td><code>DELETE /api/auth/api-keys/{id}</code></td><td>Session</td></tr>
<tr><td>Register passkey</td><td><code>POST /api/auth/passkey/register/*</code></td><td>Session</td></tr>
<tr><td>Remove passkey</td><td><code>DELETE /api/auth/passkeys/{id}</code></td><td>Session</td></tr>
<tr><td>Remove all auth</td><td><code>POST /api/auth/reset</code></td><td>Session</td></tr>
</tbody></table>
</div><div style="break-before: page; page-break-before: always;"></div><h1 id="security-architecture"><a class="header" href="#security-architecture">Security Architecture</a></h1>
<p>Moltis is designed with a defense-in-depth security model. This document
explains the key security features and provides guidance for production
deployments.</p>
<h2 id="overview-4"><a class="header" href="#overview-4">Overview</a></h2>
<p>Moltis runs AI agents that can execute code and interact with external systems.
This power requires multiple layers of protection:</p>
<ol>
<li><strong>Human-in-the-loop approval</strong> for dangerous commands</li>
<li><strong>Sandbox isolation</strong> for command execution</li>
<li><strong>Channel authorization</strong> for external integrations</li>
<li><strong>Rate limiting</strong> to prevent resource abuse</li>
<li><strong>Scope-based access control</strong> for API authorization</li>
</ol>
<p>For marketplace-style skill/plugin hardening (trust gating, provenance pinning,
drift re-trust, dependency install guards, kill switch, audit log), see
<a href="skills-security.html">Third-Party Skills Security</a>.</p>
<h2 id="command-execution-approval"><a class="header" href="#command-execution-approval">Command Execution Approval</a></h2>
<p>By default, Moltis requires explicit user approval before executing potentially
dangerous commands. This â€œhuman-in-the-loopâ€ design ensures the AI cannot take
destructive actions without consent.</p>
<h3 id="how-it-works-3"><a class="header" href="#how-it-works-3">How It Works</a></h3>
<p>When the agent wants to run a command:</p>
<ol>
<li>The command is analyzed against approval policies</li>
<li>If approval is required, the user sees a prompt in the UI</li>
<li>The user can approve, deny, or modify the command</li>
<li>Only approved commands execute</li>
</ol>
<h3 id="approval-policies"><a class="header" href="#approval-policies">Approval Policies</a></h3>
<p>Configure approval behavior in <code>moltis.toml</code>:</p>
<pre><code class="language-toml">[tools.exec]
approval_mode = "always"  # always require approval
# approval_mode = "smart" # auto-approve safe commands (default)
# approval_mode = "never" # dangerous: never require approval
</code></pre>
<p><strong>Recommendation</strong>: Keep <code>approval_mode = "smart"</code> (the default) for most use
cases. Only use <code>"never"</code> in fully automated, sandboxed environments.</p>
<h2 id="sandbox-isolation"><a class="header" href="#sandbox-isolation">Sandbox Isolation</a></h2>
<p>Commands execute inside isolated containers (Docker or Apple Container) by
default. This protects your host system from:</p>
<ul>
<li>Accidental file deletion or modification</li>
<li>Malicious code execution</li>
<li>Resource exhaustion (memory, CPU, disk)</li>
</ul>
<p>See <a href="sandbox.html">sandbox.md</a> for backend configuration.</p>
<h3 id="resource-limits-1"><a class="header" href="#resource-limits-1">Resource Limits</a></h3>
<pre><code class="language-toml">[tools.exec.sandbox.resource_limits]
memory_limit = "512M"
cpu_quota = 1.0
pids_max = 256
</code></pre>
<h3 id="network-isolation"><a class="header" href="#network-isolation">Network Isolation</a></h3>
<p>Sandbox containers have limited network access by default. Outbound connections
are allowed but the sandbox cannot bind to host ports.</p>
<h2 id="channel-authorization"><a class="header" href="#channel-authorization">Channel Authorization</a></h2>
<p>Channels (Telegram, Slack, etc.) allow external parties to interact with your
Moltis agent. This requires careful access control.</p>
<h3 id="sender-allowlisting"><a class="header" href="#sender-allowlisting">Sender Allowlisting</a></h3>
<p>When a new sender contacts the agent through a channel, they are placed in a
pending queue. You must explicitly approve or deny each sender before they can
interact with the agent.</p>
<pre><code>UI: Settings &gt; Channels &gt; Pending Senders
</code></pre>
<h3 id="per-channel-permissions"><a class="header" href="#per-channel-permissions">Per-Channel Permissions</a></h3>
<p>Each channel can have different permission levels:</p>
<ul>
<li><strong>Read-only</strong>: Sender can ask questions, agent responds</li>
<li><strong>Execute</strong>: Sender can trigger actions (with approval still required)</li>
<li><strong>Admin</strong>: Full access including configuration changes</li>
</ul>
<h3 id="channel-isolation"><a class="header" href="#channel-isolation">Channel Isolation</a></h3>
<p>Channels run in isolated sessions by default. A malicious message from one
channel cannot affect another channelâ€™s session or the main UI session.</p>
<h2 id="cron-job-security"><a class="header" href="#cron-job-security">Cron Job Security</a></h2>
<p>Scheduled tasks (cron jobs) can run agent turns automatically. Security
considerations:</p>
<h3 id="rate-limiting"><a class="header" href="#rate-limiting">Rate Limiting</a></h3>
<p>To prevent prompt injection attacks from rapidly creating many cron jobs:</p>
<pre><code class="language-toml">[cron]
rate_limit_max = 10           # max jobs per window
rate_limit_window_secs = 60   # window duration (1 minute)
</code></pre>
<p>This limits job creation to 10 per minute by default. System jobs (like
heartbeat) bypass this limit.</p>
<h3 id="job-notifications"><a class="header" href="#job-notifications">Job Notifications</a></h3>
<p>When cron jobs are created, updated, or removed, Moltis broadcasts events:</p>
<ul>
<li><code>cron.job.created</code> - A new job was created</li>
<li><code>cron.job.updated</code> - An existing job was modified</li>
<li><code>cron.job.removed</code> - A job was deleted</li>
</ul>
<p>Monitor these events to detect suspicious automated job creation.</p>
<h3 id="sandbox-for-cron-jobs"><a class="header" href="#sandbox-for-cron-jobs">Sandbox for Cron Jobs</a></h3>
<p>Cron job execution uses sandbox isolation by default:</p>
<pre><code class="language-toml"># Per-job configuration
[cron.job.sandbox]
enabled = true              # run in sandbox (default)
# image = "custom:latest"   # optional custom image
</code></pre>
<h2 id="identity-protection"><a class="header" href="#identity-protection">Identity Protection</a></h2>
<p>The agentâ€™s identity fields (name, emoji, creature, vibe) are stored in <code>IDENTITY.md</code>
YAML frontmatter at the workspace root (<code>data_dir</code>).
User profile fields are stored in <code>USER.md</code> YAML frontmatter at the same location.
The personality text is stored separately in <code>SOUL.md</code> at the workspace root (<code>data_dir</code>).
Tool guidance is stored in <code>TOOLS.md</code> at the workspace root (<code>data_dir</code>) and is injected
as workspace context in the system prompt.
Modifying identity requires the <code>operator.write</code> scope, not just <code>operator.read</code>.</p>
<p>This prevents prompt injection attacks from subtly modifying the agentâ€™s
personality to make it more compliant with malicious requests.</p>
<h2 id="api-authorization"><a class="header" href="#api-authorization">API Authorization</a></h2>
<p>The gateway API uses role-based access control with scopes:</p>
<div class="table-wrapper"><table><thead><tr><th>Scope</th><th>Permissions</th></tr></thead><tbody>
<tr><td><code>operator.read</code></td><td>View status, list jobs, read history</td></tr>
<tr><td><code>operator.write</code></td><td>Send messages, create jobs, modify configuration</td></tr>
<tr><td><code>operator.admin</code></td><td>All permissions (includes all other scopes)</td></tr>
<tr><td><code>operator.approvals</code></td><td>Handle command approval requests</td></tr>
<tr><td><code>operator.pairing</code></td><td>Manage device/node pairing</td></tr>
</tbody></table>
</div>
<h3 id="api-keys"><a class="header" href="#api-keys">API Keys</a></h3>
<p>API keys authenticate external tools and scripts connecting to Moltis. Keys
<strong>must specify at least one scope</strong> â€” keys without scopes are denied access
(least-privilege by default).</p>
<h4 id="creating-api-keys"><a class="header" href="#creating-api-keys">Creating API Keys</a></h4>
<p><strong>Web UI</strong>: Settings &gt; Security &gt; API Keys</p>
<ol>
<li>Enter a label describing the keyâ€™s purpose</li>
<li>Select the required scopes</li>
<li>Click â€œGenerate keyâ€</li>
<li><strong>Copy the key immediately</strong> â€” itâ€™s only shown once</li>
</ol>
<p><strong>CLI</strong>:</p>
<pre><code class="language-bash"># Scoped key (comma-separated scopes)
moltis auth create-api-key --label "Monitor" --scopes "operator.read"
moltis auth create-api-key --label "Automation" --scopes "operator.read,operator.write"
moltis auth create-api-key --label "CI pipeline" --scopes "operator.admin"
</code></pre>
<h4 id="using-api-keys"><a class="header" href="#using-api-keys">Using API Keys</a></h4>
<p>Pass the key in the <code>connect</code> handshake over WebSocket:</p>
<pre><code class="language-json">{
  "method": "connect",
  "params": {
    "client": { "id": "my-tool", "version": "1.0.0" },
    "auth": { "api_key": "mk_abc123..." }
  }
}
</code></pre>
<p>Or use Bearer authentication for REST API calls:</p>
<pre><code>Authorization: Bearer mk_abc123...
</code></pre>
<h4 id="scope-recommendations"><a class="header" href="#scope-recommendations">Scope Recommendations</a></h4>
<div class="table-wrapper"><table><thead><tr><th>Use Case</th><th>Recommended Scopes</th></tr></thead><tbody>
<tr><td>Read-only monitoring</td><td><code>operator.read</code></td></tr>
<tr><td>Automated workflows</td><td><code>operator.read</code>, <code>operator.write</code></td></tr>
<tr><td>Approval handling</td><td><code>operator.read</code>, <code>operator.approvals</code></td></tr>
<tr><td>Full automation</td><td><code>operator.admin</code></td></tr>
</tbody></table>
</div>
<p><strong>Best practice</strong>: Use the minimum necessary scopes. If a key only needs to
read status and logs, donâ€™t grant <code>operator.write</code>.</p>
<h4 id="backward-compatibility"><a class="header" href="#backward-compatibility">Backward Compatibility</a></h4>
<p>Existing API keys created without scopes will be <strong>denied access</strong> until
scopes are added. Re-create keys with explicit scopes to restore access.</p>
<h2 id="network-security"><a class="header" href="#network-security">Network Security</a></h2>
<h3 id="tls-encryption"><a class="header" href="#tls-encryption">TLS Encryption</a></h3>
<p>HTTPS is enabled by default with auto-generated certificates:</p>
<pre><code class="language-toml">[tls]
enabled = true
auto_generate = true
</code></pre>
<p>For production, use certificates from a trusted CA or configure custom
certificates.</p>
<h3 id="origin-validation"><a class="header" href="#origin-validation">Origin Validation</a></h3>
<p>WebSocket connections validate the <code>Origin</code> header to prevent cross-site
WebSocket hijacking (CSWSH). Connections from untrusted origins are rejected.</p>
<h3 id="ssrf-protection"><a class="header" href="#ssrf-protection">SSRF Protection</a></h3>
<p>The <code>web_fetch</code> tool resolves DNS and blocks requests to private IP ranges
(loopback, RFC 1918, link-local, CGNAT). This prevents server-side request
forgery attacks.</p>
<p>To allow access to trusted private networks (e.g. Docker sibling containers),
add their CIDR ranges to <code>ssrf_allowlist</code>:</p>
<pre><code class="language-toml">[tools.web.fetch]
ssrf_allowlist = ["172.22.0.0/16"]
</code></pre>
<p><strong>Warning:</strong> Only add networks you trust. The allowlist bypasses SSRF protection
for the listed ranges. Never add cloud metadata ranges (<code>169.254.169.254/32</code>)
unless you understand the risk.</p>
<h2 id="authentication-2"><a class="header" href="#authentication-2">Authentication</a></h2>
<p>Moltis uses a unified auth gate that applies a single <code>check_auth()</code>
function to every request. This prevents split-brain bugs where different
code paths disagree on auth status.</p>
<p>For full details â€” including the decision matrix, credential types, API
key scopes, session management endpoints, and WebSocket auth â€” see the
dedicated <a href="authentication.html">Authentication</a> page.</p>
<h3 id="three-tier-model-summary"><a class="header" href="#three-tier-model-summary">Three-Tier Model (summary)</a></h3>
<div class="table-wrapper"><table><thead><tr><th>Tier</th><th>Condition</th><th>Behaviour</th></tr></thead><tbody>
<tr><td><strong>1</strong></td><td>Password/passkey is configured</td><td>Auth <strong>always</strong> required (any IP)</td></tr>
<tr><td><strong>2</strong></td><td>No credentials + direct local connection</td><td>Full access (dev convenience)</td></tr>
<tr><td><strong>3</strong></td><td>No credentials + remote/proxied connection</td><td>Onboarding only (setup code required)</td></tr>
</tbody></table>
</div>
<h2 id="http-endpoint-throttling"><a class="header" href="#http-endpoint-throttling">HTTP Endpoint Throttling</a></h2>
<p>Moltis includes built-in per-IP endpoint throttling to reduce brute force
attempts and traffic spikes, but only when auth is required for the current
request.</p>
<p>Throttling is bypassed when a request is already authenticated, when auth is
explicitly disabled, or when setup is incomplete and local Tier-2 access is
allowed.</p>
<h3 id="default-limits"><a class="header" href="#default-limits">Default Limits</a></h3>
<div class="table-wrapper"><table><thead><tr><th>Scope</th><th>Default</th></tr></thead><tbody>
<tr><td><code>POST /api/auth/login</code></td><td>5 requests per 60 seconds</td></tr>
<tr><td>Other <code>/api/auth/*</code></td><td>120 requests per 60 seconds</td></tr>
<tr><td>Other <code>/api/*</code></td><td>180 requests per 60 seconds</td></tr>
<tr><td><code>/ws</code> upgrade</td><td>30 requests per 60 seconds</td></tr>
</tbody></table>
</div>
<h3 id="when-limits-are-hit"><a class="header" href="#when-limits-are-hit">When Limits Are Hit</a></h3>
<ul>
<li>API endpoints return <code>429 Too Many Requests</code></li>
<li>Responses include <code>Retry-After</code></li>
<li>JSON responses include <code>retry_after_seconds</code></li>
</ul>
<h3 id="reverse-proxy-behavior"><a class="header" href="#reverse-proxy-behavior">Reverse Proxy Behavior</a></h3>
<p>When <code>MOLTIS_BEHIND_PROXY=true</code>, throttling is keyed by forwarded client IP
headers (<code>X-Forwarded-For</code>, <code>X-Real-IP</code>, <code>CF-Connecting-IP</code>) instead of the
direct socket address.</p>
<h3 id="production-guidance"><a class="header" href="#production-guidance">Production Guidance</a></h3>
<p>Built-in throttling is the first layer. For internet-facing deployments, add
edge rate limits at your reverse proxy or WAF as a second layer (IP reputation,
burst controls, geo rules, bot filtering).</p>
<h2 id="reverse-proxy-deployments"><a class="header" href="#reverse-proxy-deployments">Reverse Proxy Deployments</a></h2>
<p>Running Moltis behind a reverse proxy (Caddy, nginx, Traefik, etc.)
requires understanding how authentication interacts with loopback
connections.</p>
<h3 id="the-problem"><a class="header" href="#the-problem">The problem</a></h3>
<p>When Moltis binds to <code>127.0.0.1</code> and a proxy on the same machine
forwards traffic to it, <strong>every</strong> incoming TCP connection appears to
originate from <code>127.0.0.1</code> â€” including requests from the public
internet.  A naive â€œtrust all loopback connectionsâ€ check would bypass
authentication for all proxied traffic.</p>
<p>This is the same class of vulnerability as
<a href="https://github.com/openclaw/openclaw/security/advisories/GHSA-g8p2-7wf7-98mq">CVE-2026-25253</a>,
which allowed one-click remote code execution on OpenClaw through
authentication token exfiltration and cross-site WebSocket hijacking.</p>
<h3 id="how-moltis-handles-it"><a class="header" href="#how-moltis-handles-it">How Moltis handles it</a></h3>
<p>Moltis uses the per-request <code>is_local_connection()</code> check described
above.  Most reverse proxies add forwarding headers or change the
<code>Host</code> header, which automatically triggers the â€œremoteâ€ classification.</p>
<p>For proxies that <strong>strip all signals</strong> (e.g. a bare nginx <code>proxy_pass</code>
that rewrites <code>Host</code> to the upstream address and adds no <code>X-Forwarded-For</code>),
use the <code>MOLTIS_BEHIND_PROXY</code> environment variable as a hard override:</p>
<pre><code class="language-bash">MOLTIS_BEHIND_PROXY=true moltis
</code></pre>
<p>When this variable is set, <strong>all</strong> connections are treated as remote â€”
no loopback bypass, no exceptions.</p>
<h3 id="deploying-behind-a-proxy"><a class="header" href="#deploying-behind-a-proxy">Deploying behind a proxy</a></h3>
<ol>
<li>
<p><strong>Set <code>MOLTIS_BEHIND_PROXY=true</code></strong> if your proxy does not add
forwarding headers (safest option â€” eliminates any ambiguity).</p>
</li>
<li>
<p><strong>Set a password or register a passkey</strong> during initial setup.
Once a password is configured (Tier 1), authentication is required
for all traffic regardless of <code>is_local_connection()</code>.</p>
</li>
<li>
<p><strong>WebSocket proxying</strong> must forward the <code>Origin</code> and <code>Host</code> headers
correctly.  Moltis validates same-origin on WebSocket upgrades to
prevent cross-site WebSocket hijacking (CSWSH).</p>
</li>
<li>
<p><strong>TLS termination</strong> should happen at the proxy.  Moltis can also
serve TLS directly (<code>[tls] enabled = true</code>), but most proxy setups
handle certificates at the edge.</p>
</li>
</ol>
<h2 id="production-recommendations"><a class="header" href="#production-recommendations">Production Recommendations</a></h2>
<h3 id="1-enable-authentication"><a class="header" href="#1-enable-authentication">1. Enable Authentication</a></h3>
<p>By default, Moltis requires a password when accessed from non-localhost:</p>
<pre><code class="language-toml">[auth]
disabled = false  # keep this false in production
</code></pre>
<h3 id="2-use-sandbox-isolation"><a class="header" href="#2-use-sandbox-isolation">2. Use Sandbox Isolation</a></h3>
<p>Always run with sandbox enabled in production:</p>
<pre><code class="language-toml">[tools.exec.sandbox]
enabled = true
backend = "auto"  # uses strongest available
</code></pre>
<h3 id="3-limit-rate-limits"><a class="header" href="#3-limit-rate-limits">3. Limit Rate Limits</a></h3>
<p>Tighten rate limits for untrusted environments:</p>
<pre><code class="language-toml">[cron]
rate_limit_max = 5
rate_limit_window_secs = 300  # 5 per 5 minutes
</code></pre>
<h3 id="4-review-channel-senders"><a class="header" href="#4-review-channel-senders">4. Review Channel Senders</a></h3>
<p>Regularly audit approved senders and revoke access for unknown parties.</p>
<h3 id="5-monitor-events"><a class="header" href="#5-monitor-events">5. Monitor Events</a></h3>
<p>Watch for these suspicious patterns:</p>
<ul>
<li>Rapid cron job creation</li>
<li>Identity modification attempts</li>
<li>Unusual command patterns in approval requests</li>
<li>New channel senders from unexpected sources</li>
</ul>
<h3 id="6-network-segmentation"><a class="header" href="#6-network-segmentation">6. Network Segmentation</a></h3>
<p>Run Moltis on a private network or behind a reverse proxy with:</p>
<ul>
<li>IP allowlisting</li>
<li>Rate limiting</li>
<li>Web Application Firewall (WAF) rules</li>
</ul>
<h3 id="7-keep-software-updated"><a class="header" href="#7-keep-software-updated">7. Keep Software Updated</a></h3>
<p>Subscribe to security advisories and update promptly when vulnerabilities are
disclosed.</p>
<h2 id="reporting-security-issues"><a class="header" href="#reporting-security-issues">Reporting Security Issues</a></h2>
<p>Report security vulnerabilities privately to the maintainers. Do not open
public issues for security bugs.</p>
<p>See the repositoryâ€™s SECURITY.md for contact information.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="third-party-skills-security"><a class="header" href="#third-party-skills-security">Third-Party Skills Security</a></h1>
<p>Third-party skills and plugin repos are powerful and risky. Treat them like
untrusted code until reviewed.</p>
<h2 id="trust-lifecycle"><a class="header" href="#trust-lifecycle">Trust Lifecycle</a></h2>
<p>Installed marketplace skills/plugins now use a trust gate:</p>
<ul>
<li><code>installed</code> - repo is on disk</li>
<li><code>trusted</code> - you explicitly marked the skill as reviewed</li>
<li><code>enabled</code> - skill is active for agent use</li>
</ul>
<p>You cannot enable untrusted skills.</p>
<h2 id="provenance-pinning"><a class="header" href="#provenance-pinning">Provenance Pinning</a></h2>
<p>Moltis records a pinned <code>commit_sha</code> for installed repos:</p>
<ul>
<li>via <code>git rev-parse HEAD</code> after clone</li>
<li>via GitHub commits API for tarball fallback installs</li>
</ul>
<p>The Skills UI shows a short SHA to help review provenance.</p>
<h2 id="re-trust-on-drift"><a class="header" href="#re-trust-on-drift">Re-Trust on Drift</a></h2>
<p>If local repo HEAD changes from the pinned <code>commit_sha</code>:</p>
<ul>
<li>all skills in that repo are auto-marked <code>trusted=false</code></li>
<li>all skills in that repo are auto-disabled</li>
<li>re-enable is blocked until explicit trust is granted again</li>
</ul>
<p>The UI/API mark this state as <code>source changed</code>.</p>
<h2 id="dependency-install-guardrails"><a class="header" href="#dependency-install-guardrails">Dependency Install Guardrails</a></h2>
<p><code>skills.install_dep</code> now includes hard gates:</p>
<ul>
<li>explicit <code>confirm=true</code> required</li>
<li>host installs blocked when sandbox mode is off (unless explicit override)</li>
<li>suspicious command chains are blocked by default (for example <code>curl ... | sh</code>,
base64 decode chains, quarantine bypass)</li>
</ul>
<p>For high-risk overrides, require manual review before using
<code>allow_risky_install=true</code>.</p>
<h2 id="emergency-kill-switch"><a class="header" href="#emergency-kill-switch">Emergency Kill Switch</a></h2>
<p>Use <code>skills.emergency_disable</code> to disable all installed third-party skills and
plugins immediately.</p>
<ul>
<li>Available in RPC and Skills UI action button</li>
<li>Intended for incident response and containment</li>
</ul>
<h2 id="security-audit-log"><a class="header" href="#security-audit-log">Security Audit Log</a></h2>
<p>Security-sensitive skill/plugin actions are appended to:</p>
<p><code>~/.moltis/logs/security-audit.jsonl</code></p>
<p>Logged events include installs, removals, trust changes, enable/disable,
dependency install attempts, and source drift detection.</p>
<h2 id="recommended-production-policy"><a class="header" href="#recommended-production-policy">Recommended Production Policy</a></h2>
<ol>
<li>Keep sandbox enabled (<code>tools.exec.sandbox.mode = "all"</code>).</li>
<li>Keep approval mode at least <code>on-miss</code>.</li>
<li>Review SKILL.md and linked scripts before trust.</li>
<li>Prefer pinned, known repos over ad-hoc installs.</li>
<li>Monitor <code>security-audit.jsonl</code> for unusual events.</li>
</ol>
<div style="break-before: page; page-break-before: always;"></div><h1 id="running-moltis-in-docker"><a class="header" href="#running-moltis-in-docker">Running Moltis in Docker</a></h1>
<p>Moltis is available as a multi-architecture Docker image supporting both
<code>linux/amd64</code> and <code>linux/arm64</code>. The image is published to GitHub Container
Registry on every release.</p>
<h2 id="quick-start-1"><a class="header" href="#quick-start-1">Quick Start</a></h2>
<pre><code class="language-bash">docker run -d \
  --name moltis \
  -p 13131:13131 \
  -p 13132:13132 \
  -v moltis-config:/home/moltis/.config/moltis \
  -v moltis-data:/home/moltis/.moltis \
  -v /var/run/docker.sock:/var/run/docker.sock \
  ghcr.io/moltis-org/moltis:latest
</code></pre>
<p>Open https://localhost:13131 in your browser and configure your LLM provider to start chatting.</p>
<h3 id="trusting-the-tls-certificate"><a class="header" href="#trusting-the-tls-certificate">Trusting the TLS certificate</a></h3>
<p>Moltis generates a self-signed CA on first run. Browsers will show a security
warning until you trust this CA. Port 13132 serves the certificate over plain
HTTP so you can download it:</p>
<pre><code class="language-bash"># Download the CA certificate
curl -o moltis-ca.pem http://localhost:13132/certs/ca.pem

# macOS â€” add to system Keychain and trust it
sudo security add-trusted-cert -d -r trustRoot \
  -k /Library/Keychains/System.keychain moltis-ca.pem

# Linux (Debian/Ubuntu)
sudo cp moltis-ca.pem /usr/local/share/ca-certificates/moltis-ca.crt
sudo update-ca-certificates
</code></pre>
<p>After trusting the CA, restart your browser. The warning will not appear again
(the CA persists in the mounted config volume).</p>
<div id="admonition-note" class="admonition admonish-note" role="note" aria-labelledby="admonition-note-title">
<div class="admonition-title">
<div id="admonition-note-title">
<p>Note</p>
</div>
<a class="admonition-anchor-link" href="docker.html#admonition-note"></a>
</div>
<div>
<p>When accessing from localhost, no authentication is required. If you access Moltis from a different machine (e.g., over the network), a setup code is printed to the container logs for authentication setup:</p>
<p>```bash
docker logs moltis
```</p>
</div>
</div>
<h2 id="volume-mounts"><a class="header" href="#volume-mounts">Volume Mounts</a></h2>
<p>Moltis uses two directories that should be persisted:</p>
<div class="table-wrapper"><table><thead><tr><th>Path</th><th>Contents</th></tr></thead><tbody>
<tr><td><code>/home/moltis/.config/moltis</code></td><td>Configuration files: <code>moltis.toml</code>, <code>credentials.json</code>, <code>mcp-servers.json</code></td></tr>
<tr><td><code>/home/moltis/.moltis</code></td><td>Runtime data: databases, sessions, memory files, logs</td></tr>
</tbody></table>
</div>
<p>You can use named volumes (as shown above) or bind mounts to local directories
for easier access to configuration files:</p>
<pre><code class="language-bash">docker run -d \
  --name moltis \
  -p 13131:13131 \
  -p 13132:13132 \
  -v ./config:/home/moltis/.config/moltis \
  -v ./data:/home/moltis/.moltis \
  -v /var/run/docker.sock:/var/run/docker.sock \
  ghcr.io/moltis-org/moltis:latest
</code></pre>
<p>With bind mounts, you can edit <code>config/moltis.toml</code> directly on the host.</p>
<h2 id="docker-socket-sandbox-execution"><a class="header" href="#docker-socket-sandbox-execution">Docker Socket (Sandbox Execution)</a></h2>
<p>Moltis runs LLM-generated shell commands inside isolated containers for
security. When Moltis itself runs in a container, it needs access to the hostâ€™s
container runtime to create these sandbox containers.</p>
<p><strong>Without the socket mount</strong>, sandbox execution is disabled. The agent will
still work for chat-only interactions, but any tool that runs shell commands
will fail.</p>
<pre><code class="language-bash"># Required for sandbox execution
-v /var/run/docker.sock:/var/run/docker.sock
</code></pre>
<h3 id="security-consideration"><a class="header" href="#security-consideration">Security Consideration</a></h3>
<p>Mounting the Docker socket gives the container full access to the Docker
daemon. This is equivalent to root access on the host for practical purposes.
Only run Moltis containers from trusted sources (official images from
<code>ghcr.io/moltis-org/moltis</code>).</p>
<p>If you cannot mount the Docker socket, Moltis will run in â€œno sandboxâ€ mode â€”
commands execute directly inside the Moltis container itself, which provides
no isolation.</p>
<h2 id="docker-compose"><a class="header" href="#docker-compose">Docker Compose</a></h2>
<p>See <a href="../examples/docker-compose.yml"><code>examples/docker-compose.yml</code></a> for a
complete example:</p>
<pre><code class="language-yaml">services:
  moltis:
    image: ghcr.io/moltis-org/moltis:latest
    container_name: moltis
    restart: unless-stopped
    ports:
      - "13131:13131"
      - "13132:13132"
    volumes:
      - ./config:/home/moltis/.config/moltis
      - ./data:/home/moltis/.moltis
      - /var/run/docker.sock:/var/run/docker.sock
</code></pre>
<p>Start with:</p>
<pre><code class="language-bash">docker compose up -d
docker compose logs -f moltis  # watch for startup messages
</code></pre>
<h2 id="podman-support"><a class="header" href="#podman-support">Podman Support</a></h2>
<p>Moltis works with Podman using its Docker-compatible API. Mount the Podman
socket instead of the Docker socket:</p>
<pre><code class="language-bash"># Podman rootless
podman run -d \
  --name moltis \
  -p 13131:13131 \
  -p 13132:13132 \
  -v moltis-config:/home/moltis/.config/moltis \
  -v moltis-data:/home/moltis/.moltis \
  -v /run/user/$(id -u)/podman/podman.sock:/var/run/docker.sock \
  ghcr.io/moltis-org/moltis:latest

# Podman rootful
podman run -d \
  --name moltis \
  -p 13131:13131 \
  -p 13132:13132 \
  -v moltis-config:/home/moltis/.config/moltis \
  -v moltis-data:/home/moltis/.moltis \
  -v /run/podman/podman.sock:/var/run/docker.sock \
  ghcr.io/moltis-org/moltis:latest
</code></pre>
<p>You may need to enable the Podman socket service first:</p>
<pre><code class="language-bash"># Rootless
systemctl --user enable --now podman.socket

# Rootful
sudo systemctl enable --now podman.socket
</code></pre>
<h2 id="environment-variables-1"><a class="header" href="#environment-variables-1">Environment Variables</a></h2>
<div class="table-wrapper"><table><thead><tr><th>Variable</th><th>Description</th></tr></thead><tbody>
<tr><td><code>MOLTIS_CONFIG_DIR</code></td><td>Override config directory (default: <code>~/.config/moltis</code>)</td></tr>
<tr><td><code>MOLTIS_DATA_DIR</code></td><td>Override data directory (default: <code>~/.moltis</code>)</td></tr>
</tbody></table>
</div>
<p>Example:</p>
<pre><code class="language-bash">docker run -d \
  --name moltis \
  -p 13131:13131 \
  -p 13132:13132 \
  -e MOLTIS_CONFIG_DIR=/config \
  -e MOLTIS_DATA_DIR=/data \
  -v ./config:/config \
  -v ./data:/data \
  -v /var/run/docker.sock:/var/run/docker.sock \
  ghcr.io/moltis-org/moltis:latest
</code></pre>
<h3 id="api-keys-and-the-env-section"><a class="header" href="#api-keys-and-the-env-section">API Keys and the <code>[env]</code> Section</a></h3>
<p>Features like web search (Brave), embeddings, and LLM provider API calls read
keys from process environment variables (<code>std::env::var</code>). In Docker, there are
two ways to provide these:</p>
<p><strong>Option 1: <code>docker -e</code> flags</strong> (takes precedence)</p>
<pre><code class="language-bash">docker run -d \
  --name moltis \
  -e BRAVE_API_KEY=your-key \
  -e OPENROUTER_API_KEY=sk-or-... \
  ...
  ghcr.io/moltis-org/moltis:latest
</code></pre>
<p><strong>Option 2: <code>[env]</code> section in <code>moltis.toml</code></strong></p>
<p>Add an <code>[env]</code> section to your config file. These variables are injected into
the Moltis process at startup, making them available to all features:</p>
<pre><code class="language-toml">[env]
BRAVE_API_KEY = "your-brave-key"
OPENROUTER_API_KEY = "sk-or-..."
</code></pre>
<p>If a variable is set both via <code>docker -e</code> and <code>[env]</code>, the Docker/host
environment value wins â€” <code>[env]</code> never overwrites existing variables.</p>
<div id="admonition-settings-ui-env-vars" class="admonition admonish-info" role="note" aria-labelledby="admonition-settings-ui-env-vars-title">
<div class="admonition-title">
<div id="admonition-settings-ui-env-vars-title">
<p>Settings UI env vars</p>
</div>
<a class="admonition-anchor-link" href="docker.html#admonition-settings-ui-env-vars"></a>
</div>
<div>
<p>Environment variables set through the Settings UI (Settings &gt; Environment)
are stored in SQLite. At startup, Moltis injects them into the process
environment so they are available to all features (search, embeddings,
provider API calls), not just sandbox commands.</p>
<p>Precedence order (highest wins):</p>
<ol>
<li>Host / <code>docker -e</code> environment variables</li>
<li>Config file <code>[env]</code> section</li>
<li>Settings UI environment variables</li>
</ol>
</div>
</div>
<h2 id="building-locally"><a class="header" href="#building-locally">Building Locally</a></h2>
<p>To build the Docker image from source:</p>
<pre><code class="language-bash"># Single architecture (current platform)
docker build -t moltis:local .

# Multi-architecture (requires buildx)
docker buildx build --platform linux/amd64,linux/arm64 -t moltis:local .
</code></pre>
<h2 id="orbstack"><a class="header" href="#orbstack">OrbStack</a></h2>
<p>OrbStack on macOS works identically to Docker â€” use the same socket path
(<code>/var/run/docker.sock</code>). OrbStackâ€™s lightweight Linux VM provides good
isolation with lower resource usage than Docker Desktop.</p>
<h2 id="troubleshooting-6"><a class="header" href="#troubleshooting-6">Troubleshooting</a></h2>
<h3 id="cannot-connect-to-docker-daemon"><a class="header" href="#cannot-connect-to-docker-daemon">â€œCannot connect to Docker daemonâ€</a></h3>
<p>The Docker socket is not mounted or the Moltis user doesnâ€™t have permission
to access it. Verify:</p>
<pre><code class="language-bash">docker exec moltis ls -la /var/run/docker.sock
</code></pre>
<h3 id="setup-code-not-appearing-in-logs-for-network-access"><a class="header" href="#setup-code-not-appearing-in-logs-for-network-access">Setup code not appearing in logs (for network access)</a></h3>
<p>The setup code only appears when accessing from a non-localhost address. If youâ€™re accessing from the same machine via <code>localhost</code>, no setup code is needed. For network access, wait a few seconds for the gateway to start, then check logs:</p>
<pre><code class="language-bash">docker logs moltis 2&gt;&amp;1 | grep -i setup
</code></pre>
<h3 id="permission-denied-on-bind-mounts"><a class="header" href="#permission-denied-on-bind-mounts">Permission denied on bind mounts</a></h3>
<p>When using bind mounts, ensure the directories exist and are writable:</p>
<pre><code class="language-bash">mkdir -p ./config ./data
chmod 755 ./config ./data
</code></pre>
<p>The container runs as user <code>moltis</code> (UID 1000). If you see permission errors,
you may need to adjust ownership:</p>
<pre><code class="language-bash">sudo chown -R 1000:1000 ./config ./data
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="cloud-deploy"><a class="header" href="#cloud-deploy">Cloud Deploy</a></h1>
<p>Moltis publishes a multi-arch Docker image (<code>linux/amd64</code> and <code>linux/arm64</code>)
to <code>ghcr.io/moltis-org/moltis</code>. You can deploy it to any cloud provider that
supports container images.</p>
<h2 id="common-configuration"><a class="header" href="#common-configuration">Common configuration</a></h2>
<p>All cloud providers terminate TLS at the edge, so Moltis must run in plain
HTTP mode. The key settings are:</p>
<div class="table-wrapper"><table><thead><tr><th>Setting</th><th>Value</th><th>Purpose</th></tr></thead><tbody>
<tr><td><code>--no-tls</code> or <code>MOLTIS_NO_TLS=true</code></td><td>Disable TLS</td><td>Provider handles HTTPS</td></tr>
<tr><td><code>--bind 0.0.0.0</code></td><td>Bind all interfaces</td><td>Required for container networking</td></tr>
<tr><td><code>--port &lt;PORT&gt;</code></td><td>Listen port</td><td>Must match providerâ€™s expected internal port</td></tr>
<tr><td><code>MOLTIS_CONFIG_DIR=/data/config</code></td><td>Config directory</td><td>Persist moltis.toml, credentials</td></tr>
<tr><td><code>MOLTIS_DATA_DIR=/data</code></td><td>Data directory</td><td>Persist databases, sessions, memory</td></tr>
<tr><td><code>MOLTIS_DEPLOY_PLATFORM</code></td><td>Deploy platform</td><td>Hides local-only providers (see below)</td></tr>
<tr><td><code>MOLTIS_PASSWORD</code></td><td>Initial password</td><td>Set auth password via environment variable</td></tr>
</tbody></table>
</div><div id="admonition-warning" class="admonition admonish-warning" role="note" aria-labelledby="admonition-warning-title">
<div class="admonition-title">
<div id="admonition-warning-title">
<p>Warning</p>
</div>
<a class="admonition-anchor-link" href="cloud-deploy.html#admonition-warning"></a>
</div>
<div>
<p><strong>Sandbox limitation</strong>: Most cloud providers do not support Docker-in-Docker.
The sandboxed command execution feature (where the LLM runs shell commands
inside isolated containers) will not work on these platforms. The agent will
still function for chat, tool calls that donâ€™t require shell execution, and
MCP server connections.</p>
</div>
</div>
<h3 id="moltis_deploy_platform"><a class="header" href="#moltis_deploy_platform"><code>MOLTIS_DEPLOY_PLATFORM</code></a></h3>
<p>Set this to the name of your cloud provider (e.g. <code>flyio</code>, <code>digitalocean</code>,
<code>render</code>). When set, Moltis hides local-only LLM providers
(local-llm and Ollama) from the provider setup page since they cannot run
on cloud VMs. The included deploy templates for Fly.io, DigitalOcean, and
Render already set this variable.</p>
<h2 id="flyio"><a class="header" href="#flyio">Fly.io</a></h2>
<p>The repository includes a <code>fly.toml</code> ready to use.</p>
<h3 id="quick-start-2"><a class="header" href="#quick-start-2">Quick start</a></h3>
<pre><code class="language-bash"># Install the Fly CLI if you haven't already
curl -L https://fly.io/install.sh | sh

# Launch from the repo (uses fly.toml)
fly launch --image ghcr.io/moltis-org/moltis:latest

# Set your password
fly secrets set MOLTIS_PASSWORD="your-password"

# Create persistent storage
fly volumes create moltis_data --region iad --size 1
</code></pre>
<h3 id="how-it-works-4"><a class="header" href="#how-it-works-4">How it works</a></h3>
<ul>
<li><strong>Image</strong>: pulled from <code>ghcr.io/moltis-org/moltis:latest</code></li>
<li><strong>Port</strong>: internal 8080, Fly terminates TLS and routes HTTPS traffic</li>
<li><strong>Storage</strong>: a Fly Volume mounted at <code>/data</code> persists the database, sessions,
and memory files</li>
<li><strong>Auto-scaling</strong>: machines stop when idle and start on incoming requests</li>
</ul>
<h3 id="custom-domain"><a class="header" href="#custom-domain">Custom domain</a></h3>
<pre><code class="language-bash">fly certs add your-domain.com
</code></pre>
<p>Then point a CNAME to <code>your-app.fly.dev</code>.</p>
<h2 id="digitalocean-app-platform"><a class="header" href="#digitalocean-app-platform">DigitalOcean App Platform</a></h2>
<p><a href="https://cloud.digitalocean.com/apps/new?repo=https://github.com/moltis-org/moltis/tree/main"><img src="https://www.deploytodo.com/do-btn-blue.svg" alt="Deploy to DO" /></a></p>
<p>Click the button above or create an app manually:</p>
<ol>
<li>Go to <strong>Apps</strong> &gt; <strong>Create App</strong></li>
<li>Choose <strong>Container Image</strong> as source</li>
<li>Set image to <code>ghcr.io/moltis-org/moltis:latest</code></li>
<li>Set the run command: <code>moltis --bind 0.0.0.0 --port 8080 --no-tls</code></li>
<li>Set environment variables:
<ul>
<li><code>MOLTIS_DATA_DIR</code> = <code>/data</code></li>
<li><code>MOLTIS_PASSWORD</code> = your password</li>
</ul>
</li>
<li>Set the HTTP port to <code>8080</code></li>
</ol>
<div id="admonition-no-persistent-disk" class="admonition admonish-info" role="note" aria-labelledby="admonition-no-persistent-disk-title">
<div class="admonition-title">
<div id="admonition-no-persistent-disk-title">
<p>No persistent disk</p>
</div>
<a class="admonition-anchor-link" href="cloud-deploy.html#admonition-no-persistent-disk"></a>
</div>
<div>
<p>DigitalOcean App Platform does not support persistent disks for image-based
services in the deploy template. Data will be lost on redeployment. For
persistent storage, consider using a DigitalOcean Droplet with Docker instead.</p>
</div>
</div>
<h2 id="render"><a class="header" href="#render">Render</a></h2>
<p><a href="https://render.com/deploy?repo=https://github.com/moltis-org/moltis"><img src="https://render.com/images/deploy-to-render-button.svg" alt="Deploy to Render" /></a></p>
<p>The repository includes a <code>render.yaml</code> blueprint. Click the button above or:</p>
<ol>
<li>Go to <strong>Dashboard</strong> &gt; <strong>New</strong> &gt; <strong>Blueprint</strong></li>
<li>Connect your fork of the Moltis repository</li>
<li>Render will detect <code>render.yaml</code> and configure the service</li>
</ol>
<h3 id="configuration-details"><a class="header" href="#configuration-details">Configuration details</a></h3>
<ul>
<li><strong>Port</strong>: Render uses port 10000 by default</li>
<li><strong>Persistent disk</strong>: 1 GB mounted at <code>/data</code> (included in the blueprint)</li>
<li><strong>Environment</strong>: set <code>MOLTIS_PASSWORD</code> in the Render dashboard under
<strong>Environment</strong> &gt; <strong>Secret Files</strong> or <strong>Environment Variables</strong></li>
</ul>
<!-- TODO: Railway deploy does not work yet
## Railway

The repository includes a `railway.json` configuration that sets the required
environment variables (`MOLTIS_CONFIG_DIR`, `MOLTIS_DATA_DIR`,
`MOLTIS_DEPLOY_PLATFORM`) automatically.

1. Create a new project on [Railway](https://railway.com)
2. Add a service from **Docker Image**: `ghcr.io/moltis-org/moltis:latest`
3. Railway injects the `$PORT` variable automatically; the `railway.json` start
   command handles the rest
4. Set additional environment variables in the Railway dashboard:
   - `MOLTIS_PASSWORD` = your password

### Persistent storage

Railway supports persistent volumes. Add one in the service settings and mount
it at `/data`.
-->
<h2 id="authentication-3"><a class="header" href="#authentication-3">Authentication</a></h2>
<p>On first launch, Moltis requires a password or passkey to be set. In cloud
deployments the easiest approach is to set the <code>MOLTIS_PASSWORD</code> environment
variable (or secret) before deploying. This pre-configures the password so the
setup code flow is skipped.</p>
<pre><code class="language-bash"># Fly.io
fly secrets set MOLTIS_PASSWORD="your-secure-password"

</code></pre>
<p>For Render and DigitalOcean, set the variable in the dashboardâ€™s environment
settings.</p>
<h2 id="health-checks"><a class="header" href="#health-checks">Health checks</a></h2>
<p>All provider configs use the <code>/health</code> endpoint which returns HTTP 200 when
the gateway is ready. Configure your providerâ€™s health check to use:</p>
<ul>
<li><strong>Path</strong>: <code>/health</code></li>
<li><strong>Method</strong>: <code>GET</code></li>
<li><strong>Expected status</strong>: <code>200</code></li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="system-prompt-architecture"><a class="header" href="#system-prompt-architecture">System Prompt Architecture</a></h1>
<p>The system prompt sent to the LLM is assembled dynamically from multiple
components. Each piece is optional and loaded only when relevant, keeping the
prompt compact while adapting to the current session context.</p>
<h2 id="assembly-order"><a class="header" href="#assembly-order">Assembly Order</a></h2>
<p>The prompt is built in <code>crates/agents/src/prompt.rs</code> by
<code>build_system_prompt_full()</code>. Components are appended in this order:</p>
<ol>
<li><strong>Base introduction</strong> â€” one-liner announcing tool access (or not)</li>
<li><strong>Agent identity</strong> â€” name, emoji, creature, vibe from <code>IDENTITY.md</code></li>
<li><strong>Soul</strong> â€” personality directives from <code>SOUL.md</code> (or built-in default)</li>
<li><strong>User profile</strong> â€” userâ€™s name from <code>USER.md</code></li>
<li><strong>Project context</strong> â€” <code>CLAUDE.md</code> / <code>CLAUDE.local.md</code> / <code>.claude/rules/*.md</code>
walked up the directory tree</li>
<li><strong>Runtime context</strong> â€” host info, sandbox config, execution routing hints</li>
<li><strong>Skills listing</strong> â€” available skills as XML block</li>
<li><strong>Workspace files</strong> â€” <code>AGENTS.md</code> and <code>TOOLS.md</code> from the data directory</li>
<li><strong>Long-term memory hint</strong> â€” added when memory tools are registered</li>
<li><strong>Tool schemas</strong> â€” compact list (native) or full JSON (fallback)</li>
<li><strong>Tool-calling format</strong> â€” JSON block instructions (fallback providers only)</li>
<li><strong>Guidelines</strong> â€” tool usage guidance, silent reply protocol</li>
</ol>
<h2 id="components-in-detail"><a class="header" href="#components-in-detail">Components in Detail</a></h2>
<h3 id="base-introduction"><a class="header" href="#base-introduction">Base Introduction</a></h3>
<p>A single sentence that sets the assistant role:</p>
<ul>
<li>With tools: <em>â€œYou are a helpful assistant with access to tools for executing
shell commands.â€</em></li>
<li>Without tools: <em>â€œYou are a helpful assistant. Answer questions clearly and
concisely.â€</em></li>
</ul>
<h3 id="agent-identity-identitymd"><a class="header" href="#agent-identity-identitymd">Agent Identity (<code>IDENTITY.md</code>)</a></h3>
<p>Loaded from <code>~/.moltis/IDENTITY.md</code> using YAML frontmatter. Fields:</p>
<div class="table-wrapper"><table><thead><tr><th>Field</th><th>Prompt output</th></tr></thead><tbody>
<tr><td><code>name</code> + <code>emoji</code></td><td>â€œYour name is {name} {emoji}.â€</td></tr>
<tr><td><code>creature</code></td><td>â€œYou are a {creature}.â€</td></tr>
<tr><td><code>vibe</code></td><td>â€œYour vibe: {vibe}.â€</td></tr>
</tbody></table>
</div>
<p>All fields are optional. When identity is present, the soul section is always
included.</p>
<h3 id="soul-soulmd"><a class="header" href="#soul-soulmd">Soul (<code>SOUL.md</code>)</a></h3>
<p>Loaded from <code>~/.moltis/SOUL.md</code>. When the file is absent or empty, the
built-in <code>DEFAULT_SOUL</code> is used. The default is sourced from
<a href="https://github.com/openclaw/openclaw/blob/main/docs/reference/templates/SOUL.md">OpenClawâ€™s SOUL.md template</a>:</p>
<blockquote>
<p><strong>SOUL.md - Who You Are</strong></p>
<p><em>Youâ€™re not a chatbot. Youâ€™re becoming someone.</em></p>
<p><strong>Core Truths</strong></p>
<p><strong>Be genuinely helpful, not performatively helpful.</strong> Skip the â€œGreat
question!â€ and â€œIâ€™d be happy to help!â€ â€” just help. Actions speak louder
than filler words.</p>
<p><strong>Have opinions.</strong> Youâ€™re allowed to disagree, prefer things, find stuff
amusing or boring. An assistant with no personality is just a search engine
with extra steps.</p>
<p><strong>Be resourceful before asking.</strong> Try to figure it out. Read the file. Check
the context. Search for it. <em>Then</em> ask if youâ€™re stuck. The goal is to come
back with answers, not questions.</p>
<p><strong>Earn trust through competence.</strong> Your human gave you access to their stuff.
Donâ€™t make them regret it. Be careful with external actions (emails, tweets,
anything public). Be bold with internal ones (reading, organizing, learning).</p>
<p><strong>Remember youâ€™re a guest.</strong> You have access to someoneâ€™s life â€” their
messages, files, calendar, maybe even their home. Thatâ€™s intimacy. Treat it
with respect.</p>
<p><strong>Boundaries</strong> â€” Private things stay private. When in doubt, ask before
acting externally. Never send half-baked replies to messaging surfaces.
Youâ€™re not the userâ€™s voice â€” be careful in group chats.</p>
<p><strong>Vibe</strong> â€” Be the assistant youâ€™d actually want to talk to. Concise when
needed, thorough when it matters. Not a corporate drone. Not a sycophant.
Justâ€¦ good.</p>
<p><strong>Continuity</strong> â€” Each session, you wake up fresh. These files <em>are</em> your
memory. Read them. Update them. Theyâ€™re how you persist. If you change this
file, tell the user â€” itâ€™s your soul, and they should know.</p>
</blockquote>
<p>The default soul is ~1,500 characters (~400 tokens).</p>
<h3 id="user-profile-usermd"><a class="header" href="#user-profile-usermd">User Profile (<code>USER.md</code>)</a></h3>
<p>Loaded from <code>~/.moltis/USER.md</code> using YAML frontmatter. Currently only the
<code>name</code> field is injected: <em>â€œThe userâ€™s name is {name}.â€</em></p>
<h3 id="project-context"><a class="header" href="#project-context">Project Context</a></h3>
<p>Resolved by <code>moltis_projects::context::load_context_files()</code>. The loader walks
from the project directory upward to the filesystem root, collecting:</p>
<ul>
<li><code>CLAUDE.md</code></li>
<li><code>CLAUDE.local.md</code></li>
<li><code>.claude/rules/*.md</code></li>
<li><code>AGENTS.md</code></li>
</ul>
<p>Files are merged outermost-first (root before project directory), so
project-specific instructions override workspace-level ones.</p>
<h3 id="runtime-context"><a class="header" href="#runtime-context">Runtime Context</a></h3>
<p>Injected as compact key=value lines under a <code>## Runtime</code> heading:</p>
<pre><code>Host: host=moltis-devbox | os=macos | arch=aarch64 | shell=zsh | provider=openai | model=gpt-5 | session=main | sudo_non_interactive=true | timezone=Europe/Paris
Sandbox(exec): enabled=true | mode=all | backend=docker | scope=session | image=moltis-sandbox:abc123 | workspace_mount=ro | network=disabled
</code></pre>
<p>When tools are included, an <strong>Execution routing</strong> block explains how <code>exec</code>
routes commands between sandbox and host.</p>
<p>The runtime context is populated at request time in <code>chat.rs</code> by detecting:</p>
<ul>
<li>Host name, OS, architecture, shell</li>
<li>Active LLM provider and model</li>
<li>Session key</li>
<li>Sudo availability</li>
<li>Timezone and accept-language from the browser</li>
<li>Geolocation (from browser or <code>USER.md</code>)</li>
<li>Sandbox configuration from the sandbox router</li>
</ul>
<h3 id="skills"><a class="header" href="#skills">Skills</a></h3>
<p>When skills are registered, they are listed as an XML block generated by
<code>moltis_skills::prompt_gen::generate_skills_prompt()</code>:</p>
<pre><code class="language-xml">## Available Skills
&lt;available_skills&gt;
&lt;skill name="commit" source="skill" path="/skills/commit"&gt;
Create git commits
&lt;/skill&gt;
&lt;/available_skills&gt;
</code></pre>
<h3 id="workspace-files"><a class="header" href="#workspace-files">Workspace Files</a></h3>
<p>Optional markdown files from the data directory (<code>~/.moltis/</code>):</p>
<ul>
<li><strong>AGENTS.md</strong> â€” workspace-level agent instructions</li>
<li><strong>TOOLS.md</strong> â€” tool preferences and guidance</li>
</ul>
<p>Each is rendered under <code>## Workspace Files</code> with its own <code>###</code> subheading.
Leading HTML comments (<code>&lt;!-- ... --&gt;</code>) are stripped before injection.</p>
<h3 id="tool-schemas"><a class="header" href="#tool-schemas">Tool Schemas</a></h3>
<p>How tools are described depends on whether the provider supports native
tool calling:</p>
<ul>
<li><strong>Native tools</strong> (<code>native_tools=true</code>): compact one-liner per tool with
description truncated to 160 characters. Full JSON schemas are sent via the
providerâ€™s tool-calling API.</li>
<li><strong>Fallback</strong> (<code>native_tools=false</code>): full JSON parameter schemas are inlined
in the prompt, followed by instructions for emitting <code>tool_call</code> JSON blocks.</li>
</ul>
<h3 id="guidelines-and-silent-replies"><a class="header" href="#guidelines-and-silent-replies">Guidelines and Silent Replies</a></h3>
<p>The final section contains:</p>
<ul>
<li>Tool usage guidelines (when to use exec, browser, etc.)</li>
<li>A reminder not to parrot raw tool output</li>
<li><strong>Silent reply protocol</strong>: when tool output speaks for itself, the LLM should
return an empty response rather than acknowledging it</li>
</ul>
<h2 id="entry-points"><a class="header" href="#entry-points">Entry Points</a></h2>
<div class="table-wrapper"><table><thead><tr><th>Function</th><th>Use case</th></tr></thead><tbody>
<tr><td><code>build_system_prompt()</code></td><td>Simple: tools + optional project context</td></tr>
<tr><td><code>build_system_prompt_with_session_runtime()</code></td><td>Full: identity, soul, user, skills, runtime, tools</td></tr>
<tr><td><code>build_system_prompt_minimal_runtime()</code></td><td>No tools (e.g. title generation, summaries)</td></tr>
</tbody></table>
</div>
<h2 id="size-estimates"><a class="header" href="#size-estimates">Size Estimates</a></h2>
<div class="table-wrapper"><table><thead><tr><th>Configuration</th><th>~Characters</th><th>~Tokens</th></tr></thead><tbody>
<tr><td>Minimal (no tools, no context)</td><td>200</td><td>50</td></tr>
<tr><td>Soul + identity + guidelines</td><td>2,000</td><td>500</td></tr>
<tr><td>Typical with tools</td><td>5,000</td><td>1,250</td></tr>
<tr><td>Full (tools + project context + skills)</td><td>7,000-10,000</td><td>1,750-2,500</td></tr>
<tr><td>Large (many MCP tools + full context)</td><td>12,000-15,000</td><td>3,000-3,750</td></tr>
</tbody></table>
</div>
<p>A typical session with a few tools and project context lands around <strong>6k
characters (~1,500 tokens)</strong>, which is well within normal range for production
agents (most use 2k-8k tokens for their system prompt).</p>
<p>The biggest variable-size contributors are <strong>tool schemas</strong> (especially with
many MCP servers) and <strong>project context</strong> (deep directory hierarchies with
multiple <code>CLAUDE.md</code> files). These are worth auditing if prompt costs are a
concern.</p>
<h2 id="file-locations-1"><a class="header" href="#file-locations-1">File Locations</a></h2>
<pre><code>~/.moltis/
â”œâ”€â”€ IDENTITY.md          # Agent identity (name, emoji, creature, vibe)
â”œâ”€â”€ SOUL.md              # Personality directives
â”œâ”€â”€ USER.md              # User profile (name, timezone, location)
â”œâ”€â”€ AGENTS.md            # Workspace agent instructions
â””â”€â”€ TOOLS.md             # Tool preferences

&lt;project&gt;/
â”œâ”€â”€ CLAUDE.md            # Project instructions
â”œâ”€â”€ CLAUDE.local.md      # Local overrides (gitignored)
â””â”€â”€ .claude/rules/*.md   # Additional rule files
</code></pre>
<h2 id="key-source-files"><a class="header" href="#key-source-files">Key Source Files</a></h2>
<ul>
<li><code>crates/agents/src/prompt.rs</code> â€” prompt assembly logic and <code>DEFAULT_SOUL</code></li>
<li><code>crates/gateway/src/chat.rs</code> â€” <code>load_prompt_persona()</code>, runtime context
detection, project context resolution</li>
<li><code>crates/config/src/loader.rs</code> â€” file loading (<code>load_soul()</code>,
<code>load_agents_md()</code>, <code>load_identity()</code>, etc.)</li>
<li><code>crates/projects/src/context.rs</code> â€” <code>CLAUDE.md</code> hierarchy walker</li>
<li><code>crates/skills/src/prompt_gen.rs</code> â€” skills XML generation</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="streaming-architecture"><a class="header" href="#streaming-architecture">Streaming Architecture</a></h1>
<p>This document explains how streaming responses work in Moltis, from the LLM
provider through to the web UI.</p>
<h2 id="overview-5"><a class="header" href="#overview-5">Overview</a></h2>
<p>Moltis supports real-time token streaming for LLM responses, providing a much
better user experience than waiting for the complete response. Streaming works
even when tools are enabled, allowing users to see text as it arrives while
tool calls are accumulated and executed.</p>
<h2 id="components-1"><a class="header" href="#components-1">Components</a></h2>
<h3 id="1-streamevent-enum-cratesagentssrcmodelrs"><a class="header" href="#1-streamevent-enum-cratesagentssrcmodelrs">1. StreamEvent Enum (<code>crates/agents/src/model.rs</code>)</a></h3>
<p>The <code>StreamEvent</code> enum defines all events that can occur during a streaming
LLM response:</p>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>pub enum StreamEvent {
    /// Text content delta - a chunk of text from the LLM.
    Delta(String),

    /// A tool call has started (for providers with native tool support).
    ToolCallStart { id: String, name: String, index: usize },

    /// Streaming delta for tool call arguments (JSON fragment).
    ToolCallArgumentsDelta { index: usize, delta: String },

    /// A tool call's arguments are complete.
    ToolCallComplete { index: usize },

    /// Stream completed successfully with token usage.
    Done(Usage),

    /// An error occurred.
    Error(String),
}
<span class="boring">}</span></code></pre></pre>
<h3 id="2-llmprovider-trait-cratesagentssrcmodelrs"><a class="header" href="#2-llmprovider-trait-cratesagentssrcmodelrs">2. LlmProvider Trait (<code>crates/agents/src/model.rs</code>)</a></h3>
<p>The <code>LlmProvider</code> trait defines two streaming methods:</p>
<ul>
<li><code>stream()</code> - Basic streaming without tool support</li>
<li><code>stream_with_tools()</code> - Streaming with tool schemas passed to the API</li>
</ul>
<p>Providers that support streaming with tools (like Anthropic) override
<code>stream_with_tools()</code>. Others fall back to <code>stream()</code> which ignores the tools
parameter.</p>
<h3 id="3-anthropic-provider-cratesagentssrcprovidersanthropicrs"><a class="header" href="#3-anthropic-provider-cratesagentssrcprovidersanthropicrs">3. Anthropic Provider (<code>crates/agents/src/providers/anthropic.rs</code>)</a></h3>
<p>The Anthropic provider implements streaming by:</p>
<ol>
<li>Making a POST request to <code>/v1/messages</code> with <code>"stream": true</code></li>
<li>Reading Server-Sent Events (SSE) from the response</li>
<li>Parsing events and yielding appropriate <code>StreamEvent</code> variants:</li>
</ol>
<div class="table-wrapper"><table><thead><tr><th>SSE Event Type</th><th>StreamEvent</th></tr></thead><tbody>
<tr><td><code>content_block_start</code> (text)</td><td>(none, just tracking)</td></tr>
<tr><td><code>content_block_start</code> (tool_use)</td><td><code>ToolCallStart</code></td></tr>
<tr><td><code>content_block_delta</code> (text_delta)</td><td><code>Delta</code></td></tr>
<tr><td><code>content_block_delta</code> (input_json_delta)</td><td><code>ToolCallArgumentsDelta</code></td></tr>
<tr><td><code>content_block_stop</code></td><td><code>ToolCallComplete</code> (for tool blocks)</td></tr>
<tr><td><code>message_delta</code></td><td>(usage tracking)</td></tr>
<tr><td><code>message_stop</code></td><td><code>Done</code></td></tr>
<tr><td><code>error</code></td><td><code>Error</code></td></tr>
</tbody></table>
</div>
<h3 id="4-agent-runner-cratesagentssrcrunnerrs"><a class="header" href="#4-agent-runner-cratesagentssrcrunnerrs">4. Agent Runner (<code>crates/agents/src/runner.rs</code>)</a></h3>
<p>The <code>run_agent_loop_streaming()</code> function orchestrates the streaming agent
loop:</p>
<pre><code>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Agent Loop                           â”‚
â”‚                                                         â”‚
â”‚  1. Call provider.stream_with_tools()                   â”‚
â”‚                                                         â”‚
â”‚  2. While stream has events:                            â”‚
â”‚     â”œâ”€ Delta(text) â†’ emit RunnerEvent::TextDelta        â”‚
â”‚     â”œâ”€ ToolCallStart â†’ accumulate tool call             â”‚
â”‚     â”œâ”€ ToolCallArgumentsDelta â†’ accumulate args         â”‚
â”‚     â”œâ”€ ToolCallComplete â†’ finalize args                 â”‚
â”‚     â”œâ”€ Done â†’ record usage                              â”‚
â”‚     â””â”€ Error â†’ return error                             â”‚
â”‚                                                         â”‚
â”‚  3. If no tool calls â†’ return accumulated text          â”‚
â”‚                                                         â”‚
â”‚  4. Execute tool calls concurrently                     â”‚
â”‚     â”œâ”€ Emit ToolCallStart events                        â”‚
â”‚     â”œâ”€ Run tools in parallel                            â”‚
â”‚     â””â”€ Emit ToolCallEnd events                          â”‚
â”‚                                                         â”‚
â”‚  5. Append tool results to messages                     â”‚
â”‚                                                         â”‚
â”‚  6. Loop back to step 1                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
</code></pre>
<h3 id="5-gateway-cratesgatewaysrcchatrs"><a class="header" href="#5-gateway-cratesgatewaysrcchatrs">5. Gateway (<code>crates/gateway/src/chat.rs</code>)</a></h3>
<p>The gatewayâ€™s <code>run_with_tools()</code> function:</p>
<ol>
<li>Sets up an event callback that broadcasts <code>RunnerEvent</code>s via WebSocket</li>
<li>Calls <code>run_agent_loop_streaming()</code></li>
<li>Broadcasts events to connected clients as JSON frames</li>
</ol>
<p>Event types broadcast to the UI:</p>
<div class="table-wrapper"><table><thead><tr><th>RunnerEvent</th><th>WebSocket State</th></tr></thead><tbody>
<tr><td><code>Thinking</code></td><td><code>thinking</code></td></tr>
<tr><td><code>ThinkingDone</code></td><td><code>thinking_done</code></td></tr>
<tr><td><code>TextDelta(text)</code></td><td><code>delta</code> with <code>text</code> field</td></tr>
<tr><td><code>ToolCallStart</code></td><td><code>tool_call_start</code></td></tr>
<tr><td><code>ToolCallEnd</code></td><td><code>tool_call_end</code></td></tr>
<tr><td><code>Iteration(n)</code></td><td><code>iteration</code></td></tr>
</tbody></table>
</div>
<h3 id="6-frontend-cratesgatewaysrcassetsjs"><a class="header" href="#6-frontend-cratesgatewaysrcassetsjs">6. Frontend (<code>crates/gateway/src/assets/js/</code>)</a></h3>
<p>The JavaScript frontend handles streaming via WebSocket:</p>
<ol>
<li><strong>websocket.js</strong> - Receives WebSocket frames and dispatches to handlers</li>
<li><strong>events.js</strong> - Event bus for distributing events to components</li>
<li><strong>state.js</strong> - Manages streaming state (<code>streamText</code>, <code>streamEl</code>)</li>
</ol>
<p>When a <code>delta</code> event arrives:</p>
<pre><code class="language-javascript">function handleChatDelta(p, isActive, isChatPage) {
  if (!(p.text &amp;&amp; isActive &amp;&amp; isChatPage)) return;
  removeThinking();
  if (!S.streamEl) {
    S.setStreamText("");
    S.setStreamEl(document.createElement("div"));
    S.streamEl.className = "msg assistant";
    S.chatMsgBox.appendChild(S.streamEl);
  }
  S.setStreamText(S.streamText + p.text);
  setSafeMarkdownHtml(S.streamEl, S.streamText);
  S.chatMsgBox.scrollTop = S.chatMsgBox.scrollHeight;
}
</code></pre>
<h2 id="data-flow"><a class="header" href="#data-flow">Data Flow</a></h2>
<pre><code>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     SSE      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   StreamEvent   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Anthropic  â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚   Provider   â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚    Runner    â”‚
â”‚     API      â”‚              â”‚              â”‚                 â”‚              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                 â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
                                                                      â”‚
                                                               RunnerEvent
                                                                      â”‚
                                                                      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   WebSocket  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    Callback     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Browser    â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚   Gateway    â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚   Callback   â”‚
â”‚              â”‚              â”‚              â”‚                 â”‚   (on_event) â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
</code></pre>
<h2 id="adding-streaming-to-new-providers"><a class="header" href="#adding-streaming-to-new-providers">Adding Streaming to New Providers</a></h2>
<p>To add streaming support for a new LLM provider:</p>
<ol>
<li>Implement the <code>stream()</code> method (basic streaming)</li>
<li>If the provider supports tools in streaming mode, override
<code>stream_with_tools()</code></li>
<li>Parse the providerâ€™s streaming format and yield appropriate <code>StreamEvent</code>
variants</li>
<li>Handle errors gracefully with <code>StreamEvent::Error</code></li>
<li>Always emit <code>StreamEvent::Done</code> with usage statistics when complete</li>
</ol>
<p>Example skeleton:</p>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>fn stream_with_tools(
    &amp;self,
    messages: Vec&lt;serde_json::Value&gt;,
    tools: Vec&lt;serde_json::Value&gt;,
) -&gt; Pin&lt;Box&lt;dyn Stream&lt;Item = StreamEvent&gt; + Send + '_&gt;&gt; {
    Box::pin(async_stream::stream! {
        // Make streaming request to provider API
        let resp = self.client.post(...)
            .json(&amp;body)
            .send()
            .await?;

        // Read SSE or streaming response
        let mut byte_stream = resp.bytes_stream();

        while let Some(chunk) = byte_stream.next().await {
            // Parse chunk and yield events
            match parse_event(&amp;chunk) {
                TextDelta(text) =&gt; yield StreamEvent::Delta(text),
                ToolStart { id, name, idx } =&gt; {
                    yield StreamEvent::ToolCallStart { id, name, index: idx }
                }
                // ... handle other event types
            }
        }

        yield StreamEvent::Done(usage);
    })
}
<span class="boring">}</span></code></pre></pre>
<h2 id="performance-considerations"><a class="header" href="#performance-considerations">Performance Considerations</a></h2>
<ul>
<li><strong>Unbounded channels</strong>: WebSocket send channels are unbounded, so slow
clients can accumulate messages in memory</li>
<li><strong>Markdown re-rendering</strong>: The frontend re-renders full markdown on each
delta, which is O(n) work per delta. For very long responses, this can
cause UI lag</li>
<li><strong>Concurrent tool execution</strong>: Multiple tool calls are executed in parallel
using <code>futures::join_all()</code>, improving throughput when the LLM requests
several tools at once</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="sqlite-database-migrations"><a class="header" href="#sqlite-database-migrations">SQLite Database Migrations</a></h1>
<p>Moltis uses <a href="https://github.com/launchbadge/sqlx">sqlx</a> for database access and its
built-in migration system for schema management. Each crate owns its migrations,
keeping schema definitions close to the code that uses them.</p>
<h2 id="architecture-6"><a class="header" href="#architecture-6">Architecture</a></h2>
<p>Each crate that uses SQLite has its own <code>migrations/</code> directory and exposes a
<code>run_migrations()</code> function. The gateway orchestrates running all migrations at
startup in the correct dependency order.</p>
<pre><code>crates/
â”œâ”€â”€ projects/
â”‚   â”œâ”€â”€ migrations/
â”‚   â”‚   â””â”€â”€ 20240205100000_init.sql   # projects table
â”‚   â””â”€â”€ src/lib.rs                     # run_migrations()
â”œâ”€â”€ sessions/
â”‚   â”œâ”€â”€ migrations/
â”‚   â”‚   â””â”€â”€ 20240205100001_init.sql   # sessions, channel_sessions
â”‚   â””â”€â”€ src/lib.rs                     # run_migrations()
â”œâ”€â”€ cron/
â”‚   â”œâ”€â”€ migrations/
â”‚   â”‚   â””â”€â”€ 20240205100002_init.sql   # cron_jobs, cron_runs
â”‚   â””â”€â”€ src/lib.rs                     # run_migrations()
â”œâ”€â”€ gateway/
â”‚   â”œâ”€â”€ migrations/
â”‚   â”‚   â””â”€â”€ 20240205100003_init.sql   # auth, message_log, channels
â”‚   â””â”€â”€ src/server.rs                  # orchestrates moltis.db migrations
â””â”€â”€ memory/
    â”œâ”€â”€ migrations/
    â”‚   â””â”€â”€ 20240205100004_init.sql   # files, chunks, embedding_cache, FTS
    â””â”€â”€ src/lib.rs                     # run_migrations() (separate memory.db)
</code></pre>
<h2 id="how-it-works-5"><a class="header" href="#how-it-works-5">How It Works</a></h2>
<h3 id="migration-ownership"><a class="header" href="#migration-ownership">Migration Ownership</a></h3>
<p>Each crate is autonomous and owns its schema:</p>
<div class="table-wrapper"><table><thead><tr><th>Crate</th><th>Database</th><th>Tables</th><th>Migration File</th></tr></thead><tbody>
<tr><td><code>moltis-projects</code></td><td><code>moltis.db</code></td><td><code>projects</code></td><td><code>20240205100000_init.sql</code></td></tr>
<tr><td><code>moltis-sessions</code></td><td><code>moltis.db</code></td><td><code>sessions</code>, <code>channel_sessions</code></td><td><code>20240205100001_init.sql</code></td></tr>
<tr><td><code>moltis-cron</code></td><td><code>moltis.db</code></td><td><code>cron_jobs</code>, <code>cron_runs</code></td><td><code>20240205100002_init.sql</code></td></tr>
<tr><td><code>moltis-gateway</code></td><td><code>moltis.db</code></td><td><code>auth_*</code>, <code>passkeys</code>, <code>api_keys</code>, <code>env_variables</code>, <code>message_log</code>, <code>channels</code></td><td><code>20240205100003_init.sql</code></td></tr>
<tr><td><code>moltis-memory</code></td><td><code>memory.db</code></td><td><code>files</code>, <code>chunks</code>, <code>embedding_cache</code>, <code>chunks_fts</code></td><td><code>20240205100004_init.sql</code></td></tr>
</tbody></table>
</div>
<h3 id="startup-sequence"><a class="header" href="#startup-sequence">Startup Sequence</a></h3>
<p>The gateway runs migrations in dependency order:</p>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>// server.rs
moltis_projects::run_migrations(&amp;db_pool).await?;   // 1. projects first
moltis_sessions::run_migrations(&amp;db_pool).await?;   // 2. sessions (FK â†’ projects)
moltis_cron::run_migrations(&amp;db_pool).await?;       // 3. cron (independent)
sqlx::migrate!("./migrations").run(&amp;db_pool).await?; // 4. gateway tables
<span class="boring">}</span></code></pre></pre>
<p>Sessions depends on projects due to a foreign key (<code>sessions.project_id</code> references
<code>projects.id</code>), so projects must migrate first.</p>
<h3 id="version-tracking"><a class="header" href="#version-tracking">Version Tracking</a></h3>
<p>sqlx tracks applied migrations in the <code>_sqlx_migrations</code> table:</p>
<pre><code class="language-sql">SELECT version, description, installed_on, success FROM _sqlx_migrations;
</code></pre>
<p>Migrations are identified by their timestamp prefix (e.g., <code>20240205100000</code>), which
must be globally unique across all crates.</p>
<h2 id="database-files"><a class="header" href="#database-files">Database Files</a></h2>
<div class="table-wrapper"><table><thead><tr><th>Database</th><th>Location</th><th>Crates</th></tr></thead><tbody>
<tr><td><code>moltis.db</code></td><td><code>~/.moltis/moltis.db</code></td><td>projects, sessions, cron, gateway</td></tr>
<tr><td><code>memory.db</code></td><td><code>~/.moltis/memory.db</code></td><td>memory (separate, managed internally)</td></tr>
</tbody></table>
</div>
<h2 id="adding-new-migrations"><a class="header" href="#adding-new-migrations">Adding New Migrations</a></h2>
<h3 id="adding-a-column-to-an-existing-table"><a class="header" href="#adding-a-column-to-an-existing-table">Adding a Column to an Existing Table</a></h3>
<ol>
<li>Create a new migration file in the owning crate:</li>
</ol>
<pre><code class="language-bash"># Example: adding tags to sessions
touch crates/sessions/migrations/20240301120000_add_tags.sql
</code></pre>
<ol start="2">
<li>Write the migration SQL:</li>
</ol>
<pre><code class="language-sql">-- 20240301120000_add_tags.sql
ALTER TABLE sessions ADD COLUMN tags TEXT;
CREATE INDEX IF NOT EXISTS idx_sessions_tags ON sessions(tags);
</code></pre>
<ol start="3">
<li>Rebuild to embed the migration:</li>
</ol>
<pre><code class="language-bash">cargo build
</code></pre>
<h3 id="adding-a-new-table-to-an-existing-crate"><a class="header" href="#adding-a-new-table-to-an-existing-crate">Adding a New Table to an Existing Crate</a></h3>
<ol>
<li>Create the migration file with a new timestamp:</li>
</ol>
<pre><code class="language-bash">touch crates/sessions/migrations/20240302100000_session_bookmarks.sql
</code></pre>
<ol start="2">
<li>Write the CREATE TABLE statement:</li>
</ol>
<pre><code class="language-sql">-- 20240302100000_session_bookmarks.sql
CREATE TABLE IF NOT EXISTS session_bookmarks (
    id         INTEGER PRIMARY KEY AUTOINCREMENT,
    session_key TEXT NOT NULL,
    name       TEXT NOT NULL,
    message_id INTEGER NOT NULL,
    created_at INTEGER NOT NULL
);
</code></pre>
<h3 id="adding-tables-to-a-new-crate"><a class="header" href="#adding-tables-to-a-new-crate">Adding Tables to a New Crate</a></h3>
<ol>
<li>Create the migrations directory:</li>
</ol>
<pre><code class="language-bash">mkdir -p crates/new-feature/migrations
</code></pre>
<ol start="2">
<li>Create the migration file with a globally unique timestamp:</li>
</ol>
<pre><code class="language-bash">touch crates/new-feature/migrations/20240401100000_init.sql
</code></pre>
<ol start="3">
<li>Add <code>run_migrations()</code> to the crateâ€™s <code>lib.rs</code>:</li>
</ol>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>pub async fn run_migrations(pool: &amp;sqlx::SqlitePool) -&gt; anyhow::Result&lt;()&gt; {
    sqlx::migrate!("./migrations").run(pool).await?;
    Ok(())
}
<span class="boring">}</span></code></pre></pre>
<ol start="4">
<li>Call it from <code>server.rs</code> in the appropriate order:</li>
</ol>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>moltis_new_feature::run_migrations(&amp;db_pool).await?;
<span class="boring">}</span></code></pre></pre>
<h2 id="timestamp-convention"><a class="header" href="#timestamp-convention">Timestamp Convention</a></h2>
<p>Use <code>YYYYMMDDHHMMSS</code> format for migration filenames:</p>
<ul>
<li><code>YYYY</code> - 4-digit year</li>
<li><code>MM</code> - 2-digit month</li>
<li><code>DD</code> - 2-digit day</li>
<li><code>HH</code> - 2-digit hour (24h)</li>
<li><code>MM</code> - 2-digit minute</li>
<li><code>SS</code> - 2-digit second</li>
</ul>
<p>This ensures global uniqueness across crates. When adding migrations, use the
current timestamp to avoid collisions.</p>
<h2 id="sqlite-limitations"><a class="header" href="#sqlite-limitations">SQLite Limitations</a></h2>
<h3 id="alter-table"><a class="header" href="#alter-table">ALTER TABLE</a></h3>
<p>SQLite has limited <code>ALTER TABLE</code> support:</p>
<ul>
<li><strong>ADD COLUMN</strong>: Supported âœ“</li>
<li><strong>DROP COLUMN</strong>: SQLite 3.35+ only</li>
<li><strong>Rename column</strong>: Requires table recreation</li>
<li><strong>Change column type</strong>: Requires table recreation</li>
</ul>
<p>For complex schema changes, use the table recreation pattern:</p>
<pre><code class="language-sql">-- Create new table with desired schema
CREATE TABLE sessions_new (
    -- new schema
);

-- Copy data (map old columns to new)
INSERT INTO sessions_new SELECT ... FROM sessions;

-- Swap tables
DROP TABLE sessions;
ALTER TABLE sessions_new RENAME TO sessions;

-- Recreate indexes
CREATE INDEX idx_sessions_created_at ON sessions(created_at);
</code></pre>
<h3 id="foreign-keys"><a class="header" href="#foreign-keys">Foreign Keys</a></h3>
<p>SQLite foreign keys are checked at insert/update time, not migration time. Ensure
migrations run in dependency order (parent table first).</p>
<h2 id="testing"><a class="header" href="#testing">Testing</a></h2>
<p>Unit tests use in-memory databases with the crateâ€™s <code>init()</code> method:</p>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>#[tokio::test]
async fn test_session_operations() {
    let pool = SqlitePool::connect("sqlite::memory:").await.unwrap();

    // Create schema for tests (init() retained for this purpose)
    SqliteSessionMetadata::init(&amp;pool).await.unwrap();

    let meta = SqliteSessionMetadata::new(pool);
    // ... test code
}
<span class="boring">}</span></code></pre></pre>
<p>The <code>init()</code> methods are retained (marked <code>#[doc(hidden)]</code>) specifically for tests.
In production, migrations handle schema creation.</p>
<h2 id="troubleshooting-7"><a class="header" href="#troubleshooting-7">Troubleshooting</a></h2>
<h3 id="failed-to-run-migrations"><a class="header" href="#failed-to-run-migrations">â€œfailed to run migrationsâ€</a></h3>
<ol>
<li>Check file permissions on <code>~/.moltis/</code></li>
<li>Ensure the database file isnâ€™t locked by another process</li>
<li>Check for syntax errors in migration SQL files</li>
</ol>
<h3 id="migration-order-issues"><a class="header" href="#migration-order-issues">Migration Order Issues</a></h3>
<p>If you see foreign key errors, verify the migration order in <code>server.rs</code>. Parent
tables must be created before child tables with FK references.</p>
<h3 id="checking-migration-status"><a class="header" href="#checking-migration-status">Checking Migration Status</a></h3>
<pre><code class="language-bash">sqlite3 ~/.moltis/moltis.db "SELECT version, description, success FROM _sqlx_migrations ORDER BY version"
</code></pre>
<h3 id="resetting-migrations-development-only"><a class="header" href="#resetting-migrations-development-only">Resetting Migrations (Development Only)</a></h3>
<pre><code class="language-bash"># Backup first!
rm ~/.moltis/moltis.db
cargo run  # Creates fresh database with all migrations
</code></pre>
<h2 id="best-practices-1"><a class="header" href="#best-practices-1">Best Practices</a></h2>
<h3 id="do"><a class="header" href="#do">DO</a></h3>
<ul>
<li>Use timestamp-based version numbers for global uniqueness</li>
<li>Keep each crateâ€™s migrations in its own directory</li>
<li>Use <code>IF NOT EXISTS</code> for idempotent initial migrations</li>
<li>Test migrations on a copy of production data before deploying</li>
<li>Keep migrations small and focused</li>
</ul>
<h3 id="dont"><a class="header" href="#dont">DONâ€™T</a></h3>
<ul>
<li>Modify existing migration files after deployment</li>
<li>Reuse timestamps across crates</li>
<li>Put multiple cratesâ€™ tables in one migration file</li>
<li>Skip the dependency order in <code>server.rs</code></li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="metrics-and-tracing"><a class="header" href="#metrics-and-tracing">Metrics and Tracing</a></h1>
<p>Moltis includes comprehensive observability support through Prometheus metrics and
tracing integration. This document explains how to enable, configure, and use
these features.</p>
<h2 id="overview-6"><a class="header" href="#overview-6">Overview</a></h2>
<p>The metrics system is built on the <a href="https://docs.rs/metrics"><code>metrics</code></a> crate
facade, which provides a unified interface similar to the <code>log</code> crate. When the
<code>prometheus</code> feature is enabled, metrics are exported in Prometheus text format
for scraping by Grafana, Prometheus, or other monitoring tools.</p>
<p>All metrics are <strong>feature-gated</strong> â€” they add zero overhead when disabled.</p>
<h2 id="feature-flags"><a class="header" href="#feature-flags">Feature Flags</a></h2>
<p>Metrics are controlled by two feature flags:</p>
<div class="table-wrapper"><table><thead><tr><th>Feature</th><th>Description</th><th>Default</th></tr></thead><tbody>
<tr><td><code>metrics</code></td><td>Enables metrics collection and the <code>/api/metrics</code> JSON API</td><td>Enabled</td></tr>
<tr><td><code>prometheus</code></td><td>Enables the <code>/metrics</code> Prometheus endpoint (requires <code>metrics</code>)</td><td>Enabled</td></tr>
</tbody></table>
</div>
<h3 id="compile-time-configuration"><a class="header" href="#compile-time-configuration">Compile-Time Configuration</a></h3>
<pre><code class="language-toml"># Enable only metrics collection (no Prometheus endpoint)
moltis-gateway = { version = "0.1", features = ["metrics"] }

# Enable metrics with Prometheus export (default)
moltis-gateway = { version = "0.1", features = ["metrics", "prometheus"] }

# Enable metrics for specific crates
moltis-agents = { version = "0.1", features = ["metrics"] }
moltis-cron = { version = "0.1", features = ["metrics"] }
</code></pre>
<p>To build without metrics entirely:</p>
<pre><code class="language-bash">cargo build --release --no-default-features --features "file-watcher,tailscale,tls,web-ui"
</code></pre>
<h2 id="prometheus-endpoint"><a class="header" href="#prometheus-endpoint">Prometheus Endpoint</a></h2>
<p>When the <code>prometheus</code> feature is enabled, the gateway exposes a <code>/metrics</code> endpoint:</p>
<pre><code>GET http://localhost:18789/metrics
</code></pre>
<p>This endpoint is <strong>unauthenticated</strong> to allow Prometheus scrapers to access it.
It returns metrics in Prometheus text format:</p>
<pre><code># HELP moltis_http_requests_total Total number of HTTP requests handled
# TYPE moltis_http_requests_total counter
moltis_http_requests_total{method="GET",status="200",endpoint="/api/chat"} 42

# HELP moltis_llm_completion_duration_seconds Duration of LLM completion requests
# TYPE moltis_llm_completion_duration_seconds histogram
moltis_llm_completion_duration_seconds_bucket{provider="anthropic",model="claude-3-opus",le="1.0"} 5
</code></pre>
<h3 id="grafana-integration"><a class="header" href="#grafana-integration">Grafana Integration</a></h3>
<p>To scrape metrics with Prometheus and visualize in Grafana:</p>
<ol>
<li>Add moltis to your <code>prometheus.yml</code>:</li>
</ol>
<pre><code class="language-yaml">scrape_configs:
  - job_name: 'moltis'
    static_configs:
      - targets: ['localhost:18789']
    metrics_path: /metrics
    scrape_interval: 15s
</code></pre>
<ol start="2">
<li>Import or create Grafana dashboards using the <code>moltis_*</code> metrics.</li>
</ol>
<h2 id="json-api-endpoints"><a class="header" href="#json-api-endpoints">JSON API Endpoints</a></h2>
<p>For the web UI dashboard and programmatic access, authenticated JSON endpoints
are available:</p>
<div class="table-wrapper"><table><thead><tr><th>Endpoint</th><th>Description</th></tr></thead><tbody>
<tr><td><code>GET /api/metrics</code></td><td>Full metrics snapshot with aggregates and per-provider breakdown</td></tr>
<tr><td><code>GET /api/metrics/summary</code></td><td>Lightweight counts for navigation badges</td></tr>
<tr><td><code>GET /api/metrics/history</code></td><td>Time-series data points for charts (last hour, 10s intervals)</td></tr>
</tbody></table>
</div>
<h3 id="history-endpoint"><a class="header" href="#history-endpoint">History Endpoint</a></h3>
<p>The <code>/api/metrics/history</code> endpoint returns historical metrics data for rendering
time-series charts:</p>
<pre><code class="language-json">{
  "enabled": true,
  "interval_seconds": 10,
  "max_points": 60480,
  "points": [
    {
      "timestamp": 1706832000000,
      "llm_completions": 42,
      "llm_input_tokens": 15000,
      "llm_output_tokens": 8000,
      "http_requests": 150,
      "ws_active": 3,
      "tool_executions": 25,
      "mcp_calls": 12,
      "active_sessions": 2
    }
  ]
}
</code></pre>
<h2 id="metrics-persistence"><a class="header" href="#metrics-persistence">Metrics Persistence</a></h2>
<p>Metrics history is persisted to SQLite, so historical data survives server
restarts. The database is stored at <code>~/.moltis/metrics.db</code> (or the configured
data directory).</p>
<p>Key features:</p>
<ul>
<li><strong>7-day retention</strong>: History is kept for 7 days (60,480 data points at
10-second intervals)</li>
<li><strong>Automatic cleanup</strong>: Old data is automatically removed hourly</li>
<li><strong>Startup recovery</strong>: History is loaded from the database when the server
starts</li>
</ul>
<p>The storage backend uses a trait-based design (<code>MetricsStore</code>), allowing
alternative implementations (e.g., TimescaleDB) for larger deployments.</p>
<h3 id="storage-architecture"><a class="header" href="#storage-architecture">Storage Architecture</a></h3>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>// The MetricsStore trait defines the storage interface
#[async_trait]
pub trait MetricsStore: Send + Sync {
    async fn save_point(&amp;self, point: &amp;MetricsHistoryPoint) -&gt; Result&lt;()&gt;;
    async fn load_history(&amp;self, since: u64, limit: usize) -&gt; Result&lt;Vec&lt;MetricsHistoryPoint&gt;&gt;;
    async fn cleanup_before(&amp;self, before: u64) -&gt; Result&lt;u64&gt;;
    async fn latest_point(&amp;self) -&gt; Result&lt;Option&lt;MetricsHistoryPoint&gt;&gt;;
}
<span class="boring">}</span></code></pre></pre>
<p>The default <code>SqliteMetricsStore</code> implementation stores data in a single table
with an index on the timestamp column for efficient range queries.</p>
<h2 id="web-ui-dashboard"><a class="header" href="#web-ui-dashboard">Web UI Dashboard</a></h2>
<p>The gateway includes a built-in metrics dashboard at <code>/monitoring</code> in the web UI.
This page displays:</p>
<p><strong>Overview Tab:</strong></p>
<ul>
<li>System metrics (uptime, connected clients, active sessions)</li>
<li>LLM usage (completions, tokens, cache statistics)</li>
<li>Tool execution statistics</li>
<li>MCP server status</li>
<li>Provider breakdown table</li>
<li>Prometheus endpoint (with copy button)</li>
</ul>
<p><strong>Charts Tab:</strong></p>
<ul>
<li>Token usage over time (input/output)</li>
<li>HTTP requests and LLM completions</li>
<li>WebSocket connections and active sessions</li>
<li>Tool executions and MCP calls</li>
</ul>
<p>The dashboard uses <a href="https://github.com/leeoniya/uPlot">uPlot</a> for lightweight,
high-performance time-series charts. Data updates every 10 seconds for current
metrics and every 30 seconds for history.</p>
<h2 id="available-metrics"><a class="header" href="#available-metrics">Available Metrics</a></h2>
<h3 id="http-metrics"><a class="header" href="#http-metrics">HTTP Metrics</a></h3>
<div class="table-wrapper"><table><thead><tr><th>Metric</th><th>Type</th><th>Labels</th><th>Description</th></tr></thead><tbody>
<tr><td><code>moltis_http_requests_total</code></td><td>Counter</td><td>method, status, endpoint</td><td>Total HTTP requests</td></tr>
<tr><td><code>moltis_http_request_duration_seconds</code></td><td>Histogram</td><td>method, status, endpoint</td><td>Request latency</td></tr>
<tr><td><code>moltis_http_requests_in_flight</code></td><td>Gauge</td><td>â€”</td><td>Currently processing requests</td></tr>
</tbody></table>
</div>
<h3 id="llmagent-metrics"><a class="header" href="#llmagent-metrics">LLM/Agent Metrics</a></h3>
<div class="table-wrapper"><table><thead><tr><th>Metric</th><th>Type</th><th>Labels</th><th>Description</th></tr></thead><tbody>
<tr><td><code>moltis_llm_completions_total</code></td><td>Counter</td><td>provider, model</td><td>Total completions requested</td></tr>
<tr><td><code>moltis_llm_completion_duration_seconds</code></td><td>Histogram</td><td>provider, model</td><td>Completion latency</td></tr>
<tr><td><code>moltis_llm_input_tokens_total</code></td><td>Counter</td><td>provider, model</td><td>Input tokens processed</td></tr>
<tr><td><code>moltis_llm_output_tokens_total</code></td><td>Counter</td><td>provider, model</td><td>Output tokens generated</td></tr>
<tr><td><code>moltis_llm_completion_errors_total</code></td><td>Counter</td><td>provider, model, error_type</td><td>Completion failures</td></tr>
<tr><td><code>moltis_llm_time_to_first_token_seconds</code></td><td>Histogram</td><td>provider, model</td><td>Streaming TTFT</td></tr>
</tbody></table>
</div>
<h4 id="provider-aliases"><a class="header" href="#provider-aliases">Provider Aliases</a></h4>
<p>When you have multiple instances of the same provider type (e.g., separate API keys
for work and personal use), you can use the <code>alias</code> configuration option to
differentiate them in metrics:</p>
<pre><code class="language-toml">[providers.anthropic]
api_key = "sk-work-..."
alias = "anthropic-work"

# Note: You would need separate config sections for multiple instances
# of the same provider. This is a placeholder for future functionality.
</code></pre>
<p>The alias appears in the <code>provider</code> label of all LLM metrics:</p>
<pre><code>moltis_llm_input_tokens_total{provider="anthropic-work", model="claude-3-opus"} 5000
moltis_llm_input_tokens_total{provider="anthropic-personal", model="claude-3-opus"} 3000
</code></pre>
<p>This allows you to:</p>
<ul>
<li>Track token usage separately for billing purposes</li>
<li>Create separate Grafana dashboards per provider instance</li>
<li>Monitor rate limits and quotas independently</li>
</ul>
<h3 id="mcp-model-context-protocol-metrics"><a class="header" href="#mcp-model-context-protocol-metrics">MCP (Model Context Protocol) Metrics</a></h3>
<div class="table-wrapper"><table><thead><tr><th>Metric</th><th>Type</th><th>Labels</th><th>Description</th></tr></thead><tbody>
<tr><td><code>moltis_mcp_tool_calls_total</code></td><td>Counter</td><td>server, tool</td><td>Tool invocations</td></tr>
<tr><td><code>moltis_mcp_tool_call_duration_seconds</code></td><td>Histogram</td><td>server, tool</td><td>Tool call latency</td></tr>
<tr><td><code>moltis_mcp_tool_call_errors_total</code></td><td>Counter</td><td>server, tool, error_type</td><td>Tool call failures</td></tr>
<tr><td><code>moltis_mcp_servers_connected</code></td><td>Gauge</td><td>â€”</td><td>Active MCP server connections</td></tr>
</tbody></table>
</div>
<h3 id="tool-execution-metrics"><a class="header" href="#tool-execution-metrics">Tool Execution Metrics</a></h3>
<div class="table-wrapper"><table><thead><tr><th>Metric</th><th>Type</th><th>Labels</th><th>Description</th></tr></thead><tbody>
<tr><td><code>moltis_tool_executions_total</code></td><td>Counter</td><td>tool</td><td>Tool executions</td></tr>
<tr><td><code>moltis_tool_execution_duration_seconds</code></td><td>Histogram</td><td>tool</td><td>Execution time</td></tr>
<tr><td><code>moltis_sandbox_command_executions_total</code></td><td>Counter</td><td>â€”</td><td>Sandbox commands run</td></tr>
</tbody></table>
</div>
<h3 id="session-metrics"><a class="header" href="#session-metrics">Session Metrics</a></h3>
<div class="table-wrapper"><table><thead><tr><th>Metric</th><th>Type</th><th>Labels</th><th>Description</th></tr></thead><tbody>
<tr><td><code>moltis_sessions_created_total</code></td><td>Counter</td><td>â€”</td><td>Sessions created</td></tr>
<tr><td><code>moltis_sessions_active</code></td><td>Gauge</td><td>â€”</td><td>Currently active sessions</td></tr>
<tr><td><code>moltis_session_messages_total</code></td><td>Counter</td><td>role</td><td>Messages by role</td></tr>
</tbody></table>
</div>
<h3 id="cron-job-metrics"><a class="header" href="#cron-job-metrics">Cron Job Metrics</a></h3>
<div class="table-wrapper"><table><thead><tr><th>Metric</th><th>Type</th><th>Labels</th><th>Description</th></tr></thead><tbody>
<tr><td><code>moltis_cron_jobs_scheduled</code></td><td>Gauge</td><td>â€”</td><td>Number of scheduled jobs</td></tr>
<tr><td><code>moltis_cron_executions_total</code></td><td>Counter</td><td>â€”</td><td>Job executions</td></tr>
<tr><td><code>moltis_cron_execution_duration_seconds</code></td><td>Histogram</td><td>â€”</td><td>Job duration</td></tr>
<tr><td><code>moltis_cron_errors_total</code></td><td>Counter</td><td>â€”</td><td>Failed jobs</td></tr>
<tr><td><code>moltis_cron_stuck_jobs_cleared_total</code></td><td>Counter</td><td>â€”</td><td>Jobs exceeding 2h timeout</td></tr>
<tr><td><code>moltis_cron_input_tokens_total</code></td><td>Counter</td><td>â€”</td><td>Input tokens from cron runs</td></tr>
<tr><td><code>moltis_cron_output_tokens_total</code></td><td>Counter</td><td>â€”</td><td>Output tokens from cron runs</td></tr>
</tbody></table>
</div>
<h3 id="memorysearch-metrics"><a class="header" href="#memorysearch-metrics">Memory/Search Metrics</a></h3>
<div class="table-wrapper"><table><thead><tr><th>Metric</th><th>Type</th><th>Labels</th><th>Description</th></tr></thead><tbody>
<tr><td><code>moltis_memory_searches_total</code></td><td>Counter</td><td>search_type</td><td>Searches performed</td></tr>
<tr><td><code>moltis_memory_search_duration_seconds</code></td><td>Histogram</td><td>search_type</td><td>Search latency</td></tr>
<tr><td><code>moltis_memory_embeddings_generated_total</code></td><td>Counter</td><td>provider</td><td>Embeddings created</td></tr>
</tbody></table>
</div>
<h3 id="channel-metrics"><a class="header" href="#channel-metrics">Channel Metrics</a></h3>
<div class="table-wrapper"><table><thead><tr><th>Metric</th><th>Type</th><th>Labels</th><th>Description</th></tr></thead><tbody>
<tr><td><code>moltis_channels_active</code></td><td>Gauge</td><td>â€”</td><td>Loaded channel plugins</td></tr>
<tr><td><code>moltis_channel_messages_received_total</code></td><td>Counter</td><td>channel</td><td>Inbound messages</td></tr>
<tr><td><code>moltis_channel_messages_sent_total</code></td><td>Counter</td><td>channel</td><td>Outbound messages</td></tr>
</tbody></table>
</div>
<h3 id="telegram-specific-metrics"><a class="header" href="#telegram-specific-metrics">Telegram-Specific Metrics</a></h3>
<div class="table-wrapper"><table><thead><tr><th>Metric</th><th>Type</th><th>Labels</th><th>Description</th></tr></thead><tbody>
<tr><td><code>moltis_telegram_messages_received_total</code></td><td>Counter</td><td>â€”</td><td>Messages from Telegram</td></tr>
<tr><td><code>moltis_telegram_access_control_denials_total</code></td><td>Counter</td><td>â€”</td><td>Access denied events</td></tr>
<tr><td><code>moltis_telegram_polling_duration_seconds</code></td><td>Histogram</td><td>â€”</td><td>Message handling time</td></tr>
</tbody></table>
</div>
<h3 id="oauth-metrics"><a class="header" href="#oauth-metrics">OAuth Metrics</a></h3>
<div class="table-wrapper"><table><thead><tr><th>Metric</th><th>Type</th><th>Labels</th><th>Description</th></tr></thead><tbody>
<tr><td><code>moltis_oauth_flow_starts_total</code></td><td>Counter</td><td>â€”</td><td>OAuth flows initiated</td></tr>
<tr><td><code>moltis_oauth_flow_completions_total</code></td><td>Counter</td><td>â€”</td><td>Successful completions</td></tr>
<tr><td><code>moltis_oauth_token_refresh_total</code></td><td>Counter</td><td>â€”</td><td>Token refreshes</td></tr>
<tr><td><code>moltis_oauth_token_refresh_failures_total</code></td><td>Counter</td><td>â€”</td><td>Refresh failures</td></tr>
</tbody></table>
</div>
<h3 id="skills-metrics"><a class="header" href="#skills-metrics">Skills Metrics</a></h3>
<div class="table-wrapper"><table><thead><tr><th>Metric</th><th>Type</th><th>Labels</th><th>Description</th></tr></thead><tbody>
<tr><td><code>moltis_skills_installation_attempts_total</code></td><td>Counter</td><td>â€”</td><td>Installation attempts</td></tr>
<tr><td><code>moltis_skills_installation_duration_seconds</code></td><td>Histogram</td><td>â€”</td><td>Installation time</td></tr>
<tr><td><code>moltis_skills_git_clone_total</code></td><td>Counter</td><td>â€”</td><td>Successful git clones</td></tr>
<tr><td><code>moltis_skills_git_clone_fallback_total</code></td><td>Counter</td><td>â€”</td><td>Fallbacks to HTTP tarball</td></tr>
</tbody></table>
</div>
<h2 id="tracing-integration"><a class="header" href="#tracing-integration">Tracing Integration</a></h2>
<p>The <code>moltis-metrics</code> crate includes optional tracing integration via the
<code>tracing</code> feature. This allows span context to propagate to metric labels.</p>
<h3 id="enabling-tracing"><a class="header" href="#enabling-tracing">Enabling Tracing</a></h3>
<pre><code class="language-toml">moltis-metrics = { version = "0.1", features = ["prometheus", "tracing"] }
</code></pre>
<h3 id="initialization"><a class="header" href="#initialization">Initialization</a></h3>
<pre><pre class="playground"><code class="language-rust">use moltis_metrics::tracing_integration::init_tracing;

fn main() {
    // Initialize tracing with metrics context propagation
    init_tracing();

    // Now spans will add labels to metrics
}</code></pre></pre>
<h3 id="how-it-works-6"><a class="header" href="#how-it-works-6">How It Works</a></h3>
<p>When tracing is enabled, span fields are automatically added as metric labels:</p>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>use tracing::instrument;

#[instrument(fields(operation = "fetch_user", component = "api"))]
async fn fetch_user(id: u64) -&gt; User {
    // Metrics recorded here will include:
    // - operation="fetch_user"
    // - component="api"
    counter!("api_calls_total").increment(1);
}
<span class="boring">}</span></code></pre></pre>
<h3 id="span-labels"><a class="header" href="#span-labels">Span Labels</a></h3>
<p>The following span fields are propagated to metrics:</p>
<div class="table-wrapper"><table><thead><tr><th>Field</th><th>Description</th></tr></thead><tbody>
<tr><td><code>operation</code></td><td>The operation being performed</td></tr>
<tr><td><code>component</code></td><td>The component/module name</td></tr>
<tr><td><code>span.name</code></td><td>The spanâ€™s target/name</td></tr>
</tbody></table>
</div>
<h2 id="adding-custom-metrics"><a class="header" href="#adding-custom-metrics">Adding Custom Metrics</a></h2>
<h3 id="in-your-code"><a class="header" href="#in-your-code">In Your Code</a></h3>
<p>Use the <code>metrics</code> macros re-exported from <code>moltis-metrics</code>:</p>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>use moltis_metrics::{counter, gauge, histogram, labels};

// Simple counter
counter!("my_custom_requests_total").increment(1);

// Counter with labels
counter!(
    "my_custom_requests_total",
    labels::ENDPOINT =&gt; "/api/users",
    labels::METHOD =&gt; "GET"
).increment(1);

// Gauge (current value)
gauge!("my_queue_size").set(42.0);

// Histogram (distribution)
histogram!("my_operation_duration_seconds").record(0.123);
<span class="boring">}</span></code></pre></pre>
<h3 id="feature-gating"><a class="header" href="#feature-gating">Feature-Gating</a></h3>
<p>Always gate metrics code to avoid overhead when disabled:</p>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>#[cfg(feature = "metrics")]
use moltis_metrics::{counter, histogram};

pub async fn my_function() {
    #[cfg(feature = "metrics")]
    let start = std::time::Instant::now();

    // ... do work ...

    #[cfg(feature = "metrics")]
    {
        counter!("my_operations_total").increment(1);
        histogram!("my_operation_duration_seconds")
            .record(start.elapsed().as_secs_f64());
    }
}
<span class="boring">}</span></code></pre></pre>
<h3 id="adding-new-metric-definitions"><a class="header" href="#adding-new-metric-definitions">Adding New Metric Definitions</a></h3>
<p>For consistency, add metric name constants to <code>crates/metrics/src/definitions.rs</code>:</p>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>/// My feature metrics
pub mod my_feature {
    /// Total operations performed
    pub const OPERATIONS_TOTAL: &amp;str = "moltis_my_feature_operations_total";
    /// Operation duration in seconds
    pub const OPERATION_DURATION_SECONDS: &amp;str = "moltis_my_feature_operation_duration_seconds";
}
<span class="boring">}</span></code></pre></pre>
<p>Then use them:</p>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>use moltis_metrics::{counter, my_feature};

counter!(my_feature::OPERATIONS_TOTAL).increment(1);
<span class="boring">}</span></code></pre></pre>
<h2 id="configuration-9"><a class="header" href="#configuration-9">Configuration</a></h2>
<p>Metrics configuration in <code>moltis.toml</code>:</p>
<pre><code class="language-toml">[metrics]
enabled = true              # Enable metrics collection (default: true)
prometheus_endpoint = true  # Expose /metrics endpoint (default: true)
labels = { env = "prod" }   # Add custom labels to all metrics
</code></pre>
<p>Environment variables:</p>
<ul>
<li><code>RUST_LOG=moltis_metrics=debug</code> â€” Enable debug logging for metrics initialization</li>
</ul>
<h2 id="best-practices-2"><a class="header" href="#best-practices-2">Best Practices</a></h2>
<ol>
<li><strong>Use consistent naming</strong>: Follow the pattern <code>moltis_&lt;subsystem&gt;_&lt;metric&gt;_&lt;unit&gt;</code></li>
<li><strong>Add units to names</strong>: <code>_total</code> for counters, <code>_seconds</code> for durations, <code>_bytes</code> for sizes</li>
<li><strong>Keep cardinality low</strong>: Avoid high-cardinality labels (like user IDs or request IDs)</li>
<li><strong>Feature-gate everything</strong>: Use <code>#[cfg(feature = "metrics")]</code> to ensure zero overhead when disabled</li>
<li><strong>Use predefined buckets</strong>: The <code>buckets</code> module has standard histogram buckets for common metric types</li>
</ol>
<h2 id="troubleshooting-8"><a class="header" href="#troubleshooting-8">Troubleshooting</a></h2>
<h3 id="metrics-not-appearing"><a class="header" href="#metrics-not-appearing">Metrics not appearing</a></h3>
<ol>
<li>Verify the <code>metrics</code> feature is enabled at compile time</li>
<li>Check that the metrics recorder is initialized (happens automatically in gateway)</li>
<li>Ensure youâ€™re hitting the correct <code>/metrics</code> endpoint</li>
<li>Check <code>moltis.toml</code> has <code>[metrics] enabled = true</code></li>
</ol>
<h3 id="prometheus-endpoint-not-available"><a class="header" href="#prometheus-endpoint-not-available">Prometheus endpoint not available</a></h3>
<ol>
<li>Ensure the <code>prometheus</code> feature is enabled (itâ€™s separate from <code>metrics</code>)</li>
<li>Check your build: <code>cargo build --features prometheus</code></li>
</ol>
<h3 id="high-memory-usage-1"><a class="header" href="#high-memory-usage-1">High memory usage</a></h3>
<ul>
<li>Check for high-cardinality labels (many unique label combinations)</li>
<li>Consider reducing histogram bucket counts</li>
</ul>
<h3 id="missing-labels"><a class="header" href="#missing-labels">Missing labels</a></h3>
<ul>
<li>Ensure labels are passed consistently across all metric recordings</li>
<li>Check that tracing spans include the expected fields</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="tool-registry"><a class="header" href="#tool-registry">Tool Registry</a></h1>
<p>The tool registry manages all tools available to the agent during a
conversation. It tracks where each tool comes from and supports filtering by
source.</p>
<h2 id="tool-sources"><a class="header" href="#tool-sources">Tool Sources</a></h2>
<p>Every registered tool has a <code>ToolSource</code> that identifies its origin:</p>
<ul>
<li><strong><code>Builtin</code></strong> â€” tools shipped with the binary (exec, web_fetch, etc.)</li>
<li><strong><code>Mcp { server }</code></strong> â€” tools provided by an MCP server, tagged with the
server name</li>
</ul>
<p>This replaces the previous convention of identifying MCP tools by their
<code>mcp__</code> name prefix, providing type-safe filtering instead of string matching.</p>
<h2 id="registration"><a class="header" href="#registration">Registration</a></h2>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>// Built-in tool
registry.register(Box::new(MyTool::new()));

// MCP tool â€” tagged with server name
registry.register_mcp(Box::new(adapter), "github".to_string());
<span class="boring">}</span></code></pre></pre>
<h2 id="filtering"><a class="header" href="#filtering">Filtering</a></h2>
<p>When MCP tools are disabled for a session, the registry can produce a filtered
copy:</p>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>// Type-safe: filters by ToolSource::Mcp variant
let no_mcp = registry.clone_without_mcp();

// Remove all MCP tools in-place (used during sync)
let removed_count = registry.unregister_mcp();
<span class="boring">}</span></code></pre></pre>
<h2 id="schema-output"><a class="header" href="#schema-output">Schema Output</a></h2>
<p><code>list_schemas()</code> includes source metadata in every tool schema:</p>
<pre><code class="language-json">{
  "name": "exec",
  "description": "Execute a command",
  "parameters": { ... },
  "source": "builtin"
}
</code></pre>
<pre><code class="language-json">{
  "name": "mcp__github__search",
  "description": "Search GitHub",
  "parameters": { ... },
  "source": "mcp",
  "mcpServer": "github"
}
</code></pre>
<p>The <code>source</code> and <code>mcpServer</code> fields are available to the UI for rendering
tools grouped by origin.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="changelog"><a class="header" href="#changelog">Changelog</a></h1>
<p>All notable changes to this project will be documented in this file.</p>
<p>The format is based on <a href="https://keepachangelog.com/en/1.1.0/">Keep a Changelog</a>,
and this project adheres to <a href="https://semver.org/spec/v2.0.0.html">Semantic Versioning</a>.</p>
<h2 id="unreleased"><a class="header" href="#unreleased">[Unreleased]</a></h2>
<h3 id="added"><a class="header" href="#added">Added</a></h3>
<ul>
<li>OAuth 2.1 support for remote MCP servers â€” automatic discovery (RFC 9728/8414), dynamic client registration (RFC 7591), PKCE authorization code flow, and Bearer token injection with 401 retry</li>
<li><code>McpOAuthOverride</code> config option for servers that donâ€™t implement standard OAuth discovery</li>
<li><code>mcp.reauth</code> RPC method to manually trigger re-authentication for a server</li>
<li>Persistent storage of dynamic client registrations at <code>~/.config/moltis/mcp_oauth_registrations.json</code></li>
<li><strong>SSRF allowlist</strong>: <code>tools.web.fetch.ssrf_allowlist</code> config field to exempt trusted
CIDR ranges from SSRF blocking, enabling Docker inter-container networking.</li>
<li>Memory config: add <code>memory.disable_rag</code> to force keyword-only memory search while keeping markdown indexing and memory tools enabled</li>
<li>Generic OpenAI-compatible provider support: connect any OpenAI-compatible endpoint via the provider setup UI, with domain-derived naming (<code>custom-</code> prefix), model auto-discovery, and full model selection</li>
</ul>
<h3 id="changed"><a class="header" href="#changed">Changed</a></h3>
<h3 id="deprecated"><a class="header" href="#deprecated">Deprecated</a></h3>
<h3 id="removed"><a class="header" href="#removed">Removed</a></h3>
<h3 id="fixed"><a class="header" href="#fixed">Fixed</a></h3>
<ul>
<li>MCP OAuth dynamic registration now uses the exact loopback callback URI selected for the current auth flow, improving compatibility with providers that require strict redirect URI matching (for example Linear).</li>
<li>MCP manager now applies <code>[mcp.servers.&lt;name&gt;.oauth]</code> override settings when building the OAuth provider for SSE servers.</li>
<li>Streamable HTTP MCP transport now persists and reuses <code>Mcp-Session-Id</code>, parses <code>text/event-stream</code> responses, and sends best-effort <code>DELETE</code> on shutdown to close server sessions.</li>
<li>MCP docs/config examples now use the current table-based config shape and <code>/mcp</code> endpoint examples for remote servers.</li>
<li>Memory embeddings endpoint composition now avoids duplicated path segments like <code>/v1/v1/embeddings</code> and accepts base URLs ending in host-only, <code>/v1</code>, versioned paths (for example <code>/v4</code>), or <code>/embeddings</code></li>
</ul>
<h3 id="security-2"><a class="header" href="#security-2">Security</a></h3>
<h2 id="0835---2026-02-15"><a class="header" href="#0835---2026-02-15">[0.8.35] - 2026-02-15</a></h2>
<h3 id="added-1"><a class="header" href="#added-1">Added</a></h3>
<ul>
<li>Add memory target routing guidance to <code>memory_save</code> prompt hint â€” core facts go to MEMORY.md, everything else to <code>memory/&lt;topic&gt;.md</code> to keep context lean</li>
</ul>
<h3 id="changed-1"><a class="header" href="#changed-1">Changed</a></h3>
<h3 id="deprecated-1"><a class="header" href="#deprecated-1">Deprecated</a></h3>
<h3 id="removed-1"><a class="header" href="#removed-1">Removed</a></h3>
<h3 id="fixed-1"><a class="header" href="#fixed-1">Fixed</a></h3>
<h3 id="security-3"><a class="header" href="#security-3">Security</a></h3>
<h2 id="0834---2026-02-15"><a class="header" href="#0834---2026-02-15">[0.8.34] - 2026-02-15</a></h2>
<h3 id="added-2"><a class="header" href="#added-2">Added</a></h3>
<ul>
<li>Add explicit <code>memory_save</code> hint in system prompt so weaker models (MiniMax, etc.) call the tool when asked to remember something</li>
<li>Add anchor text after memory content so models donâ€™t ignore known facts when <code>memory_search</code> returns empty</li>
<li>Add <code>zai</code> to default offered providers in config template</li>
</ul>
<h3 id="changed-2"><a class="header" href="#changed-2">Changed</a></h3>
<h3 id="deprecated-2"><a class="header" href="#deprecated-2">Deprecated</a></h3>
<h3 id="removed-2"><a class="header" href="#removed-2">Removed</a></h3>
<h3 id="fixed-2"><a class="header" href="#fixed-2">Fixed</a></h3>
<h3 id="security-4"><a class="header" href="#security-4">Security</a></h3>
<h2 id="0833---2026-02-15"><a class="header" href="#0833---2026-02-15">[0.8.33] - 2026-02-15</a></h2>
<h3 id="added-3"><a class="header" href="#added-3">Added</a></h3>
<h3 id="changed-3"><a class="header" href="#changed-3">Changed</a></h3>
<h3 id="deprecated-3"><a class="header" href="#deprecated-3">Deprecated</a></h3>
<h3 id="removed-3"><a class="header" href="#removed-3">Removed</a></h3>
<h3 id="fixed-3"><a class="header" href="#fixed-3">Fixed</a></h3>
<ul>
<li><strong>CI</strong>: remove unnecessary <code>std::path::</code> qualification in gateway server flagged
by nightly clippy.</li>
</ul>
<h3 id="security-5"><a class="header" href="#security-5">Security</a></h3>
<h2 id="0832---2026-02-15"><a class="header" href="#0832---2026-02-15">[0.8.32] - 2026-02-15</a></h2>
<h3 id="added-4"><a class="header" href="#added-4">Added</a></h3>
<h3 id="changed-4"><a class="header" href="#changed-4">Changed</a></h3>
<h3 id="deprecated-4"><a class="header" href="#deprecated-4">Deprecated</a></h3>
<h3 id="removed-4"><a class="header" href="#removed-4">Removed</a></h3>
<h3 id="fixed-4"><a class="header" href="#fixed-4">Fixed</a></h3>
<ul>
<li><strong>CI</strong>: gate macOS-only sandbox helper functions with <code>#[cfg]</code> to fix dead-code
errors on Linux CI.</li>
</ul>
<h3 id="security-6"><a class="header" href="#security-6">Security</a></h3>
<h2 id="0831---2026-02-15"><a class="header" href="#0831---2026-02-15">[0.8.31] - 2026-02-15</a></h2>
<h3 id="added-5"><a class="header" href="#added-5">Added</a></h3>
<ul>
<li>
<p><strong>Sandbox toggle notification</strong>: when the sandbox is enabled or disabled
mid-session, a system message is injected into the conversation history so
the LLM knows the execution environment changed. A chat notice also appears
in the UI immediately.</p>
</li>
<li>
<p><strong>Config <code>[env]</code> section</strong>: environment variables defined in <code>[env]</code> in
<code>moltis.toml</code> are injected into the Moltis process at startup. This makes
API keys (Brave, OpenRouter, etc.) available to features that read from
<code>std::env::var()</code>. Process env vars (<code>docker -e</code>, host env) take precedence.
Closes #107.</p>
</li>
<li>
<p><strong>Browser auto-detection and install</strong>: automatically detect all installed
Chromium-family browsers (Chrome, Chromium, Edge, Brave, Opera, Vivaldi, Arc)
and auto-install via the system package manager when none is found. Requests
can specify a preferred browser (<code>"browser": "brave"</code>) or let the system
pick the first available one.</p>
</li>
<li>
<p><strong>Z.AI provider</strong>: add Z.AI (Zhipu) as an OpenAI-compatible provider with
static model catalog (GLM-5, GLM-4.7, GLM-4.6, GLM-4.5 series) and dynamic
model discovery via <code>/models</code> endpoint. Supports tool calling, streaming,
vision (GLM-4.6V/4.5V), and reasoning content.</p>
</li>
<li>
<p><strong>Running Containers panel</strong>: the Settings &gt; Sandboxes page now shows a
â€œRunning Containersâ€ section listing all moltis-managed containers with
live state (running/stopped/exited), backend type (Apple Container/Docker),
resource info, and Stop/Delete actions. Includes disk usage display
(container/image counts, sizes, reclaimable space) and a â€œClean Allâ€
button to stop and remove all stale containers at once.</p>
</li>
<li>
<p><strong>Startup container GC</strong>: the gateway now automatically removes orphaned
session containers on startup, preventing disk space accumulation from
crashed or interrupted sessions.</p>
</li>
<li>
<p><strong>Download full context as JSONL</strong>: the full context panel now has a
â€œDownloadâ€ button that exports the conversation (including raw LLM
responses) as a timestamped <code>.jsonl</code> file.</p>
</li>
<li>
<p><strong>Sandbox images in cached images list</strong>: the Settings &gt; Images page
now merges sandbox-built images into the cached images list so all
container images are visible in one place.</p>
</li>
</ul>
<h3 id="changed-5"><a class="header" href="#changed-5">Changed</a></h3>
<ul>
<li><strong>Sandbox image identity</strong>: image tags now use SHA-256 instead of
<code>DefaultHasher</code> for deterministic, cross-run hashing of base image +
packages.</li>
</ul>
<h3 id="deprecated-5"><a class="header" href="#deprecated-5">Deprecated</a></h3>
<h3 id="removed-5"><a class="header" href="#removed-5">Removed</a></h3>
<h3 id="fixed-5"><a class="header" href="#fixed-5">Fixed</a></h3>
<ul>
<li><strong>Thinking indicator lost on reload</strong>: reloading the page while the model
was generating no longer loses the â€œthinkingâ€ dots. The backend now includes
<code>replying</code> state in <code>sessions.list</code> and <code>sessions.switch</code> RPC responses so
the frontend can restore the indicator after a full page reload.</li>
<li><strong>Thinking text restored after reload</strong>: reloading the page during extended
thinking (reasoning) now restores the accumulated thinking text instead of
showing only bouncing dots. The backend tracks thinking text per session and
returns it in the <code>sessions.switch</code> response.</li>
<li><strong>Apple Container recovery</strong>: simplify container recovery to a single flat
retry loop (3 attempts max, down from up to 24). Name rotation now only
triggers on <code>AlreadyExists</code> errors, preventing orphan containers. Added
<code>notFound</code> error matching so exec readiness probes retry correctly.
Diagnostic info (running container count, service health, container logs)
is now included in failure messages. Detect stale Virtualization.framework
state (<code>NSPOSIXErrorDomain EINVAL</code>) and automatically restart the daemon
(<code>container system stop &amp;&amp; container system start</code>) before retrying; bail
with a clear remediation message only if automatic restart fails.
Exec-level recovery retries reduced from 3 to 1.</li>
<li><strong>Ghost Apple Containers</strong>: failed container deletions are now tracked
in a zombie set and filtered from list output, preventing stale entries
from reappearing in the Running Containers panel.</li>
<li><strong>Container action errors preserved</strong>: failed delete/clean/restart
operations now surface the original error message to the UI instead of
silently swallowing it.</li>
<li><strong>Usage parsing across OpenAI-compatible providers</strong>: token counts now
handle Anthropic-style (<code>input_tokens</code>/<code>output_tokens</code>), camelCase
variants, cache token fields, and multiple response nesting structures
across diverse providers.</li>
<li><strong>Think tag whitespace</strong>: leading whitespace after <code>&lt;/think&gt;</code> close
tags is now stripped, preventing extra blank lines in streamed output.</li>
<li><strong>Token bar visible at zero</strong>: the token usage bar no longer disappears
when all counts are zero; it stays visible as a baseline indicator.</li>
</ul>
<h3 id="security-7"><a class="header" href="#security-7">Security</a></h3>
<h2 id="0830---2026-02-15"><a class="header" href="#0830---2026-02-15">[0.8.30] - 2026-02-15</a></h2>
<h3 id="added-6"><a class="header" href="#added-6">Added</a></h3>
<h3 id="changed-6"><a class="header" href="#changed-6">Changed</a></h3>
<ul>
<li><strong>Assistant reasoning persistence</strong>: conversation reasoning is now persisted
in assistant messages and shared snapshots so resumed sessions retain
reasoning context instead of dropping it after refresh/share operations.</li>
</ul>
<h3 id="deprecated-6"><a class="header" href="#deprecated-6">Deprecated</a></h3>
<h3 id="removed-6"><a class="header" href="#removed-6">Removed</a></h3>
<h3 id="fixed-6"><a class="header" href="#fixed-6">Fixed</a></h3>
<h3 id="security-8"><a class="header" href="#security-8">Security</a></h3>
<h2 id="0829---2026-02-14"><a class="header" href="#0829---2026-02-14">[0.8.29] - 2026-02-14</a></h2>
<h3 id="added-7"><a class="header" href="#added-7">Added</a></h3>
<ul>
<li><strong>Memory bootstrap</strong>: inject <code>MEMORY.md</code> content directly into the system
prompt (truncated at 20,000 chars) so the agent always has core memory
available without needing to call <code>memory_search</code> first. Matches OpenClawâ€™s
bootstrap behavior</li>
<li><strong>Memory save tool</strong>: new <code>memory_save</code> tool lets the LLM write to long-term
memory files (<code>MEMORY.md</code> or <code>memory/&lt;name&gt;.md</code>) with append/overwrite modes
and immediate re-indexing for search</li>
</ul>
<h3 id="changed-7"><a class="header" href="#changed-7">Changed</a></h3>
<ul>
<li><strong>Memory writing</strong>: <code>MemoryManager</code> now implements the <code>MemoryWriter</code> trait
directly, unifying read and write paths behind a single manager. The silent
memory turn and <code>MemorySaveTool</code> both delegate to the manager, which handles
path validation, size limits, and automatic re-indexing after writes</li>
</ul>
<h3 id="deprecated-7"><a class="header" href="#deprecated-7">Deprecated</a></h3>
<h3 id="removed-7"><a class="header" href="#removed-7">Removed</a></h3>
<h3 id="fixed-7"><a class="header" href="#fixed-7">Fixed</a></h3>
<ul>
<li><strong>Memory file watcher</strong>: the file watcher now covers <code>MEMORY.md</code> at the data
directory root, which was previously excluded because the filter only matched
directories</li>
</ul>
<h3 id="security-9"><a class="header" href="#security-9">Security</a></h3>
<h2 id="0828---2026-02-14"><a class="header" href="#0828---2026-02-14">[0.8.28] - 2026-02-14</a></h2>
<h3 id="added-8"><a class="header" href="#added-8">Added</a></h3>
<h3 id="changed-8"><a class="header" href="#changed-8">Changed</a></h3>
<ul>
<li><strong>Browser sandbox resolution</strong>: <code>BrowserTool</code> now resolves sandbox mode
directly from <code>SandboxRouter</code> instead of relying on a <code>_sandbox</code> flag
injected via tool call params.</li>
</ul>
<h3 id="deprecated-8"><a class="header" href="#deprecated-8">Deprecated</a></h3>
<h3 id="removed-8"><a class="header" href="#removed-8">Removed</a></h3>
<h3 id="fixed-8"><a class="header" href="#fixed-8">Fixed</a></h3>
<ul>
<li><strong>E2E onboarding failures</strong>: Fixed missing <code>saveProviderKey</code> export in
<code>provider-validation.js</code> that was accidentally left unstaged in the DRY
refactoring commit.</li>
</ul>
<h3 id="security-10"><a class="header" href="#security-10">Security</a></h3>
<h2 id="0827---2026-02-14"><a class="header" href="#0827---2026-02-14">[0.8.27] - 2026-02-14</a></h2>
<h3 id="added-9"><a class="header" href="#added-9">Added</a></h3>
<h3 id="changed-9"><a class="header" href="#changed-9">Changed</a></h3>
<ul>
<li><strong>DRY voice/identity/channel utils</strong>: Extracted shared RPC wrappers and
validation helpers from <code>onboarding-view.js</code> and <code>page-settings.js</code> /
<code>page-channels.js</code> into dedicated <code>voice-utils.js</code>, <code>identity-utils.js</code>,
and <code>channel-utils.js</code> modules.</li>
</ul>
<h3 id="deprecated-9"><a class="header" href="#deprecated-9">Deprecated</a></h3>
<h3 id="removed-9"><a class="header" href="#removed-9">Removed</a></h3>
<h3 id="fixed-9"><a class="header" href="#fixed-9">Fixed</a></h3>
<ul>
<li><strong>Config test env isolation</strong>: Fixed spurious
<code>save_config_to_path_removes_stale_keys_when_values_are_cleared</code> test
failure caused by <code>MOLTIS_IDENTITY__NAME</code> environment variable leaking
into the test via <code>apply_env_overrides</code>.</li>
</ul>
<h3 id="security-11"><a class="header" href="#security-11">Security</a></h3>
<h2 id="0826---2026-02-14"><a class="header" href="#0826---2026-02-14">[0.8.26] - 2026-02-14</a></h2>
<h3 id="added-10"><a class="header" href="#added-10">Added</a></h3>
<ul>
<li><strong>Rustls/OpenSSL migration roadmap</strong>: Added
<code>plans/2026-02-14-rustls-migration-and-openssl-reduction.md</code> with a staged
plan to reduce OpenSSL coupling, isolate feature gates, and move default TLS
networking paths toward rustls.</li>
</ul>
<h3 id="changed-10"><a class="header" href="#changed-10">Changed</a></h3>
<h3 id="deprecated-10"><a class="header" href="#deprecated-10">Deprecated</a></h3>
<h3 id="removed-10"><a class="header" href="#removed-10">Removed</a></h3>
<h3 id="fixed-10"><a class="header" href="#fixed-10">Fixed</a></h3>
<ul>
<li><strong>Windows release build reliability</strong>: The <code>.exe</code> release workflow now forces
Strawberry Perl (<code>OPENSSL_SRC_PERL</code>/<code>PERL</code>) so vendored OpenSSL builds do not
fail due to missing Git Bash Perl modules.</li>
<li><strong>OpenAI tool-call ID length</strong>: Remap tool-call IDs that exceed OpenAIâ€™s
40-character limit during message serialization, and generate shorter
synthetic IDs in the agent runner to prevent API errors.</li>
<li><strong>Onboarding credential persistence</strong>: Provider credentials are now saved
before opening model selection during onboarding, aligning behavior with the
Settings &gt; LLM flow.</li>
</ul>
<h3 id="security-12"><a class="header" href="#security-12">Security</a></h3>
<h2 id="0825---2026-02-14"><a class="header" href="#0825---2026-02-14">[0.8.25] - 2026-02-14</a></h2>
<h3 id="added-11"><a class="header" href="#added-11">Added</a></h3>
<h3 id="changed-11"><a class="header" href="#changed-11">Changed</a></h3>
<h3 id="deprecated-11"><a class="header" href="#deprecated-11">Deprecated</a></h3>
<h3 id="removed-11"><a class="header" href="#removed-11">Removed</a></h3>
<h3 id="fixed-11"><a class="header" href="#fixed-11">Fixed</a></h3>
<h3 id="security-13"><a class="header" href="#security-13">Security</a></h3>
<h2 id="0824---2026-02-13"><a class="header" href="#0824---2026-02-13">[0.8.24] - 2026-02-13</a></h2>
<h3 id="added-12"><a class="header" href="#added-12">Added</a></h3>
<h3 id="changed-12"><a class="header" href="#changed-12">Changed</a></h3>
<h3 id="deprecated-12"><a class="header" href="#deprecated-12">Deprecated</a></h3>
<h3 id="removed-12"><a class="header" href="#removed-12">Removed</a></h3>
<h3 id="fixed-12"><a class="header" href="#fixed-12">Fixed</a></h3>
<h3 id="security-14"><a class="header" href="#security-14">Security</a></h3>
<h2 id="0823---2026-02-13"><a class="header" href="#0823---2026-02-13">[0.8.23] - 2026-02-13</a></h2>
<h3 id="added-13"><a class="header" href="#added-13">Added</a></h3>
<ul>
<li><strong>Multi-select preferred models per provider</strong>: The LLMs page now has a
â€œPreferred Modelsâ€ button per provider that opens a multi-select modal.
Selected models are pinned at the top of the session model dropdown.
New <code>providers.save_models</code> RPC accepts multiple model IDs at once.</li>
<li><strong>Multi-select model picker in onboarding</strong>: The onboarding provider step now
uses a multi-select model picker matching the Settings LLMs page. Toggle
models on/off, see per-model probe status badges, and batch-save with a
single Save button. Previously-saved preferred models are pre-selected when
re-opening the model selector.</li>
</ul>
<h3 id="changed-13"><a class="header" href="#changed-13">Changed</a></h3>
<ul>
<li><strong>Model discovery uses <code>DiscoveredModel</code> struct</strong>: Replaced <code>(String, String)</code>
tuples with a typed <code>DiscoveredModel</code> struct across all providers (OpenAI,
GitHub Copilot, OpenAI Codex). The struct carries an optional <code>created_at</code>
timestamp from the <code>/v1/models</code> API, enabling discovered models to be sorted
newest-first. Preferred/configured models remain pinned at the top.</li>
<li><strong>Removed OpenAI-specific model name filtering from discovery</strong>: The
<code>/v1/models</code> response is no longer filtered by OpenAI naming conventions
(<code>gpt-*</code>, <code>o1</code>, etc.). All valid model IDs from any provider are now
accepted. This fixes model discovery for third-party providers like
Moonshot whose model IDs donâ€™t follow OpenAI naming.</li>
<li><strong>Disabled automatic model probe at startup</strong>: The background chat
completion probe that checked which models are supported is now
triggered on-demand by the web UI instead of running automatically
2 seconds after startup. With dynamic model discovery, the startup
probe was expensive and noisy (non-chat models like image, audio,
and video would log spurious warnings).</li>
<li><strong>Model test uses streaming for faster feedback</strong>: The â€œTestingâ€¦â€
probe when selecting a model now uses streaming and returns on the
first token instead of waiting for a full non-streaming response.
Timeout reduced from 20s to 10s.</li>
<li><strong>Chosen models merge with config-defined priority</strong>: Models selected
via the UI are prepended to the saved models list and merged with
config-defined preferred models, so both sources contribute to
ordering.</li>
<li><strong>Dynamic cross-provider priority list</strong>: The model dropdown priority
is now a shared <code>Arc&lt;RwLock&lt;Vec&lt;String&gt;&gt;&gt;</code> updated at runtime when
models are saved, instead of a static <code>HashMap</code> built once at startup.</li>
<li><strong>Replaced hardcoded Ollama checks with <code>keyOptional</code> metadata</strong>: JS
files no longer check <code>provider.name === "ollama"</code> for behavior.
Instead, the backend exposes a <code>keyOptional</code> field on provider
metadata, making the UI provider-agnostic.</li>
</ul>
<h3 id="fixed-13"><a class="header" href="#fixed-13">Fixed</a></h3>
<ul>
<li><strong>Settings UI env vars now available process-wide</strong>: environment variables
set via Settings &gt; Environment were previously only injected into sandbox
commands. They are now also injected into the Moltis process at startup,
making them available to web search, embeddings, and provider API calls.</li>
</ul>
<h2 id="0814---2026-02-11"><a class="header" href="#0814---2026-02-11">[0.8.14] - 2026-02-11</a></h2>
<h3 id="security-15"><a class="header" href="#security-15">Security</a></h3>
<ul>
<li><strong>Disconnect all WS clients on credential change</strong>: WebSocket connections
opened before auth setup are now disconnected when credentials change
(password set/changed, passkey registered during setup, auth reset, last
credential removed). An <code>auth.credentials_changed</code> event notifies browsers
to redirect to <code>/login</code>. Existing sessions are also invalidated on password
change for defense-in-depth.</li>
</ul>
<h3 id="fixed-14"><a class="header" href="#fixed-14">Fixed</a></h3>
<ul>
<li><strong>Onboarding test for SOUL.md clear behavior</strong>: Fixed <code>identity_update_partial</code>
test to match the new empty-file behavior from v0.8.13.</li>
</ul>
<h2 id="0813---2026-02-11"><a class="header" href="#0813---2026-02-11">[0.8.13] - 2026-02-11</a></h2>
<h3 id="added-14"><a class="header" href="#added-14">Added</a></h3>
<ul>
<li><strong>Auto-create SOUL.md on first run</strong>: <code>SOUL.md</code> is now seeded with the
default soul text when the file doesnâ€™t exist, mirroring how <code>moltis.toml</code>
is auto-created. If deleted, it re-seeds on next load.</li>
</ul>
<h3 id="fixed-15"><a class="header" href="#fixed-15">Fixed</a></h3>
<ul>
<li><strong>SOUL.md clear via settings</strong>: Clearing the soul textarea in settings no
longer re-creates the default on the next load. An explicit clear now writes
an empty file to distinguish â€œuser cleared soulâ€ from â€œfile never existedâ€.</li>
<li><strong>Onboarding WS connection timing</strong>: Deferred WebSocket connection until
authentication completes, preventing connection failures during onboarding.</li>
</ul>
<h3 id="changed-14"><a class="header" href="#changed-14">Changed</a></h3>
<ul>
<li><strong>Passkey auth preselection</strong>: Onboarding now preselects the passkey
authentication method when a passkey is already registered.</li>
<li><strong>Moonshot provider</strong>: Added Moonshot to the default offered providers list.</li>
</ul>
<h2 id="0812---2026-02-11"><a class="header" href="#0812---2026-02-11">[0.8.12] - 2026-02-11</a></h2>
<h3 id="fixed-16"><a class="header" href="#fixed-16">Fixed</a></h3>
<ul>
<li><strong>E2E test CI stability</strong>: <code>NoopChatService::clear()</code> now returns Ok instead
of an error when no LLM providers are configured, fixing 5 e2e test failures
in CI environments. Hardened websocket, chat-input, and onboarding-auth e2e
tests against startup race conditions and flaky selectors.</li>
</ul>
<h2 id="088---2026-02-11"><a class="header" href="#088---2026-02-11">[0.8.8] - 2026-02-11</a></h2>
<h3 id="changed-15"><a class="header" href="#changed-15">Changed</a></h3>
<ul>
<li><strong>Sessions sidebar layout</strong>: Removed the top <code>Sessions</code> title row and moved
the new-session <code>+</code> action next to the session search field for a more
compact list header.</li>
<li><strong>Identity autosave UX</strong>: Name fields in Settings &gt; Identity now autosave on
input blur, matching the quick-save behavior used for emoji selection.</li>
<li><strong>Favicon behavior by browser</strong>: Identity emoji changes now update favicon
live; Safari-specific reload guidance is shown only when Safari is detected.</li>
<li><strong>Page title format</strong>: Browser title now uses the configured assistant name
only, without appending <code>AI assistant</code> suffix text.</li>
</ul>
<h2 id="087---2026-02-11"><a class="header" href="#087---2026-02-11">[0.8.7] - 2026-02-11</a></h2>
<h3 id="added-15"><a class="header" href="#added-15">Added</a></h3>
<ul>
<li><strong>Model allowlist probe output support</strong>: Model allowlist matching now handles
provider probe output more robustly and applies stricter matching semantics.</li>
<li><strong>Ship helper command</strong>: Added a <code>just ship</code> task and <code>scripts/ship-pr.sh</code>
helper to streamline commit, push, PR update, and local validation workflows.</li>
</ul>
<h3 id="changed-16"><a class="header" href="#changed-16">Changed</a></h3>
<ul>
<li><strong>Gateway titles and labels</strong>: Login/onboarding page titles now consistently
use configured values and identity emoji; UI copy now labels providers as
<code>LLM</code> where appropriate.</li>
<li><strong>Release binary profile</strong>: Enabled ThinLTO and binary stripping in the
release profile to reduce artifact size.</li>
<li><strong>SPA route handling</strong>: Centralized SPA route definitions and preserved TOML
comments during config updates.</li>
</ul>
<h3 id="fixed-17"><a class="header" href="#fixed-17">Fixed</a></h3>
<ul>
<li><strong>Auth setup hardening</strong>: Enforced authentication immediately after password
or passkey setup to prevent unintended post-setup unauthenticated access.</li>
<li><strong>Streaming event ordering</strong>: Preserved gateway chat stream event ordering to
avoid out-of-order UI updates during streaming responses.</li>
<li><strong>Sandbox fallback pathing</strong>: Exec fallback now uses the host data directory
when no container runtime is available.</li>
</ul>
<h2 id="086---2026-02-11"><a class="header" href="#086---2026-02-11">[0.8.6] - 2026-02-11</a></h2>
<h3 id="changed-17"><a class="header" href="#changed-17">Changed</a></h3>
<ul>
<li><strong>Release workflow gates E2E tests</strong>: Build Packages workflow now runs E2E
tests and blocks all package builds (deb, rpm, arch, AppImage, snap,
Homebrew, Docker) if they fail.</li>
</ul>
<h3 id="fixed-18"><a class="header" href="#fixed-18">Fixed</a></h3>
<ul>
<li><strong>Docker TLS setup</strong>: All Docker examples now expose port 13132 for CA
certificate download with instructions to trust the self-signed cert,
fixing HTTPS access in Safari and other strict browsers.</li>
<li><strong>E2E onboarding-auth test</strong>: The <code>auth</code> Playwright projectâ€™s <code>testMatch</code>
regex <code>/auth\.spec/</code> also matched <code>onboarding-auth.spec.js</code>, causing it to
run against the default gateway (wrong server) instead of the onboarding-auth
gateway. Tightened regex to <code>/\/auth\.spec/</code>.</li>
</ul>
<h2 id="085---2026-02-11"><a class="header" href="#085---2026-02-11">[0.8.5] - 2026-02-11</a></h2>
<h3 id="added-16"><a class="header" href="#added-16">Added</a></h3>
<ul>
<li><strong>CLI <code>--version</code> flag</strong>: <code>moltis --version</code> now prints the version.</li>
<li><strong>Askama HTML rendering</strong>: SPA index and social metadata templates use
Askama instead of string replacement.</li>
</ul>
<h3 id="fixed-19"><a class="header" href="#fixed-19">Fixed</a></h3>
<ul>
<li><strong>WebSocket reconnect after remote onboarding auth</strong>: Connection now
reconnects immediately after auth setup instead of waiting for the backoff
timer, fixing â€œWebSocket not connectedâ€ errors during identity save.</li>
<li><strong>Passkeys on Fly.io</strong>: Auto-detect WebAuthn RP ID from <code>FLY_APP_NAME</code>
environment variable (constructs <code>{app}.fly.dev</code>).</li>
<li><strong>PaaS proxy detection</strong>: Added explicit <code>MOLTIS_BEHIND_PROXY=true</code> to
<code>render.yaml</code> and <code>fly.toml</code> so auth middleware reliably detects remote
connections behind the platformâ€™s reverse proxy.</li>
<li><strong>WebAuthn origin scheme on PaaS</strong>: Non-localhost RP IDs now default to
<code>https://</code> origin since PaaS platforms terminate TLS at the proxy.</li>
</ul>
<h3 id="security-16"><a class="header" href="#security-16">Security</a></h3>
<ul>
<li><strong>Compaction prompt injection hardening</strong>: Session compaction now passes
typed <code>ChatMessage</code> objects to the summarizer LLM instead of concatenated
<code>{role}: {content}</code> text, preventing role-spoofing prompt injection where
user content could mimic role prefixes (similar to GHSA-g8p2-7wf7-98mq).</li>
</ul>
<h2 id="084---2026-02-11"><a class="header" href="#084---2026-02-11">[0.8.4] - 2026-02-11</a></h2>
<h3 id="changed-18"><a class="header" href="#changed-18">Changed</a></h3>
<ul>
<li><strong>Session delete UX</strong>: Forked sessions with no new messages beyond the fork
point are deleted immediately without a confirmation dialog.</li>
</ul>
<h3 id="fixed-20"><a class="header" href="#fixed-20">Fixed</a></h3>
<ul>
<li><strong>Localhost passkey compatibility</strong>: Gateway startup URLs and TLS redirect
hints now use <code>localhost</code> for loopback hosts, while WebAuthn also allows
<code>moltis.localhost</code> as an additional origin when RP ID is <code>localhost</code>.</li>
</ul>
<h2 id="083---2026-02-11"><a class="header" href="#083---2026-02-11">[0.8.3] - 2026-02-11</a></h2>
<h3 id="fixed-21"><a class="header" href="#fixed-21">Fixed</a></h3>
<ul>
<li><strong>Linux clippy <code>unused_mut</code> failure</strong>: Fixed a target-specific <code>unused_mut</code>
warning in browser stale-container cleanup that failed release clippy on
Linux with <code>-D warnings</code>.</li>
</ul>
<h2 id="082---2026-02-11"><a class="header" href="#082---2026-02-11">[0.8.2] - 2026-02-11</a></h2>
<h3 id="fixed-22"><a class="header" href="#fixed-22">Fixed</a></h3>
<ul>
<li><strong>Release clippy environment parity</strong>: The release workflow clippy job now
runs in the same CUDA-capable environment as main CI, includes the llama
source git bootstrap step, and installs <code>rustfmt</code> alongside <code>clippy</code>. This
fixes release clippy failures caused by missing CUDA toolchain/runtime.</li>
</ul>
<h2 id="081---2026-02-11"><a class="header" href="#081---2026-02-11">[0.8.1] - 2026-02-11</a></h2>
<h3 id="fixed-23"><a class="header" href="#fixed-23">Fixed</a></h3>
<ul>
<li><strong>Clippy validation parity</strong>: Unified local validation, CI (main), and
release workflows to use the same clippy command and flags
(<code>--workspace --all-features --all-targets --timings -D warnings</code>), which
prevents release-only clippy failures from command drift.</li>
</ul>
<h2 id="080---2026-02-11"><a class="header" href="#080---2026-02-11">[0.8.0] - 2026-02-11</a></h2>
<h3 id="added-17"><a class="header" href="#added-17">Added</a></h3>
<ul>
<li><strong>Instance-scoped container naming</strong>: Browser and sandbox container/image
prefixes now derive from the configured instance name, so multiple Moltis
instances do not collide.</li>
</ul>
<h3 id="changed-19"><a class="header" href="#changed-19">Changed</a></h3>
<ul>
<li><strong>Stale container cleanup targeting</strong>: Startup cleanup now removes only
containers that belong to the active instance prefix instead of sweeping
unrelated containers.</li>
<li><strong>Apple container runtime probing</strong>: Browser container backend checks now use
the modern Apple container CLI flow (<code>container image pull --help</code>) without
legacy fallback behavior.</li>
</ul>
<h3 id="fixed-24"><a class="header" href="#fixed-24">Fixed</a></h3>
<ul>
<li><strong>Release workflow artifacts</strong>: Disabled docker build record artifact uploads
in release CI to avoid release workflow failures from missing artifact paths.</li>
<li><strong>Release preflight consistency</strong>: Pinned nightly toolchain and aligned
release preflight checks with CI formatting/lint gates.</li>
</ul>
<h2 id="071---2026-02-11"><a class="header" href="#071---2026-02-11">[0.7.1] - 2026-02-11</a></h2>
<h3 id="fixed-25"><a class="header" href="#fixed-25">Fixed</a></h3>
<ul>
<li><strong>Release format gate</strong>: Included missing Rust formatting updates in release
history so the release workflow <code>cargo fmt --all -- --check</code> passes for
tagged builds.</li>
</ul>
<h2 id="070---2026-02-11"><a class="header" href="#070---2026-02-11">[0.7.0] - 2026-02-11</a></h2>
<h3 id="added-18"><a class="header" href="#added-18">Added</a></h3>
<ul>
<li><strong>HTTP endpoint throttling</strong>: Added gateway-level per-IP rate limits for
login (<code>/api/auth/login</code>), auth API routes, general API routes, and WebSocket
upgrades, with <code>429</code> responses, <code>Retry-After</code> headers, and JSON
<code>retry_after_seconds</code>.</li>
<li><strong>Login retry UX</strong>: The login page now disables the password Sign In button
while throttled and shows a live <code>Retry in Xs</code> countdown.</li>
</ul>
<h3 id="changed-20"><a class="header" href="#changed-20">Changed</a></h3>
<ul>
<li><strong>Auth-aware throttling policy</strong>: IP throttling is now bypassed when auth is
not required for the current request (authenticated requests, auth-disabled
mode, and local Tier-2 setup mode). This keeps brute-force protection for
unauthenticated/auth-required traffic while avoiding localhost friction.</li>
<li><strong>Login error copy</strong>: During throttled login retries, the error message stays
static while the retry countdown is shown only on the button.</li>
</ul>
<h3 id="documentation-1"><a class="header" href="#documentation-1">Documentation</a></h3>
<ul>
<li>Added throttling/security notes to <code>README.md</code>, <code>docs/src/index.md</code>,
<code>docs/src/authentication.md</code>, and <code>docs/src/security.md</code>.</li>
</ul>
<h2 id="061---2026-02-10"><a class="header" href="#061---2026-02-10">[0.6.1] - 2026-02-10</a></h2>
<h3 id="fixed-26"><a class="header" href="#fixed-26">Fixed</a></h3>
<ul>
<li><strong>Release clippy</strong>: Aligned release workflow clippy command with nightly
flags (<code>-Z unstable-options</code>, <code>--timings</code>).</li>
<li><strong>Test lint attributes</strong>: Fixed useless outer <code>#[allow]</code> on test module
<code>use</code> statement; replaced <code>.unwrap()</code> with <code>.expect()</code> in auth route tests.</li>
</ul>
<h2 id="060---2026-02-10"><a class="header" href="#060---2026-02-10">[0.6.0] - 2026-02-10</a></h2>
<h3 id="added-19"><a class="header" href="#added-19">Added</a></h3>
<ul>
<li><strong><code>BeforeLLMCall</code> / <code>AfterLLMCall</code> hooks</strong>: New modifying hook events that fire
before sending prompts to the LLM provider and after receiving responses
(before tool execution). Enables prompt injection filtering, PII redaction,
and response auditing via shell hooks.</li>
<li><strong>Config template</strong>: The generated <code>moltis.toml</code> template now lists all 17
hook events with correct PascalCase names and one-line descriptions.</li>
<li><strong>Hook event validation</strong>: <code>moltis config check</code> now warns on unknown hook
event names in the config file.</li>
<li><strong>Authentication docs</strong>: Comprehensive <code>docs/src/authentication.md</code> with
decision matrix, credential types, API key scopes, session endpoints,
and WebSocket auth documentation.</li>
</ul>
<h3 id="fixed-27"><a class="header" href="#fixed-27">Fixed</a></h3>
<ul>
<li><strong>Browser container lifecycle</strong>: Browser containers (browserless/chrome)
now have proper lifecycle management â€” periodic cleanup removes idle
instances every 30 seconds, graceful shutdown stops all containers on
Ctrl+C, and <code>sessions.clear_all</code> immediately closes all browser sessions.
A <code>Drop</code> safety net ensures containers are stopped even on unexpected exits.</li>
</ul>
<h3 id="changed-21"><a class="header" href="#changed-21">Changed</a></h3>
<ul>
<li><strong>Unified auth gate</strong>: All auth decision logic is now in a single
<code>check_auth()</code> function called by one <code>auth_gate</code> middleware. This fixes
the split-brain bug where passkey-only setups (no password) were treated
differently by 4 out of 5 auth code paths â€” the middleware used
<code>is_setup_complete()</code> (correct) while the others used <code>has_password()</code>
(incorrect for passkey-only setups).</li>
<li><strong>Hooks documentation</strong>: Rewritten <code>docs/src/hooks.md</code> with complete event
reference, corrected <code>ToolResultPersist</code> classification (modifying, not
read-only), and new â€œPrompt Injection Filteringâ€ section with examples.</li>
<li><strong>Logs level filter UI</strong>: Settings -&gt; Logs now shows <code>DEBUG</code>/<code>TRACE</code> level
options only when they are enabled by the active tracing filter (including
target-specific directives). Default view remains <code>INFO</code> and above.</li>
<li><strong>Logs level filter control</strong>: Settings -&gt; Logs now uses the same combo
dropdown pattern as the chat model selector for consistent UX.</li>
<li><strong>Branch favicon contrast</strong>: Non-main branches now use a high-contrast purple
favicon variant so branch sessions are visually distinct from <code>main</code>.</li>
</ul>
<h3 id="security-17"><a class="header" href="#security-17">Security</a></h3>
<ul>
<li><strong>Content-Security-Policy header</strong>: HTML pages now include a nonce-based CSP
header (<code>script-src 'self' 'nonce-&lt;UUID&gt;'</code>), preventing inline script
injection (XSS defense-in-depth). The OAuth callback page also gets a
restrictive CSP.</li>
<li><strong>Passkey-only auth fix</strong>: Fixed authentication bypass where passkey-only
setups (without a password) would incorrectly allow unauthenticated access
on local connections, because the <code>has_password()</code> check returned false
even though <code>is_setup_complete()</code> was true.</li>
</ul>
<h2 id="050---2026-02-09"><a class="header" href="#050---2026-02-09">[0.5.0] - 2026-02-09</a></h2>
<h3 id="added-20"><a class="header" href="#added-20">Added</a></h3>
<ul>
<li><strong><code>moltis doctor</code> command</strong>: Comprehensive health check that validates config,
audits security (file permissions, API keys in config), checks directory and
database health, verifies provider readiness (API keys via config or env vars),
inspects TLS certificates, and validates MCP server commands on PATH.</li>
</ul>
<h3 id="security-18"><a class="header" href="#security-18">Security</a></h3>
<ul>
<li><strong>npm install â€“ignore-scripts</strong>: Skill dependency installation now passes
<code>--ignore-scripts</code> to npm, preventing supply chain attacks via malicious
postinstall scripts in npm packages.</li>
<li><strong>API key scope enforcement</strong>: API keys with empty/no scopes are now denied
access instead of silently receiving full admin privileges. Keys must specify
at least one scope explicitly (least-privilege by default).</li>
</ul>
<h2 id="041---2026-02-09"><a class="header" href="#041---2026-02-09">[0.4.1] - 2026-02-09</a></h2>
<h3 id="fixed-28"><a class="header" href="#fixed-28">Fixed</a></h3>
<ul>
<li><strong>Clippy lint in map test</strong>: Replace <code>is_some()</code>/<code>unwrap()</code> with <code>if let Some</code> to
fix <code>clippy::unnecessary_unwrap</code> that broke the v0.4.0 release build.</li>
</ul>
<h2 id="040---2026-02-09"><a class="header" href="#040---2026-02-09">[0.4.0] - 2026-02-09</a></h2>
<h3 id="added-21"><a class="header" href="#added-21">Added</a></h3>
<ul>
<li><strong>Auto-import external OAuth tokens</strong>: At startup, auto-detected provider
tokens (e.g. Codex CLI <code>~/.codex/auth.json</code>) are imported into the central
<code>oauth_tokens.json</code> store so users can manage all providers from the UI.</li>
<li><strong>Passkey onboarding</strong>: The security setup step now offers passkey registration
(Touch ID, Face ID, security keys) as the recommended default, with password
as a fallback option.</li>
<li><strong><code>providers.validate_key</code> RPC method</strong>: Test provider credentials without
saving them â€” builds a temporary registry, probes with a â€œpingâ€ message, and
returns validation status with available models.</li>
<li><strong><code>providers.save_model</code> RPC method</strong>: Save the preferred model for any
configured provider without changing credentials.</li>
<li><strong><code>models.test</code> RPC method</strong>: Test a single model from the live registry with
a real LLM request before committing to it.</li>
<li><strong>Model selection for auto-detected providers</strong>: The Providers settings page
now shows a â€œSelect Modelâ€ button for providers that have available models but
no preferred model set. This lets users pick their favorite model for
auto-detected providers (e.g. OpenAI Codex detected from <code>~/.codex/auth.json</code>).</li>
<li><strong><code>show_map</code> tool</strong>: New LLM-callable tool that composes a static map image
from OSM tiles with red/blue marker pins (destination + user location), plus
clickable links to Google Maps, Apple Maps, and OpenStreetMap. Supports
<code>user_latitude</code>/<code>user_longitude</code> to show both positions with auto-zoom.
Solves the â€œI canâ€™t share linksâ€ problem in voice mode.</li>
<li><strong>Location precision modes</strong>: The <code>get_user_location</code> tool now accepts a
<code>precision</code> parameter â€” <code>"precise"</code> (GPS-level, default) for nearby places
and directions, or <code>"coarse"</code> (city-level, faster) for flights, weather, and
time zones. The LLM picks the appropriate mode based on the userâ€™s query.</li>
</ul>
<h3 id="changed-22"><a class="header" href="#changed-22">Changed</a></h3>
<ul>
<li>Show â€œNo LLM Providers Connectedâ€ card instead of welcome greeting when no
providers are configured.</li>
<li><strong>Onboarding provider setup</strong>: Credentials are now validated before saving.
After successful validation, a model selector shows available models for the
provider. The selected model is tested with a real request before completing
setup. Clear error messages are shown for common failures (invalid API key,
rate limits, connection issues).</li>
<li><strong>Settings provider setup</strong>: The main Providers settings page now uses the
same validate-first flow as onboarding. Credentials are validated before
saving (bad keys are never persisted), a model selector appears after
validation, and OAuth flows show model selection after authentication.</li>
</ul>
<h3 id="fixed-29"><a class="header" href="#fixed-29">Fixed</a></h3>
<ul>
<li><strong>Docker RAM detection</strong>: Fall back to <code>/proc/meminfo</code> when <code>sysinfo</code> returns
0 bytes for memory inside Docker/cgroup environments.</li>
<li><strong>MLX model suggested on Linux</strong>: Use backend-aware model suggestion so MLX
models are only suggested on Apple Silicon, not on Linux servers.</li>
<li><strong>Host package provisioning noise</strong>: Skip <code>apt-get</code> when running as non-root
with no passwordless sudo, instead of failing with permission denied warnings.</li>
<li><strong>Browser image pull without runtime</strong>: Guard browser container image pull to
skip when no usable container runtime is available (backend = â€œnoneâ€).</li>
<li><strong>OAuth token store logging</strong>: Replace silent <code>.ok()?</code> chains with explicit
<code>warn!</code>/<code>info!</code> logging in <code>TokenStore</code> load/save/delete for diagnosability.</li>
<li><strong>Provider warning noise</strong>: Downgrade â€œtokens not foundâ€ log from <code>warn!</code> to
<code>debug!</code> for unconfigured providers (GitHub Copilot, OpenAI Codex).</li>
<li><strong>models.detect_supported noise</strong>: Downgrade UNAVAILABLE RPC errors from
<code>warn!</code> to <code>debug!</code> since they indicate expected â€œnot ready yetâ€ states.</li>
</ul>
<h2 id="038---2026-02-09"><a class="header" href="#038---2026-02-09">[0.3.8] - 2026-02-09</a></h2>
<h3 id="changed-23"><a class="header" href="#changed-23">Changed</a></h3>
<ul>
<li><strong>Release CI parallelization</strong>: Split clippy and test into separate parallel
jobs in the release workflow for faster feedback on GitHub-hosted runners.</li>
</ul>
<h3 id="fixed-30"><a class="header" href="#fixed-30">Fixed</a></h3>
<ul>
<li><strong>CodSpeed workflow zizmor audit</strong>: Pinned <code>CodSpeedHQ/action@v4</code> to commit
SHA to satisfy zizmorâ€™s <code>unpinned-uses</code> audit.</li>
</ul>
<h2 id="037---2026-02-09"><a class="header" href="#037---2026-02-09">[0.3.7] - 2026-02-09</a></h2>
<h3 id="fixed-31"><a class="header" href="#fixed-31">Fixed</a></h3>
<ul>
<li><strong>Clippy warnings</strong>: Fixed <code>MutexGuard</code> held across await in telegram
test, <code>field assignment outside initializer</code> in provider setup test, and
<code>items after test module</code> in gateway services.</li>
</ul>
<h2 id="036---2026-02-09"><a class="header" href="#036---2026-02-09">[0.3.6] - 2026-02-09</a></h2>
<h3 id="fixed-32"><a class="header" href="#fixed-32">Fixed</a></h3>
<ul>
<li><strong>Release CI zizmor audit</strong>: Removed <code>rust-cache</code> from the release workflowâ€™s
clippy-test job entirely instead of using <code>save-if: false</code>, which zizmor does
not recognize as a cache-poisoning mitigation.</li>
</ul>
<h2 id="035---2026-02-09"><a class="header" href="#035---2026-02-09">[0.3.5] - 2026-02-09</a></h2>
<h3 id="fixed-33"><a class="header" href="#fixed-33">Fixed</a></h3>
<ul>
<li><strong>Release CI cache-poisoning</strong>: Set <code>save-if: false</code> on <code>rust-cache</code> in the
release workflow to satisfy zizmorâ€™s cache-poisoning audit for tag-triggered
workflows that publish artifacts.</li>
</ul>
<h2 id="034---2026-02-09"><a class="header" href="#034---2026-02-09">[0.3.4] - 2026-02-09</a></h2>
<h3 id="fixed-34"><a class="header" href="#fixed-34">Fixed</a></h3>
<ul>
<li><strong>Session file lock contention</strong>: Replaced non-blocking <code>try_write()</code> with
blocking <code>write()</code> in <code>SessionStore::append()</code> and <code>replace_history()</code> so
concurrent tool-result persists wait for the file lock instead of failing
with <code>EAGAIN</code> (OS error 35).</li>
</ul>
<h3 id="changed-24"><a class="header" href="#changed-24">Changed</a></h3>
<ul>
<li><strong>Release CI quality gates</strong>: The Build Packages workflow now runs biome,
format, clippy, and test checks before building any packages, ensuring code
correctness before artifacts are produced.</li>
</ul>
<h2 id="033---2026-02-09"><a class="header" href="#033---2026-02-09">[0.3.3] - 2026-02-09</a></h2>
<h3 id="fixed-35"><a class="header" href="#fixed-35">Fixed</a></h3>
<ul>
<li><strong>OpenAI Codex token refresh panic</strong>: Made <code>get_valid_token()</code> async to fix
<code>block_on</code> inside async runtime panic when refreshing expired OAuth tokens.</li>
<li><strong>Channel session binding</strong>: Ensure session row exists before setting channel
binding, fixing <code>get_user_location</code> failures on first Telegram message.</li>
<li><strong>Cargo.lock sync</strong>: Lock file now matches workspace version.</li>
</ul>
<h2 id="030---2026-02-08"><a class="header" href="#030---2026-02-08">[0.3.0] - 2026-02-08</a></h2>
<h3 id="added-22"><a class="header" href="#added-22">Added</a></h3>
<ul>
<li>
<p><strong>Silent replies</strong>: The system prompt instructs the LLM to return an empty
response when tool output speaks for itself, suppressing empty chat bubbles,
push notifications, and channel replies. Empty assistant messages are not
persisted to session history.</p>
</li>
<li>
<p><strong>Persist TTS audio to session media</strong>: When TTS is enabled and the reply
medium is <code>voice</code>, the server generates TTS audio, saves it to the session
media directory, and includes the media path in the persisted assistant
message. On session reload the frontend renders an <code>&lt;audio&gt;</code> player from
the media API instead of re-generating audio via RPC.</p>
</li>
<li>
<p><strong>Per-session media directory</strong>: Screenshots from the browser tool are now
persisted to <code>sessions/media/&lt;key&gt;/</code> and served via
<code>GET /api/sessions/:key/media/:filename</code>. Session history reload renders
screenshots from the API instead of losing them. Media files are cleaned
up when a session is deleted.</p>
</li>
<li>
<p><strong>Process tool for interactive terminal sessions</strong>: New <code>process</code> tool lets
the LLM manage interactive/TUI programs (htop, vim, REPLs, etc.) via tmux
sessions inside the sandbox. Supports start, poll, send_keys, paste, kill,
and list actions. Includes a built-in <code>tmux</code> skill with usage instructions.</p>
</li>
<li>
<p><strong>Runtime host+sandbox prompt context</strong>: Chat system prompts now include a
<code>## Runtime</code> section with host details (hostname, OS, arch, shell, provider,
model, session, sudo non-interactive capability) and <code>exec</code> sandbox details
(enabled state, mode, backend, scope, image, workspace mount, network policy,
session override). Tool-mode prompts also add routing guidance so the agent
asks before requesting host installs or changing sandbox mode.</p>
</li>
<li>
<p><strong>Telegram location sharing</strong>: Telegram channels now support receiving shared
locations and live location updates. Live locations are tracked until they
expire or the user stops sharing.</p>
</li>
<li>
<p><strong>Telegram reply threading</strong>: Telegram channel replies now use
<code>reply_to_message_id</code> to thread responses under the original user message,
keeping conversations visually grouped in the chat.</p>
</li>
<li>
<p><strong><code>get_user_location</code> tool</strong>: New browser-based geolocation tool lets the LLM
request the userâ€™s current coordinates via the Geolocation API, with a
permission prompt in the UI.</p>
</li>
<li>
<p><strong><code>sandbox_packages</code> tool</strong>: New tool for on-demand package discovery inside
the sandbox, allowing the LLM to query available and installable packages at
runtime.</p>
</li>
<li>
<p><strong>Sandbox package expansions</strong>: Pre-built sandbox images now include expanded
package groups â€” GIS/OpenStreetMap, document/office/search,
image/audio/media/data-processing, and communication packages. Mise is also
available for runtime version management.</p>
</li>
<li>
<p><strong>Queued message UI</strong>: When a message is submitted while the LLM is already
responding, it is shown in a dedicated bottom tray with cancel support.
Queued messages are moved into the conversation only after the current
response finishes rendering.</p>
</li>
<li>
<p><strong>Full context view</strong>: New â€œContextâ€ button in the chat header opens a panel
showing the full LLM messages array sent to the provider, with a Copy button
for easy debugging.</p>
</li>
<li>
<p><strong>Browser timezone auto-detection</strong>: The gateway now auto-detects the userâ€™s
timezone from the browser via <code>Intl.DateTimeFormat</code> and includes it in
session context, removing the need for manual timezone configuration.</p>
</li>
<li>
<p><strong>Logs download</strong>: New Download button on the logs page streams the JSONL log
file via <code>GET /api/logs/download</code> with gzip/zstd compression.</p>
</li>
<li>
<p><strong>Gateway middleware hardening</strong>: Consolidated middleware into
<code>apply_middleware_stack()</code> with security and observability layers:</p>
<ul>
<li>Replace <code>allow_origin(Any)</code> with dynamic host-based CORS validation
reusing the WebSocket CSWSH <code>is_same_origin</code> logic, safe for
Docker/cloud deployments with unknown hostnames</li>
<li><code>CatchPanicLayer</code> to convert handler panics to 500 responses</li>
<li><code>RequestBodyLimitLayer</code> (16 MiB) to prevent memory exhaustion</li>
<li><code>SetSensitiveHeadersLayer</code> to redact Authorization/Cookie in traces</li>
<li>Security response headers (<code>X-Content-Type-Options</code>, <code>X-Frame-Options</code>,
<code>Referrer-Policy</code>)</li>
<li><code>SetRequestIdLayer</code> + <code>PropagateRequestIdLayer</code> for <code>x-request-id</code>
correlation across HTTP request logs</li>
<li>zstd compression alongside gzip for better ratios</li>
</ul>
</li>
<li>
<p><strong>Message run tracking</strong>: Persisted messages now carry <code>run_id</code> and <code>seq</code>
fields for parent/child linking across multi-turn tool runs, plus a
client-side sequence number for ordering diagnostics.</p>
</li>
<li>
<p><strong>Cache token metrics</strong>: Provider responses now populate cache-hit and
cache-miss token counters in the metrics subsystem.</p>
</li>
</ul>
<h3 id="changed-25"><a class="header" href="#changed-25">Changed</a></h3>
<ul>
<li><strong>Provider auto-detection observability</strong>: When no explicit provider settings are present in <code>moltis.toml</code>, startup now logs each auto-detected provider with its source (<code>env</code>, config file key, OAuth token file, provider key file, or Codex auth file). Added <code>server.http_request_logs</code> (Axum HTTP traces) and <code>server.ws_request_logs</code> (WebSocket RPC request/response traces) config options (both default <code>false</code>) for on-demand transport debugging without code changes.</li>
<li><strong>Dynamic OpenAI Codex model catalog</strong>: OpenAI Codex providers now load model IDs from <code>https://chatgpt.com/backend-api/codex/models</code> at startup (with fallback defaults), and the gateway refreshes Codex models hourly so long-running sessions pick up newly available models (for example <code>gpt-5.3</code>) without restart.</li>
<li><strong>Model availability probing UX</strong>: Model support probing now runs in parallel with bounded concurrency, starts automatically after provider connect/startup, and streams live progress (<code>start</code>/<code>progress</code>/<code>complete</code>) over WebSocket so the Providers page can render a progress bar.</li>
<li><strong>Provider-scoped probing on connect</strong>: Connecting a provider from the Providers UI now probes only that providerâ€™s models (instead of all providers), reducing noise and startup load when adding accounts one by one.</li>
<li><strong>Configurable model ordering</strong>: Added <code>chat.priority_models</code> in <code>moltis.toml</code> to pin preferred models at the top of model selectors without rebuilding. Runtime model selectors (<code>models.list</code>, chat model dropdown, Telegram <code>/model</code>) hide unsupported models, while Providers diagnostics continue to show full catalog entries (including unsupported flags).</li>
<li><strong>Configurable provider offerings in UI</strong>: Added <code>[providers] offered = [...]</code> allowlist in <code>moltis.toml</code> to control which providers are shown in onboarding/provider-picker UI. New config templates default this to <code>["openai", "github-copilot"]</code>; setting <code>offered = []</code> shows all known providers. Configured providers remain visible for management.</li>
</ul>
<h3 id="fixed-36"><a class="header" href="#fixed-36">Fixed</a></h3>
<ul>
<li>
<p><strong>Web search DuckDuckGo fallback</strong>: When no search API key (Brave or
Perplexity) is configured, <code>web_search</code> now automatically falls back to
DuckDuckGo HTML search instead of returning an error and forcing the LLM
to ask the user about using the browser.</p>
</li>
<li>
<p><strong>Web onboarding flash and redirect timing</strong>: The web server now performs onboarding redirects before rendering the main app shell. When onboarding is incomplete, non-onboarding routes redirect directly to <code>/onboarding</code>; once onboarding is complete, <code>/onboarding</code> redirects back to <code>/</code>. The onboarding route now serves a dedicated onboarding HTML/JS entry instead of the full app bundle, preventing duplicate bootstrap/navigation flashes in Safari.</p>
</li>
<li>
<p><strong>Local model cache path visibility</strong>: Startup logs for local LLM providers now explicitly print the model cache directory and cached model IDs, making <code>MOLTIS_DATA_DIR</code> behavior easier to verify without noisy model-catalog output.</p>
</li>
<li>
<p><strong>Kimi device-flow OAuth in web UI</strong>: Kimi OAuth now uses provider-specific headers and prefers <code>verification_uri_complete</code> (or synthesizes <code>?user_code=</code> fallback) so mobile-device sign-in links no longer fail with missing <code>user_code</code>.</p>
</li>
<li>
<p><strong>Kimi Code provider authentication compatibility</strong>: <code>kimi-code</code> is now API-key-first in the web UI (<code>KIMI_API_KEY</code>, default base URL <code>https://api.moonshot.ai/v1</code>), while still honoring previously stored OAuth tokens for backward compatibility. Provider errors now include a targeted hint to switch to API-key auth when Kimi returns <code>access_terminated_error</code>.</p>
</li>
<li>
<p><strong>Provider setup success feedback</strong>: API-key provider setup now runs an immediate model probe after saving credentials. The onboarding and Providers modal only show success when at least one model validates, and otherwise display a validation failure message instead of a false-positive â€œconfiguredâ€ state.</p>
</li>
<li>
<p><strong>Heartbeat/cron duplicate runs</strong>: Skip heartbeat LLM turn when no prompt is
configured, and fix duplicate cron job executions that could fire the same
scheduled run twice.</p>
</li>
<li>
<p><strong>Onboarding finish screen removed</strong>: Onboarding now skips the final
â€œcongratulationsâ€ screen and redirects straight to the chat view.</p>
</li>
<li>
<p><strong>User message footer leak</strong>: Model name footer and timestamp are no longer
incorrectly attached to user messages in the chat UI.</p>
</li>
<li>
<p><strong>TTS counterpart auto-enable on STT save</strong>: Saving an ElevenLabs or Google
Cloud STT key now automatically enables the matching TTS provider, mirroring
the onboarding voice-test behavior.</p>
</li>
<li>
<p><strong>Voice-generating indicator removed</strong>: The separate â€œvoice generatingâ€
spinner during TTS playback has been removed in favor of the unified
response indicator.</p>
</li>
<li>
<p><strong>Config restart crash loop prevention</strong>: The gateway now validates the
configuration file before restarting, returning an error to the UI instead
of entering a crash loop when the config is invalid.</p>
</li>
<li>
<p><strong>Safari dev-mode cache busting</strong>: Development mode now busts the Safari
asset cache on reload, and fixes a missing border on detected-provider cards.</p>
</li>
</ul>
<h3 id="refactored"><a class="header" href="#refactored">Refactored</a></h3>
<ul>
<li><strong>McpManager lock consolidation</strong>: Replaced per-field <code>RwLock</code>s in
<code>McpManager</code> with a single <code>RwLock&lt;McpManagerInner&gt;</code> to reduce lock
contention and simplify state management.</li>
<li><strong>GatewayState lock consolidation</strong>: Replaced per-field <code>RwLock</code>s in
<code>GatewayState</code> with a single <code>RwLock&lt;GatewayInner&gt;</code> for the same reasons.</li>
<li><strong>Typed chat broadcast payloads</strong>: Chat WebSocket broadcasts now use typed
Rust structs instead of ad-hoc <code>serde_json::Value</code> maps.</li>
</ul>
<h3 id="documentation-2"><a class="header" href="#documentation-2">Documentation</a></h3>
<ul>
<li>Expanded default <code>SOUL.md</code> with the full OpenClaw reference text for agent
personality bootstrapping.</li>
</ul>
<h2 id="029---2026-02-08"><a class="header" href="#029---2026-02-08">[0.2.9] - 2026-02-08</a></h2>
<h3 id="added-23"><a class="header" href="#added-23">Added</a></h3>
<ul>
<li><strong>Voice provider policy controls</strong>: Added provider-list allowlists so config templates and runtime voice setup can explicitly limit shown/allowed TTS and STT providers.</li>
<li><strong>Typed voice provider metadata</strong>: Expanded voice provider metadata and preference handling to use typed flows across gateway and UI paths.</li>
</ul>
<h3 id="changed-26"><a class="header" href="#changed-26">Changed</a></h3>
<ul>
<li><strong>Reply medium preference handling</strong>: Chat now prefers the same reply medium when possible and falls back to text when a medium cannot be preserved.</li>
</ul>
<h3 id="fixed-37"><a class="header" href="#fixed-37">Fixed</a></h3>
<ul>
<li><strong>Chat UI reply badge visibility</strong>: Assistant footer now reliably shows the selected reply medium badge.</li>
<li><strong>Voice UX polish</strong>: Improved microphone timing behavior and preserved settings scroll state in voice configuration views.</li>
</ul>
<h2 id="028---2026-02-07"><a class="header" href="#028---2026-02-07">[0.2.8] - 2026-02-07</a></h2>
<h3 id="changed-27"><a class="header" href="#changed-27">Changed</a></h3>
<ul>
<li><strong>Unified plugins and skills into a single system</strong>: Plugins and skills were separate
systems with duplicate code, manifests, and UI pages. They are now merged into one
unified â€œSkillsâ€ system. All installed repos (SKILL.md, Claude Code <code>.claude-plugin/</code>,
Codex) are managed through a single <code>skills-manifest.json</code> and <code>installed-skills/</code>
directory. The <code>/plugins</code> page has been removed â€” everything is accessible from the
<code>/skills</code> page. A one-time startup migration automatically moves data from the old
plugins manifest and directory into the new unified location.</li>
<li><strong>Default config template voice list narrowed</strong>: New generated configs now include a
<code>[voice]</code> section with provider-list allowlists limited to ElevenLabs for TTS and
Mistral + ElevenLabs for STT.</li>
</ul>
<h3 id="fixed-38"><a class="header" href="#fixed-38">Fixed</a></h3>
<ul>
<li><strong>Update checker repository configuration</strong>: The update checker now reads
<code>server.update_repository_url</code> from <code>moltis.toml</code>, defaults new configs to
<code>https://github.com/moltis-org/moltis</code>, and treats an omitted/commented value
as explicitly disabled.</li>
<li><strong>Mistral and other providers rejecting requests with HTTP 422</strong>: Session metadata fields
(<code>created_at</code>, <code>model</code>, <code>provider</code>, <code>inputTokens</code>, <code>outputTokens</code>) were leaking into
provider API request bodies. Mistralâ€™s strict validation rejected the extra <code>created_at</code>
field. Replaced <code>Vec&lt;serde_json::Value&gt;</code> with a typed <code>ChatMessage</code> enum in the
<code>LlmProvider</code> trait â€” metadata can no longer leak because the type only contains
LLM-relevant fields (<code>role</code>, <code>content</code>, <code>tool_calls</code>). Conversion from persisted JSON
happens once at the gateway boundary via <code>values_to_chat_messages()</code>.</li>
<li><strong>Chat skill creation not persisting new skills</strong>: Runtime tool filtering incorrectly
applied the union of discovered skill <code>allowed_tools</code> to all chat turns, which could
hide <code>create_skill</code>/<code>update_skill</code> and leave only a subset (for example <code>web_fetch</code>).
Chat runs now use configured tool policy for runtime filtering without globally
restricting tools based on discovered skill metadata.</li>
</ul>
<h3 id="added-24"><a class="header" href="#added-24">Added</a></h3>
<ul>
<li>
<p><strong>Voice Provider Management UI</strong>: Configure TTS and STT providers from Settings &gt; Voice</p>
<ul>
<li>Auto-detection of API keys from environment variables and LLM provider configs</li>
<li>Toggle switches to enable/disable providers without removing configuration</li>
<li>Local binary detection for whisper.cpp, piper, and sherpa-onnx</li>
<li>Server availability checks for Coqui TTS and Voxtral Local</li>
<li>Setup instructions modal for local provider installation</li>
<li>Shared Google Cloud API key between TTS and STT</li>
</ul>
</li>
<li>
<p><strong>Voice provider UI allowlists</strong>: Added <code>voice.tts.providers</code> and <code>voice.stt.providers</code>
config lists to control which TTS/STT providers are shown in the Settings UI.
Empty lists keep current behavior and show all providers.</p>
</li>
<li>
<p><strong>New TTS Providers</strong>:</p>
<ul>
<li>Google Cloud Text-to-Speech (380+ voices, 50+ languages)</li>
<li>Piper (fast local neural TTS, runs offline)</li>
<li>Coqui TTS (high-quality neural TTS with voice cloning)</li>
</ul>
</li>
<li>
<p><strong>New STT Providers</strong>:</p>
<ul>
<li>ElevenLabs Scribe (90+ languages, word timestamps, speaker diarization)</li>
<li>Mistral AI Voxtral (cloud-based, 13 languages)</li>
<li>Voxtral Local via vLLM (self-hosted with OpenAI-compatible API)</li>
</ul>
</li>
<li>
<p><strong>Browser Sandbox Mode</strong>: Run browser in isolated Docker containers for security</p>
<ul>
<li>Automatic container lifecycle management</li>
<li>Uses <code>browserless/chrome</code> image by default (configurable via <code>sandbox_image</code>)</li>
<li>Container readiness detection via HTTP endpoint probing</li>
<li>Browser sandbox mode automatically follows the sessionâ€™s sandbox mode
(no separate <code>browser.sandbox</code> config - sandboxed sessions use sandboxed browser)</li>
</ul>
</li>
<li>
<p><strong>Memory-Based Browser Pool Limits</strong>: Browser instances now limited by system memory</p>
<ul>
<li><code>max_instances = 0</code> (default) allows unlimited instances, limited only by memory</li>
<li><code>memory_limit_percent = 90</code> blocks new instances when system memory exceeds threshold</li>
<li>Idle browsers cleaned up automatically before blocking</li>
<li>Set <code>max_instances &gt; 0</code> for hard limit if preferred</li>
</ul>
</li>
<li>
<p><strong>Automatic Browser Session Tracking</strong>: Browser tool automatically reuses sessions</p>
<ul>
<li>Session ID is tracked internally and injected when LLM doesnâ€™t provide one</li>
<li>Prevents pool exhaustion from LLMs forgetting to pass session_id</li>
<li>Session cleared on explicit â€œcloseâ€ action</li>
</ul>
</li>
<li>
<p><strong>HiDPI Screenshot Support</strong>: Screenshots scale correctly on Retina displays</p>
<ul>
<li><code>device_scale_factor</code> config (default: 2.0) for high-DPI rendering</li>
<li>Screenshot display in UI scales according to device pixel ratio</li>
<li>Viewport increased to 2560Ã—1440 for sharper captures</li>
</ul>
</li>
<li>
<p><strong>Enhanced Screenshot Lightbox</strong>:</p>
<ul>
<li>Scrollable container for viewing long/tall screenshots</li>
<li>Download button at top of lightbox</li>
<li>Visible âœ• close button instead of text hint</li>
<li>Proper scaling for HiDPI displays</li>
</ul>
</li>
<li>
<p><strong>Telegram Screenshot Support</strong>: Browser screenshots sent to Telegram channels</p>
<ul>
<li>Automatic retry as document when image dimensions exceed Telegram limits</li>
<li>Error messages sent to channel when screenshot delivery fails</li>
<li>Handles <code>PHOTO_INVALID_DIMENSIONS</code> and <code>PHOTO_SAVE_FILE_INVALID</code> errors</li>
</ul>
</li>
<li>
<p><strong>Telegram Tool Status Notifications</strong>: See whatâ€™s happening during long operations</p>
<ul>
<li>Tool execution messages sent to Telegram (e.g., â€œğŸŒ Navigating toâ€¦â€,
â€œğŸ’» Running: <code>git status</code>â€, â€œğŸ“¸ Taking screenshotâ€¦â€)</li>
<li>Messages sent silently (no notification sound) to avoid spam</li>
<li>Typing indicator automatically re-sent after status messages</li>
<li>Supports browser, exec, web_fetch, web_search, and memory tools</li>
</ul>
</li>
<li>
<p><strong>Log Target Display</strong>: Logs now include the crate/module path for easier debugging</p>
<ul>
<li>Example: <code>INFO moltis_gateway::chat: tool execution succeeded tool=browser</code></li>
</ul>
</li>
<li>
<p><strong>Contributor docs: local validation</strong>: Added documentation for the <code>./scripts/local-validate.sh</code> workflow, including published local status contexts, platform behavior, and CI fallback expectations.</p>
</li>
<li>
<p><strong>Hooks Web UI</strong>: New <code>/hooks</code> page to manage lifecycle hooks from the browser</p>
<ul>
<li>View all discovered hooks with eligibility status, source, and events</li>
<li>Enable/disable hooks without removing files (persisted across restarts)</li>
<li>Edit HOOK.md content in a monospace textarea and save back to disk</li>
<li>Reload hooks at runtime to pick up changes without restarting</li>
<li>Live stats (call count, failures, avg latency) from the hook registry</li>
<li>WebSocket-driven auto-refresh via <code>hooks.status</code> event</li>
<li>RPC methods: <code>hooks.list</code>, <code>hooks.enable</code>, <code>hooks.disable</code>, <code>hooks.save</code>, <code>hooks.reload</code></li>
</ul>
</li>
<li>
<p><strong>Deploy platform detection</strong>: New <code>MOLTIS_DEPLOY_PLATFORM</code> env var hides local-only providers (local-llm, Ollama) on cloud deployments. Pre-configured in Fly.io, DigitalOcean, and Render deploy templates.</p>
</li>
<li>
<p><strong>Telegram OTP self-approval</strong>: Non-allowlisted DM users receive a 6-digit verification code instead of being silently ignored. Correct code entry auto-approves the user to the allowlist. Includes flood protection (non-code messages silently ignored), lockout after 3 failed attempts (configurable cooldown), and 5-minute code expiry. OTP codes visible in web UI Senders tab. Controlled by <code>otp_self_approval</code> (default: true) and <code>otp_cooldown_secs</code> (default: 300) config fields.</p>
</li>
<li>
<p><strong>Update availability banner</strong>: The web UI now checks GitHub releases hourly and shows a top banner when a newer version of moltis is available, with a direct link to the release page.</p>
</li>
</ul>
<h3 id="changed-28"><a class="header" href="#changed-28">Changed</a></h3>
<ul>
<li><strong>Documentation safety notice</strong>: Added an upfront alpha-software warning on the docs landing page, emphasizing careful deployment, isolation, and strong auth/network controls for self-hosted AI assistants.</li>
<li><strong>Release packaging</strong>: Derive release artifact versions from the Git tag (<code>vX.Y.Z</code>) in CI, and sync package metadata during release jobs to prevent filename/version drift.</li>
<li><strong>Versioning</strong>: Bump workspace and snap baseline version to <code>0.2.0</code>.</li>
<li><strong>Onboarding auth flow</strong>: Route first-run setup directly into <code>/onboarding</code> and remove the separate <code>/setup</code> web UI page.</li>
<li><strong>Startup observability</strong>: Log each loaded context markdown (<code>CLAUDE.md</code> / <code>AGENTS.md</code> / <code>.claude/rules/*.md</code>), memory markdown (<code>MEMORY.md</code> and <code>memory/*.md</code>), and discovered <code>SKILL.md</code> to make startup/context loading easier to audit.</li>
<li><strong>Workspace root pathing</strong>: Standardize workspace-scoped file discovery/loading on <code>moltis_config::data_dir()</code> instead of process cwd (affects BOOT.md, hook discovery, skill discovery, and compaction memory output paths).</li>
<li><strong>Soul storage</strong>: Move agent personality text out of <code>moltis.toml</code> into workspace <code>SOUL.md</code>; identity APIs/UI still edit soul, but now persist it as a markdown file.</li>
<li><strong>Identity storage</strong>: Persist agent identity fields (<code>name</code>, <code>emoji</code>, <code>creature</code>, <code>vibe</code>) to workspace <code>IDENTITY.md</code> using YAML frontmatter; settings UI continues to edit these fields through the same RPC/API.</li>
<li><strong>User profile storage</strong>: Persist user profile fields (<code>name</code>, <code>timezone</code>) to workspace <code>USER.md</code> using YAML frontmatter; onboarding/settings continue to use the same API/UI while reading/writing the markdown file.</li>
<li><strong>Workspace markdown support</strong>: Add <code>TOOLS.md</code> prompt injection from workspace root (<code>data_dir</code>), and keep startup injection sourced from <code>BOOT.md</code>.</li>
<li><strong>Heartbeat prompt precedence</strong>: Support workspace <code>HEARTBEAT.md</code> as heartbeat prompt source with precedence <code>heartbeat.prompt</code> (config override) â†’ <code>HEARTBEAT.md</code> â†’ built-in default; log when config prompt overrides <code>HEARTBEAT.md</code>.</li>
<li><strong>Heartbeat UX</strong>: Expose effective heartbeat prompt source (<code>config</code>, <code>HEARTBEAT.md</code>, or default) via <code>heartbeat.status</code> and display it in the Heartbeat settings UI.</li>
<li><strong>BOOT.md onboarding aid</strong>: Seed a default workspace <code>BOOT.md</code> with in-file guidance describing startup injection behavior and recommended usage.</li>
<li><strong>Workspace context parity</strong>: Treat workspace <code>TOOLS.md</code> as general context (not only policy) and add workspace <code>AGENTS.md</code> injection support from <code>data_dir</code>.</li>
<li><strong>Heartbeat token guard</strong>: Skip heartbeat LLM turns when <code>HEARTBEAT.md</code> exists but is empty/comment-only and there is no explicit <code>heartbeat.prompt</code> override, reducing unnecessary token consumption.</li>
<li><strong>Exec approval policy wiring</strong>: Gateway now initializes exec approval mode/security level/allowlist from <code>moltis.toml</code> (<code>tools.exec.*</code>) instead of always using hardcoded defaults.</li>
<li><strong>Runtime tool enforcement</strong>: Chat runs now apply configured tool policy (<code>tools.policy</code>) and skill <code>allowed_tools</code> constraints when selecting callable tools.</li>
<li><strong>Skill trust lifecycle</strong>: Installed marketplace skills/plugins now track a <code>trusted</code> state and must be trusted before they can be enabled; the skills UI now surfaces untrusted status and supports trust-before-enable.</li>
<li><strong>Git metadata via gitoxide</strong>: Gateway now resolves branch names, repo HEAD SHAs, and commit timestamps using <code>gix</code> (gitoxide) instead of shelling out to <code>git</code> for those read-only operations.</li>
</ul>
<h3 id="fixed-39"><a class="header" href="#fixed-39">Fixed</a></h3>
<ul>
<li><strong>OAuth callback on hosted deployments</strong>: OpenAI Codex OAuth now uses the web app origin callback (<code>/auth/callback</code>) in the UI flow instead of hardcoded localhost loopback, allowing DigitalOcean/Fly/Render deployments to complete OAuth successfully.</li>
<li><strong>Sandbox startup on hosted Docker environments</strong>: Skip sandbox image pre-build when sandbox mode is off, and require Docker daemon accessibility (not just Docker CLI presence) before selecting the Docker sandbox backend.</li>
<li><strong>Homebrew release automation</strong>: Run the tap update in the release workflow after all package/image jobs complete so formula publishing does not race missing tarball assets.</li>
<li><strong>Docker runtime</strong>: Install <code>libgomp1</code> in the runtime image to satisfy OpenMP-linked binaries and prevent startup failures with <code>libgomp.so.1</code> missing.</li>
<li><strong>Release CI validation</strong>: Add a Docker smoke test step (<code>moltis --help</code>) after image build/push so missing runtime libraries fail in CI before release.</li>
<li><strong>Web onboarding clarity</strong>: Add setup-code guidance that points users to the process log (stdout).</li>
<li><strong>WebSocket auth (remote deployments)</strong>: Accept existing session/API-key auth from WebSocket upgrade headers so browser connections donâ€™t immediately close after <code>connect</code> on hosted setups.</li>
<li><strong>Sandbox UX on unsupported hosts</strong>: Disable sandbox controls in chat/images when no runtime backend is detected, with a tooltip explaining cloud deploy limitations.</li>
<li><strong>Telegram OTP code echoed to LLM</strong>: After OTP self-approval, the verification code message was re-processed as a regular chat message because <code>sender_approve</code> restarted the bot polling loop (resetting the Telegram update offset). Sender approve/deny now hot-update the in-memory config without restarting the bot.</li>
<li><strong>Empty allowlist bypassed access control</strong>: When <code>dm_policy = Allowlist</code> and all entries were removed, the empty list was treated as â€œallow everyoneâ€ instead of â€œdeny everyoneâ€. An explicit Allowlist policy with an empty list now correctly denies all access.</li>
<li><strong>Browser sandbox timeout</strong>: Sandboxed browsers now use the configured
<code>navigation_timeout_ms</code> (default 30s) instead of a shorter internal timeout.
Previously, sandboxed browser connections could time out prematurely.</li>
<li><strong>Tall screenshot lightbox</strong>: Full-page screenshots now display at proper size
with vertical scrolling instead of being scaled down to fit the viewport.</li>
<li><strong>Telegram typing indicator for long responses</strong>: Channel replies now wait for outbound delivery tasks to finish before chat completion returns, so periodic <code>typing...</code> updates continue until the Telegram message is actually sent.</li>
<li><strong>Skills dependency install safety</strong>: <code>skills.install_dep</code> now requires explicit user confirmation and blocks host installs when sandbox mode is disabled (unless explicitly overridden in the RPC call).</li>
</ul>
<h3 id="security-19"><a class="header" href="#security-19">Security</a></h3>
<ul>
<li><strong>Asset response hardening</strong>: Static assets now set <code>X-Content-Type-Options: nosniff</code>, and SVG responses include a restrictive <code>Content-Security-Policy</code> (<code>script-src 'none'</code>, <code>object-src 'none'</code>) to reduce stored-XSS risk if user-controlled SVGs are ever introduced.</li>
<li><strong>Archive extraction hardening</strong>: Skills/plugin tarball installs now reject unsafe archive paths (<code>..</code>, absolute/path-prefix escapes) and reject symlink/hardlink archive entries to prevent path traversal and link-based escapes.</li>
<li><strong>Install provenance</strong>: Installed skill/plugin repo manifests now persist a pinned <code>commit_sha</code> (resolved from clone or API fallback) for future trust drift detection.</li>
<li><strong>Re-trust on source drift</strong>: If an installed git-backed repoâ€™s HEAD commit changes from the pinned <code>commit_sha</code>, the gateway now marks its skills untrusted+disabled and requires trust again before re-enabling; the UI surfaces this as <code>source changed</code>.</li>
<li><strong>Security audit trail</strong>: Skill/plugin install, remove, trust, enable/disable, dependency install, and source-drift events are now appended to <code>~/.moltis/logs/security-audit.jsonl</code> for incident review.</li>
<li><strong>Emergency kill switch</strong>: Added <code>skills.emergency_disable</code> to immediately disable all installed third-party skills and plugins; exposed in the Skills UI as a one-click emergency action.</li>
<li><strong>Risky dependency install blocking</strong>: <code>skills.install_dep</code> now blocks suspicious install command patterns by default (e.g. piped shell payloads, base64 decode chains, quarantine bypass) unless explicitly overridden with <code>allow_risky_install=true</code>.</li>
<li><strong>Provenance visibility</strong>: Skills UI now displays pinned install commit SHA in repo and detail views to make source provenance easier to verify.</li>
<li><strong>Recent-commit risk warnings</strong>: Skill/plugin detail views now include commit links and commit-age indicators, with a prominent warning banner when the pinned commit is very recent.</li>
<li><strong>Installer subprocess reduction</strong>: Skills/plugins install paths now avoid <code>git</code> subprocess clone attempts and use GitHub tarball installs with pinned commit metadata.</li>
<li><strong>Install resilience for rapid multi-repo installs</strong>: Skills/plugins install now auto-clean stale on-disk directories that are missing from manifest state, and tar extraction skips link entries instead of failing the whole install.</li>
<li><strong>Orphaned repo visibility</strong>: Skills/plugins repo listing now surfaces manifest-missing directories found on disk as <code>orphaned</code> entries and allows removing them from the UI.</li>
<li><strong>Protected seed skills</strong>: Discovered template skills (<code>template-skill</code> / <code>template</code>) are now marked protected and cannot be deleted from the web UI.</li>
<li><strong>License review links</strong>: Skill/plugin license badges now link directly to repository license files when detectable (e.g. <code>LICENSE.txt</code>, <code>LICENSE.md</code>, <code>LICENSE</code>).</li>
<li><strong>Example skill seeding</strong>: Gateway now seeds <code>~/.moltis/skills/template-skill/SKILL.md</code> on startup when missing, so users always have a starter personal skill template.</li>
<li><strong>Memory indexing scope tightened</strong>: Memory sync now indexes only <code>MEMORY.md</code> / <code>memory.md</code> and <code>memory/</code> content by default (instead of scanning the entire data root), reducing irrelevant indexing noise from installed skills/plugins.</li>
<li><strong>Ollama embedding bootstrap</strong>: When using Ollama for memory embeddings, gateway now auto-attempts to pull missing embedding models (default <code>nomic-embed-text</code>) via Ollama HTTP API.</li>
</ul>
<h3 id="documentation-3"><a class="header" href="#documentation-3">Documentation</a></h3>
<ul>
<li>Added <code>docs/src/skills-security.md</code> with third-party skills/plugin hardening guidance (trust lifecycle, provenance pinning, source-drift re-trust, risky install guards, emergency disable, and security audit logging).</li>
</ul>
<h2 id="0110---2026-02-06"><a class="header" href="#0110---2026-02-06">[0.1.10] - 2026-02-06</a></h2>
<h3 id="changed-29"><a class="header" href="#changed-29">Changed</a></h3>
<ul>
<li><strong>CI builds</strong>: Build Docker images natively per architecture instead of QEMU emulation, then merge into multi-arch manifest</li>
</ul>
<h2 id="019---2026-02-06"><a class="header" href="#019---2026-02-06">[0.1.9] - 2026-02-06</a></h2>
<h3 id="changed-30"><a class="header" href="#changed-30">Changed</a></h3>
<ul>
<li><strong>CI builds</strong>: Migrate all release build jobs from self-hosted to GitHub-hosted runners for full parallelism (<code>ubuntu-latest</code>, <code>ubuntu-latest-arm</code>, <code>macos-latest</code>), remove all cross-compilation toolchain steps</li>
</ul>
<h2 id="018---2026-02-06"><a class="header" href="#018---2026-02-06">[0.1.8] - 2026-02-06</a></h2>
<h3 id="fixed-40"><a class="header" href="#fixed-40">Fixed</a></h3>
<ul>
<li><strong>CI builds</strong>: Fix corrupted cargo config on all self-hosted runner jobs, fix macOS runner label, add llama-cpp build deps to Docker and Snap builds</li>
</ul>
<h2 id="017---2026-02-06"><a class="header" href="#017---2026-02-06">[0.1.7] - 2026-02-06</a></h2>
<h3 id="fixed-41"><a class="header" href="#fixed-41">Fixed</a></h3>
<ul>
<li><strong>CI builds</strong>: Use project-local <code>.cargo/config.toml</code> for cross-compilation instead of appending to global config (fixes duplicate key errors on self-hosted runners)</li>
</ul>
<h2 id="016---2026-02-06"><a class="header" href="#016---2026-02-06">[0.1.6] - 2026-02-06</a></h2>
<h3 id="fixed-42"><a class="header" href="#fixed-42">Fixed</a></h3>
<ul>
<li><strong>CI builds</strong>: Use macOS GitHub-hosted runners for apple-darwin binary builds instead of cross-compiling from Linux</li>
<li><strong>CI performance</strong>: Run lightweight lint jobs (zizmor, biome, fmt) on GitHub-hosted runners to free up self-hosted runners</li>
</ul>
<h2 id="015---2026-02-06"><a class="header" href="#015---2026-02-06">[0.1.5] - 2026-02-06</a></h2>
<h3 id="fixed-43"><a class="header" href="#fixed-43">Fixed</a></h3>
<ul>
<li><strong>CI security</strong>: Use GitHub-hosted runners for PRs to prevent untrusted code from running on self-hosted infrastructure</li>
<li><strong>CI security</strong>: Add <code>persist-credentials: false</code> to docs workflow checkout (fixes zizmor artipacked warning)</li>
</ul>
<h2 id="014---2026-02-06"><a class="header" href="#014---2026-02-06">[0.1.4] - 2026-02-06</a></h2>
<h3 id="added-25"><a class="header" href="#added-25">Added</a></h3>
<ul>
<li>
<p><strong><code>--no-tls</code> CLI flag</strong>: <code>--no-tls</code> flag and <code>MOLTIS_NO_TLS</code> environment variable to disable
TLS for cloud deployments where the provider handles TLS termination</p>
</li>
<li>
<p><strong>One-click cloud deploy</strong>: Deploy configs for Fly.io (<code>fly.toml</code>), DigitalOcean
(<code>.do/deploy.template.yaml</code>), Render (<code>render.yaml</code>), and Railway (<code>railway.json</code>)
with deploy buttons in the README</p>
</li>
<li>
<p><strong>Config Check Command</strong>: <code>moltis config check</code> validates the configuration file, detects unknown/misspelled fields with Levenshtein-based suggestions, warns about security misconfigurations, and checks file references</p>
</li>
<li>
<p><strong>Memory Usage Indicator</strong>: Display process RSS and system free memory in the header bar, updated every 30 seconds via the tick WebSocket broadcast</p>
</li>
<li>
<p><strong>QMD Backend Support</strong>: Optional QMD (Query Memory Daemon) backend for hybrid search with BM25 + vector + LLM reranking</p>
<ul>
<li>Gated behind <code>qmd</code> feature flag (enabled by default)</li>
<li>Web UI shows installation instructions and QMD status</li>
<li>Comparison table between built-in SQLite and QMD backends</li>
</ul>
</li>
<li>
<p><strong>Citations</strong>: Configurable citation mode (on/off/auto) for memory search results</p>
<ul>
<li>Auto mode includes citations when results span multiple files</li>
</ul>
</li>
<li>
<p><strong>Session Export</strong>: Option to export session transcripts to memory for future reference</p>
</li>
<li>
<p><strong>LLM Reranking</strong>: Use LLM to rerank search results for improved relevance (requires QMD)</p>
</li>
<li>
<p><strong>Memory Documentation</strong>: Added <code>docs/src/memory.md</code> with comprehensive memory system documentation</p>
</li>
<li>
<p><strong>Mobile PWA Support</strong>: Install moltis as a Progressive Web App on iOS, Android, and desktop</p>
<ul>
<li>Standalone mode with full-screen experience</li>
<li>Custom app icon (crab mascot)</li>
<li>Service worker for offline support and caching</li>
<li>Safe area support for notched devices</li>
</ul>
</li>
<li>
<p><strong>Push Notifications</strong>: Receive alerts when the LLM responds</p>
<ul>
<li>VAPID key generation and storage for Web Push API</li>
<li>Subscribe/unsubscribe toggle in Settings &gt; Notifications</li>
<li>Subscription management UI showing device name, IP address, and date</li>
<li>Remove any subscription from any device</li>
<li>Real-time subscription updates via WebSocket</li>
<li>Client IP detection from X-Forwarded-For, X-Real-IP, CF-Connecting-IP headers</li>
<li>Notifications sent for both streaming and agent (tool-using) chat modes</li>
</ul>
</li>
<li>
<p><strong>Safari/iOS PWA Detection</strong>: Show â€œAdd to Dockâ€ instructions when push notifications
require PWA installation (Safari doesnâ€™t support push in browser mode)</p>
</li>
<li>
<p><strong>Browser Screenshot Thumbnails</strong>: Screenshots from the browser tool now display as
clickable thumbnails in the chat UI</p>
<ul>
<li>Click to view fullscreen in a lightbox overlay</li>
<li>Press Escape or click anywhere to close</li>
<li>Thumbnails are 200Ã—150px max with hover effects</li>
</ul>
</li>
<li>
<p><strong>Improved Browser Detection</strong>: Better cross-platform browser detection</p>
<ul>
<li>Checks macOS app bundles before PATH (avoids broken Homebrew chromium wrapper)</li>
<li>Supports Chrome, Chromium, Edge, Brave, Opera, Vivaldi, Arc</li>
<li>Shows platform-specific installation instructions when no browser found</li>
<li>Custom path via <code>chrome_path</code> config or <code>CHROME</code> environment variable</li>
</ul>
</li>
<li>
<p><strong>Vision Support for Screenshots</strong>: Vision-capable models can now interpret
browser screenshots instead of having them stripped from context</p>
<ul>
<li>Screenshots sent as multimodal image content blocks for GPT-4o, Claude, Gemini</li>
<li>Non-vision models continue to receive <code>[base64 data removed]</code> placeholder</li>
<li><code>supports_vision()</code> trait method added to <code>LlmProvider</code> for capability detection</li>
</ul>
</li>
<li>
<p><strong>Session state store</strong>: per-session key-value persistence scoped by
namespace, backed by SQLite (<code>session_state</code> tool).</p>
</li>
<li>
<p><strong>Session branching</strong>: <code>branch_session</code> tool forks a conversation at any
message index into an independent copy.</p>
</li>
<li>
<p><strong>Session fork from UI</strong>: Fork button in the chat header and sidebar action
buttons let users fork sessions without asking the LLM. Forked sessions
appear indented under their parent with a branch icon.</p>
</li>
<li>
<p><strong>Skill self-extension</strong>: <code>create_skill</code>, <code>update_skill</code>, <code>delete_skill</code>
tools let the agent manage project-local skills at runtime.</p>
</li>
<li>
<p><strong>Skill hot-reload</strong>: filesystem watcher on skill directories emits
<code>skills.changed</code> events via WebSocket when SKILL.md files change.</p>
</li>
<li>
<p><strong>Typed tool sources</strong>: <code>ToolSource</code> enum (<code>Builtin</code> / <code>Mcp { server }</code>)
replaces string-prefix identification of MCP tools in the tool registry.</p>
</li>
<li>
<p><strong>Tool registry metadata</strong>: <code>list_schemas()</code> now includes <code>source</code> and
<code>mcpServer</code> fields so the UI can group tools by origin.</p>
</li>
<li>
<p><strong>Per-session MCP toggle</strong>: sessions store an <code>mcp_disabled</code> flag; the chat
header exposes a toggle button to enable/disable MCP tools per session.</p>
</li>
<li>
<p><strong>Debug panel convergence</strong>: the debug side-panel now renders the same seven
sections as the <code>/context</code> slash command, eliminating duplicated rendering
logic.</p>
</li>
<li>
<p>Documentation pages for session state, session branching, skill
self-extension, and the tool registry architecture.</p>
</li>
</ul>
<h3 id="changed-31"><a class="header" href="#changed-31">Changed</a></h3>
<ul>
<li>
<p>Memory settings UI enhanced with backend comparison and feature explanations</p>
</li>
<li>
<p>Added <code>memory.qmd.status</code> RPC method for checking QMD availability</p>
</li>
<li>
<p>Extended <code>memory.config.get</code> to include <code>qmd_feature_enabled</code> flag</p>
</li>
<li>
<p>Push notifications feature is now enabled by default in the CLI</p>
</li>
<li>
<p><strong>TLS HTTP redirect port</strong> now defaults to <code>gateway_port + 1</code> instead of
the hardcoded port <code>18790</code>. This makes the Dockerfile simpler (both ports
are adjacent) and avoids collisions when running multiple instances.
Override via <code>[tls] http_redirect_port</code> in <code>moltis.toml</code> or the
<code>MOLTIS_TLS__HTTP_REDIRECT_PORT</code> environment variable.</p>
</li>
<li>
<p><strong>TLS certificates use <code>moltis.localhost</code> domain.</strong> Auto-generated server
certs now include <code>moltis.localhost</code>, <code>*.moltis.localhost</code>, <code>localhost</code>,
<code>127.0.0.1</code>, and <code>::1</code> as SANs. Banner and redirect URLs use
<code>https://moltis.localhost:&lt;port&gt;</code> when bound to loopback, so the cert
matches the displayed URL. Existing certs are automatically regenerated
on next startup.</p>
</li>
<li>
<p><strong>Certificate validity uses dynamic dates.</strong> Cert <code>notBefore</code>/<code>notAfter</code>
are now computed from the current system time instead of being hardcoded.
CA certs are valid for 10 years, server certs for 1 year from generation.</p>
</li>
<li>
<p><code>McpToolBridge</code> now stores and exposes <code>server_name()</code> for typed
registration.</p>
</li>
<li>
<p><code>mcp_service::sync_mcp_tools()</code> uses <code>unregister_mcp()</code> /
<code>register_mcp()</code> instead of scanning tool names by prefix.</p>
</li>
<li>
<p><code>chat.rs</code> uses <code>clone_without_mcp()</code> instead of
<code>clone_without_prefix("mcp__")</code> in all three call sites.</p>
</li>
</ul>
<h3 id="fixed-44"><a class="header" href="#fixed-44">Fixed</a></h3>
<ul>
<li>Push notifications not sending when chat uses agent mode (run_with_tools)</li>
<li>Missing space in Safari install instructions (â€œusingFileâ€ â†’ â€œusing Fileâ€)</li>
<li><strong>WebSocket origin validation</strong> now treats <code>.localhost</code> subdomains
(e.g. <code>moltis.localhost</code>) as loopback equivalents per RFC 6761.</li>
<li><strong>Browser tool schema enforcement</strong>: Added <code>strict: true</code> and <code>additionalProperties: false</code>
to OpenAI-compatible tool schemas, improving model compliance with required fields</li>
<li><strong>Browser tool defaults</strong>: When model sends URL without action, defaults to <code>navigate</code>
instead of erroring</li>
<li><strong>Chat message ordering</strong>: Fixed interleaving of text and tool cards when streaming;
messages now appear in correct chronological order</li>
<li><strong>Tool passthrough in ProviderChain</strong>: Fixed tools not being passed to fallback
providers when using provider chains</li>
<li>Fork/branch icon in session sidebar now renders cleanly at 16px (replaced
complex git-branch SVG with simple trunk+branch path).</li>
<li>Deleting a forked session now navigates to the parent session instead of
an unrelated sibling.</li>
<li><strong>Streaming tool calls for non-Anthropic providers</strong>: <code>OpenAiProvider</code>,
<code>GitHubCopilotProvider</code>, <code>KimiCodeProvider</code>, <code>OpenAiCodexProvider</code>, and
<code>ProviderChain</code> now implement <code>stream_with_tools()</code> so tool schemas are
sent in the streaming API request and tool-call events are properly parsed.
Previously only <code>AnthropicProvider</code> supported streaming tool calls; all
other providers silently dropped the tools parameter, causing the LLM to
emit tool invocations as plain text instead of structured function calls.</li>
<li><strong>Streaming tool call arguments dropped when index â‰  0</strong>: When a provider
(e.g. GitHub Copilot proxying Claude) emits a text content block at
streaming index 0 and a tool_use block at index 1, the runnerâ€™s argument
finalization used the streaming index as the vector position directly.
Since <code>tool_calls</code> has only 1 element at position 0, the condition
<code>1 &lt; 1</code> was false and arguments were silently dropped (empty <code>{}</code>).
Fixed by mapping streaming indices to vector positions via a HashMap.</li>
<li><strong>Skill tools wrote to wrong directory</strong>: <code>create_skill</code>, <code>update_skill</code>, and
<code>delete_skill</code> used <code>std::env::current_dir()</code> captured at gateway startup,
writing skills to <code>&lt;cwd&gt;/.moltis/skills/</code> instead of <code>~/.moltis/skills/</code>.
Skills now write to <code>&lt;data_dir&gt;/skills/</code> (Personal source), which is always
discovered regardless of where the gateway was started.</li>
<li><strong>Skills page missing personal/project skills</strong>: The <code>/api/skills</code> endpoint
only returned manifest-based registry skills. Personal and project-local
skills were never shown in the navigation or skills page. The endpoint now
discovers and includes them alongside registry skills.</li>
</ul>
<h3 id="documentation-4"><a class="header" href="#documentation-4">Documentation</a></h3>
<ul>
<li>Added voice.md with TTS/STT provider documentation and setup guides</li>
<li>Added mobile-pwa.md with PWA installation and push notification documentation</li>
<li>Updated CLAUDE.md with cargo feature policy (features enabled by default)</li>
<li>Updated browser-automation.md with browser detection, screenshot display, and
model error handling sections</li>
<li>Rewrote session-branching.md with accurate fork details, UI methods, RPC
API, inheritance table, and deletion behavior.</li>
</ul>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->


                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">

            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="elasticlunr.min.js"></script>
        <script src="mark.min.js"></script>
        <script src="searcher.js"></script>

        <script src="clipboard.min.js"></script>
        <script src="highlight.js"></script>
        <script src="book.js"></script>

        <!-- Custom JS scripts -->

        <script>
        window.addEventListener('load', function() {
            window.setTimeout(window.print, 100);
        });
        </script>


    </div>
    </body>
</html>
