name: CI

on:
  push:
    branches: [main]
  pull_request:
  workflow_dispatch:
  schedule:
    - cron: "0 4 * * *"

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions: {}

env:
  CARGO_TERM_COLOR: always

jobs:
  local-validation:
    name: ${{ matrix.label }}
    if: ${{ github.event_name == 'pull_request' }}
    runs-on: ubuntu-latest
    permissions:
      contents: read
      statuses: read
    strategy:
      fail-fast: false
      matrix:
        include:
          - label: fmt
            context: local/fmt
          - label: biome
            context: local/biome
          - label: zizmor
            context: local/zizmor
          - label: clippy
            context: local/lint
          - label: test
            context: local/test
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4
        with:
          persist-credentials: false
      - name: Verify local status context
        env:
          GH_TOKEN: ${{ github.token }}
          REPO: ${{ github.repository }}
          PR_HEAD_SHA: ${{ github.event.pull_request.head.sha }}
          REQUIRED_CONTEXT: ${{ matrix.context }}
        run: python3 scripts/check-local-status.py

  zizmor:
    name: Workflow Security
    if: ${{ github.event_name != 'pull_request' }}
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4
        with:
          persist-credentials: false
      - uses: zizmorcore/zizmor-action@135698455da5c3b3e55f73f4419e481ab68cdd95 # v0.4.1
        with:
          advanced-security: false
          online-audits: false

  biome:
    name: Biome
    if: ${{ github.event_name != 'pull_request' }}
    needs: zizmor
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4
        with:
          persist-credentials: false
      - uses: biomejs/setup-biome@29711cbb52afee00eb13aeb30636592f9edc0088 # v2.7.0
        with:
          version: "2.3.13"
      - run: biome ci crates/gateway/src/assets/js/

  fmt:
    name: Format
    if: ${{ github.event_name != 'pull_request' }}
    needs: zizmor
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4
        with:
          persist-credentials: false
      - uses: dtolnay/rust-toolchain@f7ccc83f9ed1e5b9c81d8a67d7ad1a747e22a561 # master
        with:
          toolchain: nightly
          components: rustfmt
      - run: cargo fmt --all -- --check

  rust-ci:
    name: Rust CI (clippy + test)
    if: ${{ github.event_name != 'pull_request' }}
    needs: [fmt, biome]
    runs-on: [self-hosted, Linux, X64]
    permissions:
      contents: read
    container:
      image: nvidia/cuda:12.4.1-devel-ubuntu22.04
    env:
      RUSTC_WRAPPER: sccache
      SCCACHE_GHA_ENABLED: "true"
      SCCACHE_CACHE_SIZE: "5G"
      LD_LIBRARY_PATH: /usr/local/cuda/compat:/usr/local/nvidia/lib:/usr/local/nvidia/lib64
      CMAKE_C_COMPILER_LAUNCHER: sccache
      CMAKE_CXX_COMPILER_LAUNCHER: sccache
      CMAKE_CUDA_COMPILER_LAUNCHER: sccache
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4
        with:
          persist-credentials: false
      - name: Clean up corrupted cargo config
        run: rm -f ~/.cargo/config.toml
      - name: Install build dependencies
        run: |
          apt-get update
          apt-get install -y curl git cmake build-essential clang libclang-dev pkg-config ca-certificates
          nvcc --version
      - uses: dtolnay/rust-toolchain@f7ccc83f9ed1e5b9c81d8a67d7ad1a747e22a561 # master
        with:
          toolchain: nightly
          components: clippy
      - uses: mozilla-actions/sccache-action@65101d47ea8028ed0c98a1cdea8dd9182e9b5133 # v0.0.8
      - uses: Swatinem/rust-cache@779680da715d629ac1d338a641029a2f4372abb5 # v2
        with:
          shared-key: rust-ci-cuda-v1
          cache-all-crates: true
      - name: Initialize git repo in llama-cpp source to satisfy cmake
        run: |
          cargo fetch --locked
          LLAMA_SRC=$(find ~/.cargo/registry/src -name "llama-cpp-sys-2-*" -type d 2>/dev/null | head -1)
          if [ -n "$LLAMA_SRC" ] && [ ! -d "$LLAMA_SRC/.git" ]; then
            cd "$LLAMA_SRC"
            git init
            git config user.email "ci@example.com"
            git config user.name "CI"
            git add -A
            git commit -m "init" --allow-empty
            git tag v0.0.0
          fi
      - run: cargo clippy -Z unstable-options --workspace --all-features --timings -- -D warnings
      - run: cargo test -Z unstable-options --all-features --timings
      - name: Upload cargo timing reports
        if: always()
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4
        with:
          name: cargo-timings-rust-ci-${{ github.run_id }}-${{ github.run_attempt }}
          path: target/cargo-timings/
          if-no-files-found: ignore
      - name: Show sccache stats
        if: always()
        run: sccache --show-stats

  rust-full-targets:
    name: Rust Full Targets (scheduled)
    if: ${{ github.event_name == 'schedule' || github.event_name == 'workflow_dispatch' }}
    continue-on-error: true
    needs: [fmt, biome]
    runs-on: [self-hosted, Linux, X64]
    permissions:
      contents: read
    container:
      image: nvidia/cuda:12.4.1-devel-ubuntu22.04
    env:
      RUSTC_WRAPPER: sccache
      SCCACHE_GHA_ENABLED: "true"
      SCCACHE_CACHE_SIZE: "5G"
      LD_LIBRARY_PATH: /usr/local/cuda/compat:/usr/local/nvidia/lib:/usr/local/nvidia/lib64
      CMAKE_C_COMPILER_LAUNCHER: sccache
      CMAKE_CXX_COMPILER_LAUNCHER: sccache
      CMAKE_CUDA_COMPILER_LAUNCHER: sccache
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4
        with:
          persist-credentials: false
      - name: Clean up corrupted cargo config
        run: rm -f ~/.cargo/config.toml
      - name: Install build dependencies
        run: |
          apt-get update
          apt-get install -y curl git cmake build-essential clang libclang-dev pkg-config ca-certificates
          nvcc --version
      - uses: dtolnay/rust-toolchain@f7ccc83f9ed1e5b9c81d8a67d7ad1a747e22a561 # master
        with:
          toolchain: nightly
          components: clippy
      - uses: mozilla-actions/sccache-action@65101d47ea8028ed0c98a1cdea8dd9182e9b5133 # v0.0.8
      - uses: Swatinem/rust-cache@779680da715d629ac1d338a641029a2f4372abb5 # v2
        with:
          shared-key: rust-ci-cuda-v1
          cache-all-crates: true
      - name: Initialize git repo in llama-cpp source to satisfy cmake
        run: |
          cargo fetch --locked
          LLAMA_SRC=$(find ~/.cargo/registry/src -name "llama-cpp-sys-2-*" -type d 2>/dev/null | head -1)
          if [ -n "$LLAMA_SRC" ] && [ ! -d "$LLAMA_SRC/.git" ]; then
            cd "$LLAMA_SRC"
            git init
            git config user.email "ci@example.com"
            git config user.name "CI"
            git add -A
            git commit -m "init" --allow-empty
            git tag v0.0.0
          fi
      - run: cargo clippy -Z unstable-options --all-features --all-targets --timings -- -D warnings
      - name: Upload cargo timing reports
        if: always()
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4
        with:
          name: cargo-timings-rust-full-targets-${{ github.run_id }}-${{ github.run_attempt }}
          path: target/cargo-timings/
          if-no-files-found: ignore
      - name: Show sccache stats
        if: always()
        run: sccache --show-stats
