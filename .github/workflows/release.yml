name: Build Packages

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions: {}

jobs:
  zizmor:
    name: Workflow Security
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4
        with:
          persist-credentials: false

      - uses: zizmorcore/zizmor-action@135698455da5c3b3e55f73f4419e481ab68cdd95 # v0.4.1
        with:
          advanced-security: false
          online-audits: false

  biome:
    needs: zizmor
    runs-on: ubuntu-latest
    name: Biome
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4
        with:
          persist-credentials: false
      - uses: biomejs/setup-biome@29711cbb52afee00eb13aeb30636592f9edc0088 # v2.7.0
        with:
          version: "2.3.13"
      - run: biome ci crates/gateway/src/assets/js/

  fmt:
    needs: zizmor
    runs-on: ubuntu-latest
    name: Format
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4
        with:
          persist-credentials: false
      - uses: dtolnay/rust-toolchain@f7ccc83f9ed1e5b9c81d8a67d7ad1a747e22a561 # master
        with:
          toolchain: nightly
          components: rustfmt
      - run: cargo fmt --all -- --check

  clippy:
    needs: [fmt, biome]
    runs-on: ubuntu-latest
    name: Clippy
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4
        with:
          persist-credentials: false
      - uses: dtolnay/rust-toolchain@f7ccc83f9ed1e5b9c81d8a67d7ad1a747e22a561 # master
        with:
          toolchain: nightly
          components: clippy
      - run: cargo clippy --workspace --all-targets -- -D warnings

  test:
    needs: [fmt, biome]
    runs-on: ubuntu-latest
    name: Test
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4
        with:
          persist-credentials: false
      - uses: dtolnay/rust-toolchain@f7ccc83f9ed1e5b9c81d8a67d7ad1a747e22a561 # master
        with:
          toolchain: stable
      - run: cargo test

  build-deb:
    needs: [clippy, test]
    strategy:
      matrix:
        include:
          - target: x86_64-unknown-linux-gnu
            arch: amd64
            os: ubuntu-latest
          - target: aarch64-unknown-linux-gnu
            arch: arm64
            os: ubuntu-24.04-arm

    runs-on: ${{ matrix.os }}
    name: Build .deb (${{ matrix.arch }})
    permissions:
      contents: write
      id-token: write # Required for Sigstore keyless signing

    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4
        with:
          persist-credentials: false

      - name: Resolve release version
        id: release_version
        run: |
          if [[ "$GITHUB_REF" == refs/tags/v* ]]; then
            VERSION="${GITHUB_REF#refs/tags/v}"
          else
            VERSION=$(grep '^version' Cargo.toml | head -1 | sed 's/.*"\(.*\)"/\1/')
          fi
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"

      - name: Sync Cargo workspace version to release version
        env:
          VERSION: ${{ steps.release_version.outputs.version }}
        run: sed -Ei "s/^version[[:space:]]*=.*/version    = \"${VERSION}\"/" Cargo.toml

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@f7ccc83f9ed1e5b9c81d8a67d7ad1a747e22a561 # master
        with:
          toolchain: stable
          targets: ${{ matrix.target }}

      - name: Install cargo-deb
        run: cargo install cargo-deb

      - name: Install cosign
        uses: sigstore/cosign-installer@d7d6bc7722e3daa8354c50bcb52f4837da5e9b6a # v3.8.1

      - name: Build release binary
        env:
          BUILD_TARGET: ${{ matrix.target }}
        run: cargo build --release --target "$BUILD_TARGET"

      - name: Build .deb package
        env:
          BUILD_TARGET: ${{ matrix.target }}
        run: cargo deb -p moltis --no-build --target "$BUILD_TARGET"

      - name: Sign with Sigstore and generate checksums
        uses: ./.github/actions/sign-artifacts
        with:
          files: '*.deb'
          working-directory: target/${{ matrix.target }}/debian

      - name: Upload .deb artifact
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4
        with:
          name: moltis-${{ matrix.arch }}.deb
          path: |
            target/${{ matrix.target }}/debian/*.deb
            target/${{ matrix.target }}/debian/*.sha256
            target/${{ matrix.target }}/debian/*.sha512
            target/${{ matrix.target }}/debian/*.sig
            target/${{ matrix.target }}/debian/*.crt

      - name: Upload to release
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@a06a81a03ee405af7f2048a818ed3f03bbf83c7b # v2
        with:
          files: |
            target/${{ matrix.target }}/debian/*.deb
            target/${{ matrix.target }}/debian/*.sha256
            target/${{ matrix.target }}/debian/*.sha512
            target/${{ matrix.target }}/debian/*.sig
            target/${{ matrix.target }}/debian/*.crt

  build-rpm:
    needs: [clippy, test]
    strategy:
      matrix:
        include:
          - target: x86_64-unknown-linux-gnu
            arch: x86_64
            os: ubuntu-latest
          - target: aarch64-unknown-linux-gnu
            arch: aarch64
            os: ubuntu-24.04-arm

    runs-on: ${{ matrix.os }}
    name: Build .rpm (${{ matrix.arch }})
    permissions:
      contents: write
      id-token: write # Required for Sigstore keyless signing

    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4
        with:
          persist-credentials: false

      - name: Resolve release version
        id: release_version
        run: |
          if [[ "$GITHUB_REF" == refs/tags/v* ]]; then
            VERSION="${GITHUB_REF#refs/tags/v}"
          else
            VERSION=$(grep '^version' Cargo.toml | head -1 | sed 's/.*"\(.*\)"/\1/')
          fi
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"

      - name: Sync Cargo workspace version to release version
        env:
          VERSION: ${{ steps.release_version.outputs.version }}
        run: sed -Ei "s/^version[[:space:]]*=.*/version    = \"${VERSION}\"/" Cargo.toml

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@f7ccc83f9ed1e5b9c81d8a67d7ad1a747e22a561 # master
        with:
          toolchain: stable
          targets: ${{ matrix.target }}

      - name: Install cargo-generate-rpm
        run: cargo install cargo-generate-rpm

      - name: Install cosign
        uses: sigstore/cosign-installer@d7d6bc7722e3daa8354c50bcb52f4837da5e9b6a # v3.8.1

      - name: Build release binary
        env:
          BUILD_TARGET: ${{ matrix.target }}
        run: cargo build --release --target "$BUILD_TARGET"

      - name: Strip binary
        env:
          BUILD_TARGET: ${{ matrix.target }}
        run: strip "target/$BUILD_TARGET/release/moltis"

      - name: Build .rpm package
        env:
          BUILD_TARGET: ${{ matrix.target }}
        run: cargo generate-rpm -p crates/cli --target "$BUILD_TARGET"

      - name: Sign with Sigstore and generate checksums
        uses: ./.github/actions/sign-artifacts
        with:
          files: '*.rpm'
          working-directory: target/${{ matrix.target }}/generate-rpm

      - name: Upload .rpm artifact
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4
        with:
          name: moltis-${{ matrix.arch }}.rpm
          path: |
            target/${{ matrix.target }}/generate-rpm/*.rpm
            target/${{ matrix.target }}/generate-rpm/*.sha256
            target/${{ matrix.target }}/generate-rpm/*.sha512
            target/${{ matrix.target }}/generate-rpm/*.sig
            target/${{ matrix.target }}/generate-rpm/*.crt

      - name: Upload to release
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@a06a81a03ee405af7f2048a818ed3f03bbf83c7b # v2
        with:
          files: |
            target/${{ matrix.target }}/generate-rpm/*.rpm
            target/${{ matrix.target }}/generate-rpm/*.sha256
            target/${{ matrix.target }}/generate-rpm/*.sha512
            target/${{ matrix.target }}/generate-rpm/*.sig
            target/${{ matrix.target }}/generate-rpm/*.crt

  build-arch:
    needs: [clippy, test]
    strategy:
      matrix:
        include:
          - target: x86_64-unknown-linux-gnu
            arch: x86_64
            os: ubuntu-latest
          - target: aarch64-unknown-linux-gnu
            arch: aarch64
            os: ubuntu-24.04-arm

    runs-on: ${{ matrix.os }}
    name: Build .pkg.tar.zst (${{ matrix.arch }})
    permissions:
      contents: write
      id-token: write # Required for Sigstore keyless signing

    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4
        with:
          persist-credentials: false

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@f7ccc83f9ed1e5b9c81d8a67d7ad1a747e22a561 # master
        with:
          toolchain: stable
          targets: ${{ matrix.target }}

      - name: Install packaging tools
        run: sudo apt-get update && sudo apt-get install -y fakeroot zstd

      - name: Install cosign
        uses: sigstore/cosign-installer@d7d6bc7722e3daa8354c50bcb52f4837da5e9b6a # v3.8.1

      - name: Build release binary
        env:
          BUILD_TARGET: ${{ matrix.target }}
        run: cargo build --release --target "$BUILD_TARGET"

      - name: Determine package version
        id: version
        run: |
          if [[ "$GITHUB_REF" == refs/tags/v* ]]; then
            VERSION="${GITHUB_REF#refs/tags/v}"
          else
            VERSION=$(grep '^version' Cargo.toml | head -1 | sed 's/.*"\(.*\)"/\1/')
          fi
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"

      - name: Build .pkg.tar.zst
        env:
          VERSION: ${{ steps.version.outputs.version }}
          BUILD_TARGET: ${{ matrix.target }}
          MATRIX_ARCH: ${{ matrix.arch }}
        run: |
          PKG_DIR="pkg-root"
          mkdir -p "$PKG_DIR/usr/bin"
          cp "target/$BUILD_TARGET/release/moltis" "$PKG_DIR/usr/bin/moltis"
          chmod 755 "$PKG_DIR/usr/bin/moltis"

          cat > "$PKG_DIR/.PKGINFO" <<PKGINFO
          pkgname = moltis
          pkgver = ${VERSION}-1
          pkgdesc = Personal AI gateway inspired by OpenClaw
          url = https://www.moltis.org/
          arch = $MATRIX_ARCH
          license = MIT
          PKGINFO

          cd "$PKG_DIR"
          fakeroot -- tar --zstd -cf "../moltis-${VERSION}-1-${MATRIX_ARCH}.pkg.tar.zst" .PKGINFO usr/

      - name: Sign with Sigstore and generate checksums
        uses: ./.github/actions/sign-artifacts
        with:
          files: moltis-${{ steps.version.outputs.version }}-1-${{ matrix.arch }}.pkg.tar.zst

      - name: Upload .pkg.tar.zst artifact
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4
        with:
          name: moltis-${{ matrix.arch }}.pkg.tar.zst
          path: |
            *.pkg.tar.zst
            *.pkg.tar.zst.sha256
            *.pkg.tar.zst.sha512
            *.pkg.tar.zst.sig
            *.pkg.tar.zst.crt

      - name: Upload to release
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@a06a81a03ee405af7f2048a818ed3f03bbf83c7b # v2
        with:
          files: |
            *.pkg.tar.zst
            *.pkg.tar.zst.sha256
            *.pkg.tar.zst.sha512
            *.pkg.tar.zst.sig
            *.pkg.tar.zst.crt

  build-appimage:
    needs: [clippy, test]
    strategy:
      matrix:
        include:
          - target: x86_64-unknown-linux-gnu
            arch: x86_64
            os: ubuntu-latest
            appimagetool_arch: x86_64
          - target: aarch64-unknown-linux-gnu
            arch: aarch64
            os: ubuntu-24.04-arm
            appimagetool_arch: aarch64

    runs-on: ${{ matrix.os }}
    name: Build AppImage (${{ matrix.arch }})
    permissions:
      contents: write
      id-token: write # Required for Sigstore keyless signing

    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4
        with:
          persist-credentials: false

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@f7ccc83f9ed1e5b9c81d8a67d7ad1a747e22a561 # master
        with:
          toolchain: stable
          targets: ${{ matrix.target }}

      - name: Install cosign
        uses: sigstore/cosign-installer@d7d6bc7722e3daa8354c50bcb52f4837da5e9b6a # v3.8.1

      - name: Build release binary
        env:
          BUILD_TARGET: ${{ matrix.target }}
        run: cargo build --release --target "$BUILD_TARGET"

      - name: Determine package version
        id: version
        run: |
          if [[ "$GITHUB_REF" == refs/tags/v* ]]; then
            VERSION="${GITHUB_REF#refs/tags/v}"
          else
            VERSION=$(grep '^version' Cargo.toml | head -1 | sed 's/.*"\(.*\)"/\1/')
          fi
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"

      - name: Build AppImage
        env:
          VERSION: ${{ steps.version.outputs.version }}
          BUILD_TARGET: ${{ matrix.target }}
          MATRIX_ARCH: ${{ matrix.arch }}
          APPIMAGETOOL_ARCH: ${{ matrix.appimagetool_arch }}
        run: |
          # Download appimagetool matching the runner architecture
          wget -q "https://github.com/AppImage/appimagetool/releases/download/continuous/appimagetool-${APPIMAGETOOL_ARCH}.AppImage" -O appimagetool
          chmod +x appimagetool

          # Build AppDir structure
          APP_DIR="moltis.AppDir"
          mkdir -p "$APP_DIR/usr/bin"
          cp "target/$BUILD_TARGET/release/moltis" "$APP_DIR/usr/bin/moltis"
          chmod 755 "$APP_DIR/usr/bin/moltis"

          # Create .desktop file
          cat > "$APP_DIR/moltis.desktop" <<DESKTOP
          [Desktop Entry]
          Type=Application
          Name=Moltis
          Exec=moltis
          Icon=moltis
          Categories=Network;
          Terminal=true
          DESKTOP

          # Create minimal icon
          cat > "$APP_DIR/moltis.svg" <<SVG
          <svg xmlns="http://www.w3.org/2000/svg" width="256" height="256"><rect width="256" height="256" fill="#333"/><text x="128" y="140" font-size="120" text-anchor="middle" fill="white">M</text></svg>
          SVG
          ln -s moltis.svg "$APP_DIR/.DirIcon"

          # Create AppRun
          cat > "$APP_DIR/AppRun" <<'APPRUN'
          #!/bin/sh
          SELF=$(readlink -f "$0")
          HERE=${SELF%/*}
          exec "$HERE/usr/bin/moltis" "$@"
          APPRUN
          chmod +x "$APP_DIR/AppRun"

          # Package - use --appimage-extract-and-run to avoid FUSE requirement in CI
          ARCH="$MATRIX_ARCH" ./appimagetool --appimage-extract-and-run "$APP_DIR" "moltis-${VERSION}-${MATRIX_ARCH}.AppImage"

      - name: Sign with Sigstore and generate checksums
        uses: ./.github/actions/sign-artifacts
        with:
          files: moltis-${{ steps.version.outputs.version }}-${{ matrix.arch }}.AppImage

      - name: Upload AppImage artifact
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4
        with:
          name: moltis-${{ matrix.arch }}.AppImage
          path: |
            *.AppImage
            *.AppImage.sha256
            *.AppImage.sha512
            *.AppImage.sig
            *.AppImage.crt

      - name: Upload to release
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@a06a81a03ee405af7f2048a818ed3f03bbf83c7b # v2
        with:
          files: |
            *.AppImage
            *.AppImage.sha256
            *.AppImage.sha512
            *.AppImage.sig
            *.AppImage.crt

  build-snap:
    needs: [clippy, test]
    runs-on: ubuntu-latest
    name: Build Snap
    permissions:
      contents: write
      id-token: write # Required for Sigstore keyless signing

    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4
        with:
          persist-credentials: false

      - name: Resolve release version
        id: release_version
        run: |
          if [[ "$GITHUB_REF" == refs/tags/v* ]]; then
            VERSION="${GITHUB_REF#refs/tags/v}"
          else
            VERSION=$(grep '^version' Cargo.toml | head -1 | sed 's/.*"\(.*\)"/\1/')
          fi
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"

      - name: Sync snap version to release version
        env:
          VERSION: ${{ steps.release_version.outputs.version }}
        run: |
          sed -Ei "s/^version:[[:space:]]*'.*'/version: '${VERSION}'/" snap/snapcraft.yaml

      - name: Install cosign
        uses: sigstore/cosign-installer@d7d6bc7722e3daa8354c50bcb52f4837da5e9b6a # v3.8.1

      - uses: snapcore/action-build@b391f430cb2650fd359ed4d2cfe88b2c481800e0 # v1
        id: build-snap

      - name: Sign with Sigstore and generate checksums
        uses: ./.github/actions/sign-artifacts
        with:
          files: ${{ steps.build-snap.outputs.snap }}

      - name: Upload Snap artifact
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4
        with:
          name: moltis.snap
          path: |
            ${{ steps.build-snap.outputs.snap }}
            ${{ steps.build-snap.outputs.snap }}.sha256
            ${{ steps.build-snap.outputs.snap }}.sha512
            ${{ steps.build-snap.outputs.snap }}.sig
            ${{ steps.build-snap.outputs.snap }}.crt

      - name: Upload to release
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@a06a81a03ee405af7f2048a818ed3f03bbf83c7b # v2
        with:
          files: |
            ${{ steps.build-snap.outputs.snap }}
            ${{ steps.build-snap.outputs.snap }}.sha256
            ${{ steps.build-snap.outputs.snap }}.sha512
            ${{ steps.build-snap.outputs.snap }}.sig
            ${{ steps.build-snap.outputs.snap }}.crt

  build-homebrew-binaries:
    needs: [clippy, test]
    strategy:
      matrix:
        include:
          - target: x86_64-apple-darwin
            os: macos-latest
          - target: aarch64-apple-darwin
            os: macos-latest
          - target: x86_64-unknown-linux-gnu
            os: ubuntu-latest
          - target: aarch64-unknown-linux-gnu
            os: ubuntu-24.04-arm

    runs-on: ${{ matrix.os }}
    name: Build binary (${{ matrix.target }})
    permissions:
      contents: write
      id-token: write # Required for Sigstore keyless signing

    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4
        with:
          persist-credentials: false

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@f7ccc83f9ed1e5b9c81d8a67d7ad1a747e22a561 # master
        with:
          toolchain: stable
          targets: ${{ matrix.target }}

      - name: Install cosign
        uses: sigstore/cosign-installer@d7d6bc7722e3daa8354c50bcb52f4837da5e9b6a # v3.8.1

      - name: Build release binary
        env:
          BUILD_TARGET: ${{ matrix.target }}
        run: cargo build --release --target "$BUILD_TARGET"

      - name: Determine package version
        id: version
        run: |
          if [[ "$GITHUB_REF" == refs/tags/v* ]]; then
            VERSION="${GITHUB_REF#refs/tags/v}"
          else
            VERSION=$(grep '^version' Cargo.toml | head -1 | sed 's/.*"\(.*\)"/\1/')
          fi
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"

      - name: Package binary
        env:
          VERSION: ${{ steps.version.outputs.version }}
          BUILD_TARGET: ${{ matrix.target }}
        run: |
          cp "target/$BUILD_TARGET/release/moltis" moltis
          tar czf "moltis-${VERSION}-${BUILD_TARGET}.tar.gz" moltis

      - name: Sign with Sigstore and generate checksums
        uses: ./.github/actions/sign-artifacts
        with:
          files: moltis-${{ steps.version.outputs.version }}-${{ matrix.target }}.tar.gz

      - name: Upload binary artifact
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4
        with:
          name: moltis-${{ matrix.target }}
          path: |
            *.tar.gz
            *.tar.gz.sha256
            *.tar.gz.sha512
            *.tar.gz.sig
            *.tar.gz.crt

      - name: Upload to release
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@a06a81a03ee405af7f2048a818ed3f03bbf83c7b # v2
        with:
          files: |
            *.tar.gz
            *.tar.gz.sha256
            *.tar.gz.sha512
            *.tar.gz.sig
            *.tar.gz.crt

  build-docker:
    needs: [clippy, test]
    strategy:
      matrix:
        include:
          - platform: linux/amd64
            os: ubuntu-latest
          - platform: linux/arm64
            os: ubuntu-24.04-arm

    runs-on: ${{ matrix.os }}
    name: Build Docker (${{ matrix.platform }})
    permissions:
      contents: read
      packages: write
      id-token: write # Required for Sigstore keyless signing
      attestations: write # Required for provenance attestations

    outputs:
      # Each matrix leg overwrites, but merge job reads digests from artifacts
      image: ghcr.io/${{ github.repository }}

    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4
        with:
          persist-credentials: false

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@b5ca514318bd6ebac0fb2aedd5d36ec1b5c232a2 # v3

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@74a5d142397b4f367a81961eba4e8cd7edddf772 # v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@902fa8ec7d6ecbf8d84d538b9b233a880e428804 # v5
        with:
          images: ghcr.io/${{ github.repository }}

      - name: Build and push by digest
        id: build
        uses: docker/build-push-action@14487ce63c7a62a4a324b0bfb37086795e31c6c1 # v6
        with:
          context: .
          platforms: ${{ matrix.platform }}
          labels: ${{ steps.meta.outputs.labels }}
          outputs: type=image,"name=ghcr.io/${{ github.repository }}",push-by-digest=true,name-canonical=true,push=true
          cache-from: type=gha,scope=${{ matrix.platform }}
          cache-to: type=gha,scope=${{ matrix.platform }},mode=max
          sbom: true
          provenance: mode=max

      - name: Smoke test Docker image startup
        env:
          DIGEST: ${{ steps.build.outputs.digest }}
        run: |
          docker run --rm "ghcr.io/${{ github.repository }}@${DIGEST}" --help > /dev/null

      - name: Export digest
        env:
          DIGEST: ${{ steps.build.outputs.digest }}
        run: |
          mkdir -p /tmp/digests
          digest="${DIGEST#sha256:}"
          touch "/tmp/digests/${digest}"

      - name: Upload digest
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4
        with:
          name: docker-digests-${{ strategy.job-index }}
          path: /tmp/digests/*
          if-no-files-found: error
          retention-days: 1

  merge-docker:
    needs: build-docker
    runs-on: ubuntu-latest
    name: Merge Docker manifest
    permissions:
      contents: read
      packages: write
      id-token: write # Required for Sigstore keyless signing

    steps:
      - name: Download digests
        uses: actions/download-artifact@d3f86a106a0bac45b974a628896c90dbdf5c8093 # v4
        with:
          path: /tmp/digests
          pattern: docker-digests-*
          merge-multiple: true

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@b5ca514318bd6ebac0fb2aedd5d36ec1b5c232a2 # v3

      - name: Install cosign
        uses: sigstore/cosign-installer@d7d6bc7722e3daa8354c50bcb52f4837da5e9b6a # v3.8.1

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@74a5d142397b4f367a81961eba4e8cd7edddf772 # v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@902fa8ec7d6ecbf8d84d538b9b233a880e428804 # v5
        with:
          images: ghcr.io/${{ github.repository }}
          tags: |
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=sha
            type=raw,value=latest,enable=${{ startsWith(github.ref, 'refs/tags/') }}

      - name: Create multi-arch manifest and push
        env:
          TAGS: ${{ steps.meta.outputs.tags }}
        working-directory: /tmp/digests
        run: |
          docker buildx imagetools create $(jq -cr '.tags | map("-t " + .) | join(" ")' <<< "$DOCKER_METADATA_OUTPUT_JSON") \
            $(printf 'ghcr.io/${{ github.repository }}@sha256:%s ' *)

      - name: Inspect manifest
        env:
          TAGS: ${{ steps.meta.outputs.tags }}
        run: |
          tag=$(echo "$TAGS" | head -1)
          docker buildx imagetools inspect "$tag"

      - name: Get manifest digest
        id: manifest
        env:
          TAGS: ${{ steps.meta.outputs.tags }}
        run: |
          tag=$(echo "$TAGS" | head -1)
          digest=$(docker buildx imagetools inspect "$tag" --format '{{json .Manifest}}' | jq -r '.digest')
          echo "digest=${digest}" >> "$GITHUB_OUTPUT"

      - name: Sign container image with cosign (keyless)
        if: github.event_name != 'pull_request'
        env:
          DIGEST: ${{ steps.manifest.outputs.digest }}
          TAGS: ${{ steps.meta.outputs.tags }}
        run: |
          images=""
          for tag in ${TAGS}; do
            images+="${tag}@${DIGEST} "
          done
          cosign sign --yes ${images}

      - name: Verify container signature
        if: github.event_name != 'pull_request'
        env:
          DIGEST: ${{ steps.manifest.outputs.digest }}
        run: |
          cosign verify \
            --certificate-identity-regexp="https://github.com/${{ github.repository }}/*" \
            --certificate-oidc-issuer="https://token.actions.githubusercontent.com" \
            "ghcr.io/${{ github.repository }}@${DIGEST}"

  # Generate SBOM for the entire release
  generate-sbom:
    needs:
      - build-deb
      - build-rpm
      - build-arch
      - build-appimage
      - build-snap
      - build-homebrew-binaries
      - merge-docker
    if: startsWith(github.ref, 'refs/tags/')
    runs-on: ubuntu-latest
    name: Generate Release SBOM
    permissions:
      contents: write
      id-token: write # Required for Sigstore keyless signing

    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4
        with:
          persist-credentials: false

      - name: Install cosign
        uses: sigstore/cosign-installer@d7d6bc7722e3daa8354c50bcb52f4837da5e9b6a # v3.8.1

      - name: Install cargo-sbom
        run: cargo install cargo-sbom

      - name: Generate SBOM (CycloneDX and SPDX)
        run: |
          cargo sbom --output-format cyclone_dx_json_1_4 > moltis-sbom.cdx.json
          cargo sbom --output-format spdx_json_2_3 > moltis-sbom.spdx.json

      - name: Sign SBOMs with Sigstore and generate checksums
        uses: ./.github/actions/sign-artifacts
        with:
          files: moltis-sbom.cdx.json moltis-sbom.spdx.json
          skip-sha512: 'true'

      - name: Upload SBOM to release
        uses: softprops/action-gh-release@a06a81a03ee405af7f2048a818ed3f03bbf83c7b # v2
        with:
          files: |
            moltis-sbom.cdx.json
            moltis-sbom.cdx.json.sha256
            moltis-sbom.cdx.json.sig
            moltis-sbom.cdx.json.crt
            moltis-sbom.spdx.json
            moltis-sbom.spdx.json.sha256
            moltis-sbom.spdx.json.sig
            moltis-sbom.spdx.json.crt

  update-homebrew-tap:
    needs:
      - build-deb
      - build-rpm
      - build-arch
      - build-appimage
      - build-snap
      - build-homebrew-binaries
      - merge-docker
    if: startsWith(github.ref, 'refs/tags/')
    runs-on: ubuntu-latest
    name: Update Homebrew tap
    permissions:
      contents: read

    steps:
      - name: Check Homebrew tap token
        id: token_check
        env:
          HOMEBREW_TAP_TOKEN: ${{ secrets.HOMEBREW_TAP_TOKEN }}
        run: |
          set -euo pipefail
          if [ -z "${HOMEBREW_TAP_TOKEN}" ]; then
            echo "has_token=false" >> "$GITHUB_OUTPUT"
            echo "HOMEBREW_TAP_TOKEN is not set; skipping Homebrew tap update"
          else
            echo "has_token=true" >> "$GITHUB_OUTPUT"
          fi

      - name: Download release assets and compute SHAs
        if: steps.token_check.outputs.has_token == 'true'
        env:
          GH_TOKEN: ${{ secrets.HOMEBREW_TAP_TOKEN }}
          TAG: ${{ github.ref_name }}
        run: |
          set -euo pipefail
          VERSION="${TAG#v}"
          echo "VERSION=$VERSION" >> "$GITHUB_ENV"

          for target in aarch64-apple-darwin x86_64-apple-darwin aarch64-unknown-linux-gnu x86_64-unknown-linux-gnu; do
            ASSET="moltis-${VERSION}-${target}.tar.gz"
            URL="https://github.com/${GITHUB_REPOSITORY}/releases/download/${TAG}/${ASSET}"
            curl --silent --show-error --fail --location "$URL" -o "$ASSET"
            SHA=$(sha256sum "$ASSET" | cut -d' ' -f1)
            VAR="SHA_$(echo "$target" | tr '-' '_')"
            echo "${VAR}=${SHA}" >> "$GITHUB_ENV"
            echo "$target: $SHA"
          done

      - name: Checkout homebrew-tap
        if: steps.token_check.outputs.has_token == 'true'
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4
        with:
          repository: moltis-org/homebrew-tap
          token: ${{ secrets.HOMEBREW_TAP_TOKEN }}
          persist-credentials: true

      - name: Update formula
        if: steps.token_check.outputs.has_token == 'true'
        run: |
          cat > Formula/moltis.rb <<RUBY
          class Moltis < Formula
            desc "Personal AI gateway - one binary, multiple LLM providers"
            homepage "https://www.moltis.org/"
            license "MIT"
            version "${VERSION}"

            on_macos do
              if Hardware::CPU.arm?
                url "https://github.com/moltis-org/moltis/releases/download/v#{version}/moltis-#{version}-aarch64-apple-darwin.tar.gz"
                sha256 "${SHA_aarch64_apple_darwin}"
              else
                url "https://github.com/moltis-org/moltis/releases/download/v#{version}/moltis-#{version}-x86_64-apple-darwin.tar.gz"
                sha256 "${SHA_x86_64_apple_darwin}"
              end
            end

            on_linux do
              if Hardware::CPU.arm?
                url "https://github.com/moltis-org/moltis/releases/download/v#{version}/moltis-#{version}-aarch64-unknown-linux-gnu.tar.gz"
                sha256 "${SHA_aarch64_unknown_linux_gnu}"
              else
                url "https://github.com/moltis-org/moltis/releases/download/v#{version}/moltis-#{version}-x86_64-unknown-linux-gnu.tar.gz"
                sha256 "${SHA_x86_64_unknown_linux_gnu}"
              end
            end

            def install
              bin.install "moltis"
            end

            test do
              assert_match "moltis", shell_output("#{bin}/moltis --version")
            end
          end
          RUBY

      - name: Commit and push
        if: steps.token_check.outputs.has_token == 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add Formula/moltis.rb
          if git diff --cached --quiet; then
            echo "No Homebrew formula changes to commit"
            exit 0
          fi
          git commit -m "moltis ${VERSION}"
          git push
