name: Update Homebrew Formula

on:
  release:
    types: [published]

permissions: {}

jobs:
  update-formula:
    name: Update Homebrew tap
    runs-on: self-hosted
    permissions:
      contents: read
    steps:
      - name: Wait for release assets
        env:
          GH_TOKEN: ${{ secrets.HOMEBREW_TAP_TOKEN }}
          TAG: ${{ github.event.release.tag_name }}
        run: |
          for i in $(seq 1 30); do
            COUNT=$(gh release view "$TAG" --repo "$GITHUB_REPOSITORY" --json assets -q '.assets | length')
            if [ "$COUNT" -ge 4 ]; then
              echo "All assets available ($COUNT)"
              exit 0
            fi
            echo "Waiting for assets... ($COUNT so far)"
            sleep 30
          done
          echo "Timed out waiting for release assets"
          exit 1

      - name: Download release assets and compute SHAs
        env:
          GH_TOKEN: ${{ secrets.HOMEBREW_TAP_TOKEN }}
          TAG: ${{ github.event.release.tag_name }}
        run: |
          VERSION="${TAG#v}"
          echo "VERSION=$VERSION" >> "$GITHUB_ENV"

          for target in aarch64-apple-darwin x86_64-apple-darwin aarch64-unknown-linux-gnu x86_64-unknown-linux-gnu; do
            ASSET="moltis-${VERSION}-${target}.tar.gz"
            gh release download "$TAG" --repo "$GITHUB_REPOSITORY" --pattern "$ASSET"
            SHA=$(sha256sum "$ASSET" | cut -d' ' -f1)
            VAR="SHA_$(echo "$target" | tr '-' '_')"
            echo "${VAR}=${SHA}" >> "$GITHUB_ENV"
            echo "$target: $SHA"
          done

      - name: Checkout homebrew-tap
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4
        with:
          repository: penso/homebrew-tap
          token: ${{ secrets.HOMEBREW_TAP_TOKEN }}
          persist-credentials: true

      - name: Update formula
        run: |
          cat > Formula/moltis.rb <<RUBY
          class Moltis < Formula
            desc "Personal AI gateway â€” one binary, multiple LLM providers"
            homepage "https://docs.molt.bot/"
            license "MIT"
            version "${VERSION}"

            on_macos do
              if Hardware::CPU.arm?
                url "https://github.com/penso/moltis/releases/download/v#{version}/moltis-#{version}-aarch64-apple-darwin.tar.gz"
                sha256 "${SHA_aarch64_apple_darwin}"
              else
                url "https://github.com/penso/moltis/releases/download/v#{version}/moltis-#{version}-x86_64-apple-darwin.tar.gz"
                sha256 "${SHA_x86_64_apple_darwin}"
              end
            end

            on_linux do
              if Hardware::CPU.arm?
                url "https://github.com/penso/moltis/releases/download/v#{version}/moltis-#{version}-aarch64-unknown-linux-gnu.tar.gz"
                sha256 "${SHA_aarch64_unknown_linux_gnu}"
              else
                url "https://github.com/penso/moltis/releases/download/v#{version}/moltis-#{version}-x86_64-unknown-linux-gnu.tar.gz"
                sha256 "${SHA_x86_64_unknown_linux_gnu}"
              end
            end

            def install
              bin.install "moltis"
            end

            test do
              assert_match "moltis", shell_output("#{bin}/moltis --version")
            end
          end
          RUBY

      - name: Commit and push
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add Formula/moltis.rb
          git commit -m "moltis ${VERSION}"
          git push
