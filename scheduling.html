<!DOCTYPE HTML>
<html lang="en" class="light sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Scheduling (Cron Jobs) - Moltis Documentation</title>


        <!-- Custom HTML head -->

        <meta name="description" content="Documentation for Moltis - Your AI coding assistant">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="favicon.svg">
        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" id="highlight-css" href="highlight.css">
        <link rel="stylesheet" id="tomorrow-night-css" href="tomorrow-night.css">
        <link rel="stylesheet" id="ayu-highlight-css" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        <link rel="stylesheet" href="theme/admonish.css">
        <link rel="stylesheet" href="theme/custom.css">


        <!-- Provide site root and default themes to javascript -->
        <script>
            const path_to_root = "";
            const default_light_theme = "light";
            const default_dark_theme = "navy";
            window.path_to_searchindex_js = "searchindex.js";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="toc.js"></script>
    </head>
    <body>
    <div id="mdbook-help-container">
        <div id="mdbook-help-popup">
            <h2 class="mdbook-help-title">Keyboard shortcuts</h2>
            <div>
                <p>Press <kbd>←</kbd> or <kbd>→</kbd> to navigate between chapters</p>
                <p>Press <kbd>S</kbd> or <kbd>/</kbd> to search in the book</p>
                <p>Press <kbd>?</kbd> to show this help</p>
                <p>Press <kbd>Esc</kbd> to hide this help</p>
            </div>
        </div>
    </div>
    <div id="body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                let theme = localStorage.getItem('mdbook-theme');
                let sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            const default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? default_dark_theme : default_light_theme;
            let theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            let sidebar = null;
            const sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
                sidebar_toggle.checked = false;
            }
            if (sidebar === 'visible') {
                sidebar_toggle.checked = true;
            } else {
                html.classList.remove('sidebar-visible');
            }
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="toc.html"></iframe>
            </noscript>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="default_theme">Auto</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search (`/`)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="/ s" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Moltis Documentation</h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        <a href="https://github.com/moltis-org/moltis" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>
                        <a href="https://github.com/moltis-org/moltis/edit/main/docs/src/src/scheduling.md" title="Suggest an edit" aria-label="Suggest an edit" rel="edit">
                            <i id="git-edit-button" class="fa fa-edit"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <div class="search-wrapper">
                            <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                            <div class="spinner-wrapper">
                                <i class="fa fa-spinner fa-spin"></i>
                            </div>
                        </div>
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="scheduling-cron-jobs"><a class="header" href="#scheduling-cron-jobs">Scheduling (Cron Jobs)</a></h1>
<p>Moltis includes a built-in cron system that lets the agent schedule and manage
recurring tasks. Jobs can fire agent turns, send system events, or trigger
other actions on a flexible schedule.</p>
<h2 id="heartbeat"><a class="header" href="#heartbeat">Heartbeat</a></h2>
<p>The <strong>heartbeat</strong> is a special system cron job (<code>__heartbeat__</code>) that runs
periodically (default: every 15 minutes). It gives the agent an opportunity to
check reminders, run deferred tasks, and react to events that occurred while
the user was away.</p>
<p>The heartbeat prompt is assembled from <code>HEARTBEAT.md</code> in the workspace data
directory. If the file is empty and no pending events exist, the heartbeat
turn is skipped to save tokens.</p>
<h2 id="event-driven-heartbeat-wake"><a class="header" href="#event-driven-heartbeat-wake">Event-Driven Heartbeat Wake</a></h2>
<p>Normally the heartbeat fires on its regular schedule. The <strong>wake</strong> system lets
other parts of Moltis trigger an immediate heartbeat when something noteworthy
happens, so the agent can react in near real-time.</p>
<h3 id="wake-mode"><a class="header" href="#wake-mode">Wake Mode</a></h3>
<p>Every cron job has a <code>wakeMode</code> field that controls whether it triggers an
immediate heartbeat after execution:</p>
<div class="table-wrapper"><table><thead><tr><th>Value</th><th>Behaviour</th></tr></thead><tbody>
<tr><td><code>"nextHeartbeat"</code> (default)</td><td>No extra wake — events are picked up on the next scheduled heartbeat</td></tr>
<tr><td><code>"now"</code></td><td>Immediately reschedules the heartbeat to run as soon as possible</td></tr>
</tbody></table>
</div>
<p>Set <code>wakeMode</code> when creating or updating a job through the <code>cron</code> tool:</p>
<pre><code class="language-json">{
  "action": "add",
  "job": {
    "name": "check-deploy",
    "schedule": { "kind": "every", "every_ms": 300000 },
    "payload": { "kind": "agentTurn", "message": "Check deploy status" },
    "wakeMode": "now"
  }
}
</code></pre>
<p>Aliases are accepted: <code>"immediate"</code>, <code>"immediately"</code> map to <code>"now"</code>;
<code>"next"</code>, <code>"default"</code>, <code>"next_heartbeat"</code>, <code>"next-heartbeat"</code> map to
<code>"nextHeartbeat"</code>.</p>
<h3 id="system-events-queue"><a class="header" href="#system-events-queue">System Events Queue</a></h3>
<p>Moltis maintains an in-memory bounded queue of <strong>system events</strong> — short text
summaries of things that happened (command completions, cron triggers, etc.).
When the heartbeat fires, any pending events are drained from the queue and
prepended to the heartbeat prompt so the agent sees what occurred.</p>
<p>The queue holds up to 20 events. Consecutive duplicate events are
deduplicated. Events that arrive after the buffer is full are silently dropped
(oldest events are preserved).</p>
<h3 id="exec-completion-events"><a class="header" href="#exec-completion-events">Exec Completion Events</a></h3>
<p>When a background command finishes (via the <code>exec</code> tool), Moltis automatically
enqueues a summary event with the command name, exit code, and a short preview
of stdout/stderr. If the heartbeat is idle, it is woken immediately so the
agent can react to the result.</p>
<p>This means the agent learns about completed background tasks without polling
— a long-running build or deployment that finishes while the user is away will
surface in the next heartbeat turn.</p>
<h2 id="schedule-types"><a class="header" href="#schedule-types">Schedule Types</a></h2>
<p>Jobs support several schedule kinds:</p>
<div class="table-wrapper"><table><thead><tr><th>Kind</th><th>Fields</th><th>Description</th></tr></thead><tbody>
<tr><td><code>every</code></td><td><code>every_ms</code></td><td>Repeat at a fixed interval (milliseconds)</td></tr>
<tr><td><code>cron</code></td><td><code>cron_expr</code></td><td>Standard cron expression (e.g. <code>"0 */6 * * *"</code>)</td></tr>
<tr><td><code>at</code></td><td><code>at_ms</code></td><td>Run once at a specific Unix timestamp (ms)</td></tr>
</tbody></table>
</div>
<h2 id="cron-tool"><a class="header" href="#cron-tool">Cron Tool</a></h2>
<p>The agent manages jobs through the built-in <code>cron</code> tool. Available actions:</p>
<ul>
<li><strong><code>add</code></strong> — Create a new job</li>
<li><strong><code>list</code></strong> — List all jobs</li>
<li><strong><code>update</code></strong> — Patch an existing job (name, schedule, enabled, wakeMode, etc.)</li>
<li><strong><code>remove</code></strong> — Delete a job</li>
<li><strong><code>runs</code></strong> — View recent execution history for a job</li>
</ul>
<h3 id="one-shot-jobs"><a class="header" href="#one-shot-jobs">One-Shot Jobs</a></h3>
<p>Set <code>deleteAfterRun: true</code> to automatically remove a job after its first
execution. Combined with the <code>at</code> schedule, this is useful for deferred
one-time tasks (reminders, follow-ups).</p>
<h2 id="session-targeting"><a class="header" href="#session-targeting">Session Targeting</a></h2>
<p>Each job specifies where its agent turn runs:</p>
<div class="table-wrapper"><table><thead><tr><th>Target</th><th>Description</th></tr></thead><tbody>
<tr><td><code>"main"</code></td><td>The main UI session (default)</td></tr>
<tr><td><code>{ "channel": "&lt;name&gt;" }</code></td><td>A specific channel session</td></tr>
</tbody></table>
</div>
<h2 id="security"><a class="header" href="#security">Security</a></h2>
<p>See <a href="security.html#cron-job-security">Cron Job Security</a> for rate limiting,
sandbox isolation, and job notification details.</p>
<h2 id="metrics"><a class="header" href="#metrics">Metrics</a></h2>
<div class="table-wrapper"><table><thead><tr><th>Metric</th><th>Type</th><th>Description</th></tr></thead><tbody>
<tr><td><code>moltis_cron_jobs_scheduled</code></td><td>Gauge</td><td>Number of scheduled jobs</td></tr>
<tr><td><code>moltis_cron_executions_total</code></td><td>Counter</td><td>Job executions</td></tr>
<tr><td><code>moltis_cron_execution_duration_seconds</code></td><td>Histogram</td><td>Job duration</td></tr>
<tr><td><code>moltis_cron_errors_total</code></td><td>Counter</td><td>Failed jobs</td></tr>
<tr><td><code>moltis_cron_stuck_jobs_cleared_total</code></td><td>Counter</td><td>Jobs exceeding 2h timeout</td></tr>
<tr><td><code>moltis_cron_input_tokens_total</code></td><td>Counter</td><td>Input tokens from cron runs</td></tr>
<tr><td><code>moltis_cron_output_tokens_total</code></td><td>Counter</td><td>Output tokens from cron runs</td></tr>
</tbody></table>
</div>
                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="session-branching.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="skill-tools.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="session-branching.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="skill-tools.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="elasticlunr.min.js"></script>
        <script src="mark.min.js"></script>
        <script src="searcher.js"></script>

        <script src="clipboard.min.js"></script>
        <script src="highlight.js"></script>
        <script src="book.js"></script>

        <!-- Custom JS scripts -->



    </div>
    </body>
</html>
